# 真实带货用户访问首页系统级推演报告

**推演日期**: 2026-01-25  
**用户身份**: 已注册、已登录、非admin、role='seller'或'user'、拥有至少1个已上架商品、拥有带货能力  
**访问行为**: 浏览器直接访问 URL: `/en`

---

## Step 1. middleware.ts 分析

### 1.1 Session 识别流程

**文件**: `middleware.ts` (根目录)

```typescript
// 第50行：先更新 Supabase 会话
const response = await updateSession(request)

// 第53行：然后应用国际化中间件
return intlMiddleware(request)
```

**分析结果**:
- ✅ **Session 识别正确**: `updateSession` 函数会调用 `supabase.auth.getUser()` 验证 session
- ✅ **无 seller 特殊 redirect**: middleware 中**没有**针对 `role='seller'` 的特殊重定向逻辑
- ✅ **Locale 路由正常**: 国际化中间件会正确处理 `/en` 路由

### 1.2 updateSession 函数详细分析

**文件**: `src/lib/supabase/middleware.ts`

```typescript
// 第57行：获取用户
const { data: { user } } = await supabase.auth.getUser()

// 第61-66行：查询 profile（包括 subscription_type 和 role）
if (user) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('status, subscription_type, role')
    .eq('id', user.id)
    .single()
  
  // 第68-78行：检查 banned/suspended 状态
  if (profile?.status === 'banned' || profile?.status === 'suspended') {
    // 重定向到 /banned 页面
    return NextResponse.redirect(bannedUrl)
  }
  
  // 第81-84行：注释说明
  // Note: We query subscription_type and role here for consistency
  // Currently, we don't redirect sellers to /seller/dashboard automatically
  // as this is a product decision - sellers should be able to access the homepage
}
```

**分析结果**:
- ✅ **正确识别已登录 session**: `auth.getUser()` 会验证 cookie 中的 session
- ✅ **无 seller 特殊处理**: 明确注释说明**不会**自动重定向 seller 到 dashboard
- ✅ **只检查 banned/suspended**: 仅对封禁用户进行重定向，seller 正常用户可访问首页
- ✅ **Locale 处理正确**: banned 重定向会保留 locale 前缀

**结论**: ✅ **Step 1 通过** - middleware 不会错误地将带货用户引导到 dashboard

---

## Step 2. 路由解析

### 2.1 路由匹配

**URL**: `/en`  
**匹配路由**: `src/app/[locale]/(main)/page.tsx`

**分析结果**:
- ✅ **路由匹配正确**: `/en` → `[locale]` = `en` → `(main)/page.tsx`
- ✅ **无 seller 特殊路由分支**: 首页路由对所有用户统一处理，无 seller 专用路由
- ✅ **首页无 seller 特殊判断**: 路由层面没有针对 seller 的特殊逻辑

**结论**: ✅ **Step 2 通过** - 路由解析正常，无 seller 特殊分支

---

## Step 3. 首页 Server Component

### 3.1 用户身份读取

**文件**: `src/app/[locale]/(main)/page.tsx`

```typescript
// 第14行：创建 Supabase client
const supabase = await createClient()

// 第20行：获取当前用户
const { data: { user }, error: authError } = await supabase.auth.getUser()

// 第23行：验证 session
const validUser = authError ? null : user

// 第28-33行：查询 profile（包括 subscription_type 和 role）
if (validUser) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('status, subscription_type, role')
    .eq('id', validUser.id)
    .single()
  
  // 第83行：存储 subscription_type
  subscriptionType = profile?.subscription_type || null
}
```

**分析结果**:
- ✅ **正确读取 session**: 使用 `createClient()` 创建服务端 client，能正确读取 session
- ✅ **正确读取 profile.role**: 查询了 `role` 字段（虽然当前未使用）
- ✅ **正确判断 seller 身份**: 通过 `subscription_type === 'seller'` 判断（第52行在 Client Component）
- ✅ **无 seller 额外查询**: Server Component **没有**因为 seller 身份执行额外查询（如余额、订单）
- ✅ **未误用 admin client**: 使用的是普通 `createClient()`，不是 admin client

### 3.2 数据查询逻辑

**文件**: `src/app/[locale]/(main)/page.tsx`

```typescript
// 第87-103行：基础 posts 查询
let postsQuery = supabase
  .from('posts')
  .select(`...`)
  .eq('status', 'approved')

// 第107-215行：已登录用户的个性化逻辑
if (validUser) {
  // 获取关注列表
  const { data: following } = await supabase
    .from('follows')
    .select('following_id')
    .eq('follower_id', validUser.id)
  
  // 优先显示关注用户的帖子
  // 然后显示热门帖子
}
```

**分析结果**:
- ✅ **查询逻辑统一**: seller 和普通用户使用**相同的** posts 查询逻辑
- ✅ **无 seller 特殊查询**: **没有**查询 seller 专属数据（如自己的商品、订单、余额）
- ✅ **只查询 posts**: 仅查询 `posts` 表，符合首页功能定位

**结论**: ✅ **Step 3 通过** - Server Component 行为正常，无 seller 特殊处理

---

## Step 4. 首页数据查询

### 4.1 数据来源分析

**查询的表**:
1. `posts` - 帖子内容（主要数据源）
2. `profiles` - 用户信息（用于关联查询）
3. `follows` - 关注关系（用于个性化）
4. `post_topics` / `topics` - 话题标签（关联查询）

**查询逻辑**:
- **未登录用户**: 按 `created_at` 降序，显示最近 20 条已审核帖子
- **已登录用户（有关注）**: 优先显示关注用户的帖子（最多10条），然后填充热门帖子
- **已登录用户（无关注）**: 按 `created_at` 降序，显示最近 20 条已审核帖子

### 4.2 带货用户数据可见性

**关键问题**: 带货用户能否看到：
1. ✅ **自己的内容**: 能。如果自己发布了帖子且状态为 `approved`，会出现在首页
2. ✅ **自己的商品**: **不能直接看到**。首页只显示 `posts`，不显示 `products`。商品需要通过帖子中的链接或商品详情页访问
3. ❓ **绑定商品的帖子**: **部分可见**。如果帖子绑定了商品（通过 `affiliate_products` 表），但首页查询**没有**关联查询商品信息，所以：
   - 帖子本身会显示
   - 但商品绑定信息**不会**在首页显示（需要在帖子详情页查看）

### 4.3 是否多查了 seller-only 数据

**检查结果**:
- ✅ **未查询余额**: 首页**没有**查询 `deposits`、`deposit_lots` 等余额相关表
- ✅ **未查询订单**: 首页**没有**查询 `orders` 表
- ✅ **未查询商品列表**: 首页**没有**查询 `products` 表（即使是自己的商品）
- ✅ **未查询支付账户**: 首页**没有**查询 `payment_accounts` 表

**结论**: ✅ **Step 4 通过** - 数据查询范围合理，未多查 seller-only 数据

---

## Step 5. 带货能力表现

### 5.1 首页暴露的入口

**文件**: `src/app/[locale]/(main)/HomePageClient.tsx`

```typescript
// 第122-137行：卖家入口提示
{isSeller && effectiveUser && (
  <div className="mb-6 rounded-lg border border-blue-200 bg-blue-50/50 p-4">
    <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
      <div>
        <h3 className="text-base font-semibold">卖家中心</h3>
        <p className="mt-1 text-sm">管理您的商品和订单</p>
      </div>
      <Link href="/seller/dashboard">
        <Button size="sm">进入卖家中心</Button>
      </Link>
    </div>
  </div>
)}
```

**分析结果**:
- ✅ **卖家中心入口**: 当 `isSeller && effectiveUser` 时显示
- ❌ **创建带货帖入口**: **首页没有**直接创建带货帖的入口
- ❌ **商品绑定入口**: **首页没有**商品绑定入口
- ✅ **跳转 seller dashboard**: 有明确的"进入卖家中心"按钮

### 5.2 入口显示控制

**判断逻辑**:
```typescript
// 第52行：判断是否为 seller
const isSeller = effectiveSubscriptionType === 'seller'

// 第123行：条件渲染
{isSeller && effectiveUser && (
  // 显示卖家中心入口
)}
```

**分析结果**:
- ✅ **仅前端控制显示**: 卖家入口**只在前端**通过 `isSeller` 判断显示
- ⚠️ **无后端权限校验**: 如果用户手动修改前端代码或直接访问 `/seller/dashboard`，需要依赖该页面的权限校验

**结论**: ⚠️ **Step 5 部分通过** - 首页有卖家中心入口，但缺少创建带货帖和商品绑定的直接入口

---

## Step 6. Client Component 行为

### 6.1 Props 传递

**Server Component → Client Component**:

```typescript
// page.tsx (Server)
<HomePageClient
  initialPosts={posts}
  initialError={error}
  user={validUser}  // ✅ 传递 user
  subscriptionType={subscriptionType}  // ✅ 传递 subscriptionType
  translations={{...}}
/>
```

**Client Component 接收**:

```typescript
// HomePageClient.tsx
export function HomePageClient({ 
  initialPosts, 
  initialError, 
  user: initialUser,  // ✅ 接收 user
  subscriptionType: initialSubscriptionType,  // ✅ 接收 subscriptionType
  translations 
}: HomePageClientProps)
```

**分析结果**:
- ✅ **role 未直接传递**: `role` 字段**没有**作为 props 传递，但通过 `subscriptionType` 可以判断 seller 身份
- ✅ **isSeller 计算**: 在 Client Component 中通过 `subscriptionType === 'seller'` 计算（第52行）

### 6.2 Hydration 风险

**Hydration 一致性处理**:

```typescript
// 第42行：Client 端获取 user
const { user, loading: authLoading } = useAuth()

// 第47行：确保 hydration 一致性
const effectiveUser = authLoading ? initialUser : user

// 第51行：使用 server 传递的 subscriptionType
const effectiveSubscriptionType = initialSubscriptionType
const isSeller = effectiveSubscriptionType === 'seller'
```

**分析结果**:
- ✅ **Hydration 安全**: 在 `authLoading` 期间使用 server 传递的 `initialUser` 和 `initialSubscriptionType`
- ✅ **避免闪烁**: 有初始数据时立即显示，不等待 client auth 加载完成
- ✅ **一致性保证**: 使用 server 传递的值，而不是从 client 查询，避免 hydration mismatch

**结论**: ✅ **Step 6 通过** - Client Component 行为正常，无 hydration 风险

---

## Step 7. 交互与权限校验

### 7.1 点击"进入卖家中心"按钮

**前端行为**:
```typescript
// HomePageClient.tsx 第130行
<Link href="/seller/dashboard">
  <Button>进入卖家中心</Button>
</Link>
```

**路由**: `/seller/dashboard`  
**文件**: `src/app/[locale]/(main)/seller/dashboard/page.tsx`

**权限校验**:
```typescript
// 第14行：使用 useSellerGuard hook
const { user, loading: authLoading, isSeller } = useSellerGuard()
```

### 7.2 useSellerGuard Hook 分析

**文件**: `src/lib/hooks/useSellerGuard.tsx`

```typescript
// 第38-64行：检查 seller 状态
const { data: profile, error } = await supabase
  .from('profiles')
  .select('subscription_type')
  .eq('id', user.id)
  .single()

const sellerStatus = profile.subscription_type === 'seller'
setIsSeller(sellerStatus)

if (requireSeller && !sellerStatus) {
  // 不是卖家，重定向
  router.push(redirectTo)
}
```

**分析结果**:
- ✅ **后端权限校验**: `useSellerGuard` 会从数据库查询 `subscription_type`，**不是**仅依赖前端状态
- ✅ **自动重定向**: 如果不是 seller 且 `requireSeller=true`，会自动重定向到首页
- ✅ **权限校验正确**: 通过 `subscription_type === 'seller'` 判断，与首页逻辑一致

### 7.3 创建带货帖 API 权限校验

**API**: `/api/affiliate/posts/create`  
**文件**: `src/app/api/affiliate/posts/create/route.ts`

```typescript
// 第17-19行：验证用户身份
if (authError || !user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}

// 第32-54行：验证 affiliate 订阅状态
const { data: hasSubscription } = await supabase.rpc(
  'check_subscription_status',
  {
    p_user_id: user.id,
    p_subscription_type: 'affiliate',  // 注意：这里是 'affiliate'，不是 'seller'
    p_required_tier: null,
  }
)

if (!hasSubscription) {
  return NextResponse.json(
    { error: 'You need an active affiliate subscription to create promotional posts' },
    { status: 403 }
  )
}
```

**分析结果**:
- ✅ **API 权限校验**: API **会再次校验**用户权限，不依赖前端
- ⚠️ **订阅类型要求**: 创建带货帖需要 `subscription_type = 'affiliate'`，**不是** `seller`
- ⚠️ **权限不一致**: 首页判断 seller 用 `subscription_type === 'seller'`，但创建带货帖需要 `affiliate` 订阅

**关键发现**: 
- **seller 订阅 ≠ affiliate 订阅**
- seller 可以创建商品，但创建带货帖需要单独的 affiliate 订阅
- 首页显示的"卖家中心"入口可能误导用户，因为 seller 不一定有 affiliate 订阅

### 7.4 是否存在仅靠前端隐藏的 seller 操作

**检查结果**:
- ✅ **所有 seller 操作都有后端校验**: 
  - 创建商品: 需要 `subscription_type = 'seller'` (RLS Policy)
  - 创建带货帖: 需要 `subscription_type = 'affiliate'` (API 校验)
  - 查看订单: RLS Policy 限制只能看自己的订单
  - 查看余额: API 会校验 seller 身份

**结论**: ✅ **Step 7 通过** - 交互与权限校验正常，但存在 seller/affiliate 订阅类型混淆的风险

---

## Step 8. RLS 与数据边界

### 8.1 Posts 表 RLS Policy

**文件**: `supabase/migrations/153_add_user_status_field.sql`

```sql
-- 第32行：查看已审核帖子
CREATE POLICY "Users can view approved posts from active users" ON posts
  FOR SELECT USING (
    status = 'approved' 
    AND EXISTS (
      SELECT 1 FROM profiles 
      WHERE profiles.id = posts.user_id 
      AND profiles.status = 'active'
    )
    OR user_id = auth.uid()  -- 可以查看自己的帖子
    OR EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'support')
    )
  );
```

**分析结果**:
- ✅ **带货用户能看到**: 所有 `status = 'approved'` 且发布者 `status = 'active'` 的帖子
- ✅ **能看到自己的帖子**: 即使未审核，也能看到自己的帖子
- ✅ **不能看到其他卖家的后台数据**: RLS 只控制帖子可见性，不涉及订单、余额等

### 8.2 Products 表 RLS Policy

**文件**: `supabase/migrations/001_initial_schema.sql` 和 `153_add_user_status_field.sql`

```sql
-- 查看商品
CREATE POLICY "Users can view active products from active sellers" ON products
  FOR SELECT USING (
    (status = 'active' 
     AND EXISTS (
       SELECT 1 FROM profiles 
       WHERE profiles.id = products.seller_id 
       AND profiles.status = 'active'
     ))
    OR seller_id = auth.uid()  -- 可以查看自己的商品
    OR EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'support')
    )
  );

-- 创建商品
CREATE POLICY "Only active users can create products" ON products
  FOR INSERT WITH CHECK (
    auth.uid() = seller_id 
    AND EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND status = 'active'
      AND subscription_type = 'seller'  -- 需要 seller 订阅
    )
  );
```

**分析结果**:
- ✅ **带货用户能看到**: 所有 `status = 'active'` 且卖家 `status = 'active'` 的商品
- ✅ **能看到自己的商品**: 即使未上架，也能看到自己的商品
- ✅ **不能看到其他卖家的商品管理数据**: 只能看到已上架的商品，不能看到其他卖家的草稿、待审核商品

### 8.3 Orders 表 RLS Policy

**文件**: `supabase/migrations/001_initial_schema.sql`

```sql
CREATE POLICY "Users can view own orders" ON orders
  FOR SELECT USING (
    buyer_id = auth.uid() OR 
    seller_id = auth.uid() OR 
    affiliate_id = auth.uid() OR
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'support'))
  );
```

**分析结果**:
- ✅ **带货用户能看到**: 
  - 作为买家的订单 (`buyer_id = auth.uid()`)
  - 作为卖家的订单 (`seller_id = auth.uid()`)
  - 作为带货者的订单 (`affiliate_id = auth.uid()`)
- ✅ **不能看到**: 其他卖家的订单（除非是 admin/support）

### 8.4 数据边界总结

**带货用户能访问的数据**:
- ✅ 所有已审核的帖子（包括自己的）
- ✅ 所有已上架的商品（包括自己的）
- ✅ 自己的订单（作为买家、卖家、带货者）
- ✅ 自己的 profile 信息

**带货用户不能访问的数据**:
- ✅ 其他卖家的未上架商品
- ✅ 其他卖家的订单（除非是相关订单）
- ✅ 其他卖家的余额、支付账户信息
- ✅ 其他用户的私有数据

**结论**: ✅ **Step 8 通过** - RLS 策略足够严格，数据边界清晰

---

## Step 9. 边界情况

### 9.1 Seller 没有商品

**场景**: `subscription_type = 'seller'`，但 `products` 表中没有该用户的商品

**首页行为**:
- ✅ **页面正常渲染**: 首页不查询商品，只查询帖子
- ✅ **卖家中心入口显示**: 因为 `isSeller = true`，会显示"进入卖家中心"按钮
- ✅ **无错误**: 不会因为缺少商品而报错

**潜在问题**: 
- ⚠️ **用户体验**: 用户可能期望在首页看到自己的商品，但实际上看不到

### 9.2 Seller 商品被下架

**场景**: 用户有商品，但所有商品 `status != 'active'`

**首页行为**:
- ✅ **页面正常渲染**: 首页不查询商品，不受影响
- ✅ **帖子正常显示**: 如果用户发布了帖子，帖子会正常显示

**RLS 影响**:
- ✅ **商品不可见**: 其他用户看不到下架商品（RLS Policy 要求 `status = 'active'`）
- ✅ **自己可见**: 用户自己可以看到下架商品（`seller_id = auth.uid()`）

### 9.3 Seller 被封禁（role 降级）

**场景**: 用户 `status = 'banned'` 或 `status = 'suspended'`

**Middleware 行为**:
```typescript
// src/lib/supabase/middleware.ts 第68行
if (profile?.status === 'banned' || profile?.status === 'suspended') {
  return NextResponse.redirect(bannedUrl)  // 重定向到 /banned
}
```

**分析结果**:
- ✅ **无法访问首页**: 会被 middleware 拦截，重定向到 `/banned` 页面
- ✅ **RLS 保护**: 即使绕过 middleware，RLS Policy 也会过滤掉被封禁用户的内容

### 9.4 Seller Session 过期

**场景**: Supabase session 过期，`auth.getUser()` 返回 `null`

**首页行为**:
```typescript
// page.tsx 第20-23行
const { data: { user }, error: authError } = await supabase.auth.getUser()
const validUser = authError ? null : user

// 第28行：如果没有 user，不会查询 profile
if (validUser) {
  // 查询 profile
}
```

**分析结果**:
- ✅ **降级为游客模式**: 首页会按未登录用户处理，显示公开帖子
- ✅ **无错误**: 不会因为 session 过期而报错
- ✅ **卖家入口不显示**: 因为 `validUser = null`，`isSeller` 为 `false`，不会显示卖家入口

**结论**: ✅ **Step 9 通过** - 边界情况处理正常，但 seller 无商品时用户体验可能不够友好

---

## Step 10. 结论

### 10.1 首页行为是否合理

**总体评价**: ✅ **基本合理**

**优点**:
1. ✅ **无 seller 特殊重定向**: seller 可以正常访问首页，不会被强制跳转到 dashboard
2. ✅ **数据查询范围合理**: 只查询帖子相关数据，不查询 seller-only 数据
3. ✅ **权限校验完善**: 所有 seller 操作都有后端权限校验
4. ✅ **RLS 策略严格**: 数据边界清晰，不会泄露其他卖家的数据
5. ✅ **Hydration 安全**: 无 hydration mismatch 风险

**缺点**:
1. ⚠️ **缺少带货功能入口**: 首页没有直接创建带货帖的入口，需要进入卖家中心
2. ⚠️ **Seller/Affiliate 订阅混淆**: 首页判断 seller 用 `subscription_type = 'seller'`，但创建带货帖需要 `affiliate` 订阅
3. ⚠️ **无商品展示**: seller 在首页看不到自己的商品，可能影响用户体验

### 10.2 发现的问题

#### P0 问题（严重，必须修复）

**无 P0 问题**

#### P1 问题（重要，建议修复）

**P1-1: Seller/Affiliate 订阅类型混淆**
- **问题**: 首页判断 seller 用 `subscription_type = 'seller'`，但创建带货帖需要 `affiliate` 订阅
- **影响**: 用户可能误以为有 seller 订阅就能创建带货帖
- **位置**: 
  - `src/app/[locale]/(main)/HomePageClient.tsx` 第52行
  - `src/app/api/affiliate/posts/create/route.ts` 第36行
- **建议**: 
  - 在首页卖家入口提示中说明需要 affiliate 订阅才能创建带货帖
  - 或者在创建带货帖时提供更清晰的错误提示

**P1-2: 首页缺少带货功能入口**
- **问题**: 首页没有直接创建带货帖的入口，需要进入卖家中心
- **影响**: 带货用户需要多步操作才能创建带货帖
- **位置**: `src/app/[locale]/(main)/HomePageClient.tsx`
- **建议**: 
  - 在卖家入口提示中添加"创建带货帖"按钮
  - 或者添加一个快捷入口到 `/affiliate/products`

#### P2 问题（优化建议）

**P2-1: Seller 在首页看不到自己的商品**
- **问题**: 首页只显示帖子，不显示商品
- **影响**: seller 可能期望在首页看到自己的商品概览
- **位置**: `src/app/[locale]/(main)/page.tsx`
- **建议**: 
  - 可以考虑在首页为 seller 添加一个"我的商品"快捷入口
  - 或者在卖家入口提示中显示商品数量统计

**P2-2: 首页查询未关联商品信息**
- **问题**: 首页查询帖子时，没有关联查询 `affiliate_products` 表，无法在首页显示商品绑定信息
- **影响**: 如果帖子绑定了商品，首页无法显示商品信息
- **位置**: `src/app/[locale]/(main)/page.tsx` 第87-103行
- **建议**: 
  - 如果需要显示商品绑定信息，可以在查询时关联 `affiliate_posts` 和 `affiliate_products` 表
  - 但要注意性能影响，可能需要分页或限制查询数量

### 10.3 具体修复建议

#### 修复 P1-1: Seller/Affiliate 订阅类型混淆

**文件**: `src/app/[locale]/(main)/HomePageClient.tsx`

```typescript
// 修改前（第122-137行）
{isSeller && effectiveUser && (
  <div className="mb-6 rounded-lg border border-blue-200 bg-blue-50/50 p-4">
    <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
      <div>
        <h3 className="text-base font-semibold text-blue-900 dark:text-blue-100">卖家中心</h3>
        <p className="mt-1 text-sm text-blue-700 dark:text-blue-300">管理您的商品和订单</p>
      </div>
      <Link href="/seller/dashboard">
        <Button size="sm">进入卖家中心</Button>
      </Link>
    </div>
  </div>
)}

// 修改后：添加 affiliate 订阅检查
{isSeller && effectiveUser && (
  <div className="mb-6 rounded-lg border border-blue-200 bg-blue-50/50 p-4">
    <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
      <div>
        <h3 className="text-base font-semibold text-blue-900 dark:text-blue-100">卖家中心</h3>
        <p className="mt-1 text-sm text-blue-700 dark:text-blue-300">
          管理您的商品和订单
          {hasAffiliateSubscription && (
            <span className="ml-2 text-xs">• 可创建带货帖</span>
          )}
        </p>
      </div>
      <div className="flex gap-2">
        {hasAffiliateSubscription && (
          <Link href="/affiliate/products">
            <Button size="sm" variant="outline">创建带货帖</Button>
          </Link>
        )}
        <Link href="/seller/dashboard">
          <Button size="sm">进入卖家中心</Button>
        </Link>
      </div>
    </div>
  </div>
)}
```

**需要添加**: 在 Server Component 中查询 `affiliate` 订阅状态，并传递给 Client Component

#### 修复 P1-2: 首页缺少带货功能入口

**文件**: `src/app/[locale]/(main)/page.tsx`

```typescript
// 在查询 profile 时，同时查询 affiliate 订阅状态
if (validUser) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('status, subscription_type, role')
    .eq('id', validUser.id)
    .single()
  
  // 查询 affiliate 订阅
  const { data: affiliateSubscription } = await supabase
    .from('subscriptions')
    .select('id')
    .eq('user_id', validUser.id)
    .eq('subscription_type', 'affiliate')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .maybeSingle()
  
  subscriptionType = profile?.subscription_type || null
  hasAffiliateSubscription = !!affiliateSubscription
}
```

**然后传递给 Client Component**:
```typescript
<HomePageClient
  initialPosts={posts}
  initialError={error}
  user={validUser}
  subscriptionType={subscriptionType}
  hasAffiliateSubscription={hasAffiliateSubscription}  // 新增
  translations={{...}}
/>
```

### 10.4 总结

**系统整体表现**: ✅ **良好**

- ✅ 首页对 seller 用户友好，不会强制跳转
- ✅ 数据查询范围合理，性能良好
- ✅ 权限校验完善，安全性高
- ✅ RLS 策略严格，数据边界清晰
- ⚠️ 存在 seller/affiliate 订阅类型混淆，需要优化用户体验

**建议优先级**:
1. **P1-1**: 修复 seller/affiliate 订阅类型混淆（重要）
2. **P1-2**: 添加带货功能入口（重要）
3. **P2-1**: 优化 seller 商品展示（可选）
4. **P2-2**: 关联查询商品绑定信息（可选，需评估性能影响）

---

**报告完成时间**: 2026-01-25  
**推演执行者**: AI Assistant  
**报告版本**: v1.0
<｜tool▁calls▁begin｜><｜tool▁call▁begin｜>
read_file