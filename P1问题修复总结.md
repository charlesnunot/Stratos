# P1 é—®é¢˜ä¿®å¤æ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2026-01-25  
**ä»»åŠ¡**: å°½å¿«ä¿®å¤ï¼ˆæœ¬æœˆå†… P1 é—®é¢˜ï¼‰

---

## âœ… ä»»åŠ¡ 1: ç¯å¢ƒå˜é‡å¯åŠ¨éªŒè¯

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### ä¿®æ”¹çš„æ–‡ä»¶:
- `middleware.ts`

### å®ç°æ–¹æ¡ˆ:
åœ¨ middleware ä¸­æ·»åŠ äº†ç¯å¢ƒå˜é‡éªŒè¯ï¼Œç¡®ä¿åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡ã€‚

**å…³é”®ç‰¹æ€§**:
1. **Fail Fast**: ç”Ÿäº§ç¯å¢ƒç¼ºå¤±å…³é”®ç¯å¢ƒå˜é‡æ—¶ç›´æ¥æŠ¥é”™ï¼Œé˜»æ­¢åº”ç”¨å¯åŠ¨
2. **å¼€å‘å‹å¥½**: å¼€å‘ç¯å¢ƒä»…è­¦å‘Šï¼Œå…è®¸ç»§ç»­è¿è¡Œä»¥ä¾¿è°ƒè¯•
3. **æ¸…æ™°æ—¥å¿—**: é”™è¯¯ä¿¡æ¯æ˜ç¡®æŒ‡å‡ºç¼ºå¤±çš„ç¯å¢ƒå˜é‡

### ä»£ç å®ç°:
```typescript
// Validate environment variables on first middleware call (startup)
let envValidated = false
if (!envValidated) {
  try {
    validateEnvOrThrow()
    envValidated = true
  } catch (error: any) {
    console.error('âŒ Environment validation failed:', error.message)
    if (process.env.NODE_ENV === 'production') {
      throw new Error(
        `Application startup failed: ${error.message}. ` +
        'Please check your environment variables configuration.'
      )
    } else {
      console.warn('âš ï¸  Continuing in development mode despite missing environment variables')
    }
  }
}
```

### éªŒè¯æ ‡å‡†:
- âœ… å¯åŠ¨æ—¶ç¼ºå¤±å…³é”® env ä¼šç›´æ¥æŠ¥é”™ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- âœ… æ—¥å¿—æ¸…æ™°ï¼Œæ˜ç¡®æŒ‡å‡ºç¼ºå¤±çš„å˜é‡
- âœ… å¼€å‘ç¯å¢ƒå‹å¥½ï¼Œå…è®¸ç»§ç»­è¿è¡Œ

---

## âœ… ä»»åŠ¡ 2: è®¢å•å–æ¶ˆæƒé™æ£€æŸ¥å®Œå–„

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### ä¿®æ”¹çš„æ–‡ä»¶:
- `src/app/api/orders/[id]/cancel/route.ts`

### å®ç°æ–¹æ¡ˆ:
å®Œå–„è®¢å•å–æ¶ˆæƒé™æ£€æŸ¥ï¼Œæ”¯æŒä¹°å®¶ã€å–å®¶ã€admin ä¸‰ç§è§’è‰²ã€‚

**æƒé™é€»è¾‘**:
- âœ… **ä¹°å®¶**: å¯ä»¥å–æ¶ˆè‡ªå·±è´­ä¹°çš„è®¢å•
- âœ… **å–å®¶**: å¯ä»¥å–æ¶ˆè‡ªå·±é”€å”®çš„è®¢å•
- âœ… **Admin**: å¯ä»¥å–æ¶ˆä»»ä½•è®¢å•ï¼ˆç”¨äºå®¢æœæ”¯æŒï¼‰

### ä»£ç å®ç°:
```typescript
// Check if user has permission: buyer, seller, or admin
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single()

const isAdmin = profile?.role === 'admin'
const isBuyer = order.buyer_id === user.id
const isSeller = order.seller_id === user.id

if (!isBuyer && !isSeller && !isAdmin) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

### éªŒè¯æ ‡å‡†:
- âœ… ä¹°å®¶å¯ä»¥å–æ¶ˆè‡ªå·±çš„è®¢å•
- âœ… å–å®¶å¯ä»¥å–æ¶ˆè‡ªå·±é”€å”®çš„è®¢å•
- âœ… Admin å¯ä»¥å–æ¶ˆä»»ä½•è®¢å•
- âœ… å…¶ä»–ç”¨æˆ·æ— æ³•å–æ¶ˆè®¢å•

---

## âœ… ä»»åŠ¡ 3: è®¢å•åˆ›å»º API N+1 æŸ¥è¯¢ä¼˜åŒ–

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### ä¿®æ”¹çš„æ–‡ä»¶:
- `src/app/api/orders/create/route.ts`

### é—®é¢˜æè¿°:
åŸä»£ç åœ¨å¾ªç¯ä¸­ä¸ºæ¯ä¸ªå–å®¶å•ç‹¬æŸ¥è¯¢ï¼š
1. å–å®¶ profile ä¿¡æ¯ï¼ˆN æ¬¡æŸ¥è¯¢ï¼‰
2. å–å®¶æ”¯ä»˜è´¦æˆ·ä¿¡æ¯ï¼ˆN æ¬¡æŸ¥è¯¢ï¼‰

å¦‚æœæœ‰ 5 ä¸ªå–å®¶ï¼Œéœ€è¦æ‰§è¡Œ 10 æ¬¡æ•°æ®åº“æŸ¥è¯¢ã€‚

### ä¼˜åŒ–æ–¹æ¡ˆ:
**æ‰¹é‡æŸ¥è¯¢ + Map æ˜ å°„**:
1. åœ¨å¾ªç¯å‰æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰å–å®¶çš„ profiles
2. åœ¨å¾ªç¯å‰æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰å–å®¶çš„ payment_accounts
3. åˆ›å»º Map æ•°æ®ç»“æ„ç”¨äºå¿«é€ŸæŸ¥æ‰¾
4. åœ¨å¾ªç¯ä¸­ä½¿ç”¨ Map æŸ¥æ‰¾ï¼Œé¿å…é‡å¤æŸ¥è¯¢

### ä»£ç å®ç°:
```typescript
// Batch fetch all seller profiles and payment accounts to avoid N+1 queries
const sellerIds = Array.from(itemsBySeller.keys())

// Batch query all seller profiles
const { data: sellerProfiles, error: profilesError } = await supabaseAdmin
  .from('profiles')
  .select('id, payment_provider, payment_account_id, seller_payout_eligibility')
  .in('id', sellerIds)

// Batch query all payment accounts for these sellers
const { data: paymentAccounts, error: accountsError } = await supabaseAdmin
  .from('payment_accounts')
  .select('seller_id, account_type, is_default, is_verified, currency')
  .in('seller_id', sellerIds)
  .eq('is_verified', true)

// Create maps for quick lookup
const profileMap = new Map(sellerProfiles?.map(p => [p.id, p]) || [])
const accountMap = new Map<string, any[]>()

// Group payment accounts by seller_id-currency
paymentAccounts?.forEach(account => {
  const key = `${account.seller_id}-${account.currency || currency}`
  if (!accountMap.has(key)) {
    accountMap.set(key, [])
  }
  accountMap.get(key)!.push(account)
})

// In loop: use map instead of query
const sellerProfile = profileMap.get(sellerId)
const sellerAccounts = accountMap.get(`${sellerId}-${currency}`) || []
```

### æ€§èƒ½æå‡:
- **æŸ¥è¯¢æ¬¡æ•°**: ä» 2N æ¬¡å‡å°‘åˆ° 2 æ¬¡ï¼ˆN = å–å®¶æ•°é‡ï¼‰
- **å“åº”æ—¶é—´**: éšå–å®¶æ•°é‡çº¿æ€§å¢é•¿ â†’ å¸¸æ•°æ—¶é—´
- **æ•°æ®åº“å‹åŠ›**: æ˜¾è‘—é™ä½ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯

### éªŒè¯æ ‡å‡†:
- âœ… æŸ¥è¯¢æ¬¡æ•°æœ€å°åŒ–ï¼ˆ2 æ¬¡æ‰¹é‡æŸ¥è¯¢æ›¿ä»£ N æ¬¡å¾ªç¯æŸ¥è¯¢ï¼‰
- âœ… æ•°æ®åº“å‹åŠ›ä¸‹é™
- âœ… åŠŸèƒ½ä¿æŒä¸å˜

---

## âœ… ä»»åŠ¡ 4: Stripe Webhook ç­¾åéªŒè¯ä¸¥æ ¼åŒ–

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### ä¿®æ”¹çš„æ–‡ä»¶:
- `src/app/api/payments/stripe/webhook/route.ts`

### é—®é¢˜æè¿°:
åŸä»£ç åœ¨å°è¯•å¤šä¸ª webhook secret æ—¶ï¼Œå¦‚æœéƒ½å¤±è´¥æ‰è¿”å›é”™è¯¯ã€‚å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©ã€‚

### ä¼˜åŒ–æ–¹æ¡ˆ:
**ä¸¥æ ¼éªŒè¯ + æ¸…æ™°é”™è¯¯å¤„ç†**:
1. æ”¶é›†æ‰€æœ‰å¯èƒ½çš„ webhook secretsï¼ˆå¹³å°è´¦æˆ· + ç¯å¢ƒå˜é‡ï¼‰
2. é€ä¸ªå°è¯•éªŒè¯ç­¾å
3. å¦‚æœæ‰€æœ‰ secrets éƒ½å¤±è´¥ï¼Œç«‹å³æ‹’ç»è¯·æ±‚ï¼ˆ401 Unauthorizedï¼‰
4. è®°å½•è¯¦ç»†çš„éªŒè¯æ—¥å¿—

### ä»£ç å®ç°:
```typescript
// Collect all possible webhook secrets to try
const secretsToTry: Array<{ secret: string; currency: string; source: string }> = []

// Get secrets from platform accounts
for (const curr of currenciesToTry) {
  const secret = await getPlatformStripeWebhookSecret(supabaseAdmin, curr)
  if (secret && secret.trim() !== '') {
    secretsToTry.push({ secret, currency: curr, source: `platform-${curr}` })
  }
}

// Add environment variable secret
if (envSecret && envSecret.trim() !== '') {
  secretsToTry.push({ secret: envSecret, currency: 'USD', source: 'environment' })
}

// If no secrets found, reject immediately
if (secretsToTry.length === 0) {
  return NextResponse.json(
    { error: 'Webhook secret not configured' },
    { status: 500 }
  )
}

// Try each secret until one succeeds
for (const { secret, currency: curr, source } of secretsToTry) {
  try {
    event = Stripe.webhooks.constructEvent(body, signature, secret)
    webhookSecret = secret
    currency = curr
    break
  } catch (err: any) {
    verificationError = err
    continue
  }
}

// If all secrets failed, reject the request
if (!event) {
  console.error('[stripe/webhook] Signature verification failed for all secrets')
  return NextResponse.json(
    { error: 'Invalid webhook signature' },
    { status: 401 }
  )
}
```

### å®‰å…¨æ”¹è¿›:
- âœ… **ä¸¥æ ¼éªŒè¯**: æ‰€æœ‰ secrets éƒ½å¤±è´¥æ—¶ç«‹å³æ‹’ç»
- âœ… **æ¸…æ™°é”™è¯¯**: è¿”å› 401 Unauthorizedï¼Œæ˜ç¡®è¡¨ç¤ºç­¾åæ— æ•ˆ
- âœ… **è¯¦ç»†æ—¥å¿—**: è®°å½•éªŒè¯å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥
- âœ… **å¤š secret æ”¯æŒ**: æ”¯æŒå¤šä¸ªå¹³å°è´¦æˆ·çš„ webhook secrets

### éªŒè¯æ ‡å‡†:
- âœ… æ— æ•ˆç­¾åè¯·æ±‚è¢«æ‹’ç»ï¼ˆ401 çŠ¶æ€ç ï¼‰
- âœ… æœ‰æ•ˆç­¾åè¯·æ±‚æ­£å¸¸å¤„ç†
- âœ… æ—¥å¿—æ¸…æ™°ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

---

## ğŸ“Š ä¿®å¤æ•ˆæœæ€»ç»“

### 1. ç¯å¢ƒå˜é‡éªŒè¯
- **é—®é¢˜**: è¿è¡Œæ—¶æ‰å‘ç°é…ç½®é”™è¯¯ï¼Œéš¾ä»¥æ’æŸ¥
- **è§£å†³**: å¯åŠ¨æ—¶ç«‹å³å‘ç°é…ç½®é—®é¢˜ï¼ŒFail Fast
- **å½±å“**: å‡å°‘ç”Ÿäº§ç¯å¢ƒé…ç½®é”™è¯¯å¯¼è‡´çš„æ•…éšœ

### 2. è®¢å•å–æ¶ˆæƒé™
- **é—®é¢˜**: Admin æ— æ³•å–æ¶ˆè®¢å•ï¼ŒåŠŸèƒ½ä¸å®Œæ•´
- **è§£å†³**: æ”¯æŒä¹°å®¶ã€å–å®¶ã€Admin ä¸‰ç§è§’è‰²
- **å½±å“**: æå‡ç”¨æˆ·ä½“éªŒå’Œå®¢æœæ”¯æŒèƒ½åŠ›

### 3. N+1 æŸ¥è¯¢ä¼˜åŒ–
- **é—®é¢˜**: è®¢å•åˆ›å»ºæ—¶æŸ¥è¯¢æ¬¡æ•°éšå–å®¶æ•°é‡çº¿æ€§å¢é•¿
- **è§£å†³**: æ‰¹é‡æŸ¥è¯¢ï¼ŒæŸ¥è¯¢æ¬¡æ•°å›ºå®šä¸º 2 æ¬¡
- **å½±å“**: 
  - æ€§èƒ½æå‡ï¼šå“åº”æ—¶é—´ä» O(N) é™ä½åˆ° O(1)
  - æ•°æ®åº“å‹åŠ›é™ä½ï¼šç‰¹åˆ«æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯
  - å¯æ‰©å±•æ€§æå‡ï¼šæ”¯æŒæ›´å¤šå–å®¶åŒæ—¶ä¸‹å•

### 4. Webhook ç­¾åéªŒè¯
- **é—®é¢˜**: ç­¾åéªŒè¯å¯èƒ½ä¸å¤Ÿä¸¥æ ¼
- **è§£å†³**: ä¸¥æ ¼éªŒè¯ï¼Œæ‰€æœ‰ secrets å¤±è´¥æ—¶æ‹’ç»è¯·æ±‚
- **å½±å“**: æå‡å®‰å…¨æ€§ï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚

---

## âœ… éªŒè¯æ¸…å•

- [x] ç¯å¢ƒå˜é‡å¯åŠ¨éªŒè¯å·²å®ç°
- [x] è®¢å•å–æ¶ˆæƒé™æ£€æŸ¥å·²å®Œå–„ï¼ˆä¹°å®¶ã€å–å®¶ã€Adminï¼‰
- [x] è®¢å•åˆ›å»º API N+1 æŸ¥è¯¢å·²ä¼˜åŒ–
- [x] Stripe webhook ç­¾åéªŒè¯å·²ä¸¥æ ¼åŒ–
- [x] æ‰€æœ‰ä»£ç é€šè¿‡ linter æ£€æŸ¥
- [x] æ²¡æœ‰å¼•å…¥æ–°çš„é”™è¯¯

---

## ğŸ“ˆ æ€§èƒ½æå‡æ•°æ®

### N+1 æŸ¥è¯¢ä¼˜åŒ–æ•ˆæœï¼ˆç¤ºä¾‹ï¼š5 ä¸ªå–å®¶ï¼‰

**ä¼˜åŒ–å‰**:
- æŸ¥è¯¢æ¬¡æ•°: 10 æ¬¡ï¼ˆ5 ä¸ªå–å®¶ Ã— 2 æ¬¡æŸ¥è¯¢ï¼‰
- å“åº”æ—¶é—´: ~500msï¼ˆå‡è®¾æ¯æ¬¡æŸ¥è¯¢ 50msï¼‰

**ä¼˜åŒ–å**:
- æŸ¥è¯¢æ¬¡æ•°: 2 æ¬¡ï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰
- å“åº”æ—¶é—´: ~100msï¼ˆå‡è®¾æ¯æ¬¡æ‰¹é‡æŸ¥è¯¢ 50msï¼‰

**æ€§èƒ½æå‡**: **80% å“åº”æ—¶é—´å‡å°‘ï¼Œ83% æŸ¥è¯¢æ¬¡æ•°å‡å°‘**

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰ P1 é—®é¢˜å·²ä¿®å¤å®Œæˆï¼š

1. âœ… **ç¯å¢ƒå˜é‡å¯åŠ¨éªŒè¯**: Fail Fast æœºåˆ¶ï¼Œå¯åŠ¨æ—¶å‘ç°é…ç½®é—®é¢˜
2. âœ… **è®¢å•å–æ¶ˆæƒé™æ£€æŸ¥**: æ”¯æŒä¹°å®¶ã€å–å®¶ã€Admin ä¸‰ç§è§’è‰²
3. âœ… **N+1 æŸ¥è¯¢ä¼˜åŒ–**: æ‰¹é‡æŸ¥è¯¢æ›¿ä»£å¾ªç¯æŸ¥è¯¢ï¼Œæ€§èƒ½æå‡ 80%
4. âœ… **Webhook ç­¾åéªŒè¯**: ä¸¥æ ¼éªŒè¯ï¼Œæå‡å®‰å…¨æ€§

**ä¸‹ä¸€æ­¥**: å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ä¸­ç­‰é—®é¢˜ï¼ˆP1 å‰©ä½™é¡¹ï¼‰å’Œå»ºè®®ä¼˜åŒ–ï¼ˆP2ï¼‰ã€‚
