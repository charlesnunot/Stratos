# 真实用户行为推演：未登录用户首次访问首页

**用户状态**：未登录（无 session / 无 Supabase auth）、首次访问、无本地缓存  
**行为**：浏览器直接访问 `/` 首页

---

## Step 1. Next.js 路由与中间件

### 是否经过 `middleware.ts`

**是。** 根目录 `middleware.ts` 的 `config.matcher` 会匹配几乎所有路径（排除 `_next/static`、`_next/image`、`favicon.ico`、常见图片扩展名）。访问 `/` 会被匹配，因此**一定经过** middleware。

### Auth / Locale / Redirect 逻辑

1. **`updateSession`（Supabase）**  
   - 使用 `createServerClient` + `NEXT_PUBLIC_SUPABASE_ANON_KEY`，通过 cookie 读写维护会话。  
   - 仅调用 `await supabase.auth.getUser()` 刷新服务端会话，**不做任何重定向**。  
   - 未登录时无有效 session，`getUser()` 正常返回 null，不抛错。

2. **`intlMiddleware`（next-intl）**  
   - `createIntlMiddleware(routing)`，`routing` 使用 `localePrefix: 'always'`、`defaultLocale: 'en'`。  
   - 根据 next-intl 行为：请求 `/` 时根据 `accept-language` / cookie 检测 locale，并 **307 重定向** 到带 locale 的路径，如 `/en`（首次无 cookie 时通常为 `defaultLocale`）。

3. **根 `app/page.tsx`**  
   - `redirect(\`/${defaultLocale}\`)`，即重定向到 `/en`。  
   - 若 middleware 先对 `/` 做了重定向，则请求不会落到根 page；若因 matcher 等原因未走 middleware，根 page 仍会兜底重定向到 `/en`。

### 未登录用户是否会被错误重定向

**不会。**  
- `updateSession` 不区分登录态，不重定向。  
- next-intl 只做 locale 重定向，与 auth 无关。  
- 最终未登录用户会到达 **`/en`**（或检测到的其他 locale），对应 `[locale]/(main)/page.tsx` 首页，**不会被误重定向到登录页**。

### 代码依据

```29:36:c:\Users\admin\Desktop\Stratos\middleware.ts
const intlMiddleware = createIntlMiddleware(routing)

export async function middleware(request: NextRequest) {
  // 先更新 Supabase 会话
  const response = await updateSession(request)
  
  // 然后应用国际化中间件
  return intlMiddleware(request)
```

```4:6:c:\Users\admin\Desktop\Stratos\src\app\page.tsx
export default function RootPage() {
  redirect(`/${defaultLocale}`)
}
```

---

## Step 2. 首页 Server Component

### 首页 `page.tsx` 与数据获取

首页实为 **`src/app/[locale]/(main)/page.tsx`**（如 `/en` → `[locale]=en`）。  
该 page 为 **Server Component**，在服务端直接拉取数据。

### 使用的 Supabase Client

- **`createClient`** 来自 `@/lib/supabase/server`。  
- 使用 **`NEXT_PUBLIC_SUPABASE_URL` + `NEXT_PUBLIC_SUPABASE_ANON_KEY`**（即 **anon**），不是 service role。

### 是否假设用户一定存在

**否。**  
- 显式调用 `const { data: { user } } = await supabase.auth.getUser()`，未登录时为 `user === null`。  
- 将 `user={user}` 传给 `HomePageClient`，类型为 `{ id: string } | null`，**允许 null**。  
-  catch 中同样传 `user={null}`，没有 `user!` / `session!` 等非空断言。

### 代码依据

```10:40:c:\Users\admin\Desktop\Stratos\src\app\[locale]\(main)\page.tsx
export default async function HomePage() {
  try {
    const supabase = await createClient()
    // ...
    const { data: postsData, error } = await supabase
      .from('posts')
      // ...
    // Get current user for conditional rendering
    const { data: { user } } = await supabase.auth.getUser()
    // ...
    return (
      <HomePageClient
        initialPosts={posts}
        initialError={error}
        user={user}
        // ...
      />
    )
```

---

## Step 3. 数据获取逻辑

### 查询了哪些表

- **`posts`**：  
  `*`，且  
  - `user: profiles!posts_user_id_fkey (username, display_name, avatar_url)`  
  - `topics: post_topics (topic: topics (id, name, slug))`  
- 条件：`status = 'approved'`，`order by created_at desc`，`limit 20`。

即：**posts** + **profiles**（通过 FK inner join）+ **post_topics** + **topics**。

### 是否依赖 `auth.uid()`

- **读数据**：不依赖。查询仅按 `status = 'approved'` 过滤，未在 SQL 里使用 `auth.uid()`。  
- **RLS**：见下。

### RLS 在未登录状态下是否允许读取

- **`posts`**  
  - Policy：`Users can view approved posts`  
  - `USING`: `(status = 'approved') OR (user_id = auth.uid()) OR (admin/support)`  
  - 未登录时 `auth.uid()` 为 null，后两项恒 false，仅 **`status = 'approved'`** 生效 → **anon 可读** 已审核帖子。

- **`profiles`**  
  - `Users can view all profiles`，`USING (true)` → **anon 可读**。

- **`topics`**  
  - `Users can view all topics`，`USING (true)` → **anon 可读**。

- **`post_topics`**  
  - `Anyone can view post topics`，`USING (true)` → **anon 可读**。

因此，**未登录用户可正常读取首页所需的所有表**。

### 是否存在隐式 inner join 导致数据为空

- `profiles!posts_user_id_fkey` 为 **inner join**。  
- 若某条 `posts` 的 `user_id` 在 `profiles` 中不存在（脏数据），该 post 会被 **排除**，不会报错，但**该条不会出现在结果中**。  
- 正常数据下无问题；仅有孤儿 `user_id` 时为边界情况，一般可忽略。

### 代码依据

- `006_fix_rls_permissions.sql`：posts / profiles / topics 的 SELECT policies。  
- `078_add_post_topics_rls_policies.sql`：post_topics 的 view policy。  
- `page.tsx` 中的 `supabase.from('posts').select(...)`。

---

## Step 4. Client Component Hydration

### 是否把 user 相关数据传入 Client Component

**是。**  
`HomePageClient` 接收 `user: { id: string } | null`（以及 `initialPosts`、`initialError`、`translations`）。未登录时 `user === null`。

### 是否存在 `user!`、`session!` 等非空断言

**首页相关流程中不存在。**  
- `HomePageClient`、`PostCard`、`LikeButton`、`FavoriteButton`、`CommentSection`（帖子列表 / 详情）等均用 `user` 做条件判断或 `disabled={!user}`，**无** `user!` / `session!`。  
- 仅在 **`support/tickets/[id]/TicketDetailClient`**、**`seller/affiliate-settings`** 等与首页无关的页面使用了 `user!`，不参与本次推演。

### Hydration 阶段是否可能报错

**不会。**  
- 服务端传 `user={null}`，客户端 `useAuth()` 初始 `loading: true`，随后 `user: null`，与 props 一致。  
- `HomePageClient` 用 `user` 做条件渲染（如 `user ? ... : ...`）、`usePosts` 的 `enabled: !authLoading`，无在 null 上解构或非空断言，**不会因 user 为 null 在 hydration 时报错**。

### 代码依据

```17:20:c:\Users\admin\Desktop\Stratos\src\app\[locale]\(main)\HomePageClient.tsx
interface HomePageClientProps {
  initialPosts: Post[]
  initialError: any
  user: { id: string } | null
```

```68:79:c:\Users\admin\Desktop\Stratos\src\app\[locale]\(main)\HomePageClient.tsx
  // 显示认证加载状态
  if (authLoading) {
    return (
      // ...skeleton
    )
  }
  // ...
  {user ? translations.noContentMessage : (
    <Link href="/register">...</Link>
  )}
```

---

## Step 5. 页面交互能力

### 未登录用户可以执行的操作

| 操作 | 前端保护 | 后端 / RLS 保护 | 说明 |
|------|----------|------------------|------|
| **浏览帖子列表** | - | RLS 允许 anon 读 approved posts | ✅ 允许 |
| **点击帖子进详情** | - | 同上 | ✅ 允许 |
| **查看评论** | - | `comments` 仅 `status = 'approved'` 对 anon 可见 | ✅ 允许 |
| **点赞** | `disabled={!user}`；`handleLike` 内 `if (!user) return` | `likes` INSERT/DELETE 需 `auth.uid() = user_id` | ✅ 双重保护，未登录不可点赞 |
| **收藏** | `disabled={!user}`；`handleFavorite` 内 `if (!user) return` | `favorites` 仅本人可 INSERT/DELETE | ✅ 双重保护 |
| **评论** | 评论表单 `{user && (...)}`，未登录显示「请登录后发表评论」 | `addCommentMutation` 中 `if (!user) throw`；RLS INSERT 需 `auth.uid() = user_id` | ✅ 双重保护 |
| **举报** | `if (!user) { showInfo('请先登录...'); return }` | 未单独验证；依赖前端 + 举报 API 若存在则需自检 | ⚠️ 仅前端拦截，未点到举报即不会触发 |
| **转发** | 按钮 `{user && (...)}` 且 `handleRepost` 内 `if (!user) return` | 转发逻辑未在本次推演深挖，通常涉及 writes | ✅ 前端已保护 |
| **打赏** | `TipButton` 内 `if (!user) return null`，不渲染 | - | ✅ 不暴露入口 |
| **复制链接** | 允许 | 写 `shares` 时 `if (user && supabase)`，未登录不写 | ✅ 复制可做，分享统计不记 |

### 总结

- **点赞、收藏、评论**：前端禁用 / 不展示 + 后端 RLS 或 mutation 校验，**双重保护**。  
- **举报、转发**：至少前端明确拦截；举报若后有独立 API，建议再加服务端校验。  
- 未登录用户**可以**浏览列表、详情、评论；**不可以**点赞、收藏、评论、打赏；转发入口不展示。

---

## Step 6. 异常与边界情况

### Supabase 请求失败

- **服务端**：`HomePage` 有 `try/catch`。失败时返回 `HomePageClient` 且 `initialPosts={[]}`、`initialError={error}`、`user=null`。  
- **客户端**：`displayError = initialError || error`；当 `displayError` 且无数据时展示 `RetryableError`，`onRetry` 会 `invalidateQueries(['posts', 'approved'])` 触发重新请求。  
- **结论**：有降级与重试，不会白屏或未处理异常。

### 网络中断

- 首屏数据在服务端已拉取，HTML 照常返回；**首屏可显示**。  
- 客户端 `usePosts` 的 refetch、加载更多等依赖网络；中断时 React Query 会 `isError`，由各 UI 处理。首页 `RetryableError` 支持重试。  
- **结论**：首屏不依赖客户端网络；后续拉取失败有重试路径。

### JS 关闭

- 服务端仍渲染 `HomePageClient`，且传入 `initialPosts`。但 `HomePageClient` 为 **client component**，其内容依赖 React 与 useAuth/usePosts 等 **客户端** 逻辑。  
- JS 关闭时，**Client Component 不 hydrate**，通常仅渲染占位或外层壳，**列表、加载更多、点赞等交互均不可用**。  
- **结论**：无 JS 时，未登录用户**看不到**完整首页内容与交互；若需 SEO/无 JS 可用，需对首屏做 Server Component 直出或静态 HTML。

### 搜索引擎爬虫访问

- 爬虫请求 `/` → middleware 重定向到 `/en`（或相应 locale）→ `[locale]/(main)/page` 服务端执行。  
- 服务端拉取 posts 并渲染 `HomePageClient`，把 `initialPosts` 等注入 HTML。  
- 根 layout 有 `metadata`（title、description 等），可被爬取。  
- **结论**：首屏内容由服务端渲染并输出 HTML，爬虫**可以**抓取到标题、描述和首屏帖子结构；但列表详情依赖 Client Component 的 DOM，实际可索引程度取决于 Next 的 SSR 输出。若 `(main)/page` 完全依赖 client 渲染列表，爬虫看到的可能有限，需以实际 HTML 输出为准。

---

## Step 7. 结论

### 问题列表

#### P0（必须修复）

**无。**  
在「未登录 + 首次访问 + 直接访问 `/`」的前提下，当前实现**不会**导致白屏、误重定向、hydration 报错或未登录用户执行写操作（点赞/收藏/评论等）。

---

#### P1（应尽快修复）

**1. Middleware matcher 包含 `/api`，intl 可能影响 API 路由**

- **触发条件**：任意请求匹配到 middleware（含 `/api/*`）。当前 matcher 仅排除 `_next/static`、`_next/image`、`favicon.ico`、图片等，**未排除 `api`**。  
- **后果**：next-intl 的 `intlMiddleware` 会对匹配请求做 locale 重写/重定向。若对 `/api/*` 也做处理，可能导致 API 路由被错误重写、重定向或注入 locale，进而影响支付回调、webhook、cron 等。  
- **修复建议**：  
  - 在 `middleware` 的 `config.matcher` 中**排除 `api`**（以及如需 `trpc`、`_vercel` 等），与 [next-intl 官方示例](https://next-intl.dev/docs/routing/middleware) 一致。  
  - **已修复**：`middleware.ts` 的 matcher 已增加 `api` 排除，`/api/*` 不再经过 intl middleware。`/auth/callback` 等非 `/api` 路由仍经 middleware，`updateSession` 照常生效。

---

#### P2（建议修复 / 优化）

**2. 环境变量校验在 middleware 中 `throw` 导致生产环境整站不可用**

- **触发条件**：`validateEnvOrThrow()` 在 middleware 内、且 `NODE_ENV === 'production'` 时，若缺少必选变量（如 `NEXT_PUBLIC_SUPABASE_URL`、`ANON_KEY`、`SERVICE_ROLE_KEY`），直接 `throw new Error(...)`。  
- **后果**：middleware 在任意匹配请求上都会执行；一旦 throw，**所有**经过 middleware 的请求（含首页）均失败，表现为 500 或网关错误，整站不可访问。  
- **修复建议**：  
  - 环境校验改为 **启动时** 在 `instrumentation`、`next.config` 的 `env` 校验、或单独 bootstrap 脚本中执行；  
  - 或在 middleware 中 **仅 `console.error` + 返回 503**，避免 `throw` 导致全局失败；  
  - 同时确保必选 env 在部署流程中强制校验，而不是依赖首请求时的 middleware。

**3. 无 JS 时首屏内容与交互不可用**

- **触发条件**：用户禁用 JavaScript 或部分环境无法执行 JS。  
- **后果**：首页主体为 Client Component，依赖 `useAuth`、`usePosts` 等；无 JS 时无法 hydrate，用户看不到帖子列表与交互。  
- **修复建议**：  
  - 若需支持无 JS 或更强 SEO，可将首屏帖子列表改为 **Server Component 直出**（例如在 `page.tsx` 直接渲染列表结构）， Client 仅负责「加载更多」、点赞等增强交互；  
  - 或至少保证首屏关键信息（标题、首屏几条帖子）在服务端输出为纯 HTML，减少对 Client 的依赖。

**4. 根 `app/page.tsx` 重定向与 next-intl 可能的重复**

- **触发条件**：请求 `/` 时，若 next-intl 未重定向（如 matcher 未匹配），会落到 `app/page.tsx`。  
- **后果**：当前两者都会重定向到 `/${defaultLocale}`，逻辑重复；若日后 matcher 改动，可能出现一方生效另一方不生效的不一致。  
- **修复建议**：  
  - 以 **middleware 的 locale 重定向** 为准，根 `page.tsx` 可考虑改为 `notFound()` 或简单提示「请使用带 locale 的路径」，避免重复 redirect；  
  - 或明确文档化「根 `/` 仅由 middleware 处理」，并通过测试保证 matcher 始终覆盖 `/`。

---

### 修复优先级小结

| 优先级 | 问题 | 触发条件 | 建议动作 |
|--------|------|----------|----------|
| **P0** | 无 | - | - |
| **P1** | API 被 middleware matcher 包含，intl 可能影响 /api | 所有 /api 请求 | 从 matcher 排除 `api`，必要时对 /api 只做 updateSession |
| **P2** | 环境校验在 middleware 中 throw | 生产缺 env | 改为启动时校验或 503，勿 throw |
| **P2** | 无 JS 时首屏不可用 | JS 关闭 | 首屏 Server 直出或保证关键 HTML 服务端渲染 |
| **P2** | 根 page 与 intl 重定向重复 | 访问 / | 统一由 middleware 处理 /，根 page 简化或移除 redirect |

---

### 未登录用户访问 `/` 的端到端流程摘要

1. 请求 `/` → 经过 **middleware**（`updateSession` → `intlMiddleware`）。  
2. **next-intl** 将 `/` 重定向到 `/en`（或检测到的 locale）。  
3. 命中 **`[locale]/(main)/page`**，Server Component 用 **anon** Supabase client 查 `posts`（含 profiles、topics）。  
4. **RLS** 允许 anon 读 `approved` 帖子及关联表；未登录时 `user === null`，正常传下去。  
5. **HomePageClient** 收 `user={null}`、`initialPosts`、`initialError`；`useAuth` 落地后 `user` 为 null，**无 `user!`**，不触发 hydration 错误。  
6. 未登录用户可**浏览**列表与详情、看评论；**点赞 / 收藏 / 评论 / 打赏 / 转发** 均被前端禁用或隐藏，且后端有 RLS 或 mutation 校验。  
7. Supabase 失败时有 **try/catch + RetryableError**；网络中断时首屏仍由服务端提供；**无 JS** 时首屏依赖 Client Component，体验降级；爬虫可抓取到服务端渲染出的首页相关 HTML。

以上推演均基于当前仓库代码与迁移，无假设性修改。
