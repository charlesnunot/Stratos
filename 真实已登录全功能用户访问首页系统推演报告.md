# 真实已登录全功能用户访问首页 /en 系统推演报告

## 用户身份（严格模拟）

- ✅ 已注册、已登录，Supabase session 有效  
- ✅ `profiles.role = 'seller'`  
- ✅ `subscription.status = 'active'`（seller 订阅）  
- ✅ `profiles.tip_enabled = true`，且有有效 tip 订阅（打赏）  
- ✅ `user_features` 未在代码中使用；实际以 `profiles.tip_enabled` + `subscriptions` 表为准  
- ✅ 已绑定可用支付方式，非 admin  

---

## Step 1：middleware.ts 推演

### 流程

1. 请求进入 `middleware` → 先 `updateSession(request)`，再 `intlMiddleware(request)`。  
2. `updateSession`：`createServerClient` 用请求 cookie → `getUser()` 刷新/校验 session。  
3. 若 `user` 存在：查 `profiles`（`status, subscription_type, role, tip_enabled`）。  
4. `status in ('banned','suspended')` → 重定向到 `/xx/banned`（仅 `en|zh` 保留 locale）。  
5. 若 `subscription_type === 'tip'` 且 `tip_enabled`：再查 `subscriptions` 校验 tip 是否有效，仅打 log，不阻断请求。  
6. `intlMiddleware` 处理 locale，`/en` 匹配 matcher，正常解析。

### 检查点结论

| 检查项 | 结论 |
|--------|------|
| Session 是否被正确识别 | ✅ 是。`updateSession` 用 cookie 调 `getUser()`，session 由 middleware 刷新。 |
| `/en` 是否影响 auth | ✅ 否。locale 仅 intl 处理，auth 与 path 无关。 |
| Subscription 是否被读取 | ⚠️ 仅 tip：在 `subscription_type=tip` 且 `tip_enabled` 时多查一次 `subscriptions`，用于打 log，不写入“上下文”。 |
| tips_enabled / seller_enabled 是否进入上下文 | ❌ 否。middleware 不传 subscription/feature 给后续；这些只在各页 Server/Client 里查。 |
| 已登录但被当成未登录 | ⚠️ 理论存在。Server 用 `getUser()`，Client 用 `getSession()`；middleware 刷新失败或时序差异时，短暂不一致可能，但非常见路径。 |
| Session 丢失/重建 | ⚠️ 刷新失败会登出；逻辑在 `updateSession`，无单独“重建”分支。 |
| Middleware 多余 DB 查询 | ⚠️ 有。每个已登录请求：1 次 `profiles`；若为 tip 用户再 1 次 `subscriptions`。仅为 banned Redirect + tip 一致性 log，未用于权限判断。 |

**结论**：Session 识别正常，locale 不影响 auth。Subscription/feature 不做全局上下文，不导致“看到不该看的”；多查 1～2 次 DB 属 P2 级优化点。

---

## Step 2：首页路由解析（/en → page.tsx）

### 路由与差异化

- 路径：`[locale]/(main)/page.tsx`，`/en` → `locale=en` 的首页。  
- `(main)/layout`：Sidebar + TopBar + `children`，无 admin 守卫；非 admin 可访问首页。

### 差异化逻辑（page 内）

- `validUser`：有则拉 profile、subscriptions，算 `tipEnabled` / `sellerEnabled` / `affiliateEnabled`；无则全 false。  
- `tipEnabled`：`profile.tip_enabled` **且** 存在有效 tip 订阅（`subscriptions` 表，active、未过期）。  
- `sellerEnabled`：仅查 **subscriptions**（seller、active、未过期），**不**用 `profile.role`。  
- `affiliateEnabled`：仅 subscriptions（affiliate、active、未过期）。  
- 有 `validUser` 时还会查 `follows` 做“关注用户帖子优先”的个性化；再根据结果决定是“关注+热门”混合，还是默认时间线。

### 冲突与隐患

- `tip`：同时看 profile 与 subscriptions，逻辑一致。  
- `seller`：首页只看 **subscriptions**；Sidebar / useSellerGuard 用 **profile.subscription_type**。若 cron 未及时同步（如订阅刚过期），两边可能不一致。  
- **关注流**：依赖 `follows` 的 `following_id`；**表中实际列为 `followee_id`**。Supabase 返回 `{ data: null, error }` 不 throw，页面未检查 `error`，故 `followingIds` 恒为 `[]`，**已登录用户的「关注优先」个性化流永远不生效**，始终走默认时间线（见 Step 4）。

**结论**：首页按用户身份差异化渲染，但 **follows 列名错误** 会直接破坏已登录用户的首页加载，属 P0。

---

## Step 3：Server Component 数据推演

### 实际读取

- `profiles`：`status, subscription_type, role, tip_enabled`。  
- `subscriptions`：按 tip/seller/affiliate 各查一次（`status = 'active'` 且 `expires_at > now()`）。  
- **未**读 `user_features`；tips/seller 以 profile + subscriptions 为准。

### 权限与展示

- **打赏横幅**：`tipEnabled`（profile + 有效 tip 订阅）→ 传给 `HomePageClient`，仅 `effectiveTipEnabled && effectiveUser` 时展示。  
- **卖家横幅**：`sellerEnabled`（仅 subscriptions）→ `isSeller && effectiveUser` 时展示，含“进入卖家中心”等。  
- **带货横幅**：`affiliateEnabled` → `isAffiliate && effectiveUser` 时展示。  
- 帖子列表：`approved` + 若有 follows 则个性化（因 follows 报错，当前实际会 fallback 到 catch）。

### 风险点

- ✅ 打赏/卖家/带货 **是否展示** 均由 Server 算好再传给 Client，不单靠 Client 开关。  
- ⚠️ **卖家**：展示依据是 **subscriptions**；Sidebar / 卖家路由 依据 **profile.subscription_type**。若 profile 未同步，会出现“首页不展示卖家横幅，但侧边栏仍有卖家入口且可进 dashboard”的情况。  
- ❌ 关注流依赖的错误 `following_id` 查询；返回 `error` 未检查 → `followingIds` 恒为 `[]`，**关注优先流永远不生效**（P1）。

**结论**：打赏/带货的展示与数据源一致；卖家存在 **subscriptions vs profile** 的跨模块不一致；follows 列名错误导致 **关注流永不生效**，属 P1。

---

## Step 4：首页数据查询链路

### 帖子列表

- 基础：`posts` + `user` + `topics` + `affiliate_posts` → `products`，`status = 'approved'`。  
- 若 `validUser`：先查 `follows`（**误用 `following_id`**）→ 返回 `{ data: null, error }`，页面未检查 `error` → `followingIds = []` → 跳过关注流分支，**始终走默认 `created_at desc`**；即关注优先流永远不生效。

### 其他查询

- **affiliate 商品**：`products` 中 `allow_affiliate`、`status = 'active'`，limit 10；仅 `affiliateEnabled` 时查。  
- **卖家自有商品**：`products` 中 `seller_id = user.id`、`status = 'active'`，limit 5；仅 `sellerEnabled` 时查。

### 越权与多余

- 帖子、商品均按 **当前用户权限** 过滤；未发现越权拉取 seller-only 等数据。  
- **问题**：  
  1. **follows 列名**：`following_id` 不存在 → 查询失败被忽略，`followingIds` 恒为 `[]` → **已登录用户关注优先流永远不生效**，P1。  
  2. **usePosts**（Client）：`fetchPosts` 不包含 `affiliate_posts`；“加载更多”与首屏 server 结构不一致，属 P2。  
  3. 多处相似 `posts` 查询（关注流、热门、默认），可视为 N+1/重复查询，P2 优化。

**结论**：无越权；**follows 列名错误导致关注流永不生效**（P1）；“加载更多”与首屏结构不一致为 P2。

---

## Step 5：Client Component 行为推演

### HomePageClient

- 用 `initialUser` / `initialTipEnabled` / `initialSellerEnabled` / `initialAffiliateEnabled` 等做 **hydration 一致**（auth 未就绪时用 server 值）。  
- `usePosts('approved', { enabled, initialData })`：**`usePosts` 未使用 `initialData`**，仅用 `enabled`。  
- 展示逻辑：`data?.pages.flatMap(...) || initialPosts`。  
  - 无 `initialData` 时，先显 `initialPosts`，再 fetch；fetch 完成后替换为 **client 拉取的列表**（无 `affiliate_posts`）。  
  - 导致：首屏 server 数据被 client 结果覆盖，可能闪烁；且 **server 首屏 fetch 未通过 initialData 复用**，属浪费与体验问题。

### 帖子卡片与按钮

- **PostCard**：首页只有点赞、评论、收藏、分享、更多菜单；**无 TipButton**，无 per-post 带货商品。  
- 打赏入口：仅 **顶部打赏横幅**（`effectiveTipEnabled`）；详情页才有 TipButton。  
- 卖家入口：**顶部卖家横幅** + **Sidebar**“卖家中心”等；均受 `isSeller` / `sellerEnabled` 控制。

### 加载与错误

- 错误时用 `RetryableError`，有重试；空列表有文案。  
- “加载更多”用 `usePosts` 的 `fetchNextPage`；**加载更多**的帖子无 `affiliate_posts`，与首屏 shape 不同，若未来卡片展示商品会不一致。

### Hydration

- `effectiveUser`、`effectiveSubscriptionType` 等以 server props 为主，减轻 hydration 差异。  
- 但 **帖子列表** 会从 `initialPosts` 切到 `usePosts` 的 `data`，且 `usePosts` 未接 `initialData`，存在 **列表数据** 的 hydration / 闪烁风险。

**结论**：UI 与权限一致；**initialData 未用 + 列表被覆盖** 为 P1；**加载更多** 与首屏结构不一致为 P2。

---

## Step 6：API 调用审计（首页相关）

### 实际发生的请求

- **首页本身**：无 Next.js `fetch('/api/...')`。  
- 所有数据：**Supabase client**（`usePosts`、`useAuth`、`useProfile`、`OnboardingGuide`、`PostCard` 内 like/favorite/share 等）。

### 权限与校验

- 帖子：RLS “Users can view approved posts from active users”，已读过滤。  
- likes/favorites/shares：各自 RLS，按 `user_id` 等校验。  
- **打赏**：仅详情页 TipButton → `POST /api/payments/stripe/create-tip-session`；该 API 会 **校验 session + checkTipEnabled + 有效 tip 订阅**，无订阅则 403。  
- **卖家**：首页仅 Link 到 `/seller/*`；dashboard 用 `useSellerGuard`（**仅查 `profile.subscription_type === 'seller'`**），**不**查 subscriptions 是否过期。

### 越权与误用

- 首页 **不** 调用 seller 专用 API；**不** 存在“普通用户直接调 seller API”的路径。  
- 打赏 API 已做 **订阅 + 有效期内** 校验，无“未订阅用户成功打赏”的 P0。

**结论**：首页无越权 API 调用；打赏 API 校验完整；**卖家 dashboard 仅靠 `profile.subscription_type`，未校验订阅是否过期**，属 P1（与 Step 2/3 一致）。

---

## Step 7：边界与异常推演

| 场景 | 行为 | 风险 |
|------|------|------|
| **Subscription 过期** | 首页 `sellerEnabled`/`tipEnabled` 依 **subscriptions** → 不展示对应横幅。Sidebar、useSellerGuard 仍用 **profile.subscription_type** → 卖家入口可现、可进 dashboard。 | P1：过期卖家仍可进卖家中心。 |
| **打赏关闭** | `tipEnabled` false → 无打赏横幅。详情页 TipButton 依 profile + 订阅 → 禁用或引导订阅；API 403。 | ✅ 无 P0。 |
| **seller_enabled = false** | 代码未用该字段；实际看 **subscriptions**。无 seller 订阅 → 无卖家横幅、无 seller 数据。 | ✅ 无 P0。 |
| **Session 过期** | `onAuthStateChange` 可提示“登录已过期”；首页无强制 redirect。用户可能继续看缓存的 UI 直到操作触发 401。 | ⚠️ 体验优化，非权限漏洞。 |
| **API 401/403/500** | 首页无直接 `/api` 调用；`usePosts` 等 Supabase 失败 → `RetryableError`。 | ✅ 有降级与重试。 |
| **Follows 列名错误** | 查询返回 `{ data: null, error }` 未检查 → `followingIds` 恒为 `[]`，**关注优先流永远不生效**；不崩溃。 | **P1**：已登录用户无法获得关注流。 |

**结论**：**follows 列名错误** 导致已登录用户 **关注流永不生效**（P1）；**过期卖家仍可进 dashboard** 为 **P1**；其余边界有处理或仅体验问题。

---

## Step 8：结构化输出

### ✅ 正常点

1. **Session**：middleware 统一 `updateSession`，cookie 刷新；`/en` 与 auth 解耦。  
2. **打赏**：首页打赏横幅 + 详情 TipButton 均受 profile + 有效 tip 订阅控制；create-tip-session **API 再次校验** 订阅与额度。  
3. **首页权限**：打赏/卖家/带货展示均由 Server 计算后下传，不单靠 Client 隐藏。  
4. **帖子与商品**：按权限过滤，无越权读取；RLS 与查询条件一致。  
5. **错误与重试**：`RetryableError`、空态文案、`fetch` 失败有兜底。  
6. **Hydration**：`effectiveUser`、`effectiveSubscriptionType` 等以 server 为准，减轻闪烁。

---

### ❌ 问题清单（分级）

| 问题 | 风险 | 文件 | 原因 | 修复建议 |
|------|------|------|------|----------|
| 首页 `follows` 使用 `following_id`，表中为 `followee_id`；查询返回 error 未检查，`followingIds` 恒为 `[]`，**已登录用户关注优先流永远不生效** | **P1** | `src/app/[locale]/(main)/page.tsx` | 列名与 schema 不符，且未处理 `error` | 将 `following_id` 改为 `followee_id`（`select` 与 `map`）；并检查 `error`，失败时打 log 或 fallback。 |
| `usePosts` 未接收/使用 `initialData`，Server 首屏 fetch 未复用，且列表被 client 结果覆盖，可能闪烁 | **P1** | `src/lib/hooks/usePosts.ts` | options 仅处理 `enabled`，未传 `initialData` | 支持 `initialData` 并传入 `useInfiniteQuery`；HomePageClient 已传，需在 usePosts 中透传。 |
| 卖家 dashboard / Sidebar 仅用 `profile.subscription_type`，未校验订阅是否过期；过期卖家仍可访问卖家中心 | **P1** | `useSellerGuard`、`Sidebar`、`seller/*` | 未查 `subscriptions` 的 `status`、`expires_at` | 在 useSellerGuard（及必要时 Sidebar）中增加对 **有效 seller 订阅** 的校验；或统一改用与首页相同的 subscriptions 逻辑。 |
| 首页 seller 展示依 **subscriptions**，Sidebar/卖家路由依 **profile.subscription_type**，cron 未同步时二者不一致 | **P1** | `page.tsx` vs `Sidebar` / `useSellerGuard` | 数据源不统一 | 统一以 **subscriptions**（或单一 “subscription service”）为准；或保证 profile 与 subscriptions 的同步语义一致。 |
| Middleware 对每个已登录请求多查 1～2 次 DB（profile + 部分用户再查 subscriptions），仅用于 banned 与 tip 日志 | **P2** | `src/lib/supabase/middleware.ts` | 为 redirect 与 log 做的额外查询 | 评估是否可缓存、合并或仅在关键路径查询；至少避免重复查 profile。 |
| `usePosts` 的 `fetchPosts` 不含 `affiliate_posts`，“加载更多”与首屏结构不一致 | **P2** | `src/lib/hooks/usePosts.ts` | `fetchPosts` select 未加 `affiliate_posts` | 若首页需展示帖子带货信息，给 `fetchPosts` 加上与 server 相同的 `affiliate_posts`；否则在文档中明确“仅首屏含商品”。 |
| Banned 重定向仅保留 `en|zh` locale，`es/pt/ja/ar` 用户会跳到无 locale 的 `/banned` | **P2** | `src/lib/supabase/middleware.ts` | `localeMatch` 仅 `(en|zh)` | 扩展 `localeMatch` 支持全部 `routing.locales`，或统一走 intl 的 locale 解析。 |

---

## 最终结论（三句话）

1. **功能全开的真实用户进首页，会不会看到不该看到的？**  
   - **不会**。打赏/卖家/带货的展示与数据都按权限过滤；未发现越权字段或越权 API 调用。

2. **能不能点到不该点的按钮？**  
   - **打赏**：不行；未订阅/过期时 API 403，且 UI 已引导。  
   - **卖家**：**能**。订阅过期后，因 useSellerGuard 仅看 `profile.subscription_type`，仍可进卖家中心并操作，属 **P1**。  
   - 首页无 TipButton，仅有打赏横幅与详情页打赏，行为符合设计。

3. **极端情况会不会出错？**  
   - **会**。**已登录用户** 因 **follows 使用 `following_id`** 导致 **关注优先流永远不生效**，始终看默认时间线，属 **P1**；不崩溃。  
   - 其次，**过期卖家仍可进卖家中心**、**initialData 未用导致闪烁与浪费**，属 P1；其余为 P2 体验或优化项。

---

**报告完成。** 建议优先修复 **P1 follows 列名** 与 **关注流逻辑**，再处理 **P1 卖家订阅校验** 与 **initialData 传递**。
