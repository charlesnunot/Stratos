## 重构计划：将带货帖子合并到 posts 表

### 一、当前架构问题

* `content_events` 表与 `posts` 表分离，导致代码复杂

* 需要维护两套查询逻辑（Feed 获取、审核等）

* 读写不一致（创建用 product\_id，读取用 event\_affiliate\_binding）

***

### 二、涉及的文件清单

#### 2.1 数据库层 (Supabase)

| 文件                          | 操作                                                                              |
| --------------------------- | ------------------------------------------------------------------------------- |
| `posts` 表                   | 添加字段：`affiliate_product_id`, `affiliate_seller_id`, `affiliate_commission_rate` |
| `post_products` 表           | 已有，可复用来存储带货商品                                                                   |
| `content_events` 表          | 保留（历史数据），或标记为废弃                                                                 |
| `event_affiliate_binding` 表 | 保留（金融级佣金账本不可轻易删除）                                                               |

#### 2.2 前端页面

| 文件                                                             | 操作                         |
| -------------------------------------------------------------- | -------------------------- |
| `app/[locale]/(main)/post/create/page.tsx`                     | 添加带货商品选择器                  |
| `app/[locale]/(main)/affiliate/products/[id]/promote/page.tsx` | 改为跳转到 `/post/create` 并预填商品 |

#### 2.3 API 层

| 文件                                              | 操作                       |
| ----------------------------------------------- | ------------------------ |
| `app/api/affiliate/posts/create/route.ts`       | 改为写入 `posts` 表           |
| `app/api/admin/content-review/approve/route.ts` | 移除 `content_events` 审核逻辑 |
| `app/api/admin/content-review/reject/route.ts`  | 移除 `content_events` 审核逻辑 |

#### 2.4 数据获取层

| 文件                      | 操作                                   |
| ----------------------- | ------------------------------------ |
| `lib/hooks/usePosts.ts` | 移除 `content_events` 查询，统一用 `posts` 表 |
| `lib/posts/shared.ts`   | 更新 `POST_SELECT` 包含带货字段              |

#### 2.5 管理后台

| 文件                                   | 操作                        |
| ------------------------------------ | ------------------------- |
| `components/admin/ContentReview.tsx` | 移除 `content_events` 审核 UI |

#### 2.6 佣金计算

| 文件                                   | 操作                            |
| ------------------------------------ | ----------------------------- |
| `lib/commissions/calculate.ts`       | 修改为从 `post_products` 获取商品信息   |
| `lib/utils/affiliate-attribution.ts` | 修改为从 `posts` 表获取 affiliate 信息 |

***

### 三、实施步骤（分阶段）

#### 阶段 1：数据库变更（创建迁移）

1. 为 `posts` 表添加带货字段
2. 保留 `event_affiliate_binding` 表（金融账本不可删除）

#### 阶段 2：修改带货帖子创建流程

1. 修改 `/api/affiliate/posts/create` 写入 `posts` 表
2. 通过 `post_products` 关联商品

#### 阶段 3：统一 Feed 数据获取

1. 修改 `usePosts.ts`，移除 `content_events` 查询
2. 更新 `mapRowToPost` 处理带货帖子

#### 阶段 4：更新管理后台

1. 修改 `ContentReview.tsx` 移除 `content_events` 审核
2. 修改审核 API

#### 阶段 5：测试与验证

1. 测试创建带货帖子
2. 测试 Feed 显示
3. 测试佣金计算

***

### 四、风险与注意事项

1. **数据迁移风险**：现有 `content_events` 数据需要迁移或保留
2. **金融账本**：`event_affiliate_binding` 是金融级账本，**不能删除**
3. **向后兼容**：建议先双写，再逐步迁移
4. **测试充分**：涉及佣金计算，必须充分测试

