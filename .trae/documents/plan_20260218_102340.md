## 简化带货架构：删除 v7.0 新架构，恢复使用旧架构

---

### 阶段 1：数据库反向迁移

创建迁移文件 `999_rollback_v7_affiliate_architecture.sql`：

| 操作 | 对象 |
|------|------|
| 删除触发器 | `prevent_hard_delete_content_event`, `prevent_hard_delete_event_affiliate_binding` 等 |
| 删除函数 | `create_content_event`, `get_unified_feed_with_reasons` 等 |
| 删除表 | `content_events`, `event_affiliate_binding` |
| 删除字段 | `affiliate_commissions` 表的 `event_id`, `fx_*` 字段 |
| 删除字段 | `posts` 表的 `is_affiliate_post`, `affiliate_*`, `content_source_*` 字段 |

---

### 阶段 2：删除前端代码

| 文件 | 操作 |
|------|------|
| `affiliate/products/[id]/promote/page.tsx` | 删除整个目录 |
| `usePosts.ts` 中的 `EVENT_SELECT` | 删除 |
| `usePosts.ts` 中的 `mapContentEventToPost` | 删除 |
| `usePosts.ts` 中的 `content_events` 查询逻辑 | 删除 |
| `ContentReview.tsx` 中的 `affiliate_event` 审核 UI | 删除 |
| `lib/types/content-event.ts` | 删除 |

---

### 阶段 3：删除 API 代码

| 文件 | 操作 |
|------|------|
| `api/affiliate/posts/create/route.ts` | 删除整个目录 |
| `approve/route.ts` 中的 `affiliate_event` 同步逻辑 | 删除 |
| `reject/route.ts` 中的 `affiliate_event` 处理逻辑 | 删除 |

---

### 阶段 4：修改前端页面

| 文件 | 修改内容 |
|------|----------|
| `affiliate/products/page.tsx` | 添加 "Create Affiliate Post" 按钮，跳转到 `/post/create?product_id=xxx` |
| `post/create/page.tsx` | 支持 URL 参数 `?product_id=xxx`，自动绑定商品并写入 `affiliate_posts` 表 |

---

### 阶段 5：修改 RPC 函数

| 文件 | 修改内容 |
|------|----------|
| `272_unified_feed_rpc.sql` | 移除 `content_events` 查询，只查询 `posts` 表 |

---

### 阶段 6：删除迁移文件（本地）

| 文件 | 操作 |
|------|------|
| `263_create_content_events.sql` | 删除 |
| `264_create_event_affiliate_binding.sql` | 删除 |
| `265_update_affiliate_commissions.sql` | 删除 |
| `266_create_immutable_triggers.sql` | 删除 |
| `267_create_content_event_rpc.sql` | 删除 |
| `268_migrate_posts_to_events.sql` | 删除 |
| `270_add_review_fields_to_content_events.sql` | 删除 |
| `271_add_review_fields_to_content_events.sql` | 删除 |
| `999_posts_affiliate_fields.sql` | 删除 |

---

### 阶段 7：测试验证

1. 测试创建带货帖子（从 `/affiliate/products` 跳转）
2. 测试帖子显示（Feed、详情页）
3. 测试订单关联（`affiliate_post_id`）
4. 测试佣金计算

---

### 最终架构

```
posts 表 ← 帖子内容
    ↓
post_products 表 ← 商品关联
    ↓
affiliate_posts 表 ← 带货关系（帖子+商品+带货者）
    ↓
orders.affiliate_post_id ← 订单来源
    ↓
affiliate_commissions 表 ← 佣金记录
```