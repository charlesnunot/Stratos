# 方案 C（适度扩展）详细实施计划

## 目标
将推广页面 (`/affiliate/products/[id]/promote`) 打造成"带货专用"编辑器，在普通帖子功能基础上增加带货特有功能，同时保持简洁。

## 实施步骤

### Phase 1: 扩展 RPC 支持短视频（后端）
**文件**: `supabase/migrations/267_create_content_event_rpc.sql`

修改 `create_content_event` 函数，增加参数：
- `p_video_url TEXT DEFAULT NULL` - 短视频URL
- `p_video_cover_url TEXT DEFAULT NULL` - 短视频封面URL
- `p_duration_seconds INT DEFAULT NULL` - 视频时长

### Phase 2: 修改推广页面 UI（前端）
**文件**: `src/app/[locale]/(main)/affiliate/products/[id]/promote/page.tsx`

1. **添加 IP 自动定位** - 从普通帖子页面移植 `fetchLocationFromIp` 功能
2. **添加帖子类型切换** - 支持图文/短视频两种模式
3. **添加短视频上传组件** - 复用普通帖子页面的视频上传逻辑
4. **保留商品信息卡片** - 显示商品图片、名称、价格、佣金率

### Phase 3: 更新 API 处理逻辑
**文件**: `src/app/api/affiliate/posts/create/route.ts`

修改请求体支持：
- `video_url` - 视频URL
- `video_cover_url` - 视频封面
- `duration_seconds` - 视频时长

传递给 RPC 时包含这些参数。

### Phase 4: 调整视频上传逻辑
**文件**: `src/components/ui/ImageUpload.tsx` 或新建 `VideoUpload.tsx`

添加视频上传组件，支持：
- 本地视频文件选择
- 视频封面自动提取
- 上传到 Supabase Storage

---

## 功能对比（实施后）

| 功能 | 普通帖子页面 | 推广页面（方案C） |
|------|-------------|------------------|
| 文字内容 | ✅ | ✅ |
| 图片上传 | ✅ | ✅ |
| IP自动定位 | ✅ | ✅ |
| 短视频上传 | ✅ | ✅ |
| 商品信息展示 | ❌ | ✅ |
| 佣金率展示 | ❌ | ✅ |
| 商品选择 | ✅ | ❌（已在商品页） |
| 群组选择 | ✅ | ❌（不需要） |
| 音乐上传 | ✅ | ❌（带货不需要） |
| 故事/章节 | ✅ | ❌（带货不需要） |

---

## 预计工作量
- Phase 1: 15分钟（修改SQL）
- Phase 2: 45分钟（前端UI调整）
- Phase 3: 15分钟（API调整）
- Phase 4: 30分钟（视频上传组件）

**总计: 约 1.5 小时**