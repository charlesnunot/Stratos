## Stratos 项目统一鉴权系统计划

***

### 一、审查结果摘要

#### 1.1 已实现（无需修改）

| 功能 | 文件位置 | 说明 |
|------|----------|------|
| Middleware 层账号状态检查 | `src/lib/supabase/middleware.ts:60-87` | banned/suspended → 重定向 /banned，deleted → 重定向 /recover-account |
| usePaymentAccount hook | `src/lib/hooks/usePaymentAccount.ts` | 已存在，使用 React Query 缓存，可直接复用 |

#### 1.2 需要修改的部分

| 文件 | 当前状态 | 需要修改 | 优先级 |
|------|----------|----------|--------|
| `useAffiliateGuard.tsx` | 只检查订阅状态 | 复用 `usePaymentAccount` 添加收款账户检查 | **P0** |
| `useTipGuard.tsx` | 只检查订阅状态 | 复用 `usePaymentAccount` 添加收款账户检查 | **P0** |
| `affiliate/stats/page.tsx` | 只用 `useAuthGuard` | 改用 `useAffiliateGuard` | **P0** |
| `useSellerTierGuard.tsx` | 不存在 | 新建 hook | **P1** |
| `check-subscription.ts` | 未检查收款账户 | API 层添加收款账户检查 | **P1** |
| 高级功能页面 | 无档位检查 | 添加 `useSellerTierGuard` | **P2** |

#### 1.3 建议优化

1. `useAffiliateGuard`/`useTipGuard` 可以返回更细粒度状态（如 `hasPaymentAccount`, `isInternalUser`）方便 UI 显示不同提示
2. API 层 `checkAffiliatePermission`/`checkTipPermission` 已区分内部用户，但未检查收款账户，建议添加

***

### 二、用户类型与权限体系

#### 2.1 用户身份字段

| 字段 | 值 | 说明 |
|------|-----|------|
| `role` | user/seller/affiliate/admin/support | 用户角色 |
| `user_origin` | internal/external | 用户来源 |
| `seller_type` | external/direct | 卖家类型 |
| `status` | active/banned/suspended/deleted | 账号状态 |

#### 2.2 内部权限字段

| 字段 | 说明 |
|------|------|
| `internal_tip_enabled` | 内部用户打赏权限（使用平台收款） |
| `internal_affiliate_enabled` | 内部用户带货权限（使用平台收款） |

#### 2.3 订阅字段

| 字段 | 说明 |
|------|------|
| `seller_subscription_active` | 卖家订阅激活 |
| `affiliate_subscription_active` | 带货订阅激活 |
| `tip_subscription_active` | 打赏订阅激活 |
| `seller_subscription_tier` | 卖家订阅档位 (15/80/200) |

***

### 三、权限矩阵

| 功能 | 内部用户 | 外部用户 |
|------|----------|----------|
| **卖家功能** | `seller_type === 'direct'` | 卖家订阅 + 绑定收款账户 |
| **带货功能** | `internal_affiliate_enabled` | 带货订阅 + 绑定收款账户 |
| **打赏功能** | `internal_tip_enabled` | 打赏订阅 + 绑定收款账户 |
| **高级分析** | `seller_type === 'direct'` | tier >= 80 |
| **品牌设置** | `seller_type === 'direct'` | tier >= 80 |
| **API密钥** | `seller_type === 'direct'` | tier >= 200 |
| **推广工具** | `seller_type === 'direct'` | tier >= 200 |

***

### 四、页面鉴权需求表

#### 4.1 公开页面（无需登录）

| 页面 | 路径 |
|------|------|
| 首页 | `/` |
| 商品列表 | `/products` |
| 商品详情 | `/product/[id]` |
| 用户主页 | `/profile/[id]` |
| 帖子详情 | `/post/[id]` |
| 话题页 | `/topics/[topic]` |
| 搜索 | `/search` |
| 登录/注册 | `/login`, `/register` |

#### 4.2 登录用户页面

| 页面 | 路径 | 额外条件 |
|------|------|----------|
| Feed | `/feed` | - |
| 购物车 | `/cart` | - |
| 结账 | `/checkout` | - |
| 我的订单 | `/orders` | - |
| 消息 | `/messages` | - |
| 通知 | `/notifications` | - |
| 收藏 | `/favorites` | - |
| 设置 | `/settings` | - |
| 创建帖子 | `/post/create` | - |
| 编辑帖子 | `/post/[id]/edit` | 帖子作者 |
| 收货地址 | `/profile/addresses` | - |
| 工单 | `/support/tickets` | - |

#### 4.3 卖家页面

| 页面 | 路径 | 权限要求 |
|------|------|----------|
| 卖家中心 | `/seller/dashboard` | isSeller |
| 商品管理 | `/seller/products` | isSeller |
| 创建商品 | `/seller/products/create` | isSeller |
| 编辑商品 | `/seller/products/[id]/edit` | isSeller + 商品所有者 |
| 卖家订单 | `/seller/orders` | isSeller |
| 收款账户 | `/seller/payment-accounts` | isSeller |
| 保证金 | `/seller/deposit/*` | isSeller |
| 高级分析 | `/seller/analytics` | isSeller + tier >= 80 |
| 品牌设置 | `/seller/branding` | isSeller + tier >= 80 |
| API密钥 | `/seller/api-keys` | isSeller + tier >= 200 |
| 推广工具 | `/seller/promotion` | isSeller + tier >= 200 |

#### 4.4 带货页面

| 页面 | 路径 | 权限要求 |
|------|------|----------|
| 带货统计 | `/affiliate/stats` | isAffiliate + 收款账户 |
| 可推广商品 | `/affiliate/products` | isAffiliate + 收款账户 |

#### 4.5 打赏页面

| 页面 | 路径 | 权限要求 |
|------|------|----------|
| 打赏中心 | `/tip-center` | isTipEnabled + 收款账户 |

#### 4.6 管理员页面

| 页面 | 路径 | 权限要求 |
|------|------|----------|
| 管理仪表盘 | `/admin/dashboard` | role === 'admin' |
| 内容审核 | `/admin/review`, `/admin/content-review` | role === 'admin' |
| 用户管理 | `/admin/profiles` | role === 'admin' |
| 内部用户 | `/admin/internal-users` | role === 'admin' |
| 订单管理 | `/admin/orders` | role === 'admin' |
| 纠纷处理 | `/admin/disputes/[id]` | role === 'admin' |
| 举报处理 | `/admin/reports` | role === 'admin' |
| 工单管理 | `/admin/support` | role === 'admin' \|\| 'support' |

#### 4.7 订阅页面

| 页面 | 路径 | 权限要求 |
|------|------|----------|
| 卖家订阅 | `/subscription/seller` | 登录用户 |
| 带货订阅 | `/subscription/affiliate` | 登录用户 |
| 打赏订阅 | `/subscription/tip` | 登录用户 |
| 订阅管理 | `/subscription/manage` | 登录用户 |

***

### 五、鉴权架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Layer 1: Middleware (已实现)              │
│  文件: src/lib/supabase/middleware.ts:60-87                 │
│  检查: status === 'banned' | 'suspended' | 'deleted'        │
│  动作: 重定向到 /banned 或 /recover-account                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Layer 2: Guard Hooks                      │
│  useAuthGuard()      - 基础登录验证                          │
│  useSellerGuard()    - 卖家权限 (含内部用户)                  │
│  useAffiliateGuard() - 带货权限 (需修改: 添加收款账户检查)    │
│  useTipGuard()       - 打赏权限 (需修改: 添加收款账户检查)    │
│  useAdminGuard()     - 管理员权限                            │
│  useSellerTierGuard(minTier) - 卖家档位权限 (需新建)         │
│                                                              │
│  复用: usePaymentAccount() - 收款账户检查 (已存在)           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Layer 3: Layout Guards                    │
│  SellerLayout    - 包裹所有 /seller/* 页面                   │
│  AffiliateLayout - 包裹所有 /affiliate/* 页面                │
│  TipCenterLayout - 包裹所有 /tip-center/* 页面               │
│  AdminLayout     - 包裹所有 /admin/* 页面                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    Layer 4: API Guards                       │
│  requireAdmin()           - 管理员权限                       │
│  requireAdminOrSupport()  - 管理员或客服                     │
│  checkSellerPermission()  - 卖家权限                         │
│  checkAffiliatePermission() - 带货权限 (需修改: 添加收款账户) │
│  checkTipPermission()     - 打赏权限 (需修改: 添加收款账户)   │
│  validateSellerPaymentReady() - 卖家收款就绪                 │
└─────────────────────────────────────────────────────────────┘
```

***

### 六、实施任务清单

#### Phase 1: 基础设施 (P0)

1. **修复 affiliate/stats 鉴权错误**
   - 文件: `src/app/[locale]/(main)/affiliate/stats/page.tsx`
   - 当前: 使用 `useAuthGuard`
   - 修改: 改用 `useAffiliateGuard`

2. **修改 useAffiliateGuard**
   - 文件: `src/lib/hooks/useAffiliateGuard.tsx`
   - 当前: 只检查 `isAffiliate` 订阅状态
   - 修改: 复用 `usePaymentAccount` hook 添加收款账户检查
   - 优化: 返回更细粒度状态 (`hasPaymentAccount`, `isInternalUser`)

3. **修改 useTipGuard**
   - 文件: `src/lib/hooks/useTipGuard.tsx`
   - 当前: 只检查 `isTipEnabled` 订阅状态
   - 修改: 复用 `usePaymentAccount` hook 添加收款账户检查
   - 优化: 返回更细粒度状态 (`hasPaymentAccount`, `isInternalUser`)

#### Phase 2: 完善守卫 (P1)

4. **创建 useSellerTierGuard Hook**
   - 文件: `src/lib/hooks/useSellerTierGuard.tsx` (新建)
   - 功能: 用于高级功能的档位验证
   - 参数: `minTier` (最低档位要求)
   - 返回: `{ allowed, tier, isDirectSeller, loading }`

5. **补充 TypeScript 类型定义**
   - 文件: `src/types/database.ts`
   - 添加缺失的 profiles 字段类型

6. **修改 checkAffiliatePermission / checkTipPermission**
   - 文件: `src/lib/auth/check-subscription.ts`
   - 当前: 已区分内部用户，但未检查收款账户
   - 修改: API 层添加收款账户检查

#### Phase 3: 页面统一 (P2)

7. **统一 Admin 页面鉴权**
   - 所有 /admin/* 页面使用 `useAdminGuard`

8. **完善帖子创建页面鉴权**
   - 文件: `src/app/[locale]/(main)/post/create/page.tsx`
   - 账号状态检查: 已在 Middleware 层实现，无需额外修改
   - 区分内部/外部用户的带货/打赏权限

9. **卖家高级功能鉴权**
   - `analytics/page.tsx`: 添加 `useSellerTierGuard(80)`
   - `branding/page.tsx`: 添加 `useSellerTierGuard(80)`
   - `api-keys/page.tsx`: 添加 `useSellerTierGuard(200)`
   - `promotion/page.tsx`: 添加 `useSellerTierGuard(200)`

#### Phase 4: 文档与测试 (P3)

10. **编写鉴权文档**
    - 更新项目文档中的鉴权说明

11. **添加鉴权测试**
    - 测试各页面/功能的权限控制

***

### 七、修改文件清单

| 文件 | 修改内容 | 优先级 | 说明 |
|------|----------|--------|------|
| `src/lib/hooks/useAffiliateGuard.tsx` | 复用 `usePaymentAccount` 添加收款账户检查，返回细粒度状态 | P0 | 区分内部/外部用户，外部用户需验证收款账户 |
| `src/lib/hooks/useTipGuard.tsx` | 复用 `usePaymentAccount` 添加收款账户检查，返回细粒度状态 | P0 | 区分内部/外部用户，外部用户需验证收款账户 |
| `src/app/[locale]/(main)/affiliate/stats/page.tsx` | 改用 `useAffiliateGuard` | P0 | 修复当前使用 `useAuthGuard` 的鉴权错误 |
| `src/lib/hooks/useSellerTierGuard.tsx` | 新建档位守卫 | P1 | 用于高级功能的档位验证，支持直营卖家绕过 |
| `src/lib/auth/check-subscription.ts` | API 层添加收款账户检查 | P1 | `checkAffiliatePermission` 和 `checkTipPermission` 需验证收款账户 |
| `src/app/[locale]/(main)/post/create/page.tsx` | 完善鉴权逻辑 | P2 | 区分内部/外部用户的带货/打赏权限检查 |
| `src/app/[locale]/(main)/seller/analytics/page.tsx` | 添加档位守卫 `useSellerTierGuard(80)` | P2 | 高级分析功能需要 tier >= 80 |
| `src/app/[locale]/(main)/seller/branding/page.tsx` | 添加档位守卫 `useSellerTierGuard(80)` | P2 | 品牌设置功能需要 tier >= 80 |
| `src/app/[locale]/(main)/seller/api-keys/page.tsx` | 添加档位守卫 `useSellerTierGuard(200)` | P2 | API密钥功能需要 tier >= 200 |
| `src/app/[locale]/(main)/seller/promotion/page.tsx` | 添加档位守卫 `useSellerTierGuard(200)` | P2 | 推广工具功能需要 tier >= 200 |
| `src/types/database.ts` | 补充类型定义 | P2 | 添加 `user_origin`、`internal_*_enabled` 等字段类型 |
| `src/messages/zh.json` / `en.json` | 添加提示文案 | P3 | 添加鉴权失败的提示文案翻译 |

***

### 八、关键实现细节

#### 8.1 useAffiliateGuard 改造示例

```typescript
// 改造前：只检查订阅状态，未区分内部/外部用户
export function useAffiliateGuard() {
  const { user, loading: authLoading } = useAuth()
  const { isAffiliate, isLoading: subscriptionLoading } = useSubscription()
  
  const allowed = isAuthenticated && isAffiliate
  // 问题：外部用户即使有订阅，也可能没有绑定收款账户
}

// 改造后：区分内部/外部用户，外部用户需验证收款账户
import { PayoutEligibility } from '@/components/payment/PaymentAccountBanner'

export function useAffiliateGuard() {
  // 1. 获取基础认证状态
  const { user, loading: authLoading } = useAuth()
  
  // 2. 获取订阅状态（来自 SubscriptionContext，已缓存）
  const { isAffiliate, isLoading: subscriptionLoading } = useSubscription()
  
  // 3. 获取收款账户状态（使用 React Query 缓存，避免重复请求）
  const { data: paymentAccount, isLoading: paymentLoading } = usePaymentAccount(user?.id)
  
  const isAuthenticated = !!user
  
  // 4. 内部用户检查：内部员工可通过管理员开通带货权限，使用平台收款账户
  //    无需订阅，无需绑定收款账户
  const isInternalUser = user?.user_origin === 'internal'
  const hasInternalPermission = isInternalUser && user?.internal_affiliate_enabled
  
  // 5. 外部用户检查：必须有订阅 + 有效收款账户
  //    hasPaymentAccount: 检查是否绑定了支付提供商和账户ID
  //    eligibility: 检查账户状态是否正常（非 BLOCKED/PENDING_REVIEW）
  const hasPaymentAccount = paymentAccount?.hasPaymentAccount && 
    paymentAccount?.eligibility === PayoutEligibility.ELIGIBLE
  const hasExternalPermission = isAffiliate && hasPaymentAccount
  
  // 6. 综合判断：内部用户有权限 或 外部用户满足订阅+收款账户条件
  const allowed = isAuthenticated && (hasInternalPermission || hasExternalPermission)
  
  return {
    user,
    loading: authLoading || subscriptionLoading || paymentLoading,
    isAuthenticated,
    isAffiliate,
    isInternalUser,      // 供 UI 显示不同提示
    hasPaymentAccount,   // 供 UI 显示绑定收款账户提示
    allowed,
    // 7. 细粒度拒绝原因：方便 UI 显示针对性提示
    denyReason: !allowed 
      ? !isAuthenticated ? 'not_logged_in'           // 请先登录
        : !isAffiliate && !hasInternalPermission ? 'no_subscription'     // 请订阅带货功能
        : !hasPaymentAccount && !isInternalUser ? 'no_payment_account'   // 请绑定收款账户
        : null
      : null
  }
}
```

#### 8.2 useTipGuard 改造示例

```typescript
// src/lib/hooks/useTipGuard.tsx
// 功能：打赏功能鉴权，逻辑与 useAffiliateGuard 类似
// 区别：检查 internal_tip_enabled 而非 internal_affiliate_enabled

'use client'

import { useAuth } from './useAuth'
import { useSubscription } from '@/lib/subscription/SubscriptionContext'
import { usePaymentAccount } from './usePaymentAccount'
import { PayoutEligibility } from '@/components/payment/PaymentAccountBanner'

interface UseTipGuardResult {
  user: ReturnType<typeof useAuth>['user']
  loading: boolean
  isAuthenticated: boolean
  isTipEnabled: boolean
  isInternalUser: boolean
  hasPaymentAccount: boolean
  allowed: boolean
  denyReason: 'not_logged_in' | 'no_subscription' | 'no_payment_account' | null
}

export function useTipGuard(): UseTipGuardResult {
  // 1. 获取基础认证状态
  const { user, loading: authLoading } = useAuth()
  
  // 2. 获取打赏订阅状态
  const { isTipEnabled, isLoading: subscriptionLoading } = useSubscription()
  
  // 3. 获取收款账户状态
  const { data: paymentAccount, isLoading: paymentLoading } = usePaymentAccount(user?.id)

  const isAuthenticated = !!user
  
  // 4. 内部用户检查：管理员可开通打赏权限，使用平台收款账户
  const isInternalUser = user?.user_origin === 'internal'
  const hasInternalPermission = isInternalUser && user?.internal_tip_enabled
  
  // 5. 外部用户检查：打赏订阅 + 有效收款账户
  const hasPaymentAccount = paymentAccount?.hasPaymentAccount && 
    paymentAccount?.eligibility === PayoutEligibility.ELIGIBLE
  const hasExternalPermission = isTipEnabled && hasPaymentAccount
  
  const allowed = isAuthenticated && (hasInternalPermission || hasExternalPermission)

  return {
    user,
    loading: authLoading || subscriptionLoading || paymentLoading,
    isAuthenticated,
    isTipEnabled,
    isInternalUser,
    hasPaymentAccount,
    allowed,
    denyReason: !allowed 
      ? !isAuthenticated ? 'not_logged_in'
        : !isTipEnabled && !hasInternalPermission ? 'no_subscription'
        : !hasPaymentAccount && !isInternalUser ? 'no_payment_account'
        : null
      : null
  }
}
```

#### 8.3 useSellerTierGuard 新建示例

```typescript
// src/lib/hooks/useSellerTierGuard.tsx
// 功能：卖家档位鉴权，用于高级功能的权限控制
// 特点：直营卖家（seller_type === 'direct'）拥有所有权限，无需档位检查

'use client'

import { useAuth } from './useAuth'
import { useSubscription } from '@/lib/subscription/SubscriptionContext'

interface UseSellerTierGuardResult {
  user: ReturnType<typeof useAuth>['user']
  loading: boolean
  isSeller: boolean
  isDirectSeller: boolean
  tier: number | null
  allowed: boolean
  denyReason: 'not_seller' | 'tier_too_low' | null
}

export function useSellerTierGuard(minTier: number): UseSellerTierGuardResult {
  // 1. 获取基础认证状态
  const { user, loading: authLoading } = useAuth()
  
  // 2. 获取卖家状态和档位信息
  //    isDirectSeller: 直营卖家（内部员工），拥有所有权限
  //    sellerTier: 订阅档位 (15/80/200)
  const { isSeller, isDirectSeller, sellerTier, isLoading: subscriptionLoading } = useSubscription()
  
  // 3. 权限判断逻辑：
  //    - 直营卖家：直接通过，无需档位检查
  //    - 外部卖家：档位必须 >= minTier
  const allowed = isDirectSeller || (isSeller && (sellerTier ?? 0) >= minTier)
  
  return {
    user,
    loading: authLoading || subscriptionLoading,
    isSeller,
    isDirectSeller,
    tier: sellerTier,
    allowed,
    // 4. 拒绝原因：
    //    - not_seller: 用户不是卖家
    //    - tier_too_low: 卖家档位不足，需升级订阅
    denyReason: !allowed
      ? !isSeller ? 'not_seller'
        : !isDirectSeller && (sellerTier ?? 0) < minTier ? 'tier_too_low'
        : null
      : null
  }
}
```

#### 8.4 API 层收款账户检查示例

```typescript
// check-subscription.ts 改造
import { PayoutEligibility } from '@/components/payment/PaymentAccountBanner'

export async function checkAffiliatePermission(
  userId: string,
  supabaseAdmin: SupabaseClient
): Promise<{ hasPermission: boolean; reason?: string }> {
  const { data: profile } = await supabaseAdmin
    .from('profiles')
    .select('user_origin, internal_affiliate_enabled, payment_provider, payment_account_id, seller_payout_eligibility')
    .eq('id', userId)
    .single()

  const p = profile as { 
    user_origin?: string
    internal_affiliate_enabled?: boolean
    payment_provider?: string
    payment_account_id?: string
    seller_payout_eligibility?: string
  } | null
  
  if (!p) {
    return { hasPermission: false, reason: 'User profile not found' }
  }
  
  // 内部用户检查（使用平台收款账户，无需绑定收款账户）
  if (p.user_origin === 'internal' && p.internal_affiliate_enabled) {
    return { hasPermission: true }
  }

  // 检查订阅
  const { hasActive } = await checkSubscriptionStatus(userId, 'affiliate', supabaseAdmin)
  if (!hasActive) {
    return { hasPermission: false, reason: 'Affiliate subscription expired or not found' }
  }

  // 外部用户必须绑定收款账户
  const hasPaymentAccount = !!(p.payment_provider && p.payment_account_id)
  if (!hasPaymentAccount) {
    return { hasPermission: false, reason: 'No payment account bound' }
  }
  
  // 检查收款账户状态
  if (p.seller_payout_eligibility === PayoutEligibility.BLOCKED) {
    return { hasPermission: false, reason: 'Payment account is blocked' }
  }

  return { hasPermission: true }
}

/**
 * Check tip permission (including subscription status).
 * Internal users with internal_tip_enabled have permission without a tip subscription.
 */
export async function checkTipPermission(
  userId: string,
  supabaseAdmin: SupabaseClient
): Promise<{ hasPermission: boolean; reason?: string }> {
  const { data: profile } = await supabaseAdmin
    .from('profiles')
    .select('tip_enabled, user_origin, internal_tip_enabled, payment_provider, payment_account_id, seller_payout_eligibility')
    .eq('id', userId)
    .single()

  if (!profile) {
    return { hasPermission: false, reason: 'User profile not found' }
  }

  const p = profile as { 
    tip_enabled?: boolean
    user_origin?: string
    internal_tip_enabled?: boolean
    payment_provider?: string
    payment_account_id?: string
    seller_payout_eligibility?: string
  }
  
  // 内部用户检查（使用平台收款账户，无需绑定收款账户）
  if (p.user_origin === 'internal' && p.internal_tip_enabled) {
    return { hasPermission: true }
  }

  if (!p.tip_enabled) {
    return { hasPermission: false, reason: 'Tip feature not enabled' }
  }

  // 检查订阅
  const { hasActive } = await checkSubscriptionStatus(userId, 'tip', supabaseAdmin)
  if (!hasActive) {
    return { hasPermission: false, reason: 'Tip subscription expired or not found' }
  }

  // 外部用户必须绑定收款账户
  const hasPaymentAccount = !!(p.payment_provider && p.payment_account_id)
  if (!hasPaymentAccount) {
    return { hasPermission: false, reason: 'No payment account bound' }
  }
  
  // 检查收款账户状态
  if (p.seller_payout_eligibility === PayoutEligibility.BLOCKED) {
    return { hasPermission: false, reason: 'Payment account is blocked' }
  }

  return { hasPermission: true }
}
```

***

### 九、用户案例场景

#### 9.1 场景 1：内部用户访问带货功能

```
用户：张三（内部员工）
user_origin: 'internal'
internal_affiliate_enabled: true

访问 /affiliate/stats 页面：
1. Middleware 层：账号状态正常，通过
2. useAffiliateGuard：
   - isInternalUser = true
   - hasInternalPermission = true
   - allowed = true（无需订阅，无需收款账户）
3. 结果：✅ 允许访问，佣金打入平台收款账户
```

#### 9.2 场景 2：外部用户访问带货功能（已订阅但未绑定收款账户）

```
用户：李四（外部卖家）
user_origin: 'external'
affiliate_subscription_active: true
payment_provider: null
payment_account_id: null

访问 /affiliate/stats 页面：
1. Middleware 层：账号状态正常，通过
2. useAffiliateGuard：
   - isInternalUser = false
   - isAffiliate = true（有订阅）
   - hasPaymentAccount = false（未绑定收款账户）
   - allowed = false
   - denyReason = 'no_payment_account'
3. 结果：❌ 拒绝访问，显示提示："请先绑定收款账户"
```

#### 9.3 场景 3：外部卖家访问高级分析功能

```
用户：王五（外部卖家）
user_origin: 'external'
seller_subscription_active: true
seller_subscription_tier: 80

访问 /seller/analytics 页面：
1. Middleware 层：账号状态正常，通过
2. useSellerGuard：isSeller = true，通过
3. useSellerTierGuard(80)：
   - isDirectSeller = false
   - tier = 80
   - minTier = 80
   - allowed = (80 >= 80) = true
4. 结果：✅ 允许访问
```

#### 9.4 场景 4：直营卖家访问所有高级功能

```
用户：赵六（直营卖家）
user_origin: 'internal'
seller_type: 'direct'

访问 /seller/api-keys 页面（需要 tier >= 200）：
1. Middleware 层：账号状态正常，通过
2. useSellerGuard：isSeller = true，通过
3. useSellerTierGuard(200)：
   - isDirectSeller = true
   - allowed = true（直营卖家拥有所有权限，跳过档位检查）
4. 结果：✅ 允许访问
```

#### 9.5 场景 5：外部卖家档位不足访问高级功能

```
用户：钱七（外部卖家）
user_origin: 'external'
seller_subscription_active: true
seller_subscription_tier: 15

访问 /seller/promotion 页面（需要 tier >= 200）：
1. Middleware 层：账号状态正常，通过
2. useSellerGuard：isSeller = true，通过
3. useSellerTierGuard(200)：
   - isDirectSeller = false
   - tier = 15
   - minTier = 200
   - allowed = (15 >= 200) = false
   - denyReason = 'tier_too_low'
4. 结果：❌ 拒绝访问，显示提示："请升级订阅档位"
```

***

### 十、测试验证步骤

#### 10.1 useAffiliateGuard 测试

| 测试用例 | 预期结果 |
|----------|----------|
| 内部用户 + internal_affiliate_enabled = true | allowed = true |
| 内部用户 + internal_affiliate_enabled = false | allowed = false |
| 外部用户 + 有订阅 + 有收款账户 | allowed = true |
| 外部用户 + 有订阅 + 无收款账户 | allowed = false, denyReason = 'no_payment_account' |
| 外部用户 + 无订阅 + 有收款账户 | allowed = false, denyReason = 'no_subscription' |
| 未登录用户 | allowed = false, denyReason = 'not_logged_in' |

#### 10.2 useTipGuard 测试

| 测试用例 | 预期结果 |
|----------|----------|
| 内部用户 + internal_tip_enabled = true | allowed = true |
| 外部用户 + 有打赏订阅 + 有收款账户 | allowed = true |
| 外部用户 + 有打赏订阅 + 无收款账户 | allowed = false, denyReason = 'no_payment_account' |

#### 10.3 useSellerTierGuard 测试

| 测试用例 | minTier | 预期结果 |
|----------|---------|----------|
| 直营卖家 | 任意 | allowed = true |
| 外部卖家 tier=200 | 80 | allowed = true |
| 外部卖家 tier=80 | 80 | allowed = true |
| 外部卖家 tier=15 | 80 | allowed = false, denyReason = 'tier_too_low' |
| 非卖家 | 任意 | allowed = false, denyReason = 'not_seller' |

#### 10.4 API 层权限测试

| API | 测试用例 | 预期结果 |
|-----|----------|----------|
| checkAffiliatePermission | 内部用户 + internal_affiliate_enabled | hasPermission = true |
| checkAffiliatePermission | 外部用户 + 有订阅 + 有收款账户 | hasPermission = true |
| checkAffiliatePermission | 外部用户 + 有订阅 + 无收款账户 | hasPermission = false, reason = 'No payment account bound' |
| checkTipPermission | 内部用户 + internal_tip_enabled | hasPermission = true |
| checkTipPermission | 外部用户 + 有订阅 + 收款账户被封禁 | hasPermission = false, reason = 'Payment account is blocked' |

#### 10.5 页面访问测试

| 页面 | 测试用户 | 预期结果 |
|------|----------|----------|
| /affiliate/stats | 未登录 | 重定向到登录页 |
| /affiliate/stats | 普通用户（无订阅） | 显示无权限提示 |
| /affiliate/stats | 带货用户（有订阅无收款账户） | 显示绑定收款账户提示 |
| /seller/analytics | 卖家 tier=15 | 显示升级提示 |
| /seller/api-keys | 卖家 tier=80 | 显示升级提示 |
| /seller/api-keys | 直营卖家 | 正常访问 |

***

### 十一、文档维护说明

#### 11.1 更新周期

| 触发条件 | 更新内容 |
|----------|----------|
| 新增用户角色或权限字段 | 更新"用户类型与权限体系"章节 |
| 新增页面或修改页面权限 | 更新"页面鉴权需求表"章节 |
| 新增订阅档位或修改档位权限 | 更新"权限矩阵"章节 |
| 新增 Guard Hook 或修改鉴权逻辑 | 更新"鉴权架构"和"关键实现细节"章节 |

#### 11.2 版本记录

| 版本 | 日期 | 修改内容 |
|------|------|----------|
| v1.0 | 2025-02-20 | 初始版本，包含完整鉴权系统设计 |
| v1.1 | 2025-02-20 | 根据审查反馈添加优先级标注、用户场景、测试步骤 |
| v1.2 | 2025-02-20 | Phase 1-3 实施完成，修复类型定义，添加翻译文本 |

#### 11.4 实施状态

| Phase | 状态 | 完成内容 |
|-------|------|----------|
| Phase 1 (P0) | ✅ 完成 | useAffiliateGuard/useTipGuard 添加收款账户检查，affiliate/stats 页面修复 |
| Phase 2 (P1) | ✅ 完成 | 创建 useSellerTierGuard，API 层添加收款账户检查 |
| Phase 3 (P2) | ✅ 完成 | 帖子创建页面鉴权完善，卖家高级功能档位守卫 |
| Phase 4 (P3) | ✅ 完成 | TypeScript 类型定义补充，翻译文本添加，文档更新 |

#### 11.3 相关文档

- [Supabase Auth 文档](https://supabase.com/docs/guides/auth)
- [项目数据库 Schema](../database/schema.md)
- [API 权限规范](../api/permissions.md)
