# 带货帖子审核实施方案

## 背景

- 普通帖子：创建时 `status='pending'`，Feed 只显示 `status='approved'`，管理员审核后可见
- 带货帖子：当前直接 `status='published'`，无需审核
- 翻译已存在：`"affiliatePostCreated": "带货帖子已创建，等待审核"`

---

## 现状分析

### 现有审核架构

| 组件 | 支持类型 | 位置 |
|------|---------|------|
| `ContentReview.tsx` | post, product, product_comment | 前端审核页面 |
| `approve/route.ts` | post, product, comment, product_comment | 后端审核API |
| `reject/route.ts` | 同上 | 后端拒绝API |
| `posts` 表 | `status` 字段 | 数据库 |
| `content_events` 表 | `status` 字段 (pending/published/deleted) | 数据库 |

### 问题

1. **API 不支持** - 审核 API 只操作 `posts` 表，不支持 `content_events`
2. **UI 不显示** - ContentReview 组件不查询 `content_events` 表
3. **RPC 逻辑** - `create_content_event` 直接设为 `published`

---

## 实施步骤

### Phase 1: 修改 RPC 创建逻辑

**文件**: `supabase/migrations/267_create_content_event_rpc.sql`

修改：创建时保持 `status='pending'`，而非直接设为 `published`

```sql
-- 修改前
INSERT INTO content_events (...) VALUES (...)
  status: 'pending'
-- 之后
UPDATE content_events SET status = 'published' WHERE id = v_event_id;

-- 修改后
INSERT INTO content_events (...) VALUES (...)
  status = 'pending'
-- 不自动更新，等待审核
```

### Phase 2: 扩展审核 API 支持 content_events

**文件**: `src/app/api/admin/content-review/[id]/approve/route.ts`

1. 添加新类型 `'affiliate_event'`
2. 添加 TABLE_MAP 映射
3. 添加 STATUS_MAP 映射

```typescript
type ContentType = 'post' | 'product' | 'comment' | 'product_comment' | 'affiliate_event'

const STATUS_MAP: Record<ContentType, string> = {
  // ... existing
  affiliate_event: 'published',  // 审核通过设为 published
}

const TABLE_MAP: Record<ContentType, string> = {
  // ... existing
  affiliate_event: 'content_events',
}
```

### Phase 3: 扩展审核页面 UI

**文件**: `src/components/admin/ContentReview.tsx`

1. 查询 `content_events` 表中 `status='pending'` 且 `event_type='affiliate'` 的记录
2. 在 UI 中添加"待审带货帖子"区域
3. 显示带货特有信息（商品信息、佣金率等）

```typescript
// 查询待审带货帖子
const { data: affiliateEvents } = await supabase
  .from('content_events')
  .select('*, event_affiliate_binding(*), creator:profiles(*)')
  .eq('status', 'pending')
  .eq('event_type', 'affiliate')
```

### Phase 4: 修改 Feed 查询逻辑（可选）

**文件**: `src/lib/hooks/usePosts.ts`

由于带货帖子使用 `content_events` 表，需要确保：
1. 方案 A：继续使用 `posts` 表，通过 trigger 同步
2. 方案 B：直接查询 `content_events` 表

建议采用方案 A（保持现状），因为：
- 现有 Feed 查询 `posts` 表
- 可以通过 trigger 将 `content_events` 同步到 `posts`

---

## 详细任务清单

| # | 任务 | 文件 | 预估时间 |
|---|------|------|---------|
| 1 | 修改 RPC，创建时保持 pending | 267_create_content_event_rpc.sql | 10min |
| 2 | 扩展审核 API 支持 content_events | approve/route.ts | 20min |
| 3 | 扩展拒绝 API 支持 content_events | reject/route.ts | 15min |
| 4 | 扩展 ContentReview 前端组件 | ContentReview.tsx | 30min |
| 5 | 测试完整审核流程 | - | 20min |

**总计：约 1.5 小时**

---

## 注意事项

1. **兼容性** - 已有带货帖子（status=published）不受影响
2. **迁移** - 不需要数据迁移，只是逻辑变化
3. **同步** - Feed 显示问题可后续处理（当前主要解决审核流程）