# 三功能用户访问首页系统推演报告

## 用户身份设定

```
- 已注册、已登录
- profiles.role = 'user' 或 'seller'
- subscription.status = 'active' (已开通订阅功能)
  - subscriptions.subscription_type = 'tip' (打赏订阅)
  - subscriptions.subscription_type = 'affiliate' (带货订阅)
  - subscriptions.subscription_type = 'seller' (卖家订阅)
- profiles.tip_enabled = true (已开通打赏功能)
- profiles.subscription_type = 'seller' (卖家功能标识)
- 已绑定支付方式可使用
```

**注意**：根据代码分析，系统实际使用：
- `profiles.tip_enabled` 判断打赏功能（不是 `user_features.tips_enabled`）
- `profiles.subscription_type === 'seller'` 判断卖家功能（不是 `user_features.seller_enabled`）
- `subscriptions.subscription_type === 'affiliate'` 判断带货功能

## 访问行为

```
URL: /en
真实系统上下文：Supabase session、profile、订阅状态、功能状态均有效
```

---

## Step 1: middleware.ts 分析

### 1.1 代码路径
`middleware.ts` → `src/lib/supabase/middleware.ts`

### 1.2 执行流程

```typescript
// middleware.ts
export async function middleware(request: NextRequest) {
  // 1. 环境变量验证（通过）
  // 2. 更新 Supabase 会话
  const response = await updateSession(request)
  // 3. 应用国际化中间件
  return intlMiddleware(request)
}
```

```typescript
// src/lib/supabase/middleware.ts
export async function updateSession(request: NextRequest) {
  // 1. 创建 Supabase 客户端
  const supabase = createServerClient(...)
  
  // 2. 获取用户
  const { data: { user } } = await supabase.auth.getUser()
  
  // 3. 检查用户状态
  if (user) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('status, subscription_type, role, tip_enabled')
      .eq('id', user.id)
      .single()
    
    // 4. 检查 banned/suspended
    if (profile?.status === 'banned' || profile?.status === 'suspended') {
      return NextResponse.redirect('/en/banned')
    }
    
    // 5. 检查打赏订阅状态（仅当 subscription_type = 'tip' 时）
    if (profile?.subscription_type === 'tip' && profile?.tip_enabled) {
      const { data: tipSubscription } = await supabase
        .from('subscriptions')
        .select('status, expires_at')
        .eq('user_id', user.id)
        .eq('subscription_type', 'tip')
        .eq('status', 'active')
        .gt('expires_at', new Date().toISOString())
        .single()
      
      // 如果订阅过期但 tip_enabled 仍为 true，记录警告但不阻止
      if (!tipSubscription) {
        console.warn(`User ${user.id} has tip_enabled=true but no active tip subscription`)
      }
    }
  }
  
  return response
}
```

### 1.3 推演结果

✅ **正常流程**：
- Session 正确识别：`supabase.auth.getUser()` 返回有效用户
- Profile 查询成功：获取 `status`, `subscription_type`, `role`, `tip_enabled`
- 状态检查通过：`status` 不是 'banned' 或 'suspended'
- 打赏订阅检查：如果 `subscription_type = 'tip'`，会检查订阅是否过期（仅记录警告，不阻止访问）
- 继续路由到 `/en`

⚠️ **发现的问题**：

1. **P2 - 未检查卖家订阅状态**
   - middleware 只检查 `tip` 订阅，**不检查 `seller` 和 `affiliate` 订阅是否过期**
   - 如果 `subscription_type = 'seller'` 但订阅过期，用户仍可访问首页并看到卖家入口
   - **影响**：可能导致过期订阅用户仍看到卖家功能入口

2. **P2 - 未检查带货订阅状态**
   - middleware 不检查 `affiliate` 订阅状态
   - 如果 `subscription_type = 'affiliate'` 但订阅过期，用户仍可访问
   - **影响**：功能状态不一致时，用户可能看到错误提示

3. **P1 - 订阅状态检查不完整**
   - middleware 只对 `subscription_type = 'tip'` 的用户检查订阅状态
   - 对于同时拥有多个订阅类型的用户，只检查了 `tip` 订阅
   - **影响**：多订阅用户的权限验证不完整

### 1.4 修复建议

```typescript
// src/lib/supabase/middleware.ts
if (user) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('status, subscription_type, role, tip_enabled')
    .eq('id', user.id)
    .single()
  
  // ... 现有的 banned/suspended 检查 ...
  
  // 检查所有订阅类型的状态
  const subscriptionTypes = ['tip', 'seller', 'affiliate']
  for (const subType of subscriptionTypes) {
    const { data: subscription } = await supabase
      .from('subscriptions')
      .select('status, expires_at')
      .eq('user_id', user.id)
      .eq('subscription_type', subType)
      .eq('status', 'active')
      .gt('expires_at', new Date().toISOString())
      .single()
    
    // 记录数据不一致（但不阻止访问，由页面组件处理）
    if (subType === 'tip' && profile?.tip_enabled && !subscription) {
      console.warn(`User ${user.id} has tip_enabled=true but no active tip subscription`)
    }
    if (subType === 'seller' && profile?.subscription_type === 'seller' && !subscription) {
      console.warn(`User ${user.id} has subscription_type=seller but no active seller subscription`)
    }
  }
}
```

---

## Step 2: 路由解析

### 2.1 代码路径
`src/app/[locale]/(main)/page.tsx`

### 2.2 执行流程

```typescript
// src/app/[locale]/(main)/page.tsx
export default async function HomePage() {
  // 1. 创建 Supabase 客户端
  const supabase = await createClient()
  
  // 2. 获取用户
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  const validUser = authError ? null : user
  
  // 3. 查询用户 profile
  if (validUser) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('status, subscription_type, role')
      .eq('id', validUser.id)
      .single()
    
    // 4. 检查账户状态
    if (profile?.status === 'deleted') {
      return <HomePageClient ... tipEnabled={false} />
    }
    if (profile?.status === 'banned' || profile?.status === 'suspended') {
      return <HomePageClient ... tipEnabled={false} />
    }
    
    // 5. 获取订阅类型
    subscriptionType = profile?.subscription_type || null
    
    // 6. 获取打赏功能状态（从 profiles.tip_enabled）
    tipEnabled = profile?.tip_enabled || false
    
    // 7. 验证打赏订阅状态
    if (tipEnabled) {
      const { data: tipSubscription } = await supabase
        .from('subscriptions')
        .select('status, expires_at')
        .eq('user_id', validUser.id)
        .eq('subscription_type', 'tip')
        .eq('status', 'active')
        .gt('expires_at', new Date().toISOString())
        .single()
      
      // 如果订阅过期，设置 tipEnabled = false
      if (!tipSubscription) {
        tipEnabled = false
      }
    }
  }
  
  // 8. 查询帖子数据（个性化：优先显示关注用户的帖子）
  // ...
  
  // 9. 渲染 HomePageClient
  return (
    <HomePageClient
      initialPosts={posts}
      user={validUser}
      subscriptionType={subscriptionType}
      tipEnabled={tipEnabled}
      ...
    />
  )
}
```

### 2.3 推演结果

✅ **正常流程**：
- 用户认证成功：`validUser` 不为 null
- Profile 查询成功：获取 `status`, `subscription_type`, `role`
- 账户状态检查通过：`status` 不是 'deleted', 'banned', 'suspended'
- 订阅类型识别：`subscriptionType = 'seller'`（因为 `profiles.subscription_type = 'seller'`）
- 打赏功能检查：`tipEnabled = true`（从 `profiles.tip_enabled` 读取）
- 打赏订阅验证：检查 `subscriptions` 表，确认有 active 的 `tip` 订阅
- 数据查询成功：获取帖子列表（个性化：优先显示关注用户的帖子）

⚠️ **发现的问题**：

1. **P1 - 未检查卖家订阅状态**
   - 代码只检查了 `tip` 订阅，**未检查 `seller` 订阅是否 active**
   - 如果 `subscription_type = 'seller'` 但 `seller` 订阅过期，`subscriptionType` 仍会被设置为 'seller'
   - **影响**：用户可能看到卖家入口，但实际无法使用卖家功能

2. **P1 - 未检查带货订阅状态**
   - 代码**完全没有检查 `affiliate` 订阅状态**
   - 如果用户有 `affiliate` 订阅但过期，系统无法识别
   - **影响**：用户可能看到带货功能，但实际无法使用

3. **P2 - 订阅类型判断不准确**
   - `subscriptionType` 只从 `profiles.subscription_type` 读取
   - 但用户可能同时拥有多个订阅类型（tip, seller, affiliate）
   - **影响**：只能识别一个订阅类型，无法完整展示所有功能

4. **P2 - 缺少带货功能标识**
   - 代码没有查询或传递 `affiliate` 订阅状态
   - `HomePageClient` 无法知道用户是否有带货功能
   - **影响**：首页无法显示带货功能相关的提示或入口

### 2.4 修复建议

```typescript
// src/app/[locale]/(main)/page.tsx
if (validUser) {
  // ... 现有的 profile 查询 ...
  
  // 检查所有订阅类型
  const subscriptionChecks = {
    tip: false,
    seller: false,
    affiliate: false,
  }
  
  // 检查 tip 订阅
  if (profile?.tip_enabled) {
    const { data: tipSubscription } = await supabase
      .from('subscriptions')
      .select('status, expires_at')
      .eq('user_id', validUser.id)
      .eq('subscription_type', 'tip')
      .eq('status', 'active')
      .gt('expires_at', new Date().toISOString())
      .single()
    subscriptionChecks.tip = !!tipSubscription
  }
  
  // 检查 seller 订阅
  const { data: sellerSubscription } = await supabase
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', validUser.id)
    .eq('subscription_type', 'seller')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  subscriptionChecks.seller = !!sellerSubscription
  
  // 检查 affiliate 订阅
  const { data: affiliateSubscription } = await supabase
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', validUser.id)
    .eq('subscription_type', 'affiliate')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  subscriptionChecks.affiliate = !!affiliateSubscription
  
  // 更新 subscriptionType（优先 seller，因为这是主要功能）
  subscriptionType = subscriptionChecks.seller ? 'seller' : 
                    subscriptionChecks.affiliate ? 'affiliate' : 
                    subscriptionChecks.tip ? 'tip' : null
  
  // 更新 tipEnabled（基于实际订阅状态）
  tipEnabled = subscriptionChecks.tip
}
```

---

## Step 3: Server Component 数据查询

### 3.1 代码路径
`src/app/[locale]/(main)/page.tsx` (续)

### 3.2 执行流程

```typescript
// 查询帖子数据
let postsQuery = supabase
  .from('posts')
  .select(`
    *,
    user:profiles!posts_user_id_fkey (
      username,
      display_name,
      avatar_url
    ),
    topics:post_topics (
      topic:topics (
        id,
        name,
        slug
      )
    )
  `)
  .eq('status', 'approved')

// 个性化：已登录用户优先显示关注用户的帖子
if (validUser) {
  // 1. 获取关注列表
  const { data: following } = await supabase
    .from('follows')
    .select('following_id')
    .eq('follower_id', validUser.id)
  
  const followingIds = following?.map(f => f.following_id) || []
  
  if (followingIds.length > 0) {
    // 2. 获取关注用户的帖子（最多10条）
    const { data: followingPosts } = await supabase
      .from('posts')
      .select(...)
      .eq('status', 'approved')
      .in('user_id', followingIds)
      .order('created_at', { ascending: false })
      .limit(10)
    
    // 3. 获取热门帖子（排除已关注的用户）
    const remaining = POSTS_PER_PAGE - (followingPosts?.length || 0)
    const { data: allPopularPosts } = await supabase
      .from('posts')
      .select(...)
      .eq('status', 'approved')
      .order('like_count', { ascending: false })
      .order('created_at', { ascending: false })
      .limit(remaining * 2)
    
    const popularPosts = (allPopularPosts || [])
      .filter(post => !followingIds.includes(post.user_id))
      .slice(0, remaining)
    
    // 4. 合并并去重
    const allPosts = [...(followingPosts || []), ...(popularPosts || [])]
    const uniquePosts = Array.from(
      new Map(allPosts.map(post => [post.id, post])).values()
    )
    
    posts = uniquePosts.map(...)
  }
} else {
  // 未登录用户：显示最新帖子
  const { data: postsData } = await postsQuery
    .order('created_at', { ascending: false })
    .limit(POSTS_PER_PAGE)
  
  posts = (postsData || []).map(...)
}
```

### 3.3 推演结果

✅ **正常流程**：
- 帖子查询成功：获取已审核的帖子（`status = 'approved'`）
- 个性化内容：优先显示关注用户的帖子
- 数据转换成功：将数据库格式转换为前端需要的格式
- 包含用户信息：每个帖子包含作者的用户名、显示名称、头像
- 包含话题信息：每个帖子包含关联的话题

⚠️ **发现的问题**：

1. **P2 - 未查询带货商品数据**
   - 代码只查询了 `posts` 表，**没有查询 `products` 表或 `affiliate_products` 表**
   - 如果用户有带货功能，首页应该显示可推广的商品
   - **影响**：带货功能用户无法在首页看到可推广的商品列表

2. **P2 - 未查询卖家商品数据**
   - 代码没有查询用户自己的商品（如果用户是卖家）
   - 卖家应该能在首页看到自己商品的推广入口
   - **影响**：卖家无法在首页快速访问自己的商品管理

3. **P3 - 帖子中未包含商品关联信息**
   - 帖子查询没有包含 `post_type = 'affiliate'` 的帖子关联的商品信息
   - 如果帖子是带货帖子，应该显示关联的商品
   - **影响**：带货帖子无法在首页显示商品信息

### 3.4 修复建议

```typescript
// src/app/[locale]/(main)/page.tsx
// 在查询帖子后，如果用户有带货或卖家功能，查询相关商品

// 查询可推广的商品（如果用户有 affiliate 订阅）
let affiliateProducts = []
if (subscriptionChecks.affiliate) {
  const { data: products } = await supabase
    .from('products')
    .select(`
      *,
      seller:profiles!products_seller_id_fkey(username, display_name),
      affiliate_products(commission_rate)
    `)
    .eq('allow_affiliate', true)
    .eq('status', 'active')
    .order('created_at', { ascending: false })
    .limit(10)
  
  affiliateProducts = products || []
}

// 查询用户自己的商品（如果用户是卖家）
let sellerProducts = []
if (subscriptionChecks.seller) {
  const { data: products } = await supabase
    .from('products')
    .select('*')
    .eq('seller_id', validUser.id)
    .eq('status', 'active')
    .order('created_at', { ascending: false })
    .limit(5)
  
  sellerProducts = products || []
}

// 传递到 HomePageClient
return (
  <HomePageClient
    initialPosts={posts}
    affiliateProducts={affiliateProducts}
    sellerProducts={sellerProducts}
    ...
  />
)
```

---

## Step 4: Client Component 渲染

### 4.1 代码路径
`src/app/[locale]/(main)/HomePageClient.tsx`

### 4.2 执行流程

```typescript
// src/app/[locale]/(main)/HomePageClient.tsx
export function HomePageClient({ 
  initialPosts, 
  user: initialUser,
  subscriptionType: initialSubscriptionType,
  tipEnabled: initialTipEnabled = false,
  translations 
}: HomePageClientProps) {
  const { user, loading: authLoading } = useAuth()
  
  // 使用 server 传递的值确保 hydration 一致性
  const effectiveUser = authLoading ? initialUser : user
  const effectiveSubscriptionType = initialSubscriptionType
  const isSeller = effectiveSubscriptionType === 'seller'
  const effectiveTipEnabled = initialTipEnabled
  
  // 使用 React Query 加载更多帖子
  const { data, fetchNextPage, hasNextPage, isFetchingNextPage } = usePosts('approved', {
    enabled: !authLoading || initialPosts.length > 0,
    initialData: initialPosts.length > 0 ? {
      pages: [initialPosts],
      pageParams: [0],
    } : undefined,
  })
  
  const posts = data?.pages.flatMap((page) => page) || initialPosts
  
  return (
    <div className="mx-auto max-w-7xl px-2 sm:px-4">
      <OnboardingGuide />
      
      {/* 卖家入口提示 */}
      {isSeller && effectiveUser && (
        <div className="mb-6 rounded-lg border border-blue-200 bg-blue-50/50 p-4">
          <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
            <div>
              <h3 className="text-base font-semibold">卖家中心</h3>
              <p className="mt-1 text-sm">管理您的商品和订单</p>
            </div>
            <Link href="/seller/dashboard">
              <Button size="sm">进入卖家中心</Button>
            </Link>
          </div>
        </div>
      )}
      
      {/* 打赏功能提示 */}
      {effectiveTipEnabled && effectiveUser && (
        <div className="mb-6 rounded-lg border border-green-200 bg-green-50/50 p-4">
          <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
            <div>
              <h3 className="text-base font-semibold">打赏功能已启用</h3>
              <p className="mt-1 text-sm">您可以为喜欢的创作者打赏支持</p>
            </div>
            <Link href="/subscription/tip">
              <Button size="sm" variant="outline">管理订阅</Button>
            </Link>
          </div>
        </div>
      )}
      
      <h1 className="mb-6 text-2xl font-bold">{translations.discover}</h1>
      
      {/* 帖子列表 */}
      <MasonryGrid>
        {posts.map((post) => (
          <PostCard key={post.id} post={post} />
        ))}
      </MasonryGrid>
      
      {/* 加载更多 */}
      {hasNextPage && (
        <Button onClick={() => fetchNextPage()} disabled={isFetchingNextPage}>
          {isFetchingNextPage ? '加载中...' : translations.loadingMore}
        </Button>
      )}
    </div>
  )
}
```

### 4.3 推演结果

✅ **正常流程**：
- 卖家入口显示：`isSeller = true` 且 `effectiveUser` 不为 null，显示卖家中心提示卡片
- 打赏功能提示显示：`effectiveTipEnabled = true` 且 `effectiveUser` 不为 null，显示打赏功能提示卡片
- 帖子列表渲染：使用 `MasonryGrid` 和 `PostCard` 组件渲染帖子
- 加载更多功能：支持无限滚动加载更多帖子

⚠️ **发现的问题**：

1. **P1 - 缺少带货功能提示**
   - 代码**没有检查或显示带货功能相关的提示**
   - 如果用户有 `affiliate` 订阅，应该显示带货中心入口
   - **影响**：带货功能用户无法在首页看到带货功能入口

2. **P2 - PostCard 中未显示打赏按钮**
   - `PostCard` 组件**没有包含 `TipButton` 组件**
   - 打赏按钮只在帖子详情页（`/post/[id]`）中显示
   - **影响**：用户需要在首页点击进入详情页才能打赏，体验不够便捷

3. **P2 - 未显示可推广商品列表**
   - 代码没有显示可推广的商品列表（即使查询了 `affiliateProducts`）
   - 带货功能用户应该能在首页看到可推广的商品
   - **影响**：带货功能入口不明确，用户不知道可以推广哪些商品

4. **P3 - 卖家商品入口不明确**
   - 只有"进入卖家中心"按钮，没有直接的商品管理入口
   - 卖家应该能在首页看到自己商品的快速入口
   - **影响**：卖家需要多步操作才能管理商品

### 4.4 修复建议

```typescript
// src/app/[locale]/(main)/HomePageClient.tsx
interface HomePageClientProps {
  // ... 现有属性 ...
  affiliateEnabled?: boolean  // 新增：带货功能是否启用
  affiliateProducts?: Product[]  // 新增：可推广的商品列表
  sellerProducts?: Product[]  // 新增：卖家自己的商品列表
}

export function HomePageClient({ 
  initialPosts,
  subscriptionType: initialSubscriptionType,
  tipEnabled: initialTipEnabled = false,
  affiliateEnabled: initialAffiliateEnabled = false,  // 新增
  affiliateProducts = [],  // 新增
  sellerProducts = [],  // 新增
  ...
}: HomePageClientProps) {
  // ...
  const isAffiliate = initialAffiliateEnabled  // 新增
  
  return (
    <div className="mx-auto max-w-7xl px-2 sm:px-4">
      <OnboardingGuide />
      
      {/* 卖家入口提示 */}
      {isSeller && effectiveUser && (
        <div className="mb-6 rounded-lg border border-blue-200 bg-blue-50/50 p-4">
          {/* ... 现有内容 ... */}
          {/* 新增：快速商品管理入口 */}
          {sellerProducts.length > 0 && (
            <div className="mt-4">
              <Link href="/seller/products">
                <Button variant="outline" size="sm">
                  管理 {sellerProducts.length} 个商品
                </Button>
              </Link>
            </div>
          )}
        </div>
      )}
      
      {/* 打赏功能提示 */}
      {effectiveTipEnabled && effectiveUser && (
        {/* ... 现有内容 ... */}
      )}
      
      {/* 新增：带货功能提示 */}
      {isAffiliate && effectiveUser && (
        <div className="mb-6 rounded-lg border border-purple-200 bg-purple-50/50 p-4">
          <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
            <div>
              <h3 className="text-base font-semibold">带货功能已启用</h3>
              <p className="mt-1 text-sm">推广商品赚取佣金</p>
            </div>
            <Link href="/affiliate/products">
              <Button size="sm" variant="outline">进入带货中心</Button>
            </Link>
          </div>
          {/* 显示可推广商品预览 */}
          {affiliateProducts.length > 0 && (
            <div className="mt-4">
              <p className="text-sm text-muted-foreground mb-2">
                可推广 {affiliateProducts.length} 个商品
              </p>
              <div className="flex gap-2 overflow-x-auto">
                {affiliateProducts.slice(0, 5).map((product) => (
                  <Link key={product.id} href={`/affiliate/products/${product.id}/promote`}>
                    <Card className="p-2 min-w-[120px]">
                      {product.images?.[0] && (
                        <Image src={product.images[0]} alt={product.name} width={100} height={100} />
                      )}
                      <p className="text-xs mt-1 truncate">{product.name}</p>
                    </Card>
                  </Link>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
      
      {/* ... 现有帖子列表 ... */}
    </div>
  )
}
```

---

## Step 5: PostCard 组件分析

### 5.1 代码路径
`src/components/social/PostCard.tsx`

### 5.2 执行流程

```typescript
// src/components/social/PostCard.tsx
function PostCardComponent({ post }: PostCardProps) {
  const { user } = useAuth()
  
  return (
    <Card onClick={handleCardClick}>
      {/* 帖子图片 */}
      {post.image_urls && post.image_urls.length > 0 && (
        <Image src={post.image_urls[0]} ... />
      )}
      
      {/* 帖子内容 */}
      <div className="p-3 md:p-4">
        {/* 帖子文本 */}
        {post.content && (
          <p className="mb-3 line-clamp-3">{post.content}</p>
        )}
        
        {/* 话题标签 */}
        {post.topics && post.topics.length > 0 && (
          <div className="mb-3 flex flex-wrap gap-2">
            {post.topics.map((topic) => (
              <TopicTag key={topic.id} topic={topic} />
            ))}
          </div>
        )}
        
        {/* 操作按钮 */}
        <div className="flex items-center justify-center gap-1 sm:gap-2 md:gap-4">
          <LikeButton postId={post.id} initialLikes={post.like_count} />
          <Link href={`/post/${post.id}`}>
            <Button variant="ghost" size="sm">
              <MessageCircle className="h-4 w-4" />
              <span>{post.comment_count}</span>
            </Button>
          </Link>
          <FavoriteButton postId={post.id} initialFavorites={post.favorite_count ?? 0} />
        </div>
        
        {/* 用户信息 */}
        {post.user && (
          <div className="mt-3 flex items-center justify-between">
            <Link href={`/profile/${post.user_id}`}>
              {/* 用户头像和名称 */}
            </Link>
            {/* 更多操作菜单 */}
          </div>
        )}
      </div>
    </Card>
  )
}
```

### 5.3 推演结果

✅ **正常流程**：
- 帖子内容渲染：显示帖子文本、图片、话题标签
- 交互功能：点赞、评论、收藏按钮正常工作
- 用户信息显示：显示作者头像、名称，可点击跳转到用户主页
- 点击跳转：点击卡片跳转到帖子详情页

⚠️ **发现的问题**：

1. **P1 - 未显示打赏按钮**
   - `PostCard` 组件**没有包含 `TipButton` 组件**
   - 打赏按钮只在帖子详情页（`/post/[id]/page.tsx`）中显示
   - **影响**：用户需要在首页点击进入详情页才能打赏，体验不够便捷

2. **P2 - 未显示商品关联信息**
   - 如果帖子是带货帖子（`post_type = 'affiliate'`），应该显示关联的商品
   - 代码没有查询或显示 `affiliate_products` 或 `post_products` 关联
   - **影响**：带货帖子无法在首页显示商品信息，用户无法直接看到可购买的商品

3. **P3 - 未显示打赏金额**
   - 帖子数据包含 `tip_amount` 字段，但组件没有显示
   - 应该显示该帖子收到的总打赏金额
   - **影响**：用户无法在首页看到帖子的打赏情况

### 5.4 修复建议

```typescript
// src/components/social/PostCard.tsx
import { TipButton } from './TipButton'
import { useProfile } from '@/lib/hooks/useProfile'

function PostCardComponent({ post }: PostCardProps) {
  const { user } = useAuth()
  const { data: profile } = useProfile(user?.id ?? '')
  const tipEnabled = !!profile?.tip_enabled
  
  return (
    <Card onClick={handleCardClick}>
      {/* ... 现有内容 ... */}
      
      {/* 操作按钮区域 */}
      <div className="flex items-center justify-center gap-1 sm:gap-2 md:gap-4">
        <LikeButton postId={post.id} initialLikes={post.like_count} />
        <Link href={`/post/${post.id}`}>
          <Button variant="ghost" size="sm">
            <MessageCircle className="h-4 w-4" />
            <span>{post.comment_count}</span>
          </Button>
        </Link>
        <FavoriteButton postId={post.id} initialFavorites={post.favorite_count ?? 0} />
        
        {/* 新增：打赏按钮（如果用户已登录且启用了打赏功能） */}
        {user && tipEnabled && user.id !== post.user_id && (
          <div onClick={(e) => e.stopPropagation()}>
            <TipButton
              postId={post.id}
              postAuthorId={post.user_id}
              currentAmount={post.tip_amount || 0}
            />
          </div>
        )}
      </div>
      
      {/* 新增：显示打赏金额 */}
      {post.tip_amount > 0 && (
        <div className="mt-2 text-xs text-muted-foreground">
          已收到打赏 ¥{post.tip_amount.toFixed(2)}
        </div>
      )}
      
      {/* 新增：显示关联商品（如果是带货帖子） */}
      {post.post_type === 'affiliate' && post.products && post.products.length > 0 && (
        <div className="mt-3 border-t pt-3">
          <p className="text-xs text-muted-foreground mb-2">关联商品：</p>
          <div className="flex gap-2 overflow-x-auto">
            {post.products.slice(0, 3).map((product) => (
              <Link
                key={product.id}
                href={`/product/${product.id}`}
                onClick={(e) => e.stopPropagation()}
              >
                <Card className="p-2 min-w-[100px]">
                  {product.images?.[0] && (
                    <Image src={product.images[0]} alt={product.name} width={80} height={80} />
                  )}
                  <p className="text-xs mt-1 truncate">{product.name}</p>
                  <p className="text-xs font-semibold">¥{product.price.toFixed(2)}</p>
                </Card>
              </Link>
            ))}
          </div>
        </div>
      )}
      
      {/* ... 现有用户信息 ... */}
    </Card>
  )
}
```

---

## Step 6: API 调用权限检查

### 6.1 打赏 API 权限检查

#### 6.1.1 代码路径
`src/app/api/payments/stripe/create-tip-session/route.ts`

#### 6.1.2 执行流程

```typescript
export async function POST(request: NextRequest) {
  // 1. 用户认证
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  // 2. 参数验证
  const { amount, postId, postAuthorId, ... } = await request.json()
  if (!amount || !postId || !postAuthorId) {
    return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
  }
  
  // 3. 检查打赏功能是否启用
  const tipEnabled = await checkTipEnabled(user.id, supabaseAdmin)
  if (!tipEnabled) {
    return NextResponse.json(
      { error: 'Tip feature subscription required. Please subscribe to enable tipping.' },
      { status: 403 }
    )
  }
  
  // 4. 检查订阅状态
  const { data: tipSubscription } = await supabaseAdmin
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', user.id)
    .eq('subscription_type', 'tip')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  
  if (!tipSubscription) {
    return NextResponse.json(
      { error: 'Tip subscription expired or not found. Please renew your subscription.' },
      { status: 403 }
    )
  }
  
  // 5. 检查打赏限制
  const limitCheck = await checkTipLimits(...)
  if (!limitCheck.allowed) {
    return NextResponse.json(
      { error: limitCheck.reason || 'Tip limit exceeded' },
      { status: 400 }
    )
  }
  
  // 6. 创建支付会话
  const session = await createCheckoutSession(...)
  return NextResponse.json({ url: session.url })
}
```

#### 6.1.3 推演结果

✅ **正常流程**：
- 用户认证：检查用户是否已登录
- 打赏功能检查：使用 `checkTipEnabled` 函数检查 `profiles.tip_enabled`
- 订阅状态检查：检查 `subscriptions` 表中是否有 active 的 `tip` 订阅
- 打赏限制检查：检查打赏金额和次数限制
- 权限控制严格：多重验证确保只有有效订阅用户才能打赏

✅ **权限控制严格**：
- 未登录用户：返回 401 Unauthorized
- 未启用打赏功能：返回 403 Forbidden
- 订阅过期：返回 403 Forbidden
- 打赏限制超限：返回 400 Bad Request

### 6.2 卖家 API 权限检查

#### 6.2.1 代码路径示例
`src/app/api/orders/create/route.ts`（订单创建）

#### 6.2.2 执行流程

```typescript
// 卖家相关 API 通常使用 useSellerGuard 或直接检查 subscription_type
// 示例：订单创建 API
export async function POST(request: NextRequest) {
  // 1. 用户认证
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  // 2. 检查卖家权限（通常检查 subscription_type 或 role）
  const { data: profile } = await supabase
    .from('profiles')
    .select('subscription_type, role')
    .eq('id', user.id)
    .single()
  
  // 注意：不同 API 的检查方式可能不同
  // 有些检查 subscription_type === 'seller'
  // 有些检查 role === 'seller'
}
```

#### 6.2.3 推演结果

⚠️ **发现的问题**：

1. **P1 - 卖家权限检查不一致**
   - 不同 API 使用不同的检查方式：
     - 有些检查 `subscription_type === 'seller'`
     - 有些检查 `role === 'seller'`
     - 有些使用 `useSellerGuard` hook
   - **影响**：权限检查不统一，可能导致某些 API 的权限绕过

2. **P1 - 未检查卖家订阅状态**
   - 大多数卖家 API **只检查 `subscription_type` 或 `role`，不检查订阅是否 active**
   - 如果订阅过期，用户仍可能访问卖家 API
   - **影响**：过期订阅用户可能仍能使用卖家功能

3. **P2 - 缺少统一的卖家权限检查函数**
   - 没有类似 `checkTipEnabled` 的统一函数来检查卖家权限
   - 每个 API 都需要自己实现权限检查
   - **影响**：代码重复，容易出错

### 6.3 带货 API 权限检查

#### 6.3.1 代码路径
`src/app/api/affiliate/posts/create/route.ts`

#### 6.3.2 执行流程

```typescript
export async function POST(request: NextRequest) {
  // 1. 用户认证
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  // 2. 检查带货订阅
  const { data: subscription } = await supabase
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', user.id)
    .eq('subscription_type', 'affiliate')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  
  if (!subscription) {
    return NextResponse.json(
      { error: 'Affiliate subscription required' },
      { status: 403 }
    )
  }
  
  // 3. 创建带货帖子
  // ...
}
```

#### 6.3.3 推演结果

✅ **正常流程**：
- 用户认证：检查用户是否已登录
- 订阅状态检查：检查 `subscriptions` 表中是否有 active 的 `affiliate` 订阅
- 权限控制严格：只有有效订阅用户才能创建带货帖子

✅ **权限控制严格**：
- 未登录用户：返回 401 Unauthorized
- 无有效订阅：返回 403 Forbidden

### 6.4 修复建议

```typescript
// src/lib/auth/check-subscription.ts
/**
 * 统一的订阅状态检查函数
 */
export async function checkSubscriptionStatus(
  userId: string,
  subscriptionType: 'tip' | 'seller' | 'affiliate',
  supabaseAdmin: SupabaseClient
): Promise<{ hasActive: boolean; subscription: any | null }> {
  const { data: subscription, error } = await supabaseAdmin
    .from('subscriptions')
    .select('*')
    .eq('user_id', userId)
    .eq('subscription_type', subscriptionType)
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  
  return {
    hasActive: !!subscription && !error,
    subscription: subscription || null,
  }
}

/**
 * 检查卖家权限（包括订阅状态）
 */
export async function checkSellerPermission(
  userId: string,
  supabaseAdmin: SupabaseClient
): Promise<{ hasPermission: boolean; reason?: string }> {
  // 1. 检查 profile
  const { data: profile } = await supabaseAdmin
    .from('profiles')
    .select('subscription_type, role')
    .eq('id', userId)
    .single()
  
  if (profile?.subscription_type !== 'seller' && profile?.role !== 'seller') {
    return { hasPermission: false, reason: 'User is not a seller' }
  }
  
  // 2. 检查订阅状态
  const { hasActive } = await checkSubscriptionStatus(userId, 'seller', supabaseAdmin)
  if (!hasActive) {
    return { hasPermission: false, reason: 'Seller subscription expired or not found' }
  }
  
  return { hasPermission: true }
}

/**
 * 检查带货权限（包括订阅状态）
 */
export async function checkAffiliatePermission(
  userId: string,
  supabaseAdmin: SupabaseClient
): Promise<{ hasPermission: boolean; reason?: string }> {
  const { hasActive } = await checkSubscriptionStatus(userId, 'affiliate', supabaseAdmin)
  if (!hasActive) {
    return { hasPermission: false, reason: 'Affiliate subscription expired or not found' }
  }
  
  return { hasPermission: true }
}
```

---

## Step 7: 边界情况分析

### 7.1 订阅过期情况

#### 7.1.1 打赏订阅过期

**场景**：用户有 `profiles.tip_enabled = true`，但 `subscriptions` 表中 `tip` 订阅已过期

**当前行为**：
- `middleware.ts`：记录警告，但不阻止访问
- `page.tsx`：检查订阅状态，如果过期则设置 `tipEnabled = false`
- `HomePageClient`：不显示打赏功能提示
- `TipButton`：检查 `profile.tip_enabled`，如果为 false 则显示"启用打赏"按钮
- API：检查订阅状态，如果过期则返回 403

**问题**：
- ⚠️ **P2 - 数据不一致**：如果 `tip_enabled = true` 但订阅过期，需要等待页面组件检查才能更新
- ⚠️ **P2 - 用户体验**：用户可能看到打赏按钮，但点击后才发现订阅过期

**修复建议**：
- 在 `middleware.ts` 中检查订阅状态，如果过期则更新 `profiles.tip_enabled = false`
- 或者在 cron job 中定期清理过期的功能标志

#### 7.1.2 卖家订阅过期

**场景**：用户有 `profiles.subscription_type = 'seller'`，但 `subscriptions` 表中 `seller` 订阅已过期

**当前行为**：
- `middleware.ts`：不检查卖家订阅状态
- `page.tsx`：不检查卖家订阅状态，`subscriptionType` 仍为 'seller'
- `HomePageClient`：显示卖家入口提示
- API：大多数 API 不检查订阅状态，只检查 `subscription_type` 或 `role`

**问题**：
- ⚠️ **P1 - 权限绕过**：过期订阅用户仍可能访问卖家功能
- ⚠️ **P1 - 数据不一致**：`subscription_type = 'seller'` 但实际订阅已过期

**修复建议**：
- 在所有卖家 API 中添加订阅状态检查
- 在 `page.tsx` 中检查卖家订阅状态，如果过期则不显示卖家入口

#### 7.1.3 带货订阅过期

**场景**：用户有 `affiliate` 订阅，但已过期

**当前行为**：
- `middleware.ts`：不检查带货订阅状态
- `page.tsx`：不检查带货订阅状态
- `HomePageClient`：不显示带货功能提示（因为代码中没有检查）
- API：检查订阅状态，如果过期则返回 403

**问题**：
- ⚠️ **P2 - 功能入口缺失**：即使订阅有效，首页也不显示带货功能入口
- ⚠️ **P2 - 数据不一致**：如果订阅过期，系统无法识别

**修复建议**：
- 在 `page.tsx` 中检查带货订阅状态
- 在 `HomePageClient` 中显示带货功能提示

### 7.2 Session 过期情况

**场景**：用户 session 过期，但仍在浏览器中

**当前行为**：
- `middleware.ts`：`supabase.auth.getUser()` 返回错误，`user = null`
- `page.tsx`：`validUser = null`，按未登录用户处理
- `HomePageClient`：不显示任何功能提示
- API：返回 401 Unauthorized

**问题**：
- ✅ **正常**：系统正确处理 session 过期，按未登录用户处理

### 7.3 用户禁用功能情况

**场景**：用户手动禁用了打赏功能（`profiles.tip_enabled = false`），但订阅仍有效

**当前行为**：
- `middleware.ts`：不检查 `tip_enabled`
- `page.tsx`：`tipEnabled = false`（从 `profiles.tip_enabled` 读取）
- `HomePageClient`：不显示打赏功能提示
- `TipButton`：显示"启用打赏"按钮，链接到订阅页面
- API：`checkTipEnabled` 返回 false，返回 403

**问题**：
- ✅ **正常**：系统正确处理功能禁用

### 7.4 多订阅类型冲突

**场景**：用户同时拥有 `tip`、`seller`、`affiliate` 三个订阅，但部分过期

**当前行为**：
- `middleware.ts`：只检查 `tip` 订阅
- `page.tsx`：只检查 `tip` 订阅，`subscriptionType` 只取一个值（优先 `seller`）
- `HomePageClient`：只显示一个订阅类型的提示

**问题**：
- ⚠️ **P2 - 功能展示不完整**：用户可能同时拥有多个功能，但首页只显示一个
- ⚠️ **P2 - 订阅状态检查不完整**：只检查了部分订阅类型

**修复建议**：
- 在 `page.tsx` 中检查所有订阅类型
- 在 `HomePageClient` 中显示所有启用的功能提示

---

## Step 8: 结论与修复建议

### 8.1 功能渲染总结

| 功能 | Server Component 检查 | Client Component 显示 | API 权限检查 | 状态 |
|------|----------------------|---------------------|------------|------|
| 打赏功能 | ✅ 检查 `tip_enabled` 和订阅状态 | ✅ 显示提示卡片 | ✅ 严格检查 | ✅ 正常 |
| 卖家功能 | ⚠️ 只检查 `subscription_type` | ✅ 显示入口提示 | ⚠️ 部分 API 未检查订阅状态 | ⚠️ 有问题 |
| 带货功能 | ❌ 未检查 | ❌ 未显示 | ✅ 严格检查 | ❌ 缺失 |

### 8.2 发现的问题汇总

#### P0 - 严重问题（需要立即修复）

无

#### P1 - 重要问题（需要尽快修复）

1. **卖家订阅状态检查缺失**
   - **位置**：`src/app/[locale]/(main)/page.tsx`
   - **问题**：只检查 `subscription_type`，不检查订阅是否 active
   - **影响**：过期订阅用户仍可能看到卖家入口
   - **修复**：添加卖家订阅状态检查

2. **带货功能检查缺失**
   - **位置**：`src/app/[locale]/(main)/page.tsx`, `src/app/[locale]/(main)/HomePageClient.tsx`
   - **问题**：完全没有检查或显示带货功能
   - **影响**：带货功能用户无法在首页看到功能入口
   - **修复**：添加带货订阅状态检查和 UI 显示

3. **卖家 API 权限检查不一致**
   - **位置**：多个卖家相关 API
   - **问题**：不同 API 使用不同的权限检查方式，部分未检查订阅状态
   - **影响**：可能导致权限绕过
   - **修复**：统一使用 `checkSellerPermission` 函数

#### P2 - 次要问题（建议修复）

1. **PostCard 中未显示打赏按钮**
   - **位置**：`src/components/social/PostCard.tsx`
   - **问题**：打赏按钮只在详情页显示
   - **影响**：用户体验不够便捷
   - **修复**：在 PostCard 中添加 TipButton（如果用户启用了打赏功能）

2. **未查询带货商品数据**
   - **位置**：`src/app/[locale]/(main)/page.tsx`
   - **问题**：没有查询可推广的商品列表
   - **影响**：带货功能用户无法在首页看到可推广的商品
   - **修复**：添加商品查询逻辑

3. **未显示帖子关联商品**
   - **位置**：`src/components/social/PostCard.tsx`
   - **问题**：带货帖子未显示关联的商品信息
   - **影响**：用户无法在首页看到可购买的商品
   - **修复**：在 PostCard 中显示关联商品

4. **多订阅类型支持不完整**
   - **位置**：`src/app/[locale]/(main)/page.tsx`, `src/app/[locale]/(main)/HomePageClient.tsx`
   - **问题**：只支持显示一个订阅类型的提示
   - **影响**：多订阅用户无法看到所有功能入口
   - **修复**：支持同时显示多个功能提示

### 8.3 修复优先级

1. **立即修复（P1）**：
   - 添加卖家订阅状态检查
   - 添加带货功能检查和显示
   - 统一卖家 API 权限检查

2. **尽快修复（P2）**：
   - 在 PostCard 中添加打赏按钮
   - 添加商品数据查询和显示
   - 支持多订阅类型显示

### 8.4 修复文件清单

#### 需要修改的文件：

1. `src/app/[locale]/(main)/page.tsx`
   - 添加卖家订阅状态检查
   - 添加带货订阅状态检查
   - 查询可推广商品和卖家商品

2. `src/app/[locale]/(main)/HomePageClient.tsx`
   - 添加带货功能提示卡片
   - 支持显示多个功能提示
   - 添加商品预览

3. `src/components/social/PostCard.tsx`
   - 添加打赏按钮（如果用户启用了打赏功能）
   - 显示打赏金额
   - 显示关联商品（如果是带货帖子）

4. `src/lib/auth/check-subscription.ts`（新建）
   - 创建统一的订阅状态检查函数
   - 创建卖家权限检查函数
   - 创建带货权限检查函数

5. `src/lib/supabase/middleware.ts`
   - 添加所有订阅类型的状态检查（可选，仅记录警告）

6. 所有卖家相关 API
   - 统一使用 `checkSellerPermission` 函数

---

## 附录：代码修改示例

### A. 添加订阅状态检查（page.tsx）

```typescript
// src/app/[locale]/(main)/page.tsx
if (validUser) {
  // ... 现有的 profile 查询 ...
  
  // 检查所有订阅类型
  const subscriptionChecks = {
    tip: false,
    seller: false,
    affiliate: false,
  }
  
  // 检查 tip 订阅
  if (profile?.tip_enabled) {
    const { data: tipSubscription } = await supabase
      .from('subscriptions')
      .select('status, expires_at')
      .eq('user_id', validUser.id)
      .eq('subscription_type', 'tip')
      .eq('status', 'active')
      .gt('expires_at', new Date().toISOString())
      .single()
    subscriptionChecks.tip = !!tipSubscription
  }
  
  // 检查 seller 订阅
  const { data: sellerSubscription } = await supabase
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', validUser.id)
    .eq('subscription_type', 'seller')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  subscriptionChecks.seller = !!sellerSubscription
  
  // 检查 affiliate 订阅
  const { data: affiliateSubscription } = await supabase
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', validUser.id)
    .eq('subscription_type', 'affiliate')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  subscriptionChecks.affiliate = !!affiliateSubscription
  
  // 更新 subscriptionType（优先 seller）
  subscriptionType = subscriptionChecks.seller ? 'seller' : 
                    subscriptionChecks.affiliate ? 'affiliate' : 
                    subscriptionChecks.tip ? 'tip' : null
  
  // 更新 tipEnabled
  tipEnabled = subscriptionChecks.tip
  
  // 查询可推广商品（如果用户有 affiliate 订阅）
  let affiliateProducts = []
  if (subscriptionChecks.affiliate) {
    const { data: products } = await supabase
      .from('products')
      .select(`
        *,
        seller:profiles!products_seller_id_fkey(username, display_name),
        affiliate_products(commission_rate)
      `)
      .eq('allow_affiliate', true)
      .eq('status', 'active')
      .order('created_at', { ascending: false })
      .limit(10)
    affiliateProducts = products || []
  }
  
  // 查询用户自己的商品（如果用户是卖家）
  let sellerProducts = []
  if (subscriptionChecks.seller) {
    const { data: products } = await supabase
      .from('products')
      .select('*')
      .eq('seller_id', validUser.id)
      .eq('status', 'active')
      .order('created_at', { ascending: false })
      .limit(5)
    sellerProducts = products || []
  }
}
```

### B. 添加带货功能提示（HomePageClient.tsx）

```typescript
// src/app/[locale]/(main)/HomePageClient.tsx
interface HomePageClientProps {
  // ... 现有属性 ...
  affiliateEnabled?: boolean
  affiliateProducts?: Product[]
  sellerProducts?: Product[]
}

export function HomePageClient({ 
  initialPosts,
  subscriptionType: initialSubscriptionType,
  tipEnabled: initialTipEnabled = false,
  affiliateEnabled: initialAffiliateEnabled = false,
  affiliateProducts = [],
  sellerProducts = [],
  ...
}: HomePageClientProps) {
  // ...
  const isAffiliate = initialAffiliateEnabled
  
  return (
    <div className="mx-auto max-w-7xl px-2 sm:px-4">
      {/* ... 现有内容 ... */}
      
      {/* 新增：带货功能提示 */}
      {isAffiliate && effectiveUser && (
        <div className="mb-6 rounded-lg border border-purple-200 bg-purple-50/50 p-4 dark:border-purple-800 dark:bg-purple-950/30">
          <div className="flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
            <div>
              <h3 className="text-base font-semibold text-purple-900 dark:text-purple-100">带货功能已启用</h3>
              <p className="mt-1 text-sm text-purple-700 dark:text-purple-300">推广商品赚取佣金</p>
            </div>
            <Link href="/affiliate/products">
              <Button size="sm" variant="outline" className="border-purple-600 text-purple-700 hover:bg-purple-100 dark:border-purple-500 dark:text-purple-400 dark:hover:bg-purple-950">
                进入带货中心
              </Button>
            </Link>
          </div>
          {affiliateProducts.length > 0 && (
            <div className="mt-4">
              <p className="text-sm text-purple-700 dark:text-purple-300 mb-2">
                可推广 {affiliateProducts.length} 个商品
              </p>
              <div className="flex gap-2 overflow-x-auto">
                {affiliateProducts.slice(0, 5).map((product) => (
                  <Link key={product.id} href={`/affiliate/products/${product.id}/promote`}>
                    <Card className="p-2 min-w-[120px]">
                      {product.images?.[0] && (
                        <Image src={product.images[0]} alt={product.name} width={100} height={100} />
                      )}
                      <p className="text-xs mt-1 truncate">{product.name}</p>
                    </Card>
                  </Link>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
      
      {/* ... 现有帖子列表 ... */}
    </div>
  )
}
```

---

**报告生成时间**：2026-01-25  
**推演用户类型**：同时开通打赏、带货、卖家功能的用户  
**系统版本**：基于当前代码库分析
