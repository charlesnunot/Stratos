# Stratos é‰´æƒç³»ç»Ÿå®æ–½è®¡åˆ’ V2.4

> åŸºäº V2.3 ç°æœ‰æ¶æ„çš„å¢é‡æ”¹è¿›æ–¹æ¡ˆ
> 
> æ–‡æ¡£ç‰ˆæœ¬: 1.0
> åˆ›å»ºæ—¥æœŸ: 2026-02-19
> çŠ¶æ€: å¾…ç¡®è®¤

---

## ä¸€ã€ç°çŠ¶è¯„ä¼°

### 1.1 å·²æœ‰èƒ½åŠ›ï¼ˆV2.3ï¼‰

| æ¨¡å— | å®ç°ä½ç½® | çŠ¶æ€ |
|------|---------|------|
| èº«ä»½è®¤è¯ | Supabase Auth | âœ… å®Œæ•´ |
| è§’è‰²æƒé™ | `profiles.role` (admin/support/user) | âœ… å®Œæ•´ |
| è®¢é˜…é‰´æƒ | `SubscriptionContext.tsx` + JWT Claims | âœ… å®Œæ•´ |
| å®¢æˆ·ç«¯å®ˆå« | `useSellerGuard`, `useAffiliateGuard`, `useTipGuard`, `useAdminGuard` | âœ… å®Œæ•´ |
| æœåŠ¡ç«¯å®ˆå« | `requireAdmin()`, `requireAdminOrSupport()` | âœ… å®Œæ•´ |
| JWT Claims åŒæ­¥ | `process-subscription-payment.ts:syncJWTClaimsAndNotify` | âœ… å®Œæ•´ |
| å®æ—¶æƒé™æ›´æ–° | Realtime `subscription_updated` äº‹ä»¶ | âœ… å®Œæ•´ |
| RLS ç­–ç•¥ | 367+ æ•°æ®åº“ç­–ç•¥ | âœ… å®Œæ•´ |
| å®¡è®¡æ—¥å¿— | `logAudit()` + `audit_logs` è¡¨ | âœ… åŸºç¡€å®Œæ•´ |
| Cron ä¿æŠ¤ | `verifyCronSecret()` | âœ… å®Œæ•´ |
| Webhook å®‰å…¨ | Stripe ç­¾åéªŒè¯å®Œæ•´ | âœ… å®Œæ•´ |

### 1.2 å¾…æ”¹è¿›é¡¹

| é—®é¢˜ | é£é™©ç­‰çº§ | å½±å“ |
|------|---------|------|
| Middleware æœªåšè·¯ç”±çº§é‰´æƒ | ğŸ”´ é«˜ | æœªç™»å½•ç”¨æˆ·å¯è®¿é—®éƒ¨åˆ†å—ä¿æŠ¤é¡µé¢ |
| API ç¼ºå°‘ç»Ÿä¸€é€Ÿç‡é™åˆ¶ | ğŸ”´ é«˜ | æ˜“å—æš´åŠ›ç ´è§£/æ»¥ç”¨æ”»å‡» |
| API é‰´æƒä»£ç é‡å¤ | ğŸŸ¡ ä¸­ | 100+ è·¯ç”±æ‰‹åŠ¨è°ƒç”¨ `getUser()`ï¼Œç»´æŠ¤æˆæœ¬é«˜ |
| èµ„æºæ‰€æœ‰æƒéªŒè¯åˆ†æ•£ | ğŸŸ¡ ä¸­ | å„è·¯ç”±è‡ªè¡Œå®ç°ï¼Œä¸ä¸€è‡´ |
| 401/403 å“åº”æ ¼å¼ä¸ç»Ÿä¸€ | ğŸŸ¡ ä¸­ | å‰ç«¯é”™è¯¯å¤„ç†å›°éš¾ |
| é‰´æƒæµ‹è¯•è¦†ç›–ä¸è¶³ | ğŸŸ¡ ä¸­ | å›å½’é£é™©é«˜ |
| ç®¡ç†å‘˜å®¡è®¡ä¸å®Œæ•´ | ğŸŸ¢ ä½ | éƒ¨åˆ†æ“ä½œæœªè®°å½• |

---

## äºŒã€å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒå®‰å…¨åŠ å›ºï¼ˆ1-2å‘¨ï¼‰

#### 2.1.1 Middleware è·¯ç”±ä¿æŠ¤å¢å¼º

**ç›®æ ‡**: åœ¨ middleware å±‚é¢æ‹¦æˆªæœªæˆæƒè®¿é—®

**å®æ–½å†…å®¹**:

```typescript
// middleware.ts å¢å¼ºé€»è¾‘
const protectedRoutes = {
  '/seller': { requires: ['authenticated', 'seller'] },
  '/affiliate': { requires: ['authenticated', 'affiliate'] },
  '/tip-center': { requires: ['authenticated', 'tip_enabled'] },
  '/admin': { requires: ['authenticated', 'admin'] },
  '/settings': { requires: ['authenticated'] },
  '/orders': { requires: ['authenticated'] },
  '/cart': { requires: ['authenticated'] },
  '/messages': { requires: ['authenticated'] },
}

const publicRoutes = [
  '/', '/login', '/register', '/products', '/product/[id]',
  '/post/[id]', '/profile/[id]', '/about', '/help', '/policies'
]
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æœªç™»å½•ç”¨æˆ·è®¿é—® `/seller/*` é‡å®šå‘åˆ° `/login`
- [ ] éå–å®¶è®¿é—® `/seller/*` é‡å®šå‘åˆ° `/seller/landing`
- [ ] éç®¡ç†å‘˜è®¿é—® `/admin/*` è¿”å› 403
- [ ] å…¬å¼€è·¯ç”±æ— éœ€è®¤è¯å¯è®¿é—®

**æ¶‰åŠæ–‡ä»¶**:
- `middleware.ts` - æ·»åŠ è·¯ç”±ä¿æŠ¤é€»è¾‘

---

#### 2.1.2 API é€Ÿç‡é™åˆ¶

**ç›®æ ‡**: é˜²æ­¢ API æ»¥ç”¨å’Œæš´åŠ›æ”»å‡»

**å®æ–½æ–¹æ¡ˆ**: å†…å­˜é™æµï¼ˆæ—  Redis ä¾èµ–ï¼‰

```typescript
// src/lib/api/rate-limiter.ts
interface RateLimitConfig {
  windowMs: number      // æ—¶é—´çª—å£
  maxRequests: number   // æœ€å¤§è¯·æ±‚æ•°
  keyGenerator: (req) => string  // é™æµé”®
}

const PRESETS = {
  public: { windowMs: 60000, maxRequests: 100 },      // å…¬å¼€æ¥å£
  authenticated: { windowMs: 60000, maxRequests: 500 }, // è®¤è¯æ¥å£
  sensitive: { windowMs: 60000, maxRequests: 5 },     // æ•æ„Ÿæ“ä½œ
}
```

**é™æµç­–ç•¥**:

| æ¥å£ç±»å‹ | é™åˆ¶ | è§¦å‘æ“ä½œ |
|---------|------|---------|
| `/api/auth/*` | 5æ¬¡/åˆ†é’Ÿ/IP | ç™»å½•ã€æ³¨å†Œã€å¯†ç é‡ç½® |
| `/api/admin/*` | 100æ¬¡/åˆ†é’Ÿ/ç”¨æˆ· | ç®¡ç†å‘˜æ“ä½œ |
| `/api/orders/*` | 50æ¬¡/åˆ†é’Ÿ/ç”¨æˆ· | è®¢å•æ“ä½œ |
| `/api/*` (å…¶ä»–) | 200æ¬¡/åˆ†é’Ÿ/ç”¨æˆ· | é€šç”¨æ¥å£ |

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç™»å½•æ¥å£é™æµç”Ÿæ•ˆï¼Œè¶…é™è¿”å› 429
- [ ] é™æµå“åº”åŒ…å« `Retry-After` å¤´
- [ ] ç”Ÿäº§ç¯å¢ƒæ—¥å¿—è®°å½•é™æµè§¦å‘

**æ¶‰åŠæ–‡ä»¶**:
- æ–°å»º: `src/lib/api/rate-limiter.ts`
- ä¿®æ”¹: `src/app/api/auth/validate-password/route.ts`
- ä¿®æ”¹: `src/app/api/auth/logout/route.ts`

---

#### 2.1.3 èµ„æºæ‰€æœ‰æƒéªŒè¯æ ‡å‡†åŒ–

**ç›®æ ‡**: ç»Ÿä¸€èµ„æºè®¿é—®æƒé™æ£€æŸ¥

**å®æ–½å†…å®¹**:

```typescript
// src/lib/auth/ownership.ts
export async function verifyOwnership(
  resourceType: 'post' | 'product' | 'order' | 'group',
  resourceId: string,
  userId: string,
  supabase: SupabaseClient
): Promise<{ allowed: boolean; reason?: string }>

export async function verifyOrderOwnership(
  orderId: string, 
  userId: string, 
  supabase: SupabaseClient,
  options?: { allowSeller?: boolean }  // å–å®¶ä¹Ÿå¯è®¿é—®è‡ªå·±çš„è®¢å•
): Promise<{ allowed: boolean; order?: Order }>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] `/api/orders/[id]/*` ä½¿ç”¨ç»Ÿä¸€éªŒè¯
- [ ] `/api/posts/[id]/*` ä½¿ç”¨ç»Ÿä¸€éªŒè¯
- [ ] æœªæˆæƒè®¿é—®è¿”å›ç»Ÿä¸€æ ¼å¼: `{ error: "æ— æƒè®¿é—®æ­¤èµ„æº", code: "FORBIDDEN" }`

**æ¶‰åŠæ–‡ä»¶**:
- æ–°å»º: `src/lib/auth/ownership.ts`
- ä¿®æ”¹: `src/app/api/orders/[id]/cancel/route.ts`
- ä¿®æ”¹: `src/app/api/orders/[id]/refund/route.ts`
- ä¿®æ”¹: `src/app/api/orders/[id]/ship/route.ts`

---

#### 2.1.4 API é”™è¯¯å“åº”æ ‡å‡†åŒ–

**ç›®æ ‡**: ç»Ÿä¸€ 401/403/429 å“åº”æ ¼å¼

**å“åº”æ ¼å¼**:

```typescript
// 401 Unauthorized
{
  "error": "è¯·å…ˆç™»å½•",
  "code": "UNAUTHORIZED",
  "action": "redirect_login"
}

// 403 Forbidden  
{
  "error": "æƒé™ä¸è¶³",
  "code": "FORBIDDEN",
  "reason": "éœ€è¦å–å®¶è®¢é˜…"
}

// 429 Too Many Requests
{
  "error": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
  "code": "RATE_LIMITED",
  "retryAfter": 60
}
```

**æ¶‰åŠæ–‡ä»¶**:
- æ–°å»º: `src/lib/api/errors.ts`
- ä¿®æ”¹: é«˜é¢‘æ¥å£é€æ­¥è¿ç§»

---

### é˜¶æ®µäºŒï¼šä»£ç è´¨é‡æå‡ï¼ˆ2-3å‘¨ï¼‰

#### 2.2.1 API é‰´æƒä¸­é—´ä»¶

**ç›®æ ‡**: å‡å°‘é‡å¤é‰´æƒä»£ç 

**å®æ–½å†…å®¹**:

```typescript
// src/lib/api/withAuth.ts
export function withAuth(
  handler: (req, user) => Promise<Response>,
  options?: { roles?: string[] }
): (req) => Promise<Response>

// ä½¿ç”¨ç¤ºä¾‹
export const GET = withAuth(async (req, user) => {
  // user å·²è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€å†è°ƒç”¨ getUser()
  return NextResponse.json({ userId: user.id })
}, { roles: ['admin', 'support'] })
```

**è¿ç§»ç­–ç•¥**: åˆ†æ‰¹è¿ç§»ï¼Œä¸å¼ºåˆ¶ä¸€æ¬¡æ€§æ”¹é€ 

**ä¼˜å…ˆè¿ç§»**:
- `src/app/api/admin/**` - ç®¡ç†å‘˜æ¥å£
- `src/app/api/settings/**` - ç”¨æˆ·è®¾ç½®
- `src/app/api/subscriptions/**` - è®¢é˜…ç›¸å…³

---

#### 2.2.2 é‰´æƒæµ‹è¯•è¡¥å……

**ç›®æ ‡**: ä¿éšœé‰´æƒé€»è¾‘æ­£ç¡®æ€§

**æµ‹è¯•æ¸…å•**:

```
tests/auth/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ jwt-claims.test.ts       # JWT claims éªŒè¯
â”‚   â”œâ”€â”€ rate-limiter.test.ts     # é™æµé€»è¾‘
â”‚   â””â”€â”€ ownership.test.ts        # æ‰€æœ‰æƒéªŒè¯
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ middleware.test.ts       # ä¸­é—´ä»¶è·¯ç”±ä¿æŠ¤
â”‚   â””â”€â”€ api-auth.test.ts         # API é‰´æƒæµç¨‹
â””â”€â”€ e2e/
    â”œâ”€â”€ login-flow.spec.ts       # ç™»å½•æµç¨‹
    â”œâ”€â”€ role-access.spec.ts      # è§’è‰²æƒé™çŸ©é˜µ
    â””â”€â”€ subscription-access.spec.ts  # è®¢é˜…æƒé™
```

**è§’è‰²æƒé™çŸ©é˜µæµ‹è¯•ç”¨ä¾‹**:

| è§’è‰² | /admin/* | /seller/* | /affiliate/* | /tip-center |
|------|----------|-----------|--------------|-------------|
| æœªç™»å½• | âŒ 401 | âŒ 401 | âŒ 401 | âŒ 401 |
| æ™®é€šç”¨æˆ· | âŒ 403 | âŒ â†’landing | âŒ â†’è®¢é˜… | âŒ â†’è®¢é˜… |
| å–å®¶ | âŒ 403 | âœ… | âŒ â†’è®¢é˜… | âŒ â†’è®¢é˜… |
| å¸¦è´§è€… | âŒ 403 | âŒ â†’landing | âœ… | âŒ â†’è®¢é˜… |
| ç®¡ç†å‘˜ | âœ… | âœ… | âœ… | âœ… |

---

#### 2.2.3 å®¡è®¡æ—¥å¿—å®Œå–„

**ç›®æ ‡**: å®Œæ•´è®°å½•ç®¡ç†å‘˜æ“ä½œ

**è¡¥å……èŒƒå›´**:
- æ‰€æœ‰ `requireAdmin()` è·¯ç”±è‡ªåŠ¨è®°å½•
- è®°å½•å­—æ®µæ‰©å±•: `{ before, after }` å¿«ç…§

---

### é˜¶æ®µä¸‰ï¼šå¢å¼ºåŠŸèƒ½ï¼ˆæŒ‰éœ€å®æ–½ï¼‰

#### 2.3.1 ä¼šè¯ç®¡ç†å¢å¼º

**åŠŸèƒ½**:
- å•è®¾å¤‡ç™»å½•é€‰é¡¹ï¼ˆç”¨æˆ·å¯é€‰ï¼‰
- å¼‚åœ°ç™»å½•æé†’
- ä¼šè¯åˆ—è¡¨æŸ¥çœ‹/è¸¢å‡º

**å‰ç½®æ¡ä»¶**: ç”¨æˆ·åé¦ˆæœ‰éœ€æ±‚

---

#### 2.3.2 ç»†ç²’åº¦æƒé™æ§åˆ¶

**åœºæ™¯ç¤ºä¾‹**:
- å†…å®¹å®¡æ ¸çŠ¶æ€æ§åˆ¶å¯è§æ€§
- ä»˜è´¹å†…å®¹æŒ‰è®¢é˜…æ¡£ä½è§£é”
- ç¾¤ç»„æƒé™åˆ†çº§

**å‰ç½®æ¡ä»¶**: æœ‰æ˜ç¡®ä¸šåŠ¡éœ€æ±‚

---

#### 2.3.3 API å¯†é’¥è®¤è¯

**ç”¨é€”**: å¤–éƒ¨ç³»ç»Ÿé›†æˆï¼ˆç‰©æµã€ERPï¼‰

**å‰ç½®æ¡ä»¶**: æœ‰å¤–éƒ¨é›†æˆéœ€æ±‚

---

## ä¸‰ã€æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ç”¨é€” |
|---------|------|
| `src/lib/api/rate-limiter.ts` | API é€Ÿç‡é™åˆ¶ |
| `src/lib/api/errors.ts` | æ ‡å‡†åŒ–é”™è¯¯å“åº” |
| `src/lib/api/withAuth.ts` | API é‰´æƒä¸­é—´ä»¶ |
| `src/lib/auth/ownership.ts` | èµ„æºæ‰€æœ‰æƒéªŒè¯ |
| `tests/auth/unit/*.test.ts` | å•å…ƒæµ‹è¯• |
| `tests/auth/integration/*.test.ts` | é›†æˆæµ‹è¯• |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | æ”¹åŠ¨å†…å®¹ |
|---------|---------|
| `middleware.ts` | æ·»åŠ è·¯ç”±ä¿æŠ¤é€»è¾‘ |
| `src/app/api/auth/*.ts` | æ·»åŠ é€Ÿç‡é™åˆ¶ |
| `src/app/api/orders/[id]/*.ts` | ä½¿ç”¨æ‰€æœ‰æƒéªŒè¯ |
| `src/app/api/admin/**/*.ts` | é€æ­¥è¿ç§»åˆ° withAuth |

---

## å››ã€é£é™©ä¸å›æ»š

| é£é™© | ç¼“è§£æªæ–½ | å›æ»šæ–¹æ¡ˆ |
|------|---------|---------|
| Middleware æ”¹åŠ¨å½±å“æ€§èƒ½ | ä»…æ£€æŸ¥å¿…è¦è·¯ç”±ï¼Œä½¿ç”¨è½»é‡åˆ¤æ–­ | æ³¨é‡Šæ‰è·¯ç”±ä¿æŠ¤é€»è¾‘ |
| é€Ÿç‡é™åˆ¶è¯¯ä¼¤æ­£å¸¸ç”¨æˆ· | è®¾ç½®å®½æ¾åˆå§‹é˜ˆå€¼ | è®¾ç½® `maxRequests: Infinity` |
| API ä¸­é—´ä»¶ç ´åç°æœ‰æ¥å£ | åˆ†æ‰¹è¿ç§»ï¼Œä¿ç•™æ—§æ–¹å¼å…¼å®¹ | å›é€€åˆ°ç›´æ¥è°ƒç”¨ `getUser()` |

---

## äº”ã€éªŒæ”¶æ ‡å‡†

### é˜¶æ®µä¸€å®Œæˆæ ‡å‡†

- [ ] æœªç™»å½•ç”¨æˆ·æ— æ³•ç›´æ¥è®¿é—® `/seller/*`, `/admin/*` ç­‰å—ä¿æŠ¤è·¯ç”±
- [ ] ç™»å½•æ¥å£é™æµç”Ÿæ•ˆï¼Œ1åˆ†é’Ÿå†…è¶…è¿‡5æ¬¡ç™»å½•è¯·æ±‚è¿”å›429
- [ ] èµ„æºæ‰€æœ‰æƒéªŒè¯è¦†ç›–è®¢å•ã€å¸–å­æ ¸å¿ƒæ¥å£
- [ ] 401/403 é”™è¯¯è¿”å›æ ‡å‡†æ ¼å¼

### é˜¶æ®µäºŒå®Œæˆæ ‡å‡†

- [ ] API é‰´æƒæµ‹è¯•è¦†ç›–ç‡ > 70%
- [ ] ç®¡ç†å‘˜æ“ä½œ 100% è®°å½•å®¡è®¡æ—¥å¿—
- [ ] æ ¸å¿ƒæ¥å£å·²è¿ç§»åˆ° withAuth ä¸­é—´ä»¶

---

## å…­ã€æ—¶é—´è§„åˆ’

| é˜¶æ®µ | å†…å®¹ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| é˜¶æ®µä¸€ | Middleware + é™æµ + æ‰€æœ‰æƒéªŒè¯ | ç¬¬1-2å‘¨ |
| é˜¶æ®µäºŒ | ä¸­é—´ä»¶è¿ç§» + æµ‹è¯• + å®¡è®¡ | ç¬¬3-4å‘¨ |
| é˜¶æ®µä¸‰ | å¢å¼ºåŠŸèƒ½ï¼ˆæŒ‰éœ€ï¼‰ | åç»­è¿­ä»£ |

---

## é™„å½•ï¼šç°æœ‰é‰´æƒæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ useAuth()   â”‚  â”‚ useXxxGuard â”‚  â”‚ SubscriptionContext â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                â”‚                     â”‚            â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                          â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚ middleware  â”‚  â† å¾…å¢å¼ºï¼šè·¯ç”±ä¿æŠ¤
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡ç«¯                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚  Route API  â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚         â”‚                 â”‚                 â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚requireAdmin â”‚   â”‚getUser()    â”‚  â”‚ ownership() â”‚ â† æ–°å¢ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                 â”‚                 â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚ Supabase    â”‚                          â”‚
â”‚                    â”‚ Auth        â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                           â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚ JWT Claims  â”‚  â† seller/affiliate/tip  â”‚
â”‚                    â”‚ + RLS       â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**è¯·ç¡®è®¤æ­¤è®¡åˆ’åå¼€å§‹å®æ–½ã€‚**
