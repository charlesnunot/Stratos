# 商品个性化推荐方案

## 一、现状对比

| 维度 | 帖子（已实现） | 商品（当前） |
|------|----------------|--------------|
| 数据源 | `get_personalized_feed` RPC | useProducts 直接查 products，按 created_at 排序 |
| 分层 | Tier1 关注人 / Tier2 关注话题 / Tier3 其余 | 无 |
| 排除 | view_history(post)、举报帖/举报作者 | 无 |
| 打分 | tier_base + engagement × recency，多样性（同作者限 k 条） | 无 |
| 前端 | 首页：登录用 useFeed，未登录用 usePosts | 商城页：始终 useProducts() |

商品侧已有、可直接复用的能力：view_history(item_type=product)、useRecordView、product_likes、product_wants、favorites、orders/order_items、products(seller_id,category,like_count,want_count,favorite_count,sales_count)、follows。

---

## 二、架构（与帖子推荐对齐）

- **RPC**：`get_personalized_product_feed`，排除 → Tier1(关注卖家) / Tier2(互动分类) / Tier3(其余) → 打分 → 多样性(同卖家限 k) → 返回 product_id 有序列表。
- **前端**：已登录用 useProductFeed(RPC + 按 id 拉详情)，未登录/分类筛选用 useProducts；分类筛选长期需求则 RPC 增加 p_category 参数。

---

## 三、实现要点

### 1. RPC get_personalized_product_feed

- **排除**：view_history(user_id, item_type='product', viewed_at >= NOW() - p_exclude_viewed_days)；举报商品；举报卖家的商品。
- **Tier1**：关注卖家的在售商品（follows.followee_id = products.seller_id AND follows.follower_id = p_user_id）。
- **Tier2**：用户「互动过的分类」且达到**最低权重门槛**（见下节微调①）。
- **Tier3**：其余在售商品。
- **打分**：tier_base + LN(1+like_count) + LN(1+want_count) + … + **LN(1+sales_count)** 或 LEAST(sales_count,100)*系数（见微调②），再乘时间衰减；Tier3 可预留探索噪声（微调③）。
- **多样性**：前 p_diversity_n 条内同一 seller_id 最多 p_diversity_k 条；**默认 p_diversity_n=30 或 40，p_diversity_k=2**（微调④）。
- **分类筛选**：RPC 增加可选 **p_category TEXT**，在 RPC 内过滤（微调⑤）。
- **SECURITY DEFINER**，**SET search_path = public**，无动态 SQL（风险点②）。

### 2. 前端

- useProductFeed(userId, options?)：调 RPC 取 product_id 列表，再按 id 顺序拉完整商品；useProducts 保持不变。
- 商城页：已登录用 useProductFeed，未登录用 useProducts(category)；若带分类则传 p_category 或前端过滤（以 RPC 参数为准）。

---

## 四、架构评审微调与风险（必做）

### 微调 5 点

| 点 | 内容 | 落地方式 |
|----|------|----------|
| ① Tier2 互动分类 | 加「最低权重门槛」，避免偶然一次互动就进 Tier2 | RPC 内：category_interaction_score（like=3, want=4, order=10, view=1），只保留 HAVING SUM(score) >= X（如 5 或 8）的分类进 Tier2 |
| ② sales_count | 参与打分但限幅，防老爆款长期霸榜 | 用 LN(1 + sales_count) 或 LEAST(sales_count, 100) * 系数 |
| ③ Tier3 探索噪声 | 可选增强，长尾友好 | 预留：Tier3 打分可加 random()*ε，或每页末 10–15% 掺入低曝光高质量商品 |
| ④ 多样性窗口 | N/k 默认值要慎重 | 默认 p_diversity_n=30 或 40，p_diversity_k=2，注释/文档写明 |
| ⑤ 分类筛选 | 推荐+分类长期存在则进 RPC | 第一版即加 p_category TEXT 可选参数，在 RPC 内过滤，避免前端过滤导致分页错乱 |

### 风险 2 点

| 点 | 内容 | 落地方式 |
|----|------|----------|
| ① view_history 热点 | 排除逻辑只扫最近 X 天，且需合适索引 | 确认 (user_id, item_type, viewed_at DESC) 复合索引；RPC 中 WHERE viewed_at >= NOW() - p_exclude_viewed_days；若无复合索引则在本次迁移中新增 |
| ② SECURITY DEFINER | 安全与稳定性 | RPC 顶部显式 SET search_path = public，避免动态 SQL，与帖子 RPC 一致 |

---

## 五、实施顺序

1. 新增迁移：实现 get_personalized_product_feed（含上述微调与风险点）+ 必要时补 view_history 复合索引。
2. 前端：实现 useProductFeed，按 RPC 返回 id 顺序拉商品。
3. 商城页：按登录状态切换 useProductFeed / useProducts；分类筛选走 RPC 参数 p_category。
