# 商品运费 - 01 数据库与规则

## 一、概述

**目标**：为商品增加「运费」(shipping_fee) 字段，在创建/编辑商品时设置，结账时计入订单总价。

**运费规则**：
- 每件商品可设置固定运费（`products.shipping_fee`），单位与商品价格一致
- 同一卖家的多个商品合并计算：取该卖家订单内商品运费的最大值（一个包裹只收一次最高运费）
- 订单总价 = 商品小计 + 运费

**当前实现**：审计文档表明当前无运费逻辑，订单总价 = Σ(item.price × item.quantity)。本计划将引入运费并保持服务端计算与校验。

---

## 二、涉及表与字段

### 2.1 products

| 字段 | 类型 | 默认 | 说明 |
|------|------|------|------|
| shipping_fee | DECIMAL(10,2) | 0 | 商品运费，与 price 同单位 |

### 2.2 orders

| 字段 | 类型 | 默认 | 说明 |
|------|------|------|------|
| shipping_fee | DECIMAL(10,2) | 0 | 该订单运费部分（用于展示与对账） |

- `total_amount` = 商品小计 + `shipping_fee`

### 2.3 order_groups

- 无需新增字段
- `total_amount` = 各子订单 `total_amount` 之和，已包含运费

---

## 三、运费计算规则

**按卖家分组**：
1. 将购物车/订单项按 `product.seller_id` 分组
2. 每组内：`shipping_fee = MAX(product.shipping_fee)`（同一包裹只收一次最高运费）
3. 每组内：`product_subtotal = SUM(item.price × item.quantity)`
4. 每组订单：`total_amount = product_subtotal + shipping_fee`

---

## 四、数据库迁移

**新建**：`supabase/migrations/243_add_product_and_order_shipping_fee.sql`

```sql
-- products: 商品运费
ALTER TABLE products
ADD COLUMN IF NOT EXISTS shipping_fee DECIMAL(10,2) DEFAULT 0;

COMMENT ON COLUMN products.shipping_fee IS '商品运费，与 price 同单位；同一卖家多商品合并时取 MAX';

-- orders: 订单运费（用于展示）
ALTER TABLE orders
ADD COLUMN IF NOT EXISTS shipping_fee DECIMAL(10,2) DEFAULT 0;

COMMENT ON COLUMN orders.shipping_fee IS '该订单的运费部分，total_amount = 商品小计 + shipping_fee';

-- 兼容旧数据
UPDATE products SET shipping_fee = COALESCE(shipping_fee, 0) WHERE shipping_fee IS NULL;
UPDATE orders SET shipping_fee = COALESCE(shipping_fee, 0) WHERE shipping_fee IS NULL;
```

---

## 五、类型定义

**文件**：`src/types/database.ts`

- `products`：Row / Insert / Update 增加 `shipping_fee: number`
- `orders`：Row / Insert / Update 增加 `shipping_fee: number`
