# 商品颜色字段实施任务列表 - 第三部分：业务逻辑层

## 项目分析总结

### 当前状态
1. **订单处理**：
   - ❌ 订单创建 API 未处理颜色信息
   - ❌ 订单详情页面未显示颜色信息
   - ❌ 卖家订单管理页面未显示颜色信息

---

## 具体执行任务列表

### 阶段七：订单创建 API（Order Creation API）

#### 任务 7.1：处理颜色信息
**文件**: `src/app/api/orders/create/route.ts`
- [ ] 在订单项验证中添加颜色字段检查
- [ ] 在创建 `order_items` 时保存颜色信息：
  ```typescript
  {
    order_id: order.id,
    product_id: item.product_id,
    quantity: item.quantity,
    price: item.price,
    color: item.color || null, // 新增
    size: item.size || null,   // 新增（如果支持尺寸）
  }
  ```

---

### 阶段八：订单详情页面（Order Detail Page）

#### 任务 8.1：显示订单中的颜色信息
**文件**: `src/app/[locale]/(main)/orders/[id]/page.tsx`
- [ ] 在订单商品列表中显示颜色信息
- [ ] 确保颜色信息正确从 order_items 中读取
- [ ] 处理颜色信息为空的情况（向后兼容）

#### 任务 8.2：更新订单类型定义
**文件**: `src/lib/types/api.ts`
- [ ] 在 `Order` 接口中添加订单项信息（如果还没有）：
  ```typescript
  items?: Array<{
    product_id: string
    quantity: number
    price: number
    color?: string | null
    size?: string | null
  }>
  ```

---

### 阶段九：卖家订单管理（Seller Order Management）

#### 任务 9.1：显示订单中的颜色信息
**文件**: `src/app/[locale]/(main)/seller/orders/page.tsx`
- [ ] 在卖家订单列表中显示颜色信息
- [ ] 确保颜色信息在订单详情中可见
- [ ] 处理颜色信息为空的情况（向后兼容）

---

### 阶段十二：测试和验证

#### 任务 12.1：功能测试
- [ ] 测试商品创建时添加颜色选项
- [ ] 测试商品编辑时修改颜色选项
- [ ] 测试商品详情页显示颜色选择器
- [ ] 测试加入购物车时保存颜色信息
- [ ] 测试订单创建时保存颜色信息
- [ ] 测试订单详情页显示颜色信息
- [ ] 测试卖家订单管理页面显示颜色信息

#### 任务 12.2：边界情况测试
- [ ] 测试没有颜色选项的商品
- [ ] 测试颜色选项为空数组的情况
- [ ] 测试颜色图片URL无效的情况
- [ ] 测试订单中颜色信息缺失的兼容性
- [ ] 测试颜色信息在订单创建失败时的回滚
- [ ] 测试多个商品不同颜色的订单创建

#### 任务 12.3：API 测试
- [ ] 测试订单创建 API 正确处理颜色字段
- [ ] 测试颜色字段为空时的处理
- [ ] 测试颜色字段格式验证
- [ ] 测试订单查询 API 返回颜色信息

#### 任务 12.4：数据一致性测试
- [ ] 验证订单中的颜色信息与商品颜色选项一致
- [ ] 验证颜色信息在订单生命周期中的持久性
- [ ] 验证颜色信息在订单取消/退款时的处理

---

## 注意事项

1. **向后兼容性**：
   - 确保现有没有颜色信息的订单仍能正常显示
   - 订单中的颜色字段应为可选（nullable）
   - 处理历史订单中颜色信息缺失的情况

2. **数据验证**：
   - 验证订单中的颜色是否属于商品的颜色选项
   - 确保颜色信息在订单创建时正确保存
   - 验证颜色信息在订单更新时的处理

3. **错误处理**：
   - 处理颜色信息保存失败的情况
   - 处理颜色信息查询失败的情况
   - 提供有意义的错误提示

4. **性能考虑**：
   - 确保订单查询时颜色信息的加载不影响性能
   - 考虑是否需要为颜色字段添加索引

---

## 预计工作量

- **订单创建 API**：2-3小时
- **订单详情页面**：2-3小时
- **卖家订单管理**：1-2小时
- **测试和验证**：4-6小时
- **总计**：9-14小时

---

## 完成标准

- [ ] 订单创建 API 正确处理颜色信息
- [ ] 订单详情页面正确显示颜色信息
- [ ] 卖家订单管理页面正确显示颜色信息
- [ ] 所有功能测试通过
- [ ] 所有边界情况测试通过
- [ ] API 测试通过
- [ ] 数据一致性验证通过
- [ ] 向后兼容性验证通过

---

## 测试检查清单

### 功能测试
- [ ] 创建带颜色选项的商品
- [ ] 在商品详情页选择颜色
- [ ] 将带颜色的商品加入购物车
- [ ] 在购物车中查看颜色信息
- [ ] 创建包含颜色信息的订单
- [ ] 在订单详情页查看颜色信息
- [ ] 在卖家订单管理页查看颜色信息

### 边界情况测试
- [ ] 商品没有颜色选项
- [ ] 颜色选项为空数组
- [ ] 颜色图片URL无效
- [ ] 订单中颜色信息缺失
- [ ] 订单创建失败时的回滚
- [ ] 多个商品不同颜色的订单

### API 测试
- [ ] POST /api/orders/create 正确处理颜色
- [ ] GET /api/orders/[id] 返回颜色信息
- [ ] 颜色字段验证
- [ ] 错误处理
