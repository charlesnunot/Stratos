# 编辑页货币选择实施计划

**目标**：在商品编辑页 (`/seller/products/[id]/edit`) 增加货币下拉选择框，与创建页保持一致，使卖家能够查看并修改商品的货币设置。

---

## 一、现状分析

### 1.1 创建页 vs 编辑页对比

| 功能 | 创建页 | 编辑页 |
|------|--------|--------|
| 货币 FormData | ✅ `currency: Currency` | ❌ 无 |
| 货币加载 | ✅ 根据 locale 默认 CNY/USD | ❌ 无 |
| 货币 UI | ✅ 下拉选择（CURRENCIES） | ❌ 无 |
| 货币提交 | ✅ `productData.currency` | ❌ 无 |

### 1.2 数据库与类型

- `products.currency` 字段已存在（迁移 108），类型 `TEXT`，可选值：USD, CNY, EUR, GBP, JPY, KRW, SGD, HKD, AUD, CAD
- 默认值：`'USD'`
- 翻译：`seller.currency` 已存在（zh: 货币，en: Currency）

### 1.3 结论

**需要增加**：编辑页缺少货币选择，与创建页不一致，且无法让卖家在编辑时调整货币。应增加货币下拉选择框。

---

## 二、涉及文件

| 文件 | 修改内容 |
|------|----------|
| `src/app/[locale]/(main)/seller/products/[id]/edit/page.tsx` | FormData、加载、UI、productData |

---

## 三、实施步骤

### 步骤 1：添加导入与常量

**文件**：`src/app/[locale]/(main)/seller/products/[id]/edit/page.tsx`

**位置**：在现有 import 之后、组件定义之前

**新增**：

```ts
import { type Currency } from '@/lib/currency/detect-currency'

const CURRENCIES: Currency[] = ['USD', 'CNY', 'EUR', 'GBP', 'JPY', 'KRW', 'SGD', 'HKD', 'AUD', 'CAD']
```

---

### 步骤 2：FormData 增加 currency

**修改前**：

```ts
const [formData, setFormData] = useState({
  name: '',
  description: '',
  price: '',
  stock: '0',
  category: '',
  // ...
  shipping_fee: '0',
})
```

**修改后**：

```ts
const [formData, setFormData] = useState({
  name: '',
  description: '',
  price: '',
  stock: '0',
  category: '',
  currency: 'USD' as Currency,  // 新增，加载时会被 product.currency 覆盖
  // ...
  shipping_fee: '0',
})
```

---

### 步骤 3：加载商品时填充 currency

**位置**：`useEffect` 中 `setFormData({...})` 调用处

**在 `setFormData` 对象内增加**：

```ts
currency: (product.currency as Currency) || 'USD',
```

**说明**：与 price、stock 等一起从 product 加载，若无则默认 `'USD'`。

---

### 步骤 4：提交时包含 currency

**位置**：`handleSubmit` 中的 `productData` 对象

**在 `productData` 内增加**：

```ts
currency: formData.currency,
```

**建议位置**：在 `price` 之后、`shipping_fee` 之前，与创建页结构一致。

---

### 步骤 5：增加货币下拉 UI

**位置**：「Price and Stock」区块内，与创建页一致。创建页结构为：Price Card、Currency Card、Stock Card、Shipping Fee Card。

**编辑页当前结构**（约 506-552 行）：

- Price Card
- Stock Card
- Shipping Fee Card

**在 Price Card 与 Stock Card 之间插入**：

```tsx
<Card className="p-4">
  <label className="mb-2 block text-sm font-medium">
    {t('currency')} <span className="text-destructive">*</span>
  </label>
  <select
    value={formData.currency}
    onChange={(e) => setFormData({ ...formData, currency: e.target.value as Currency })}
    className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
  >
    {CURRENCIES.map((curr) => (
      <option key={curr} value={curr}>
        {curr}
      </option>
    ))}
  </select>
</Card>
```

**布局**：编辑页当前为 `grid gap-4 md:grid-cols-2`，插入后将为 4 个 Card（价格、货币、库存、运费），2x2 网格显示，与创建页一致。

---

## 四、实施顺序汇总

| 顺序 | 操作 | 说明 |
|------|------|------|
| 1 | 添加 `Currency` 导入和 `CURRENCIES` 常量 | |
| 2 | formData 增加 `currency: 'USD' as Currency` | |
| 3 | 加载商品时设置 `currency: product.currency \|\| 'USD'` | |
| 4 | productData 提交时增加 `currency: formData.currency` | |
| 5 | 在 Price 与 Stock 之间插入货币下拉 UI | |

---

## 五、验证步骤

1. 打开编辑页，确认显示货币下拉，且默认/加载值为商品当前货币。
2. 修改货币后保存，确认数据库 `products.currency` 已更新。
3. 刷新编辑页，确认货币值正确回填。
4. 中英文环境下，`t('currency')` 显示正确（货币 / Currency）。

---

## 六、注意事项

- **已售商品**：若业务上禁止修改已售商品的货币，可在编辑页根据 `product.status === 'sold'` 对货币下拉做 `disabled` 处理；当前计划未限制，与创建页行为一致。
- **订单一致性**：修改商品货币不影响已有订单，订单表有独立的 `currency` 字段；新订单会使用更新后的商品货币。
