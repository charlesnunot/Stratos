# æ”¯ä»˜ç³»ç»Ÿå…¨é¢å®¡è®¡æŠ¥å‘Š

> å®¡è®¡æ—¶é—´: 2026-02-21  
> å®¡è®¡èŒƒå›´: æ”¯ä»˜ç³»ç»Ÿå…¨éƒ¨æ ¸å¿ƒæ–‡ä»¶ï¼ˆçº¦ 50+ æ–‡ä»¶ï¼‰  
> å‘ç°é—®é¢˜: ä¸¥é‡ 6 ä¸ªï¼Œä¸­ç­‰ 14 ä¸ªï¼Œå»ºè®® 8 ä¸ª  
> LSP é”™è¯¯: 4 ä¸ªï¼ˆæ–°å‘ç°ï¼‰

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ”¯ä»˜å…¥å£å±‚                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Stripe    â”‚   PayPal    â”‚   Alipay    â”‚   WeChat    â”‚  Bank   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚             â”‚             â”‚             â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Webhook å›è°ƒå¤„ç†å±‚        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                            â”‚                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æ”¯ä»˜    â”‚            â”‚ è®¢é˜…æ”¯ä»˜        â”‚          â”‚ æ‰“èµæ”¯ä»˜      â”‚
â”‚ process-orderâ”‚           â”‚ process-subscriptionâ”‚      â”‚ process-tip   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚                           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     Ledger è®°è´¦ç³»ç»Ÿ           â”‚
                    â”‚   (å¤å¼è®°è´¦ + ä½™é¢è¿½è¸ª)       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     è½¬è´¦/æç°å¤„ç†             â”‚
                    â”‚   transfer-to-seller          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å®‰å…¨æ€§å®¡è®¡

### ğŸ”´ ä¸¥é‡é—®é¢˜ (P0)

#### 1. Alipay å›è°ƒéªŒç­¾åçš„æ•æ„Ÿä¿¡æ¯æš´éœ²

**æ–‡ä»¶**: `src/app/api/payments/alipay/callback/route.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 344-347 è¡Œ
console.error('Alipay callback error:', {
  message: error.message,
  stack: error.stack,  // âŒ æš´éœ²å †æ ˆä¿¡æ¯
})
```

**é£é™©**: ç”Ÿäº§ç¯å¢ƒæš´éœ²å†…éƒ¨ä»£ç è·¯å¾„ï¼Œå¯èƒ½è¢«åˆ©ç”¨è¿›è¡Œæ”»å‡»ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
console.error('Alipay callback error:', {
  message: error.message,
  // stack: error.stack,  // åˆ é™¤æˆ–ä»…åœ¨å¼€å‘ç¯å¢ƒè¾“å‡º
})
```

---

#### 2. Stripe å®ä¾‹ç¼“å­˜çš„å¹¶å‘é—®é¢˜

**æ–‡ä»¶**: `src/lib/payments/stripe.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 6-7 è¡Œ
let stripeInstance: Stripe | null = null
let stripeInstanceConfig: { secretKey: string } | null = null
```

**é£é™©**: æ¨¡å—çº§ç¼“å­˜éçº¿ç¨‹å®‰å…¨ï¼Œåœ¨å¹¶å‘è¯·æ±‚æ—¶å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// ä½¿ç”¨ Map å­˜å‚¨å¤šä¸ªå®ä¾‹ï¼ŒæŒ‰ currency åŒºåˆ†
const stripeInstances: Map<string, Stripe> = new Map()

async function getStripeClient(currency?: string): Promise<Stripe> {
  const key = currency || 'default'
  
  if (!stripeInstances.has(key)) {
    const secretKey = await getSecretKey(currency)
    const instance = new Stripe(secretKey, {
      apiVersion: '2025-12-15.clover',
    })
    stripeInstances.set(key, instance)
  }
  
  return stripeInstances.get(key)!
}
```

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

#### 3. Webhook éªŒç­¾å¤±è´¥åä»è¿”å›é”™è¯¯çŠ¶æ€ç 

**æ–‡ä»¶**: `src/app/api/payments/alipay/callback/route.ts`

**è¯´æ˜**: è™½ç„¶è¿”å› 400 çŠ¶æ€ç ï¼Œä½†æ”»å‡»è€…å¯é€šè¿‡é‡æ”¾è¯·æ±‚æ¢æµ‹ç³»ç»Ÿè¡Œä¸ºã€‚å»ºè®®æ·»åŠ è¯·æ±‚é™æµã€‚

---

#### 4. amount éªŒè¯ç²¾åº¦é—®é¢˜

**æ–‡ä»¶**: `src/app/api/payments/alipay/callback/route.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 281-287 è¡Œ
if (Math.abs(paidAmount - order.total_amount) > 0.01) {
```

**é—®é¢˜**: å›ºå®š 0.01 é˜ˆå€¼å¯¹ä¸åŒè´§å¸ä¸é€‚ç”¨ï¼ˆJPY/KRW æ— å°æ•°ä½ï¼‰ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
const isZeroDecimalCurrency = ['JPY', 'KRW'].includes(order.currency?.toUpperCase())
const precision = isZeroDecimalCurrency ? 0 : 0.01

if (Math.abs(paidAmount - order.total_amount) > precision) {
  // ...
}
```

---

## ä¸‰ã€å¹‚ç­‰æ€§å®¡è®¡

### âœ… å·²å®ç°å¹‚ç­‰æ€§ä¿æŠ¤

| ç»„ä»¶ | å®ç°æ–¹å¼ | çŠ¶æ€ |
|------|----------|------|
| Stripe webhook | `webhook_events` è¡¨ + `process_webhook_event()` | âœ… |
| Alipay callback | `payment_transactions` å”¯ä¸€ç´¢å¼• `(provider, provider_ref)` | âœ… |
| WeChat notify | `payment_transactions` å”¯ä¸€ç´¢å¼• | âœ… |
| è®¢å•æ”¯ä»˜ | `payment_status === 'paid'` æ£€æŸ¥ | âœ… |
| è®¢é˜…æ¿€æ´» | `status !== 'pending'` æ£€æŸ¥ | âœ… |

### ğŸ”´ ä¸¥é‡é—®é¢˜ (P0)

#### 5. ä½£é‡‘æ”¯ä»˜ç¼ºå°‘å…¨å±€å¹‚ç­‰

**æ–‡ä»¶**: `src/app/api/commissions/pay/route.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 127-142 è¡Œ
const { error: updateError } = await supabaseAdmin
  .from('commission_payment_obligations')
  .update({
    status: 'paid',
    paid_at: new Date().toISOString(),
    payment_transaction_id: paymentTransactionId || null,
  })
  .eq('id', obligationId)

// âŒ æ—  status æ£€æŸ¥ï¼Œå¯èƒ½é‡å¤æ”¯ä»˜
```

**é£é™©**: å·² `paid` çŠ¶æ€çš„ obligation å¯èƒ½è¢«é‡å¤å¤„ç†ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// å…ˆæ£€æŸ¥çŠ¶æ€
const { data: existingObligation } = await supabaseAdmin
  .from('commission_payment_obligations')
  .select('status')
  .eq('id', obligationId)
  .single()

if (existingObligation?.status !== 'pending') {
  return NextResponse.json(
    { error: 'Obligation already processed' },
    { status: 400 }
  )
}

// ä½¿ç”¨æ¡ä»¶æ›´æ–°ç¡®ä¿åŸå­æ€§
const { error: updateError } = await supabaseAdmin
  .from('commission_payment_obligations')
  .update({
    status: 'paid',
    paid_at: new Date().toISOString(),
    payment_transaction_id: paymentTransactionId || null,
  })
  .eq('id', obligationId)
  .eq('status', 'pending')  // ä»…å½“çŠ¶æ€ä¸º pending æ—¶æ›´æ–°

if (updateError?.code === 'PGRST116') {
  // æ²¡æœ‰è¡Œè¢«æ›´æ–°ï¼Œè¯´æ˜å·²è¢«å¤„ç†
  return NextResponse.json(
    { error: 'Obligation already processed' },
    { status: 400 }
  )
}
```

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

#### 6. Alipay å›è°ƒ GET è¯·æ±‚ç¼ºå°‘å¹‚ç­‰ä¿æŠ¤

**æ–‡ä»¶**: `src/app/api/payments/alipay/callback/route.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 357-390 è¡Œ - GET å¤„ç†
export async function GET(request: NextRequest) {
  // ... ä»…éªŒç­¾ï¼Œæ— å¹‚ç­‰æ£€æŸ¥
}
```

**é—®é¢˜**: GET å›è°ƒå¯èƒ½è¢«é‡å¤å¤„ç†ã€‚

**ä¿®å¤å»ºè®®**: å¤ç”¨ POST çš„å¹‚ç­‰æ£€æŸ¥é€»è¾‘ã€‚

---

## å››ã€æ•°æ®ä¸€è‡´æ€§å®¡è®¡

### ğŸ”´ ä¸¥é‡é—®é¢˜ (P0)

#### 7. compensation.ts æŸ¥è¯¢è¯­æ³•é”™è¯¯

**æ–‡ä»¶**: `src/lib/payments/compensation.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 48 è¡Œ
.gte('payment_transfers.retry_count', supabaseAdmin.from('payment_transfers').select('max_retries').single() || 3)
```

**é—®é¢˜**: å­æŸ¥è¯¢è¯­æ³•é”™è¯¯ï¼Œä¼šå¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// æ–¹æ¡ˆ 1: ä½¿ç”¨è”è¡¨æŸ¥è¯¢
.join('payment_transfers', 'orders.id', 'payment_transfers.payment_transaction_id')
.filter(
  'payment_transfers.retry_count',
  'gte',
  ref('payment_transfers.max_retries')
)

// æ–¹æ¡ˆ 2: å…ˆæŸ¥è¯¢åè¿‡æ»¤
const { data: orders } = await supabaseAdmin
  .from('orders')
  .select(`
    id,
    seller_id,
    total_amount,
    currency,
    payment_method,
    payment_transfers(
      id,
      status,
      retry_count,
      max_retries,
      error_message
    )
  `)
  .eq('payment_status', 'paid')
  .eq('payment_transfers.status', 'failed')

const needsCompensation = orders?.filter(order => {
  const transfer = (order as any).payment_transfers?.[0]
  return transfer && transfer.retry_count >= transfer.max_retries
})
```

---

#### 8. è½¬è´¦éƒ¨åˆ†å¤±è´¥æœªæ„ŸçŸ¥

**æ–‡ä»¶**: `src/app/api/commissions/pay/route.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 194-215 è¡Œ
for (const [affiliateId, commissionData] of commissionsByAffiliate) {
  try {
    const transferResult = await transferToSeller(...)
    if (!transferResult.success) {
      console.error(`Failed to transfer...`)  // ä»…æ—¥å¿—ï¼Œæœªè®°å½•
    }
  } catch (error) {
    console.error(...)  // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
  }
}
```

**é—®é¢˜**: éƒ¨åˆ†è½¬è´¦å¤±è´¥ä½†è¿”å›æˆåŠŸï¼Œè°ƒç”¨è€…æ— æ³•æ„ŸçŸ¥ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
const failedAffiliates: string[] = []

for (const [affiliateId, commissionData] of commissionsByAffiliate) {
  try {
    const transferResult = await transferToSeller(...)
    if (!transferResult.success) {
      failedAffiliates.push(affiliateId)
    }
  } catch (error) {
    failedAffiliates.push(affiliateId)
  }
}

if (failedAffiliates.length > 0) {
  return NextResponse.json({
    success: false,
    error: `Failed to transfer to affiliates: ${failedAffiliates.join(', ')}`,
  })
}
```

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

#### 9. process-order-payment éåŸå­æ“ä½œ

**æ–‡ä»¶**: `src/lib/payments/process-order-payment.ts`

**é—®é¢˜**: è®¢å•æ”¯ä»˜æˆåŠŸä½†ä½£é‡‘åˆ›å»ºå¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´ã€‚

**ä¿®å¤å»ºè®®**: å°†ä½£é‡‘åˆ›å»ºç§»åˆ°æ•°æ®åº“äº‹åŠ¡ä¸­ï¼Œæˆ–ä½¿ç”¨äº‹åŠ¡æ€§å‡½æ•°ã€‚

---

#### 10. refund å¤„ç†éåŸå­

**æ–‡ä»¶**: `src/lib/payments/process-refund.ts`

**é—®é¢˜**: æ”¯ä»˜æä¾›å•†é€€æ¬¾æˆåŠŸä½†æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œå¯¼è‡´èµ„é‡‘å’Œè®°å½•ä¸ä¸€è‡´ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
const { error: refundError } = await supabaseAdmin.rpc('process_refund_transaction', {
  p_order_id: orderId,
  p_refund_id: refundId,
  p_amount: amount,
  p_refund_method: refundMethod,
  // ...
})

if (refundError) {
  // è®°å½•åˆ°å¾…å¤„ç†é˜Ÿåˆ—ï¼Œäººå·¥ä»‹å…¥
  await supabaseAdmin.from('refund_anomalies').insert({...})
}
```

---

## äº”ã€é”™è¯¯å¤„ç†å®¡è®¡

### âœ… è‰¯å¥½å®è·µ

1. **ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨** (`src/lib/payments/error-handler.ts`)
   - é”™è¯¯åˆ†ç±»ï¼ˆé…ç½®/éªŒè¯/ç½‘ç»œ/æä¾›å•†/æ•°æ®åº“ï¼‰
   - æ•æ„Ÿä¿¡æ¯è„±æ•
   - ç”¨æˆ·å‹å¥½æ¶ˆæ¯

2. **ç»“æ„åŒ–æ—¥å¿—** (`src/lib/payments/logger.ts`)
   - ç»Ÿä¸€ JSON æ ¼å¼
   - æ—¥å¿—çº§åˆ«åˆ†ç¦»

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

#### 11. é”™è¯¯å¤„ç†åç»§ç»­æ‰§è¡Œ

**æ–‡ä»¶**: `src/lib/payments/transfer-to-seller.ts`

**é—®é¢˜**: å¤–å±‚è°ƒç”¨è€…å¯èƒ½å¿½ç•¥è¿”å›çš„ `success: false`ã€‚

**ä¿®å¤å»ºè®®**: ç¡®ä¿æ‰€æœ‰è°ƒç”¨è€…æ­£ç¡®å¤„ç†è¿”å›å€¼ã€‚

---

## å…­ã€ä¸šåŠ¡é€»è¾‘å®¡è®¡

### ğŸ”´ ä¸¥é‡é—®é¢˜ (P0)

#### 12. è®¢é˜…æ¿€æ´»é‡‘é¢éªŒè¯ä¸æ­£ç¡®

**æ–‡ä»¶**: `src/lib/payments/process-subscription-payment.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 370-399 è¡Œ
const platformAmount = parseFloat(String(sub.amount))
// âŒ amount å­—æ®µåœ¨ 3 æ¡£çº¯å‡€æ¨¡å¼ä¸‹æ˜¯å†…éƒ¨ tier å€¼ï¼ˆ15/50/100ï¼‰ï¼Œä¸æ˜¯å®é™…é‡‘é¢

if (Math.abs(paidAmount - expectedInPaymentCurrency) > 0.02) {
  return { success: false, error: `Amount mismatch...` }
}
```

**é—®é¢˜**: `amount` å­—æ®µæ˜¯å†…éƒ¨ tier å€¼ï¼Œä¸æ˜¯å®é™…æ”¯ä»˜é‡‘é¢ã€‚åº”ä½¿ç”¨ `display_price`ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// ä¿®å¤éªŒè¯é€»è¾‘
const expectedAmount = parseFloat(String(sub.display_price || sub.amount))

// å¦‚æœæ˜¯å¤šå¸ç§æ”¯ä»˜ï¼Œéœ€è¦è½¬æ¢
let expectedInPaymentCurrency: number
if (sub.user_currency === currency) {
  expectedInPaymentCurrency = parseFloat(String(sub.user_amount || expectedAmount))
} else {
  expectedInPaymentCurrency = convertCurrency(
    expectedAmount,
    sub.currency as Currency,
    currency as Currency
  )
}
```

---

#### 13. æ‰“èµé™åˆ¶æ•°æ®åº“å‡½æ•°ä¸å­˜åœ¨æ—¶çš„é™çº§

**æ–‡ä»¶**: `src/lib/payments/check-tip-limits.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 27-42 è¡Œ
const { data, error } = await supabaseAdmin.rpc('check_tip_limits', {...})
if (error) {
  return { allowed: false, reason: error.message }
  // âŒ æ•°æ®åº“å‡½æ•°ä¸å­˜åœ¨æ—¶æ‹’ç»æ‰€æœ‰æ‰“èµ
}
```

**é—®é¢˜**: æ•°æ®åº“å‡½æ•°ä¸å­˜åœ¨æ—¶æ‹’ç»æ‰€æœ‰æ‰“èµï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

**ä¿®å¤å»ºè®®**:
```typescript
if (error) {
  // å‡½æ•°ä¸å­˜åœ¨æ—¶ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ç”¨éªŒè¯é€»è¾‘
  if (error.message.includes('function') && error.message.includes('does not exist')) {
    // æœ¬åœ°å¤‡ç”¨éªŒè¯
    return checkTipLimitsLocally(tipperId, recipientId, amount, currency)
  }
  return { allowed: false, reason: error.message }
}
```

---

## ä¸ƒã€Ledger ç³»ç»Ÿå®¡è®¡

### âœ… è‰¯å¥½è®¾è®¡

1. **å¤å¼è®°è´¦** (`post_journal_entry`)
   - å€Ÿè´·å¹³è¡¡éªŒè¯
   - Advisory Lock é˜²å¹¶å‘
   - æ­»é”é¢„é˜²ï¼ˆè´¦æˆ·æ’åºé”å®šï¼‰

2. **ACID ä¿è¯**
   - æ•°æ®åº“äº‹åŠ¡
   - ä¸¤é˜¶æ®µæäº¤

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

#### 14. è´¦æˆ·åˆ›å»ºç«æ€

**æ–‡ä»¶**: `src/lib/payments/ledger.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 100-142 è¡Œ
} catch (error: any) {
  if (error.code === '23505') {
    // é‡è¯•
  }
  throw error  // âŒ å¦‚æœæ˜¯ 23505 ä½†é‡è¯•ä¹Ÿå¤±è´¥ï¼Œä¼šä¸¢å¤±åŸå§‹é”™è¯¯
}
```

**ä¿®å¤å»ºè®®**:
```typescript
} catch (error: any) {
  if (error.code === '23505') {
    // å·²ç»å¤„ç†è¿‡ï¼ŒæŸ¥è¯¢è¿”å›
    const { data: retryAccount } = await supabaseAdmin
      .from('accounts')
      .select('*')
      .eq('account_type', accountType)
      .eq('owner_id', ownerId || null)
      .eq('currency', currency)
      .single()
    
    if (retryAccount) return retryAccount
  }
  // å¦‚æœä¸æ˜¯å”¯ä¸€çº¦æŸå†²çªæˆ–å…¶ä»–é”™è¯¯ï¼Œé‡æ–°æŠ›å‡º
  if (!error.code || error.code !== '23505') {
    throw error
  }
  // å…œåº•ï¼šå†æ¬¡æŸ¥è¯¢ï¼ˆå¯èƒ½æœ‰å…¶ä»–è¯·æ±‚åˆšåˆ›å»ºï¼‰
  const { data: finalAccount } = await supabaseAdmin
    .from('accounts')
    .select('*')
    .eq('account_type', accountType)
    .eq('owner_id', ownerId || null)
    .eq('currency', currency)
    .single()
  
  if (finalAccount) return finalAccount
  throw error
}
```

---

## å…«ã€å®¡è®¡æ—¥å¿—å®¡è®¡

### âœ… å·²å®ç°å®¡è®¡æ—¥å¿—

| æ“ä½œ | action | ä½ç½® |
|------|--------|------|
| è®¢å•æ”¯ä»˜ | `process_order_payment` | process-order-payment.ts |
| æ‰“èµå¸–å­ | `tip_post` | process-tip-payment.ts |
| æ‰“èµç”¨æˆ· | `tip_user` | process-user-tip-payment.ts |
| è®¢é˜…æ”¯ä»˜ | `subscription_payment_success` | process-subscription-payment.ts |
| ä½£é‡‘æ”¯ä»˜ | `commission_pay` | commissions/pay/route.ts |
| Stripe webhook | `stripe_webhook` | webhook/route.ts |

---

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

#### 15. å®¡è®¡æ—¥å¿—å¤±è´¥æ— é‡è¯•æœºåˆ¶

**é—®é¢˜**: å®¡è®¡æ—¥å¿—ä¸¢å¤±åæ— æ³•è¿½æº¯ï¼Œå»ºè®®æ·»åŠ æœ¬åœ°ç¼“å†²æˆ–é˜Ÿåˆ—ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// æ·»åŠ æœ¬åœ°é˜Ÿåˆ—
const auditQueue: Array<() => Promise<void>> = []

async function logAuditWithRetry(params) {
  try {
    await logAudit(params)
  } catch (error) {
    // åŠ å…¥é‡è¯•é˜Ÿåˆ—
    auditQueue.push(() => logAudit(params))
    
    // å®šæ—¶é‡è¯•
    setInterval(async () => {
      const queue = [...auditQueue]
      auditQueue.length = 0
      for (const fn of queue) {
        try { await fn() } catch {}
      }
    }, 60000)
  }
}
```

---

### âš ï¸ ç¼ºå¤±å®¡è®¡æ—¥å¿—

ä»¥ä¸‹æ“ä½œç¼ºå°‘ `logAudit`:

- `transfer-to-seller.ts`: è½¬è´¦æˆåŠŸ/å¤±è´¥
- `process-refund.ts`: é€€æ¬¾å¤„ç†
- `retry-transfer.ts`: é‡è¯•æ“ä½œ

---

## ä¹ã€ä»£ç è´¨é‡å®¡è®¡

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ (P1)

#### 16. é‡å¤ä»£ç 

- `alipay/callback/route.ts` å’Œ `wechat/notify/route.ts` å¤§é‡é‡å¤é€»è¾‘
- å»ºè®®æŠ½å–ç»Ÿä¸€çš„ `processPaymentCallback` å‡½æ•°

**ä¿®å¤å»ºè®®**:
```typescript
// æŠ½å–åŸºç±»
abstract class PaymentWebhookHandler {
  abstract provider: string
  abstract verifySignature(request: Request): Promise<boolean>
  abstract parseEvent(request: Request): Promise<PaymentEvent>
  
  async handle(request: Request) {
    const isValid = await this.verifySignature(request)
    if (!isValid) {
      return this.onVerificationFailed(request)
    }
    
    const event = await this.parseEvent(request)
    await this.ensureIdempotency(event)
    return await this.processEvent(event)
  }
  
  protected async ensureIdempotency(event: PaymentEvent) {
    // ç»Ÿä¸€å¹‚ç­‰æ£€æŸ¥
  }
}
```

---

#### 17. ç¡¬ç¼–ç å€¼

```typescript
// transfer-to-seller.ts:129
max_retries: 3,  // ç¡¬ç¼–ç 

// check-tip-limits.ts:13-14
const MAX_TIP_AMOUNT_CNY = 35.0  // åº”ç§»åˆ°é…ç½®
const MAX_DAILY_TIPS = 3
```

**ä¿®å¤å»ºè®®**: ç§»åˆ°é…ç½®æ–‡ä»¶æˆ–æ•°æ®åº“é…ç½®è¡¨ã€‚

---

### ğŸ”´ æ–°å‘ç°: LSP ç¼–è¯‘é”™è¯¯

> 2026-02-21 æ–°å‘ç°çš„é—®é¢˜ï¼Œé€šè¿‡ LSP æ£€æµ‹

#### 18. transfer-to-seller.ts å˜é‡æœªå®šä¹‰

**æ–‡ä»¶**: `src/lib/payments/transfer-to-seller.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 136 è¡Œ
const transferResult = await transferToSeller({
  ...
  fundsSource: fundsSource,  // âŒ fundsSource æœªå®šä¹‰
  ...
})
```

**é—®é¢˜**: `fundsSource` å˜é‡æœªå®šä¹‰ï¼Œå¯èƒ½å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// æ£€æŸ¥ fundsSource çš„å®šä¹‰æˆ–ç§»é™¤è¯¥å­—æ®µ
const transferResult = await transferToSeller({
  sellerId,
  amount: actualPayoutAmount,
  currency,
  paymentMethod,
  paymentTransactionId,
  orderId: order?.id,
  supabaseAdmin,
  // ç§»é™¤ fundsSource æˆ–æ­£ç¡®å®šä¹‰
})
```

---

#### 19. ledger-helpers.ts ç±»å‹æ–­è¨€é”™è¯¯

**æ–‡ä»¶**: `src/lib/payments/ledger-helpers.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 276, 283, 291 è¡Œ
entryType: 'credit' as const  // âŒ TypeScript ç±»å‹é”™è¯¯
```

**é—®é¢˜**: TypeScript ç±»å‹ç³»ç»Ÿè®¤ä¸º 'credit' ä¸èƒ½èµ‹å€¼ç»™ LedgerEntryTypeï¼ˆå¯èƒ½æ˜¯ 'debit'ï¼‰ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
// æ£€æŸ¥ LedgerEntryType ç±»å‹å®šä¹‰
type LedgerEntryType = 'debit' | 'credit'

// ç¡®ä¿ç±»å‹å®šä¹‰æ­£ç¡®
entryType: 'credit' satisfies LedgerEntryType

// æˆ–è€…åœ¨ç±»å‹å®šä¹‰ä¸­æ·»åŠ  'credit'
```

---

#### 20. process-tip-payment.ts ç©ºå€¼æ£€æŸ¥ç¼ºå¤±

**æ–‡ä»¶**: `src/lib/payments/process-tip-payment.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 263, 265 è¡Œ
if (existingPost?.payment_destination) {
  destination = existingPost.payment_destination
  postId = existingPost.id  // âŒ å¯èƒ½ä¸º null
}
```

**é—®é¢˜**: `.single()` è¿”å›çš„å“åº”å¯èƒ½ä¸º null æˆ– errorï¼Œè®¿é—® `.id` æ—¶æœªåšç©ºå€¼æ£€æŸ¥ã€‚

**ä¿®å¤å»ºè®®**:
```typescript
const { data: existingPost } = await supabaseAdmin
  .from('posts')
  ...
  .single()

if (existingPost && existingPost.payment_destination) {
  destination = existingPost.payment_destination
  postId = existingPost.id  // å·²æœ‰éç©ºæ£€æŸ¥
}

// æˆ–è€…ä½¿ç”¨å¯é€‰é“¾
postId = existingPost?.id
```

---

#### 21. process-user-tip-payment.ts ç©ºå€¼æ£€æŸ¥ç¼ºå¤±

**æ–‡ä»¶**: `src/lib/payments/process-user-tip-payment.ts`

**é—®é¢˜ä»£ç **:
```typescript
// ç¬¬ 187, 189 è¡Œ - åŒ process-tip-payment.ts
```

**é—®é¢˜**: åŒä¸Šï¼Œ`.single()` è¿”å›å¯èƒ½ä¸º null æ—¶è®¿é—® `.id`ã€‚

**ä¿®å¤å»ºè®®**: åŒä¸Šã€‚

---

## åã€ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç«‹å³ä¿®å¤

| # | é—®é¢˜ | æ–‡ä»¶ | é£é™©ç­‰çº§ |
|---|------|------|----------|
| 1 | ä½£é‡‘æ”¯ä»˜ç¼ºå°‘å¹‚ç­‰æ£€æŸ¥ | commissions/pay/route.ts | é‡å¤æ”¯ä»˜ |
| 2 | compensation æŸ¥è¯¢è¯­æ³•é”™è¯¯ | compensation.ts:48 | åŠŸèƒ½å¤±æ•ˆ |
| 3 | è®¢é˜…é‡‘é¢éªŒè¯å­—æ®µé”™è¯¯ | process-subscription-payment.ts | éªŒè¯å¤±æ•ˆ |
| 4 | å †æ ˆä¿¡æ¯æš´éœ² | alipay/callback/route.ts | å®‰å…¨æ¼æ´ |
| 5 | Stripe å®ä¾‹å¹¶å‘é—®é¢˜ | stripe.ts | æ•°æ®ç«äº‰ |
| 18 | transfer-to-seller å˜é‡æœªå®šä¹‰ | transfer-to-seller.ts:136 | ç¼–è¯‘é”™è¯¯ |
| 19 | ledger-helpers ç±»å‹æ–­è¨€é”™è¯¯ | ledger-helpers.ts:276,283,291 | ç¼–è¯‘é”™è¯¯ |
| 20 | process-tip-payment ç©ºå€¼æ£€æŸ¥ | process-tip-payment.ts:263,265 | ç¼–è¯‘é”™è¯¯ |
| 21 | process-user-tip-payment ç©ºå€¼æ£€æŸ¥ | process-user-tip-payment.ts:187,189 | ç¼–è¯‘é”™è¯¯ |

### P1 - æœ¬å‘¨ä¿®å¤

| # | é—®é¢˜ | æ–‡ä»¶ | é£é™©ç­‰çº§ |
|---|------|------|----------|
| 6 | è½¬è´¦éƒ¨åˆ†å¤±è´¥æœªæ„ŸçŸ¥ | commissions/pay/route.ts | æ•°æ®ä¸ä¸€è‡´ |
| 7 | é‡‘é¢ç²¾åº¦éªŒè¯ | å¤šå¤„ | è´¢åŠ¡é”™è¯¯ |
| 8 | å®¡è®¡æ—¥å¿—ä¸¢å¤± | å¤šå¤„ | åˆè§„é£é™© |
| 9 | Alipay GET å›è°ƒå¹‚ç­‰ | alipay/callback/route.ts | é‡å¤å¤„ç† |

### P2 - æœ¬æœˆä¿®å¤

| # | é—®é¢˜ | æ–‡ä»¶ | é£é™©ç­‰çº§ |
|---|------|------|----------|
| 10 | PayPal Token ç¼“å­˜ | paypal.ts | æ€§èƒ½ |
| 11 | é‡å¤ä»£ç é‡æ„ | alipay/wechat | ç»´æŠ¤æ€§ |
| 12 | ç¡¬ç¼–ç é…ç½®å¤–ç½® | å¤šå¤„ | è¿ç»´ |

---

## åä¸€ã€æ”¹è¿›å»ºè®®

### 1. å¼•å…¥åˆ†å¸ƒå¼äº‹åŠ¡ (Saga æ¨¡å¼)

```typescript
async function processOrderPaymentWithCompensation() {
  const steps = [
    { name: 'validate', action: validateOrder, compensate: noop },
    { name: 'payment', action: createPayment, compensate: refundPayment },
    { name: 'inventory', action: updateInventory, compensate: restoreInventory },
    { name: 'commission', action: createCommission, compensate: cancelCommission },
    { name: 'ledger', action: recordLedger, compensate: reverseLedger },
  ]
  
  const executedSteps: string[] = []
  
  for (const step of steps) {
    try {
      await step.action()
      executedSteps.push(step.name)
    } catch (error) {
      // å›æ»šå·²æ‰§è¡Œçš„æ­¥éª¤
      for (const name of executedSteps.reverse()) {
        const stepToCompensate = steps.find(s => s.name === name)
        if (stepToCompensate?.compensate) {
          await stepToCompensate.compensate()
        }
      }
      throw error
    }
  }
}
```

---

### 2. ç»Ÿä¸€ Webhook å¤„ç†æ¡†æ¶

```typescript
abstract class PaymentWebhookHandler {
  abstract provider: string
  
  abstract verifySignature(request: Request): Promise<boolean>
  abstract parseEvent(request: Request): Promise<PaymentEvent>
  
  async handle(request: Request) {
    // 1. éªŒç­¾
    if (!await this.verifySignature(request)) {
      throw new Error('Invalid signature')
    }
    
    // 2. è§£æäº‹ä»¶
    const event = await this.parseEvent(request)
    
    // 3. å¹‚ç­‰æ£€æŸ¥
    await this.ensureIdempotency(event)
    
    // 4. å¤„ç†äº‹ä»¶
    return await this.processEvent(event)
  }
  
  protected async ensureIdempotency(event: PaymentEvent) {
    // è°ƒç”¨ process_webhook_event RPC
  }
}
```

---

### 3. æ·»åŠ æ”¯ä»˜çŠ¶æ€æœº

```typescript
// ä½¿ç”¨ xstate æˆ–ç±»ä¼¼åº“
const paymentStateMachine = createMachine({
  id: 'payment',
  initial: 'created',
  states: {
    created: { 
      on: { PAY: 'pending', CANCEL: 'cancelled' } 
    },
    pending: { 
      on: { 
        SUCCESS: 'paid', 
        FAIL: 'failed',
        REFUND_STARTED: 'refunding'
      } 
    },
    paid: { 
      on: { 
        REFUND_STARTED: 'refunding',
        FULL_REFUND: 'refunded' 
      } 
    },
    refunding: {
      on: {
        REFUND_SUCCESS: 'refunded',
        REFUND_FAIL: 'paid'
      }
    },
    failed: { type: 'final' },
    refunded: { type: 'final' },
    cancelled: { type: 'final' },
  }
})
```

---

### 4. é‡‘é¢éªŒè¯å·¥å…·å‡½æ•°

```typescript
// src/lib/payments/amount-validator.ts

interface AmountValidationOptions {
  currency: string
  maxPrecision?: number
  allowZeroDecimal?: boolean
}

export function validateAmount(
  paidAmount: number,
  expectedAmount: number,
  options: AmountValidationOptions
): { valid: boolean; diff: number; tolerance: number } {
  const { currency, maxPrecision = 2, allowZeroDecimal = false } = options
  
  const zeroDecimalCurrencies = ['JPY', 'KRW']
  const isZeroDecimal = zeroDecimalCurrencies.includes(currency.toUpperCase())
  
  const tolerance = isZeroDecimal ? 0 : Math.pow(10, -maxPrecision)
  const diff = Math.abs(paidAmount - expectedAmount)
  
  return {
    valid: diff <= tolerance,
    diff,
    tolerance
  }
}
```

---

## åäºŒã€è¿ç§»æ–‡ä»¶ä¿®å¤

### 281_ledger_system_fixes.sql (å·²åˆ›å»º)

```sql
-- Ledger System Fixes - Migration 281
-- âœ… å·²å®Œæˆ

BEGIN;

-- 1. Add internal_wallet to account_type CHECK constraint
ALTER TABLE accounts DROP CONSTRAINT IF EXISTS accounts_account_type_check;

ALTER TABLE accounts ADD CONSTRAINT accounts_account_type_check CHECK (
  account_type IN (
    'buyer_clearing',
    'seller_payable',
    'seller_receivable',
    'affiliate_payable',
    'platform_escrow',
    'platform_revenue',
    'platform_fee_payable',
    'user_wallet',
    'internal_wallet'
  )
);

-- 2. Fix RLS policies - use service role
DROP POLICY IF EXISTS "Admin full access to accounts" ON accounts;
CREATE POLICY "Service role full access to accounts"
  ON accounts FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- å…¶ä»–è¡¨ç±»ä¼¼å¤„ç†...

COMMIT;
```

---

## åä¸‰ã€æ£€æŸ¥æ¸…å•

ä¿®å¤å®Œæˆåï¼Œè¯·å¯¹ç…§ä»¥ä¸‹æ¸…å•éªŒè¯:

### P0 ç¼–è¯‘é”™è¯¯ä¿®å¤
- [x] ä¿®å¤ transfer-to-seller.ts fundsSource å˜é‡æœªå®šä¹‰
- [x] ä¿®å¤ ledger-helpers.ts ç±»å‹æ–­è¨€é”™è¯¯
- [x] ä¿®å¤ process-tip-payment.ts ç©ºå€¼æ£€æŸ¥
- [x] ä¿®å¤ process-user-tip-payment.ts ç©ºå€¼æ£€æŸ¥

### P1 åŠŸèƒ½é—®é¢˜ä¿®å¤
- [x] ä½£é‡‘æ”¯ä»˜æ·»åŠ çŠ¶æ€æ£€æŸ¥
- [x] compensation æŸ¥è¯¢ä¿®å¤
- [x] è®¢é˜…é‡‘é¢ä½¿ç”¨ display_price éªŒè¯
- [x] ç”Ÿäº§ç¯å¢ƒç§»é™¤å †æ ˆæ—¥å¿—
- [x] Stripe å®ä¾‹ä½¿ç”¨ Map ç¼“å­˜
- [x] è½¬è´¦å¤±è´¥è®°å½•åˆ°å“åº”
- [x] é‡‘é¢ç²¾åº¦æ ¹æ®è´§å¸è°ƒæ•´ (alipay callback)

### P2 æ”¹è¿›é¡¹
- [x] æ·»åŠ ç¼ºå¤±çš„å®¡è®¡æ—¥å¿— (transfer-to-seller.ts, process-refund.ts, retry-transfer.ts) - å·²æœ‰ logTransfer ç³»åˆ—æ—¥å¿—
- [x] å…¶ä»–é‡‘é¢ç²¾åº¦è°ƒæ•´ (wechat, process-order-payment, subscriptions/create-pending, stripe/create-checkout-session, å‰ç«¯é¡µé¢) - å·²å…¨éƒ¨æ ¹æ®è´§å¸è°ƒæ•´ç²¾åº¦
- [x] è¿è¡Œ `npm run typecheck` ç¡®ä¿æ—  TypeScript é”™è¯¯ (æ”¯ä»˜ç›¸å…³æ–‡ä»¶å·²ä¿®å¤ï¼Œä»æœ‰76ä¸ªé¢„å­˜é”™è¯¯)

---

**å®¡è®¡å®Œæˆ**
