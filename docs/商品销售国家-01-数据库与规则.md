# 商品销售国家 - 01 数据库与规则

## 一、概述

**目标**：为商品增加「销售国家/地区」(sales_countries) 字段，在创建/编辑商品时设置，用于标识商品可销售的主要国家。

**业务规则**：
- 每件商品可设置一个或多个目标销售国家（ISO 3166-1 alpha-2 代码）
- 空数组 `[]` 表示未限制，全球可售
- 非空数组表示仅限所列国家可售（后续结账、订单可据此校验买家收货国家）

---

## 二、涉及表与字段

### 2.1 products

| 字段 | 类型 | 默认 | 说明 |
|------|------|------|------|
| sales_countries | TEXT[] | '{}' | 商品可销售的主要国家代码，如 ['CN','US','JP'] |

- 使用 PostgreSQL `TEXT[]` 数组类型，与项目中 `payment_accounts.supported_currencies` 等用法一致
- 空数组 `'{}'` 等价于「未限制」

---

## 三、国家代码规范

- 采用 ISO 3166-1 alpha-2 两位代码（ uppercase）
- 示例：`CN`（中国）、`US`（美国）、`JP`（日本）、`GB`（英国）、`DE`（德国）等
- 前端展示用常量列表，中英双语

---

## 四、数据库迁移

**新建**：`supabase/migrations/244_add_product_sales_countries.sql`

```sql
-- products: 销售国家/地区（主要国家）
ALTER TABLE products
ADD COLUMN IF NOT EXISTS sales_countries TEXT[] DEFAULT '{}';

COMMENT ON COLUMN products.sales_countries IS '商品可销售的主要国家 ISO 3166-1 alpha-2 代码，空数组表示未限制';

-- 兼容旧数据：NULL 视为空数组
UPDATE products SET sales_countries = COALESCE(sales_countries, '{}') WHERE sales_countries IS NULL;
```

---

## 五、类型定义

**文件**：`src/types/database.ts`

在 `products` 的 `Row`、`Insert`、`Update` 中增加：

```ts
// Row
sales_countries: string[]

// Insert（可选）
sales_countries?: string[]

// Update（可选）
sales_countries?: string[]
```

---

## 六、RLS 与索引

- 无需新增 RLS 策略（沿用现有 products 策略）
- 若需按国家筛选商品，可后续添加：`CREATE INDEX IF NOT EXISTS idx_products_sales_countries ON products USING GIN (sales_countries);`（本期可选）
