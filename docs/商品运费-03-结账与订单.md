# 商品运费 - 03 结账与订单

## 一、结账页

**文件**：`src/app/[locale]/(main)/checkout/page.tsx`

- 商品查询 `select` 增加 `shipping_fee`
- 按 seller_id 分组计算：`product_subtotal`、`shipping_fee = MAX(shipping_fee)`、`sellerTotal = product_subtotal + shipping_fee`
- 展示：商品小计、运费、合计（含运费）
- `selectedTotal` 或等价展示需改为「商品小计 + 运费」；或新增 `shippingTotal`、`grandTotal`

---

## 二、订单创建 API

**文件**：`src/app/api/orders/create/route.ts`

- products 查询增加 `shipping_fee`
- 按卖家分组时计算：
  - `productSubtotal = sum(price * quantity)`
  - `shippingFee = max(product.shipping_fee)`（该卖家商品）
  - `totalAmount = productSubtotal + shippingFee`
- 插入 order 时设置：`total_amount: totalAmount`、`shipping_fee: shippingFee`
- 计算 `allSellersTotal` 时使用含运费的 `totalAmount`

---

## 三、购物车

**文件**：`src/store/cartStore.ts`

- `getSelectedTotal()` 仅含商品金额
- 运费需在结账页根据商品数据计算，购物车 store 可保持不变

**文件**：`src/components/ecommerce/ShoppingCart.tsx`

- 可显示「商品小计」，并提示「运费将在结账时计算」

---

## 四、安全与校验

- **服务端计算**：运费和总价在 `/api/orders/create` 中根据数据库 `products.shipping_fee` 计算，不信任前端传入的金额
- **价格校验**：继续校验 `item.price` 与 `product.price` 一致
- **运费校验**：使用 `product.shipping_fee ?? 0`，保证非负
- **支付校验**：`process_order_payment` 以 `order.total_amount` 为准，已包含运费，无需改动

---

## 五、兼容性

- 老商品：`shipping_fee` 默认 0，等价于包邮
- 老订单：`shipping_fee` 默认 0，总价不变
- 现有支付、库存、佣金流程保持不变

---

## 六、实施步骤（推荐顺序）

| 步骤 | 操作 | 文件 |
|------|------|------|
| 1 | 订单创建 API | 查询 shipping_fee、计算并写入 orders |
| 2 | 结账页 | 查询、计算、展示商品小计 + 运费 + 合计 |
| 3 | 订单详情 / 支付页 | 展示 shipping_fee（若需要） |

---

## 七、验证步骤

1. 创建订单：检查 `orders.shipping_fee`、`total_amount` 与预期一致
2. 结账：单商品、多商品、多卖家场景下，商品小计、运费、合计正确
3. 支付：支付金额与 `order.total_amount` 一致
4. 多语言：中英文文案正确
