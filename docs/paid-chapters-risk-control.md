# 付费章节风控方案（创作者保证金）

> **功能已下线**：帖子付费章节功能已取消。迁移 230、231、232、233（创建付费章节 schema）与 234（清理迁移）均已从仓库删除；若某库曾执行过 230–233，应已在该库上执行过 234 完成清理。订阅类型 `creator` 与 sync/expire 中的 creator 分支保留以兼容已有数据。

## 一、业务前提：平台不代收款

- **收款方式**：付费章节的款项**直接支付给作者**，平台不代收、不经手章节收入。
- **后果**：一旦发生退款、侵权下架赔付、chargeback，平台无法从「未结算收入」中扣款，只能从**创作者预先缴纳的保证金**中扣，否则平台将承担全部垫付风险。
- **结论**：必须采用**创作者保证金**，与卖家保证金类似，作为开通付费章节的前置条件与风险兜底。

---

## 二、与卖家保证金对齐：订阅费抵用 + 几乎同一套体系

- **订阅费抵用保证金**：与卖家一致，**创作者订阅费（creator 订阅档位）可抵用保证金额度**。例如：创作者月费/年费对应一档「免费保证金额度」，当「需覆盖的退款敞口」不超过该额度时无需额外缴保证金；超过时需补缴差额。
- **体系复现**：状态机、检查逻辑、缴款/扣款/解冻流程可与卖家保证金**几乎完全一致**；**唯一业务差异**：
  - **退款窗口**：付费章节为**14 天**（自然日或工作日，见下）；卖家为订单/实物交付相关规则。
  - **无实物交付**：敞口基于「最近 14 天内可退款的章节销售额」，不涉及订单发货/完成状态。
- **解耦结论**：为解耦，**仍建议单独一套「付费章节保证金」体系**（独立表、独立 RPC、独立解冻规则），见第四节。

---

## 三、付费章节退款规则与单章价格上限（业务约定）

### 3.1 退款规则

- **退款窗口**：购买付费章节的用户，仅在**购买后 14 天内**可提交退款申请；超过 14 天不予受理。（14 天与欧盟等地区常见要求一致，便于合规；具体以自然日还是工作日由产品/法务定。）
- **退款资金**：受理的退款从该章节对应**创作者的保证金**中扣减；若保证金不足，需先要求创作者补缴或暂停其付费章节权限，平台可先行垫付再追偿（具体策略可配置）。
- **自动解冻**：在「无未决退款、且最近 14 天内的销售已过退款期」的前提下，对应部分的保证金自动变为可退（解冻），创作者可申请退回或系统按规则自动解冻。

### 3.2 单章最高价格（建议限制）

- **建议**：对**单章最高价格设置上限**（如单章不超过 X 元/美元，具体数值由产品与风控定），发帖/编辑与支付下单时校验，超出则拒绝。
- **理由**：
  1. **风控**：单章价格过高时，一笔销售对应的退款敞口就很大，创作者保证金若未按「单笔上限」预留，易出现单笔退款即击穿保证金；设上限可控制单笔敞口，便于与保证金额度匹配。
  2. **防欺诈**：限制「天价单章」可降低虚假/侵权内容单笔套现空间，配合审核与保证金更易管控。
  3. **用户信任**：合理上限（如行业常见的几元～几十元/章）有助于建立预期，减少客诉与争议。
  4. **实现简单**：发帖/编辑与支付接口统一校验 `chapter_price_cents <= 平台配置的单章最高分` 即可；可选在 DB 层加 CHECK 或仅应用层校验（便于按货币/地区配置不同上限）。
- **建议默认上限**：**单章最高 5 美元**（`chapter_price_cents <= 500`）。理由：与多数连载/章节平台的单章定价区间（约 0.99–4.99 USD）一致；单笔退款敞口可控，便于与保证金额度匹配；对读者而言 5 美元以内更易形成「单章小额」预期，利于转化与复购。若运营需要更高上限，可通过配置调整。
- **实现要点**：
  - **配置**：单章最高价建议可配置（如环境变量或配置表），**默认 5 USD**，即 `CHAPTER_PRICE_MAX_CENTS=500`；可按地区/币种设不同上限（如 CNY 对应 30 元）。
  - **校验**：发帖/编辑保存付费章节时校验 `chapter_price_cents <= 配置上限`；章节支付下单前再次校验，防止历史数据或绕过前端。
  - **DB（可选）**：若希望强约束，可在 `posts` 表增加 CHECK（如 `chapter_price_cents <= 500` 或按币种区分），或由应用层统一校验以保留按币种/地区设不同上限的灵活性。

### 3.3 单用户每日购买上限（建议限制）

- **建议**：对**单用户每日章节购买金额设置上限**（如每日累计不超过 100 美元），超过当日上限时不允许继续购买本章节，并给出明确提示。
- **理由**：
  1. **风控**：单日单用户消费有顶，可限制盗刷、异常批量购买带来的退款/chargeback 敞口。
  2. **用户保护**：避免冲动或误操作在一天内大量购买，形成「单日消费上限」预期。
  3. **实现简单**：下单前按「当日已成功支付的章节金额」汇总（可按 USD 等价换算），若「当日已购 + 本章价格」> 上限则拒绝并提示。
- **建议默认上限**：**单用户每日章节购买上限 100 美元**（可配置，如 `CHAPTER_DAILY_SPEND_MAX_CENTS=10000`）。按自然日（UTC 或运营时区）统计该用户当日已成功支付的章节金额（多币种需换算为 USD 再与上限比较）。
- **提示文案**：超过上限时**不建议**使用「购买用户名额已满」等表述（易被理解为「平台今日购买人数已满」）。建议使用：
  - **推荐**：「您今日的章节购买额度已用完（每日上限 100 美元），请明日再试。」
  - 或：「每日章节购买上限 100 美元，您今日已达上限，请明日再试。」
- **实现要点**：
  - **统计**：按用户 + 日期汇总 `chapter_purchases`（或 `payment_transactions` type=chapter）中当日已支付成功的金额；多币种需按汇率换算为 USD 后与 10000 分（100 USD）比较。
  - **校验**：在章节支付**创建下单/支付会话前**校验：`当日已购 USD + 本章价格（换算为 USD）<= 每日上限`；超限则返回 400 并带上上述提示文案的 key，由前端展示。
  - **「日」的定义**：建议与运营时区一致（如 UTC 或 Asia/Shanghai 的 0 点至 24 点），并在帮助或规则中写清。

---

## 四、为何单独一套付费章节保证金（解耦）

尽管设计与卖家保证金高度一致（订阅抵用、状态机、缴款/扣款/解冻），**仍建议单独建一套付费章节保证金体系**，原因如下。

### 4.1 业务逻辑不同

| 维度 | 卖家保证金 | 付费章节保证金 |
|------|------------|----------------|
| **敞口依据** | 未履约订单总额（`get_unfilled_orders_total`，orders 表） | 最近 14 天内仍可退款的章节销售额（chapter_purchases + 时间窗口） |
| **解冻条件** | 订单完成/纠纷关闭等 + 如 3 个工作日 | 最近 14 天内的销售全部过退款期 + 无未决退款 |
| **欠款/扣款关联** | order_id, dispute_id, refund_id | chapter_purchase_id, chapter_refund_id（或等价） |

若共用同一张 deposit_lots 表，则要么用「类型字段」区分卖家/创作者，要么在一条记录里混用两套规则，会导致 RPC、定时任务、报表都充满分支，耦合高、难维护。

### 4.2 数据与生命周期独立

- **独立表**：`creator_deposit_lots`、`creator_debts`（若需要），与 `seller_deposit_lots`、`seller_debts` 分开。
- **同一用户可兼两种角色**：既是卖家又是创作者时，两套余额与要求互不干扰，查询与展示清晰。
- **独立 RPC**：`check_creator_deposit_requirement(p_creator_id, p_new_chapter_sale_amount)` 与 `check_seller_deposit_requirement` 分开实现，参数与返回值可各自扩展（如创作者侧可带 creator 订阅档位）。
- **独立解冻**：`update_creator_deposit_lots_to_refundable()` 与 `update_deposit_lots_to_refundable()`（卖家）分开，由各自定时任务或事件驱动，互不影响。

### 4.3 可复用部分（不共表）

- **状态与流程**：required → held → refundable → refunding → refunded / forfeited，与卖家一致，可在文档与实现规范上统一。
- **支付渠道**：缴保证金可使用同一套 Stripe/PayPal/支付宝等，通过「类型」区分：`deposit_type: 'seller' | 'creator'`，回调写入对应 lot 表。
- **管理端**：列表、审批、退款处理等 UI/API 可复用「模式」（列表筛类型、详情进不同表），但底层读写各自表。
- **扣款模式**：从保证金扣减、记 debt、通知创作者，逻辑结构可复用，具体表与字段按创作者场景来。

### 4.4 小结

| 问题 | 结论 |
|------|------|
| 是否要单独一套付费章节保证金？ | **要**。为解耦、可维护、同一人双角色清晰，建议独立表 + 独立 RPC + 独立解冻逻辑。 |
| 与卖家体系的关系 | **设计上尽量复现**：订阅费抵用、状态机、支付与扣款流程；**实现上分表分 RPC**，不共表、不共「敞口/解冻」逻辑。 |

---

## 五、创作者保证金设计要点（与卖家对齐、独立实现）

### 5.1 表与状态

- **creator_deposit_lots**（与 seller_deposit_lots 对齐）：  
  - 字段思路：creator_id, required_amount, currency, status（required/held/refundable/refunding/refunded/forfeited）, subscription_tier_snapshot（creator 订阅档位抵用额）, required_at, held_at, refundable_at, refund_method, refund_fee_amount, refunded_amount, refund_transaction_id, metadata（如最近 14 天章节销售快照）, created_at, updated_at。  
  - 不共用 seller_deposit_lots，保证解耦。
- **creator_debts**（可选）：平台垫付章节退款/赔付时记创作者欠款，再从保证金或后续补缴中收回；关联 chapter_purchase / 章节退款单等，不共用 seller_debts。

### 5.2 额度与检查：订阅抵用

- **check_creator_deposit_requirement(p_creator_id, p_new_chapter_sale_amount)**（或等价）：  
  - 取创作者当前**有效 creator 订阅档位**作为免费保证金额度（与卖家 subscription_tier 抵用一致）。  
  - 取「最近 14 天内仍可退款的章节销售额」作为当前敞口（可 + p_new_chapter_sale_amount 做预检）。  
  - required_deposit = max(0, 敞口 - 订阅抵用额)。  
  - 返回 requires_deposit, required_amount, current_tier（订阅档位）, suggested_tier, reason 等，供前端/发帖前校验。
- **开通/发帖前**：若 requires_deposit 且未缴足，则不允许发布新的付费章节（或仅允许发布但不允许上架付费），与卖家「不足则禁止接单」一致。

### 5.3 扣款与解冻

- **扣款**：用户退款（14 天内）、侵权下架赔付、chargeback、违规处罚等，从该创作者的保证金中扣减（更新 creator_deposit_lots 或扣款记录，必要时记 creator_debts）。
- **自动解冻**：实现 `update_creator_deposit_lots_to_refundable()`：当某批次/某时段对应的「14 天退款窗口」已全部经过且无未决退款时，将该部分保证金置为 refundable；由定时任务或事件驱动，与卖家解冻逻辑分离。

### 5.4 与卖家保证金的关系（总结）

- **独立**：单独表、单独 RPC、单独解冻规则；同一用户可为卖家与创作者，两套独立。
- **设计对齐**：订阅费抵用、状态机、缴款/扣款/退款流程尽量与卖家一致；仅退款窗口（14 天）与无实物交付两点不同，且通过单独体系实现，避免耦合。

---

## 六、合规与小结

- **14 天退款**：与常见法域（如欧盟 14 天）对齐，具体以自然日/工作日及法务确认为准。
- **小结表**：

| 项目 | 结论 |
|------|------|
| 是否需创作者保证金 | **需要**。平台不代收，款直付作者，必须用保证金兜底退款/侵权/chargeback。 |
| 退款窗口 | **14 天内**可申请退款，超期不受理；退款从创作者保证金中扣。 |
| 单章最高价 | **建议限制**。默认单章最高 **5 USD**（500 分），可配置；发帖/编辑与支付下单时校验。 |
| 单用户每日购买上限 | **建议限制**。默认单用户每日章节购买 **100 USD**，超限时拒绝并提示「您今日的章节购买额度已用完，请明日再试」；不建议用「名额已满」。 |
| 订阅费抵用 | **与卖家一致**：创作者订阅档位抵用保证金额度，不足部分需补缴。 |
| 是否单独一套体系 | **是**。为解耦，单独 creator_deposit_lots / creator_debts / check_creator_deposit_requirement / 解冻逻辑；设计与卖家对齐，实现分表分 RPC。 |
| 保证金解冻 | 无未决退款且对应销售已过 14 天退款期后，**自动解冻**（refundable），逻辑与卖家解冻一致但独立实现。 |

文档版本：1.3  
与「付费章节订阅开通」设计配套，供产品、风控与法务决策参考。
