# 管理员商品审核与创建页联动实施计划

**目标**：系统性检查管理员审核商品流程能否满足创建页 (`/seller/products/create`) 的完整链路，确保审核通过后商品正确上架并可售。

---

## 一、创建页字段与审核链路概览

### 1.1 创建页提交字段

| 字段 | 类型 | 说明 |
|------|------|------|
| name | string | 商品名称 |
| description | string | 商品描述 |
| price | number | 价格 |
| stock | number | 库存 |
| category | string | 分类 |
| currency | Currency | 货币 |
| shipping_fee | number | 运费 |
| images | string[] | 图片 URL 数组（Supabase Storage） |
| allow_affiliate | boolean | 允许带货 |
| commission_rate | number | 佣金率 |
| details | string | 商品详情 |
| faq | JSONB | 常见问题 |
| color_options | JSONB | 颜色选项 |
| sizes | string[] | 尺码 |
| allow_search | boolean | 允许搜索 |
| show_to_guests | boolean | 对访客可见 |
| visibility | enum | 可见范围 |
| condition | string \| null | 成色 |
| sales_countries | string[] | 销售国家 |
| status | 'pending' | 待审核 |

### 1.2 审核流程

1. 商品创建 → `status = 'pending'`，写入 products 表
2. 管理员在 `/admin/review` 看到待审商品列表
3. 点击「通过」→ 先调用 `/api/cloudinary/migrate-product-images`
4. 迁移成功 → 调用 `/api/admin/content-review/[id]/approve`
5. approve API → 更新 `status = 'active'`、`reviewed_by`、`reviewed_at`
6. 数据库触发器 → 发送 `product_approved` 通知给卖家
7. AI 翻译 → 异步调用 `translate-after-publish`

---

## 二、现状检查结果

### 2.1 数据流 ✅

- **approve API**：仅更新 `status`、`reviewed_by`、`reviewed_at`，不覆盖其他字段
- **结论**：创建页写入的所有字段均会被保留，审核通过后数据完整

### 2.2 图片迁移 ❌ 关键问题

**文件**：`src/app/api/cloudinary/migrate-product-images/route.ts`

**现状**：文件为空，未实现 POST 逻辑

**影响**：
- ContentReview 在审核通过前必调 `migrate-product-images`
- 空路由导致 404 或异常，审核会被阻止，提示「迁移图片失败」
- 商品无法通过审核

**结论**：必须实现 `migrate-product-images` 接口。

### 2.3 审核界面展示 ⚠️ 可增强

**文件**：`src/components/admin/ContentReview.tsx`

**现状**：待审商品仅展示 `product.name`、`product.description`

**可增强**：增加价格、货币、图片缩略图、库存、运费、成色、销售国家等，便于管理员做审核判断。

### 2.4 通知与 AI 翻译 ✅

- 触发器：`create_product_review_notification` 在 status 变更时发送 `product_approved` / `product_rejected`
- approve API 会触发 `translate-after-publish` 进行商品翻译

---

## 三、必须实施：migrate-product-images

### 3.1 职责

- 将 `products.images` 中 Supabase Storage 的图片迁移到 Cloudinary
- 更新 `products.images` 为 Cloudinary URL
- 删除 Supabase 中原图
- 仅允许 admin/support 调用

### 3.2 参考实现

- `migrate-post-images/route.ts`：帖子图片迁移
- `migrate-product-comment-images/route.ts`：商品讨论图片迁移

### 3.3 实现要点

| 项 | 说明 |
|----|------|
| 入参 | `{ productId: string }` |
| 鉴权 | admin/support |
| 数据 | products 表 `images: string[]` |
| Storage | bucket `products`，路径形如 `products/{userId}/{timestamp}-{random}.ext` |
| URL 识别 | `supabase.co` + `/storage/v1/object/public/products/` |
| Cloudinary | folder `products` |
| 流程 | 1. 查询 product 2. 筛选 Supabase URL 3. 逐张下载→上传 Cloudinary 4. 全部成功则更新 DB 5. 删除 Supabase 原文件 |
| 无 Supabase 图 | 直接返回 `{ ok: true }`，不报错 |
| Cloudinary 未配置 | 返回 503，提示配置 |

### 3.4 伪代码结构

```
POST /api/cloudinary/migrate-product-images
1. 鉴权 admin/support
2. 解析 body.productId
3. 读取 Cloudinary 配置，未配置则 503
4. 查询 product(id, images)
5. 过滤出 Supabase Storage URL
6. 若为空，return { ok: true }
7. for each url: fetch -> uploadToCloudinary -> newUrls
8. 若有失败，return 500
9. update products set images = newUrls where id = productId
10. 删除 Supabase 原文件（可选，失败仅 log）
11. return { ok: true }
```

---

## 四、可选增强：审核界面信息展示

### 4.1 目标

在 ContentReview 商品卡片中增加更多字段，便于管理员审核。

### 4.2 建议展示内容

| 字段 | 展示方式 |
|------|----------|
| 价格 + 货币 | 文本，如 `¥99.00 (CNY)` |
| 图片 | 缩略图（最多 3 张） |
| 库存 | 数字 |
| 运费 | 若有则显示 |
| 成色 | 若有则显示 |
| 销售国家 | 若有则显示，如「限 CN, US」 |
| 可见性 | visibility 文案 |

### 4.3 涉及文件

- `src/components/admin/ContentReview.tsx`：扩展待审商品卡片 UI
- `src/messages`：若需新增文案，补充 admin 命名空间

---

## 五、实施步骤汇总

| 优先级 | 任务 | 文件 | 说明 |
|--------|------|------|------|
| P0 | 实现 migrate-product-images | `src/app/api/cloudinary/migrate-product-images/route.ts` | 阻塞审核通过，必须完成 |
| P1 | 验证审核全流程 | 手动：创建→审核→上架 | 确保无遗漏 |
| P2 | 增强审核界面展示 | `ContentReview.tsx` | 可选 |

---

## 六、migrate-product-images 实现细节

### 6.1 请求体

```ts
{ productId: string }
```

### 6.2 URL 解析

- Supabase 公开 URL 格式：`https://{project}.supabase.co/storage/v1/object/public/products/{path}`
- 从 URL 解析 bucket 与 path，用于下载和删除

### 6.3 更新 products 表

```ts
await admin.from('products').update({
  images: newUrls,
  updated_at: new Date().toISOString(),
}).eq('id', productId)
```

### 6.4 删除 Supabase 文件

- 使用 `storage.from('products').remove([path])`
- 删除失败仅 log，不回滚 DB 更新（与 migrate-post-images 一致）

---

## 七、验证清单

1. 创建商品（含图片）→ status 为 pending
2. 打开 `/admin/review` → 能看到待审商品
3. 点击「通过」→ 图片迁移成功、approve 成功
4. 商品 status 变为 active，详情页可访问
5. 卖家收到 product_approved 通知
6. 商品翻译任务被触发（可查看日志）
7. 无 Supabase 图片的商品（仅外部 URL）→ 审核通过不报错
