# 支付功能测试清单

## 测试场景

### 1. Stripe 支付

#### 订单支付
- [ ] 创建订单并选择 Stripe 支付
- [ ] 成功跳转到 Stripe Checkout
- [ ] 完成支付后正确回调
- [ ] 订单状态更新为已支付
- [ ] 库存正确扣减
- [ ] 佣金正确计算（如果有）
- [ ] 通知正确发送
- [ ] 重复 webhook 回调不会重复处理（幂等性测试）

#### 订阅支付
- [ ] 卖家订阅支付流程
- [ ] 带货者订阅支付流程
- [ ] 订阅记录正确创建
- [ ] 用户 profile 正确更新
- [ ] 通知正确发送
- [ ] 幂等性测试

#### 打赏支付
- [ ] 打赏流程正常
- [ ] 打赏金额正确更新
- [ ] 通知正确发送
- [ ] 幂等性测试

### 2. PayPal 支付

**Sandbox 测试说明**：使用 Business Sandbox 作为后端凭据，在弹窗中**直接登录** Personal Sandbox 账号（如 sb-xxx@personal.example.com）付款，避免 Guest Checkout 的复杂表单。详见 [paypal-sandbox-testing-guide.md](paypal-sandbox-testing-guide.md)。

#### 订单支付
- [ ] 创建订单并选择 PayPal 支付
- [ ] PayPal 按钮正确显示
- [ ] 完成支付后正确回调
- [ ] 订单状态更新为已支付
- [ ] 库存正确扣减
- [ ] 佣金正确计算
- [ ] 通知正确发送
- [ ] 幂等性测试

#### 订阅支付
- [ ] 订阅支付流程
- [ ] 幂等性测试

#### 打赏支付
- [ ] 打赏流程正常
- [ ] 幂等性测试

#### Sandbox 验收 Gate（上线前必过）
- [ ] 使用 Sandbox business + personal 完成一次端到端支付
- [ ] 弹窗内登录 Personal 账号，点击「同意并付款」
- [ ] 验证 capture 成功、订单/订阅状态更新
- [ ] 验证幂等性（同一 captureId 不重复处理）
- [ ] 验证取消流程（弹窗取消无副作用）
- [ ] 不接受「只看到弹窗就算通过」

### 3. 支付宝支付

#### 订单支付
- [ ] 创建订单并选择支付宝支付
- [ ] 支付订单正确创建
- [ ] 支付回调正确处理
- [ ] 签名验证正确
- [ ] 订单状态更新为已支付
- [ ] 库存正确扣减
- [ ] 佣金正确计算
- [ ] 通知正确发送
- [ ] 幂等性测试

#### 退款功能
- [ ] 全额退款
- [ ] 部分退款
- [ ] 退款记录正确

### 4. 微信支付

#### 订单支付
- [ ] 创建订单并选择微信支付
- [ ] 支付订单正确创建
- [ ] 二维码正确显示
- [ ] 支付回调正确处理
- [ ] 签名验证正确
- [ ] 订单状态更新为已支付
- [ ] 库存正确扣减
- [ ] 佣金正确计算
- [ ] 通知正确发送
- [ ] 幂等性测试

### 5. 银行转账

#### 订单支付
- [ ] 选择银行转账
- [ ] 收款信息正确显示
- [ ] 凭证上传功能正常
- [ ] 凭证记录正确保存
- [ ] 后台可以审核凭证
- [ ] 审核通过后订单状态正确更新
- [ ] 审核通过后触发业务逻辑（库存、佣金、通知）

## 幂等性测试

### 测试方法
1. 完成一次支付
2. 模拟重复的 webhook/回调（相同 provider_ref）
3. 验证：
   - 不会重复扣库存
   - 不会重复计算佣金
   - 不会重复发送通知
   - PaymentTransaction 状态正确

## 错误处理测试

### 支付失败场景
- [ ] Stripe 支付取消
- [ ] PayPal 支付失败
- [ ] 支付宝支付失败
- [ ] 微信支付失败
- [ ] 金额不匹配（回调金额与订单金额不一致）
- [ ] 订单不存在
- [ ] 网络错误

### 验证点
- [ ] 错误信息正确记录
- [ ] 用户收到适当提示
- [ ] 订单状态正确（不应该是已支付）

## 对账功能

### PaymentTransaction 表查询
- [ ] 按订单号查询支付记录
- [ ] 按时间范围查询
- [ ] 按支付方式查询
- [ ] 按状态查询（pending/paid/failed/refunded）

### 数据一致性检查
- [ ] orders.payment_status 与 payment_transactions.status 一致
- [ ] 支付金额与订单金额一致
- [ ] provider_ref 唯一性约束生效

## 日志和监控

### 日志记录
- [ ] 所有支付操作都有日志
- [ ] 回调请求有完整记录
- [ ] 错误有详细日志
- [ ] 幂等性命中情况有记录

### 监控指标
- [ ] 支付成功率
- [ ] 支付失败率
- [ ] 平均处理时间
- [ ] 幂等性命中率
