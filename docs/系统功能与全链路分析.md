# Stratos 系统功能与全链路分析

> 系统性分析项目所有功能及其联动全链路

**说明**：部分链路（如 messages/retract、messages/delete、subscriptions/cancel）可能在 worktree 或分支中已实现，主仓库需合并后生效。文档描述完整设计。

---

## 一、功能域概览

| 域 | 核心实体 | 入口 | 下游联动 |
|----|----------|------|----------|
| 用户与认证 | profiles, auth.users | login/register, middleware | session, guards, RLS |
| 内容 | posts, products, comments | 创建/编辑页, Admin 审核 | 翻译、话题、通知 |
| 社交 | follows, likes, favorites, shares, reposts | 按钮/对话框 | 计数、通知、推荐 |
| 电商订单 | orders, order_items | checkout, 支付回调 | 库存、佣金、保证金 |
| 支付 | payment_transactions, Stripe/Alipay/WeChat | 支付网关 Webhook | 订单、订阅、打赏 |
| 订阅 | subscriptions | 订阅页, create-pending | 权益、profile 同步 |
| 打赏 | tip_transactions | create-tip-session | 通知、分账 |
| 佣金 | affiliate_commissions | 订单支付 | 结算、扣款 |
| 保证金 | seller_deposit_lots | deposits/pay | 接单控制、退款 |
| 纠纷与退款 | order_disputes, refunds | cancel, dispute | processRefund |
| 聊天 | conversations, messages | messages 页 | 通知、Realtime |
| 支持 | support_tickets | 工单页 | 分配、回复、通知 |
| 举报 | reports | ReportDialog | Admin 审核、通知 |
| 管理员 | admin/* | Admin 后台 | 审核、退款、结算 |

---

## 二、核心链路详解

### 2.1 用户认证与会话

```
/login, /register, /forgot-password
  → Supabase Auth
  → /api/auth/callback
  → middleware updateSession (cookie)
  → useAuth, useAuthGuard, useSellerGuard, useAdminGuard
```

- **RLS**：所有表按 `auth.uid()` 或角色策略控制访问
- **侧效**：登录后可选 track，失败写 error log

---

### 2.2 内容发布与审核

```
帖子: /post/create → posts (status=pending)
商品: /seller/products/create → products (status=pending)

Admin 审核:
  POST /api/admin/content-review/[id]/approve
    → 更新 status (approved/active)
    → 通知作者 (content_approved)
    → [post] /api/ai/translate-after-publish, /api/ai/extract-topics-after-approval
    → [product] /api/ai/translate-after-publish
    → logAudit(content_review_approve)

Admin Profile 审核:
  POST /api/admin/profiles/[id]/approve-profile
    → profile.status = approved
    → /api/ai/translate-profile-after-approval
    → 通知用户
```

---

### 2.3 社交互动

| 操作 | 入口 | API/表 | 下游 |
|------|------|--------|------|
| 关注 | FollowButton | follows 表 | 计数 trigger, 通知 |
| 点赞 | LikeButton | likes 表 | like_count trigger, 通知 |
| 收藏 | FavoriteButton | favorites 表 | favorite_count trigger |
| 转发 | RepostDialog | reposts 表 | repost_count, 通知 |
| 分享 | ShareDialog | shares 表 | share_count, 通知 |
| 评论 | CommentSection | comments 表 | comment_count, 通知 |
| 举报 | ReportDialog | reports 表 | Admin 审核, 通知 |

- **限流**：DB trigger (enforce_*_rate_limit) + 前端防抖

---

### 2.4 电商订单全链路

#### 订单创建

```
/cart → /checkout
  → POST /api/checkout/validate-product (cart 校验)
  → POST /api/orders/create
    - 校验: 登录、地址、商品 active、库存、seller 支付就绪
    - 价格: 仅用 DB products.price，忽略前端
    - Affiliate: cookie/body affiliate_post_id → 订单 affiliate_id
    - 写入 orders, order_items
    → 跳转 /orders/[id]/pay
```

#### 支付

```
/orders/[id]/pay
  → Stripe: create-order-checkout-session → Stripe Checkout
  → Alipay/WeChat: create-order → 跳转支付
  → Bank: upload-proof → approve-proof

Webhook/Callback (可信路径):
  Stripe: /api/payments/stripe/webhook (checkout.session.completed)
  Alipay: /api/payments/alipay/callback
  WeChat: /api/payments/wechat/notify
  Bank:  /api/payments/bank/approve-proof
    → processOrderPayment
      → RPC process_order_payment_transaction (库存扣减、订单 paid)
      → calculateAndCreateCommissions (如有 affiliate)
      → 通知 buyer (order_paid), seller (seller_new_order)
      → logAudit(order_paid)
```

#### 发货与完成

```
卖家: POST /api/orders/[id]/ship
  → order_status = shipped
  → 通知买家
  → logAudit(order_shipped)

买家: POST /api/orders/[id]/confirm-receipt
  → order_status = completed
  → 通知卖家
  → checkRecoveryOnOrderCompletion (保证金自动恢复)
  → logAudit(order_received)
```

#### 取消与纠纷

```
取消: POST /api/orders/[id]/cancel
  → processRefund (Stripe/Alipay/WeChat/PayPal)
  → RPC cancel_order_and_restore_stock
  → 通知买卖双方
  → logAudit(order_cancel)

纠纷: POST /api/orders/[id]/dispute
  → order_status = in_dispute
  → 通知对方、Admin
  → logAudit(dispute_open)

Admin 处理: POST /api/admin/disputes
  → processRefund 先执行
  → dispute.status = resolved
  → 通知买卖双方
```

---

### 2.5 订阅与打赏

#### 订阅

```
/subscription/seller | affiliate | tip
  → create-pending (status=pending)
  → create-payment (Alipay/WeChat) 或 Stripe Checkout

支付成功:
  - Alipay/WeChat: callback → activatePendingSubscription
  - Stripe: webhook → processSubscriptionPayment
    → subscriptions (status=active)
    → sync_profile_subscription_derived
    → enableSellerPayment (seller 订阅)
    → 通知用户 (subscription_activated)

取消: POST /api/subscriptions/cancel
  → status = cancelled (到期前仍可用)
  → sync_profile_subscription_derived
```

#### 打赏

```
帖子打赏: create-tip-session (postId, postAuthorId)
用户打赏: create-user-tip-session (targetUserId)
  → checkTipEnabled, checkTipLimits
  → Stripe Checkout

支付成功 (webhook):
  → processTipPayment / processUserTipPayment
    → tip_transactions
    → 通知 recipient (tip_received), tipper (tip_payment_success)
    → transferToSeller (Stripe Connect)
```

---

### 2.6 佣金与保证金

#### 佣金

- **产生**：订单支付时 `calculateAndCreateCommissions` → affiliate_commissions (pending)
- **结算**：Admin `POST /api/admin/commissions/[id]/settle` (仅 order_status=completed)
- **扣款**：Cron `deduct-overdue-commissions` → 超期自动扣

#### 保证金

- **缴纳**：/seller/deposit/pay → seller_deposit_lots
- **使用**：订单支付时更新 lot.used_amount
- **释放**：Cron `update-deposit-lots-status` → held→refundable，通知卖家
- **退款**：Admin `process-refund` 或 用户 `request-refund`
- **接单控制**：check_deposit_requirement → disable_seller_payment / enable_seller_payment

---

### 2.7 聊天与消息

```
私聊: useConversation.getOrCreateConversation → RPC get_or_create_private_conversation
  (校验 banned/blocked)

群聊: POST /api/groups/create
  → conversations (type=group), group_members
  → 通知新成员

发消息: POST /api/messages
  → 校验参与者/群成员
  → 限流 30/min, 每日 500, 60s 内重复内容拦截
  → messages 表
  → 通知接收者
  → 更新 last_message_at

撤回: POST /api/messages/retract (5 分钟内)
  → is_deleted = true
  → 通知成员

删除: POST /api/messages/delete (本人或 Admin)
  → 硬删除

未读: GET /api/messages/unread-count
```

---

### 2.8 Cron 任务

| Cron | 作用 | 下游 |
|------|------|------|
| cancel-expired-orders | 超期未支付订单取消 | 库存恢复, 通知买家 |
| send-order-expiry-reminders | 即将过期提醒 | 通知买家 |
| send-shipping-reminders | 已付未发提醒 | 通知卖家 |
| check-shipping-timeout | 超时未发货 | 通知、可触发纠纷 |
| subscription-lifecycle | 过期订阅 | expire_subscriptions_and_sync_profiles, 通知 |
| subscription-expiry-reminders | 即将过期提醒 | 通知 |
| update-deposit-lots-status | held→refundable | 通知卖家 |
| check-overdue-commissions | 超期佣金 | 通知 |
| deduct-overdue-commissions | 扣款 | penalty-manager |
| collect-debts | 应收欠款 | 通知/账务 |
| auto-escalate-disputes | 纠纷升级 | 通知 Admin |
| auto-close-tickets | 旧工单关闭 | logAudit |
| check-subscription-downgrade | 订阅降级 | 权限调整 |
| update-exchange-rates | 汇率更新 | currencies.rate |

---

### 2.9 埋点与监控

| 入口 | API | 存储 |
|------|-----|------|
| 浏览 | useTrackView | POST /api/track/view → views/analytics_events |
| 关键路径 | x-critical-path header | POST /api/track/critical-path → critical_path_logs |

---

## 三、交叉依赖图

```
                    ┌─────────────────┐
                    │   auth/users    │
                    │   profiles      │
                    └────────┬────────┘
                             │
     ┌───────────────────────┼───────────────────────┐
     │                       │                       │
     ▼                       ▼                       ▼
┌─────────┐           ┌─────────────┐         ┌──────────────┐
│subscriptions│        │  orders     │         │   content    │
│(seller/     │        │  order_items│         │ posts/products│
│affiliate/tip)│       └──────┬──────┘         └──────┬───────┘
└──────┬──┘                  │                       │
       │                     │                       │
       │  sync_profile       │  process_order_       │  approve
       │  subscription_      │  payment_transaction  │  → AI translate
       │  derived            │  → stock, commission  │  → topics
       ▼                     ▼                       ▼
┌──────────────┐      ┌─────────────┐         ┌─────────────┐
│profiles      │      │affiliate_   │         │notifications│
│tip_enabled   │      │commissions  │         │logAudit     │
│seller_tier   │      │seller_deposit│        └─────────────┘
└──────────────┘      │_lots        │
                      └─────────────┘
```

---

## 四、通知 content_key 汇总

| content_key | 触发场景 |
|-------------|----------|
| order_paid | 订单支付成功 |
| seller_new_order | 卖家新订单 |
| order_expiry_reminder | 订单即将过期 |
| order_cancelled | 订单取消 |
| shipping_reminder | 发货提醒 |
| order_confirmed | 买家确认收货 |
| content_approved | 内容审核通过 |
| subscription_activated | 订阅激活 |
| subscription_cancelled | 订阅取消 |
| tip_received | 打赏收到 |
| tip_payment_success | 打赏发送成功 |
| new_chat_message | 私聊新消息 |
| new_group_message | 群聊新消息 |
| message_retracted | 消息撤回 |
| dispute_submitted | 纠纷提交 |
| dispute_new_admin | 新纠纷(Admin) |
| group_invite | 加入群组 |

---

## 五、审计日志 action 汇总

| action | 场景 |
|--------|------|
| order_create, order_paid | 订单创建、支付 |
| order_shipped, order_received | 发货、确认收货 |
| order_cancel | 订单取消 |
| send_message, send_group_message | 发消息 |
| message_retract, message_delete | 撤回、删除 |
| content_review_approve | 内容审核通过 |
| subscription_cancelled | 订阅取消 |
| tip_post, tip_user | 打赏 |
| dispute_open | 纠纷创建 |
| cron_* | 各 Cron 任务 |
| admin_* | 各类 Admin 操作 |

---

## 六、数据表核心关系

- **profiles** ← auth.users, 被 orders/buyer_id|seller_id, posts/user_id, subscriptions/user_id 等引用
- **orders** ← buyer, seller, products; → order_items, order_disputes, refunds
- **subscriptions** ← user; 驱动 profiles.subscription_type, tip_enabled
- **seller_deposit_lots** ← seller; 控制 enable_seller_payment
- **affiliate_commissions** ← order, affiliate; 结算、扣款
- **conversations** ← participant1/2 或 group_members; → messages
- **notifications** ← user_id, actor_id; related_id/related_type 关联各类资源
