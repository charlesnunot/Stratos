# 商品可见性补丁实施计划

针对已验证的三个遗漏项，提供具体补丁与修改步骤。

---

## 一、问题概览

| 序号 | 问题 | 影响 |
|------|------|------|
| 1 | 搜索页未过滤 `allow_search` | 关闭「在搜索中展示」的商品仍会出现在搜索结果 |
| 2 | 迁移 240 未删除旧 RLS 策略 | 可见性限制被绕过，`visibility` / `show_to_guests` 不生效 |
| 3 | 新 RLS 策略缺少 admin/support 与卖家状态校验 | 管理员无法查看全部商品；可能展示 banned/suspended 卖家商品 |

---

## 二、补丁 1：搜索页增加 allow_search 过滤

### 文件
`src/app/[locale]/(main)/search/page.tsx`

### 修改位置
约第 36–40 行，商品搜索查询处。

### 修改前
```tsx
      // Search products
      const { data: products } = await supabase
        .from('products')
        .select('*, seller:profiles!products_seller_id_fkey(username, display_name)')
        .eq('status', 'active')
        .or(`name.ilike.%${query}%,description.ilike.%${query}%`)
        .limit(10)
```

### 修改后
```tsx
      // Search products (only products that allow search)
      const { data: products } = await supabase
        .from('products')
        .select('*, seller:profiles!products_seller_id_fkey(username, display_name)')
        .eq('status', 'active')
        .eq('allow_search', true)
        .or(`name.ilike.%${query}%,description.ilike.%${query}%`)
        .limit(10)
```

### 说明
- 在 `.eq('status', 'active')` 之后添加 `.eq('allow_search', true)`，确保仅展示允许被搜索的商品。

---

## 三、补丁 2 & 3：RLS 策略修复（新建迁移 241）

新建迁移文件修复 RLS，原因：
- 240 若已在环境中执行，不应直接修改
- 通过新迁移可安全、可回滚地修复策略

### 文件
新建：`supabase/migrations/241_fix_product_visibility_rls.sql`

### 完整 SQL 内容

```sql
-- Fix product visibility RLS: drop old policy, recreate with correct logic
-- 1. Drop OLD policy (from migration 153) - otherwise visibility rules are bypassed
DROP POLICY IF EXISTS "Users can view active products from active sellers" ON products;

-- 2. Drop current incomplete policy (from migration 240)
DROP POLICY IF EXISTS "Users can view visible products" ON products;

-- 3. Create correct SELECT policy with:
--    - Seller always sees own products
--    - Admin/support sees all products
--    - Others: active products from active sellers, subject to visibility rules
CREATE POLICY "Users can view visible products" ON products
FOR SELECT USING (
    -- Seller can always view their own products
    (seller_id = auth.uid())
    OR
    -- Admin/support can view all products
    (EXISTS (
        SELECT 1 FROM profiles
        WHERE profiles.id = auth.uid()
        AND profiles.role IN ('admin', 'support')
    ))
    OR
    (
        -- Active products from active sellers only
        status = 'active'
        AND EXISTS (
            SELECT 1 FROM profiles
            WHERE profiles.id = products.seller_id
            AND profiles.status = 'active'
        )
        AND (
            -- Either show to guests or user is authenticated
            (COALESCE(show_to_guests, true) = true OR auth.uid() IS NOT NULL)
            AND (
                -- Public visibility
                COALESCE(visibility, 'public') = 'public'
                -- Followers only
                OR (COALESCE(visibility, 'public') = 'followers_only' AND EXISTS (
                    SELECT 1 FROM follows
                    WHERE follower_id = auth.uid()
                    AND followee_id = products.seller_id
                ))
                -- Following only
                OR (COALESCE(visibility, 'public') = 'following_only' AND EXISTS (
                    SELECT 1 FROM follows
                    WHERE follower_id = products.seller_id
                    AND followee_id = auth.uid()
                ))
                -- Self only (seller only) - redundant here but kept for clarity
                OR (COALESCE(visibility, 'public') = 'self_only' AND seller_id = auth.uid())
            )
        )
    )
);
```

### 说明
- `DROP POLICY IF EXISTS "Users can view active products from active sellers"`：移除旧策略，避免可见性规则被绕过。
- `DROP POLICY IF EXISTS "Users can view visible products"`：移除 240 中的不完整策略。
- 新策略包含：
  1. 卖家本人可查看自己的商品
  2. admin/support 可查看所有商品
  3. 其他用户：仅可查看 `status = 'active'` 且卖家 `status = 'active'` 的商品，并遵守 `show_to_guests` 与 `visibility` 规则
- 使用 `COALESCE(show_to_guests, true)`、`COALESCE(visibility, 'public')` 以兼容旧数据。

---

## 四、实施步骤

### 步骤 1：修改搜索页
1. 打开 `src/app/[locale]/(main)/search/page.tsx`
2. 在商品查询 `.eq('status', 'active')` 后添加 `.eq('allow_search', true)`
3. 保存并检查 lint

### 步骤 2：新建迁移 241
1. 在 `supabase/migrations/` 下新建 `241_fix_product_visibility_rls.sql`
2. 将上文「完整 SQL 内容」复制到文件中
3. 保存

### 步骤 3：执行迁移
```bash
# 本地开发
npx supabase db push

# 或
npx supabase migration up
```

### 步骤 4：验证
1. **搜索**：将某商品设为「不在搜索中展示」，确认搜索中不出现
2. **可见性**：将商品设为 `followers_only`，用非粉丝账号确认不可见
3. **管理员**：用 admin 账号确认可查看所有商品（含非 active）
4. **卖家状态**：将卖家设为 banned/suspended，确认其商品对普通用户不可见

---

## 五、执行顺序总结

| 顺序 | 操作 | 文件 |
|------|------|------|
| 1 | 添加 allow_search 过滤 | `src/app/[locale]/(main)/search/page.tsx` |
| 2 | 新建 RLS 修复迁移 | `supabase/migrations/241_fix_product_visibility_rls.sql` |
| 3 | 执行迁移 | `npx supabase db push` 或 `npx supabase migration up` |
| 4 | 人工验证 | 搜索、可见性、管理员、卖家状态 |

---

## 六、回滚方案（可选）

若迁移 241 出现问题，可执行：

```sql
-- 回滚：恢复旧策略，删除新策略
DROP POLICY IF EXISTS "Users can view visible products" ON products;

CREATE POLICY "Users can view active products from active sellers" ON products
  FOR SELECT USING (
    (
      status = 'active' AND
      EXISTS (
        SELECT 1 FROM profiles
        WHERE profiles.id = products.seller_id
        AND profiles.status = 'active'
      )
    ) OR
    seller_id = auth.uid() OR
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role IN ('admin', 'support')
    )
  );
```

（注意：回滚后可见性功能将失效，所有 active 商品将按旧逻辑展示。）
