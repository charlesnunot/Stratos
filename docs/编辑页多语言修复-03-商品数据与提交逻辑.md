# 编辑页多语言修复 - 03 商品数据与提交逻辑

## 一、商品数据按 locale 显示

编辑页在 `useEffect` 填充表单时，应根据 `locale` 和 `content_lang` 选择原文或译文，使用 `getDisplayContent`。

**修改文件**：`src/app/[locale]/(main)/seller/products/[id]/edit/page.tsx`

### 修改点 1：导入

```ts
import { getDisplayContent } from '@/lib/ai/display-translated'
import { detectContentLanguage } from '@/lib/ai/detect-language'
```

### 修改点 2：在 useEffect 中选择展示内容

```ts
// 当前显示用的 locale（来自 URL）
const displayLocale = locale

// 文本字段
const displayName = getDisplayContent(
  displayLocale,
  product.content_lang ?? null,
  product.name,
  product.name_translated
)
const displayDescription = getDisplayContent(
  displayLocale,
  product.content_lang ?? null,
  product.description,
  product.description_translated
)
const displayDetails = getDisplayContent(
  displayLocale,
  product.content_lang ?? null,
  product.details,
  product.details_translated
)

// FAQ：faq 与 faq_translated 结构相同 [{question, answer}]
let displayFaq = parsedFaq
if (product.faq_translated && Array.isArray(product.faq_translated)) {
  const wantZh = displayLocale === 'zh'
  const isZh = product.content_lang === 'zh' || (product.content_lang !== 'en' && detectContentLanguage(String(product.name || '')) === 'zh')
  if (wantZh !== isZh) {
    displayFaq = product.faq_translated
  }
}
```

再将 `displayName`、`displayDescription`、`displayDetails`、`displayFaq` 填入 `setFormData`。

**注意**：若不想引入 `detectContentLanguage`，可简化为：当 `content_lang === 'en'` 且 `locale === 'zh'` 时用 `faq_translated`，否则用 `faq`。

### FAQ 辅助函数示例

```ts
function getDisplayFaq(
  locale: string,
  contentLang: 'zh' | 'en' | null,
  faq: Array<{ question: string; answer: string }>,
  faqTranslated: Array<{ question: string; answer: string }> | null | undefined
): Array<{ question: string; answer: string }> {
  if (!faqTranslated?.length) return faq
  const wantZh = locale === 'zh'
  const isZh = contentLang === 'zh' || (contentLang !== 'en' && detectContentLanguage(faq[0]?.question ?? '') === 'zh')
  return wantZh === isZh ? faq : faqTranslated
}
```

---

## 二、保存逻辑（方案 B）

编辑页按 locale 显示对应语言，用户编辑后提交到对应字段。在 `handleSubmit` 中根据 `locale` 与 `content_lang` 决定写入原文或译文：

- `locale === contentLang`（或 contentLang 为空时视为与 locale 一致）→ 更新 `name`、`description`、`details`、`faq`
- `locale !== contentLang` → 更新 `name_translated`、`description_translated`、`details_translated`、`faq_translated`

### handleSubmit 修改要点

```ts
// 判断当前编辑的是原文还是译文
const contentLang = (product.content_lang as 'zh' | 'en') ?? 'zh'
const isEditingOriginal = locale === contentLang

const productData: Record<string, unknown> = {
  // ... price, stock, images 等不变
  ...(isEditingOriginal
    ? {
        name: formData.name.trim(),
        description: formData.description.trim() || null,
        details: formData.details.trim() || null,
        faq: formData.faq.length > 0 ? formData.faq : null,
      }
    : {
        name_translated: formData.name.trim() || null,
        description_translated: formData.description.trim() || null,
        details_translated: formData.details.trim() || null,
        faq_translated: formData.faq.length > 0 ? formData.faq : null,
      }
  ),
  // ... 其余字段
}
```

注意：`product` 需包含 `content_lang`，查询时确保 `select('*')` 已包含该字段。

---

## 三、实施步骤

1. 导入 `getDisplayContent` 和 `detectContentLanguage`
2. 实现 `getDisplayFaq` 或等价逻辑
3. 在 `useEffect` 中计算 `displayName`、`displayDescription`、`displayDetails`、`displayFaq`，再填入 `setFormData`
4. 在 `handleSubmit` 的 `productData` 中按上述逻辑构造原文或译文字段

---

## 四、修改清单汇总

| 文件 | 修改内容 |
|------|----------|
| `src/app/[locale]/(main)/seller/products/[id]/edit/page.tsx` | 1) 导入 getDisplayContent、detectContentLanguage；2) 实现 getDisplayFaq；3) useEffect 中用 getDisplayContent/getDisplayFaq 计算展示值；4) handleSubmit 中按 locale 决定写入原文或译文 |

---

## 五、验证步骤

1. 打开 `/en/seller/products/[id]/edit`
   - 检查：有译文的商品，名称、描述、详情、FAQ 是否显示英文
2. 打开 `/zh/seller/products/[id]/edit`
   - 检查：商品数据优先显示中文
3. 编辑并保存
   - 检查：修改内容正确写入对应原文或译文字段
