# 管理员审核可改进项实施计划

**目标**：修复 ContentReview 相关翻译键缺失、商品卡片字段标签硬编码、migrate-product-images 中 crypto 导入方式，提升多语言一致性与代码规范。

---

## 一、改进项概览

| 序号 | 改进项 | 涉及文件 | 优先级 |
|------|--------|----------|--------|
| 1 | 翻译键缺失 | zh.json, en.json | 高 |
| 2 | 商品卡片字段标签硬编码 | ContentReview.tsx | 高 |
| 3 | crypto 导入方式 | migrate-product-images/route.ts | 中 |

---

## 二、改进项 1：翻译键缺失

### 2.1 问题描述

ContentReview 使用 `t('migrateProductImagesFailed')` 和 `t('migrateProductCommentImagesFailed')`，admin 命名空间中未定义，导致回退显示原始 key 或缺失。

### 2.2 涉及位置

- `src/components/admin/ContentReview.tsx` 第 179 行：`t('migrateProductCommentImagesFailed')`
- `src/components/admin/ContentReview.tsx` 第 197 行：`t('migrateProductImagesFailed')`

### 2.3 执行步骤

#### 步骤 1：补充 zh.json

**文件**：`src/messages/zh.json`  
**位置**：`admin` 命名空间内，在 `migrateImagesRetrySuccess` 之后追加

```json
"migrateProductImagesFailed": "商品图片迁移失败，请重试",
"migrateProductCommentImagesFailed": "商品讨论图片迁移失败，请重试"
```

#### 步骤 2：补充 en.json

**文件**：`src/messages/en.json`  
**位置**：`admin` 命名空间内，对应位置

```json
"migrateProductImagesFailed": "Product image migration failed, please retry",
"migrateProductCommentImagesFailed": "Product discussion image migration failed, please retry"
```

### 2.4 验证

- 模拟迁移失败（如 Cloudinary 未配置），点击商品/商品讨论「通过」
- 确认 toast 的 description 显示对应翻译文案，而非原始 key

---

## 三、改进项 2：商品卡片字段标签硬编码

### 3.1 问题描述

ContentReview 待审商品卡片中，「价格：」「库存：」「运费：」「成色：」「销售国家：」「可见性：」为硬编码中文，英文环境下仍显示中文。

### 3.2 涉及位置

**文件**：`src/components/admin/ContentReview.tsx`  
**行号**：约 517-561

| 硬编码内容 | 替换为 |
|------------|--------|
| 价格： | t('productPriceLabel') |
| 库存： | t('productStockLabel') |
| 运费： | t('shippingFeeLabel') |
| 成色： | t('conditionLabel') |
| 销售国家： | t('salesCountriesLabel') |
| 可见性： | t('visibilityLabel') |

### 3.3 执行步骤

#### 步骤 1：补充 admin 命名空间翻译

**zh.json**（在 admin 内追加）：

```json
"productPriceLabel": "价格：",
"productStockLabel": "库存：",
"shippingFeeLabel": "运费：",
"conditionLabel": "成色：",
"salesCountriesLabel": "销售国家：",
"visibilityLabel": "可见性："
```

**en.json**（对应位置）：

```json
"productPriceLabel": "Price: ",
"productStockLabel": "Stock: ",
"shippingFeeLabel": "Shipping: ",
"conditionLabel": "Condition: ",
"salesCountriesLabel": "Sales countries: ",
"visibilityLabel": "Visibility: "
```

#### 步骤 2：修改 ContentReview 组件

将各字段 label 的硬编码中文替换为 `t('...')`：

```tsx
{/* 价格 + 货币 */}
{product.price != null && (
  <div className="flex items-center gap-2">
    <span className="text-muted-foreground">{t('productPriceLabel')}</span>
    ...
  </div>
)}
{/* 库存 */}
<span className="text-muted-foreground">{t('productStockLabel')}</span>
{/* 运费 */}
<span className="text-muted-foreground">{t('shippingFeeLabel')}</span>
{/* 成色 */}
<span className="text-muted-foreground">{t('conditionLabel')}</span>
{/* 销售国家 */}
<span className="text-muted-foreground">{t('salesCountriesLabel')}</span>
{/* 可见性 */}
<span className="text-muted-foreground">{t('visibilityLabel')}</span>
```

### 3.4 可选：visibility 与 condition 取值翻译

当前 `product.visibility` 和 `product.condition` 显示原始值（如 `public`、`like_new`）。若需多语言展示，可：

- 方案 A：在 admin 中增加 `visibilityPublic`、`visibilityFollowersOnly`、`conditionNew`、`conditionLikeNew` 等（与 seller 对齐）
- 方案 B：在 ContentReview 中增加 `useTranslations('seller')`，用 seller 现有翻译展示

建议采用方案 B，复用 seller 命名空间，避免重复。

### 3.5 验证

- 切换 locale 为 `zh`、`en`
- 打开 `/admin/review`，待审商品卡片字段标签随语言正确切换

---

## 四、改进项 3：crypto 导入方式

### 4.1 问题描述

`migrate-product-images/route.ts` 使用 `require('crypto')`，而 `migrate-post-images`、`migrate-product-comment-images` 使用 `import { createHash } from 'crypto'`，风格不统一。

### 4.2 涉及位置

**文件**：`src/app/api/cloudinary/migrate-product-images/route.ts`

- 第 31 行：`return require('crypto').createHash('sha1')...`

### 4.3 执行步骤

#### 步骤 1：添加 import

**位置**：文件顶部，在 `import { getSupabaseAdmin }` 之后

```ts
import { createHash } from 'crypto'
```

#### 步骤 2：替换 cloudinarySignature 内的调用

**修改前**：

```ts
return require('crypto').createHash('sha1').update(sorted + apiSecret).digest('hex')
```

**修改后**：

```ts
return createHash('sha1').update(sorted + apiSecret).digest('hex')
```

### 4.4 验证

- 运行 `npx tsc --noEmit` 确认无类型错误
- 商品审核通过流程正常，图片迁移可成功执行

---

## 五、实施顺序建议

| 顺序 | 改进项 | 说明 |
|------|--------|------|
| 1 | 改进项 1：翻译键缺失 | 文案影响直接，先补全 |
| 2 | 改进项 2：商品卡片标签 | 依赖新翻译键，在 1 之后 |
| 3 | 改进项 3：crypto 导入 | 独立修改，可任意顺序 |

---

## 六、修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `src/messages/zh.json` | admin 命名空间新增 8 个键（2 个迁移失败 + 6 个标签） |
| `src/messages/en.json` | admin 命名空间新增 8 个键 |
| `src/components/admin/ContentReview.tsx` | 6 处硬编码标签替换为 t() |
| `src/app/api/cloudinary/migrate-product-images/route.ts` | 添加 createHash import，替换 require('crypto') |

---

## 七、可选扩展（visibility / condition 取值翻译）

若需对 visibility、condition 的取值做多语言展示，可在 ContentReview 中：

```tsx
const tSeller = useTranslations('seller')

// visibility 显示
const getVisibilityLabel = (v: string) => {
  const key = v === 'public' ? 'visibilityPublic' : 
    v === 'followers_only' ? 'visibilityFollowersOnly' :
    v === 'following_only' ? 'visibilityFollowingOnly' :
    v === 'self_only' ? 'visibilitySelfOnly' : null
  return key ? tSeller(key as any) : v
}
// condition 同理，使用 conditionNew、conditionLikeNew 等
```

并在展示处使用 `getVisibilityLabel(product.visibility)` 等。本期计划不强制包含，可作为后续优化。
