# Stratos 上线前【必须系统性推演】完整清单

**口径**：推演对象 = **交互意图（Intent）**，不是 onClick/onChange。总量约 60 个，覆盖账号、资料、帖子、聊天、商品、订单支付、订阅、系统异常，确保所有功能与交互在上线前全部跑通。

---

## 一、账号与身份相关（6 个）

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 1.1 | 游客 → 触发需要登录的行为（聊天/下单） | 未登录 | 点击「联系卖家」或「立即购买」等需登录入口 | 跳转登录页，登录后可回跳原意图页（redirect 正确） | 无 redirect 时回首页；redirect 含 locale 不重复 | middleware / useAuthGuard / 登录 redirect 与 pathname 一致 |
| 1.2 | 登录成功 → 用户资料未完成 | 新用户或 profile 缺失 | 登录后进入需资料页（如发帖、卖家中心） | 可进入或引导完善资料（按产品设计） | 不因 profile 未写全而 500 | profiles 表与 RLS、默认值 |
| 1.3 | 登录状态过期 → 执行写操作 | Session 过期 | 发帖、下单、发消息等写操作 | 401 或重定向登录，提示「登录已过期」类 | 不静默失败、不重复刷 token 死循环 | API 鉴权与前端 AuthProvider/useAuth 一致 |
| 1.4 | 多设备同时登录 → 状态同步 | 同账号多端登录 | 一端改资料/设置，另一端刷新或切回 | 能看到最新状态或重新拉取 | Session 刷新策略一致 | Supabase session refresh、useAuth 依赖 |
| 1.5 | 登出后 → 旧页面仍可操作？ | 已登出 | 在未刷新的页面继续点击（发帖、下单等） | 请求 401，前端提示登录或跳转登录 | 不暴露他人数据 | 写操作 API 均校验 user |
| 1.6 | 被封禁/冻结用户的行为边界 | 用户已被 admin ban | 访问需登录页、发消息、下单 | 重定向 /banned 或等价页，写操作均被拒绝 | 不进入正常功能页 | middleware 或 API 校验 banned 状态 |

---

## 二、用户资料与社交关系（7 个）

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 2.1 | 编辑个人资料（并发保存/刷新） | 已登录，在 profile 编辑页 | 快速连续保存或多 tab 同时保存 | 最后一次保存生效，无脏写；刷新后为最新 | 冲突时以服务端为准或提示「已被更新」 | PATCH /api/settings 或 profile 更新幂等/乐观锁 |
| 2.2 | 访问他人 profile（权限/可见性） | 对方设置了 profile_visibility | 访问 /profile/[id] | 按设置展示：public 所有人、followers 仅关注者、private 仅自己 | 无权限时 404 或空态，不 500 | RLS 与 who_can_* 一致；前端不暴露私密字段 |
| 2.3 | 关注用户 | 已登录，对方未拉黑 | 点击关注 | 关注数+1，按钮变为「已关注」 | 已关注时幂等；对方拉黑则按产品处理 | follows 表、计数 trigger、前后端一致 |
| 2.4 | 取消关注 | 已关注 | 点击取消关注 | 关注数-1，按钮恢复 | 未关注时幂等 | 同上 |
| 2.5 | 拉黑用户 | 已登录 | 在对方 profile 等入口拉黑 | 进入 blocked_users，对方不可发消息/可见性按产品 | 不能拉黑自己 | useBlock、API 与 RLS |
| 2.6 | 解除拉黑 | 已拉黑 | 设置/列表等处解除拉黑 | 从 blocked_users 移除，可再次互动 | 幂等 | 同上 |
| 2.7 | 被拉黑后，旧入口是否还能操作 | B 被 A 拉黑 | A 打开与 B 的会话或 B 的 profile | 不能发消息；profile 按产品（隐藏或提示） | 不 500，不暴露越权数据 | messages API 与 profile 可见性、blocked_users 校验 |

---

## 三、帖子与内容系统（8 个）

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 3.1 | 发布帖子 | 已登录，内容合规 | 填写内容并提交 | 帖子创建成功，需审核则进入待审；跳转帖子页或列表 | 内容超长/类型错误时前端校验与 API 一致 | 发帖 API、post_topics/post_products 关联、审核流 |
| 3.2 | 编辑帖子 | 本人帖子、未删除 | 编辑内容保存 | 帖子更新，编辑时间更新 | 非本人 403；已删除 404 | RLS 与 API 鉴权 |
| 3.3 | 删除帖子 | 本人帖子 | 点击删除并确认 | 帖子软删或硬删，列表/详情不再展示 | 非本人 403 | 同上 |
| 3.4 | 帖子可见性变化（公开/私密） | 有对应设置项 | 切换可见性并保存 | 设置生效，他人访问按新可见性 | 与 profile 可见性区分清楚 | 帖子级 visibility 若存在则 RLS 一致 |
| 3.5 | 点赞 | 已登录 | 点击点赞 | 点赞数+1，按钮高亮 | 重复点赞幂等（已赞则取消或忽略） | likes 表、like_count trigger、前后端一致 |
| 3.6 | 取消点赞 | 已点赞 | 再次点击 | 点赞数-1，按钮恢复 | 未点赞时幂等 | 同上 |
| 3.7 | 评论 | 已登录，帖子允许评论 | 提交评论 | 评论写入，评论数+1 | 权限（who_can_comment）、敏感词、长度校验 | comments、comment_count、RLS |
| 3.8 | 删除评论 | 本人或有权删除 | 删除评论 | 评论移除或标记删除，评论数-1 | 非本人 403 | 同上 |

---

## 四、聊天与会话系统（12 个）⚠️ 重点

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 4.1 | Message seller（首次建会话） | 已登录，未与卖家建过会话 | 商品页/帖子等点击「联系卖家」 | 创建会话并跳转聊天页，可发首条消息 | 超时 8s 内完成或提示「验证超时，请重试」 | getOrCreateConversationCore、openChat、criticalFetch 若接入 |
| 4.2 | 已存在会话 → 再次进入 | 已有会话 | 再次点击「联系卖家」或从会话列表进入 | 直接进入该会话，不重复建会话 | 会话 id 稳定 | 会话查询按 participant 唯一性 |
| 4.3 | 并发创建会话（双击/多端） | 同一用户对同一卖家 | 快速双击或多 tab 同时点「联系卖家」 | 只产生一个会话，或后续请求复用同一会话 | 无重复会话、无重复成员写入 | 唯一约束或 upsert、getOrCreate 幂等 |
| 4.4 | 创建会话成功，但成员写入失败 | 模拟 DB 部分失败 | 建会话后 member 写入失败（可压测/注入） | 有补偿或回滚，用户不看到「半成品」会话 | 事务或补偿逻辑 | conversations + group_members 一致性 |
| 4.5 | 发送消息 | 已在会话中 | 输入内容发送 | 消息入库，对方 Realtime 可收，未读数更新 | 长度、类型校验；rate limit 30 条/分钟 | POST /api/messages、realtime 订阅 |
| 4.6 | 发送消息失败（网络/权限） | 断网或对方已拉黑 | 发送消息 | 前端提示发送失败，可重试；不显示为「已发送」 | 401/403 明确提示 | API 返回与前端 toast |
| 4.7 | 重复发送（用户连点） | 同一内容快速连点 | 连续点击发送 | 仅一条入库，或去重（idempotency key） | 不出现重复条 | 前端防抖或服务端去重 |
| 4.8 | 消息未读数更新 | 有未读消息 | 对方打开会话或标记已读 | 未读数减为 0，列表角标更新 | Realtime 与本地状态一致 | unread 逻辑、realtime 广播 |
| 4.9 | 打开会话 → 未读清零 | 进入会话页 | 进入 /messages/[id] | 该会话未读清零 | 只清当前会话 | 已读更新 API 或 supabase 更新 |
| 4.10 | Realtime 延迟/未连接 | Realtime 断线或延迟 | 在聊天页操作 | 新消息最终一致；断线时有重连或提示 | 不丢消息、不重复消息 | Realtime channel、重连策略 |
| 4.11 | 被拉黑后发送消息 | A 被 B 拉黑 | A 向 B 发消息 | 403 或明确提示「无法发送」 | 不写入消息 | /api/messages 校验 blocked_users |
| 4.12 | 会话删除/隐藏（如有） | 产品支持删除或隐藏会话 | 执行删除/隐藏 | 会话从列表消失，历史消息按产品处理 | 不越权删他人会话 | 若有 feature，则 API+RLS |

---

## 五、电商与商品（7 个）

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 5.1 | 创建商品 | 已登录且为卖家（有效 seller 订阅） | 填写商品信息提交 | 商品创建成功，进入商品列表/详情 | 非卖家 403；必填项校验 | seller 订阅校验、products 表与 RLS |
| 5.2 | 商品上架 | 本人商品、下架状态 | 点击上架 | status 变为上架，在商品列表可见 | 非本人 403 | 同上 |
| 5.3 | 商品下架 | 本人商品、上架状态 | 点击下架 | status 变为下架，不在公区展示 | 同上 | 同上 |
| 5.4 | 商品被下架后 → 旧页面访问 | 商品已下架 | 直接打开原商品链接或从收藏/聊天进入 | 详情页展示「已下架」或不可购买，不 500 | 不暴露敏感信息 | 商品详情 API 与 status、前端展示 |
| 5.5 | 商品被下架后 → 聊天中 Buy Now | 会话中有商品卡片，商品已下架 | 点击商品卡片「立即购买」 | 提示已下架或跳转商品页看到下架态 | 不生成订单 | 下单前校验商品 status |
| 5.6 | 编辑商品（价格/库存） | 本人商品 | 修改价格或库存保存 | 更新成功，订单创建时以最新价格/库存为准 | 并发编辑时数据一致 | 乐观锁或 last_updated 校验（如有） |
| 5.7 | 非卖家操作商品 | 非卖家身份 | 访问卖家中心、创建/编辑商品 | 403 或重定向 | 不依赖仅前端鉴权 | useSellerGuard、API 与 subscriptions 校验 |

---

## 六、订单与支付（10 个）⚠️ 极高风险

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 6.1 | Buy Now → 创建订单 | 已登录、有地址、有支付方式、库存足够 | 结算页确认下单 | 订单创建成功，跳转支付页或确认页 | 超时 8s 内或「验证超时，请重试」 | criticalFetch checkout_create_orders、库存扣减 |
| 6.2 | 重复点击 Buy Now | 同上 | 快速连续点击「确认下单」 | 仅创建一次订单，或第二次提示「请勿重复提交」 | 前端防抖或服务端幂等 | 防重复提交、订单唯一性 |
| 6.3 | 支付成功 → 前端回调失败 | 支付渠道已扣款 | 用户关闭页面或网络中断未收到回调 | Webhook 仍处理成功，订单状态最终为已支付 | 用户再次打开订单页看到已支付 | Webhook 幂等、payment_transactions、订单状态更新 |
| 6.4 | 支付失败 → 状态回写 | 支付渠道返回失败 | 完成支付流程但失败 | 订单仍待支付，可重试支付；无错误扣款 | 不把失败写成成功 | Webhook 与 order 状态机 |
| 6.5 | Webhook 延迟 | 支付成功但 Webhook 晚到 | 用户立即刷新订单页 | 先见待支付，稍后刷新或 Realtime 变为已支付 | 不重复入账 | 幂等键、payment_transactions |
| 6.6 | Webhook 重复 | 支付渠道重试 | 同一 event 多次回调 | 只处理一次，return 200 | 依赖 provider_ref 或 event.id 去重 | 见 production-runbook 幂等说明 |
| 6.7 | Webhook 丢失 | 极端情况 | 支付成功但 Webhook 未达 | 有对账或人工补单流程 | 见 Runbook「支付成功但订单未更新」 | 对账 SQL、Stripe Dashboard resend |
| 6.8 | 订单状态与支付状态不一致 | 异常导致不一致 | 查询订单与 payment_transactions | 对账脚本可检出；人工修复流程 | 见 Runbook 对账 | 状态机与对账 |
| 6.9 | 订单完成 → 权限变化 | 订单完成后卖家取消订阅等 | 买家/卖家查看订单、评价 | 历史订单仍可查；新权限不影响已完成订单 | 不因权益变化抹掉订单 | 订单查询 RLS 与 buyer_id/seller_id |
| 6.10 | 非订单用户访问订单 | 用户 A | 直接访问 /orders/[B 的订单 id] | 403 或 404，不展示 B 的订单 | API 与 RLS 校验 buyer_id/seller_id | 订单详情与支付页鉴权 |

---

## 七、订阅系统（6 个）

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 7.1 | 订阅 | 已登录、选择档位 | 选择支付方式并完成支付 | 订阅记录创建，权益生效（卖家/带货/打赏） | 支付失败不创建订阅 | create-pending、create-payment、Webhook |
| 7.2 | 重复订阅 | 已有同类型有效订阅 | 再次点击订阅 | 提示已订阅或跳转管理页；不重复扣款 | 幂等 | 订阅表唯一或业务校验 |
| 7.3 | 取消订阅 | 已订阅 | 取消续费（若支持） | 当前周期结束不再续费，到期后权益失效 | 与 Cron subscription-lifecycle 一致 | 取消逻辑与 Cron |
| 7.4 | 到期自动失效 | 订阅到期 | 等待 Cron 或到期时刻 | 权益收回（如 seller 不可发商品）、UI 更新 | Cron 执行、status/expires_at | subscription-lifecycle、前端依据 expires_at |
| 7.5 | 权益生效延迟 | 刚支付完成 | 立即进入卖家中心/带货中心 | 轮询或刷新后可见权益；或提示「生效中」 | 不 500 | subscription 与 profile 或权限查询 |
| 7.6 | 权益失效但 UI 仍显示可用 | 订阅已过期，缓存未更新 | 进入卖家中心等 | 接口返回无权益或跳转续费；UI 不长期显示「可用」 | 前端依据接口与 expires_at | 权限校验与缓存失效 |

---

## 八、系统级与异常（6 个）

| # | 意图 | 前置条件 | 操作步骤 | 预期结果 | 边界/失败处理 | 验证点 |
|---|------|----------|----------|----------|---------------|--------|
| 8.1 | 页面刷新/关闭时的中间状态 | 提交中或跳转中 | 刷新或关闭页面 | 不丢钱：支付类已提交则 Webhook 处理；未提交则可重试 | 无双扣、无半成品订单 | 关键路径幂等与状态机 |
| 8.2 | 网络抖动/请求超时 | 慢网络或超时 | 发帖、下单、建会话等 | 8s 内未完成则提示「验证超时，请重试」；可重试 | 不静默失败 | criticalFetch、CriticalPathTimeoutError |
| 8.3 | API 返回异常 | 500/4xx | 任意写操作 | 前端展示明确错误或重试；不暴露堆栈 | error boundary、toast 文案 | API 错误格式与前端处理 |
| 8.4 | Realtime 断线 | 聊天/通知依赖 Realtime | 断网后恢复 | 重连后消息/通知最终一致 | 重连与重放 | Realtime channel 与重连 |
| 8.5 | Cron 未执行/延迟 | Vercel Cron 或密钥错误 | 依赖 Cron 的流程（订单取消、订阅续期等） | 有 cron_logs 可查；Runbook 有补跑步骤 | 见 production-runbook | verifyCronSecret、cron_logs |
| 8.6 | 数据不一致后的用户体验 | 如计数偏差、订单/支付不一致 | 用户遇到异常展示 | 有对账与修复流程；用户可联系客服或重试 | Runbook 与对账 | 对账脚本、客服流程 |

---

## 九、实施计划（如何执行推演）

### 9.1 执行方式

1. **手工测试**：按上表逐条执行，每条记录「通过/失败/阻塞」与备注。
2. **用例编号**：以「类别.序号」为用例 ID（如 1.1、4.1、6.1），便于与缺陷/需求对应。
3. **优先级**：  
   - P0（必过）：六（订单与支付）、四（聊天与会话）全部 + 一（账号身份）1.1/1.3/1.6。  
   - P1（强推）：二（资料与社交）、三（帖子）、五（商品）、七（订阅）全部。  
   - P2（建议）：八（系统级）及剩余一。
4. **环境**：先在 staging 或预发环境跑通，再在生产发布前做一次精简版（至少 P0）。

### 9.2 产出与衔接

- **推演结果表**：建议维护一份表格（如 Excel/Notion），列：用例 ID、意图简述、通过/失败、备注、执行人、执行日期。
- **与 Runbook 衔接**：推演中若发现「支付成功但订单未更新」「Cron 失败」等，直接对应 [production-runbook.md](production-runbook.md) 的故障条目与对账说明。
- **与配置检查表衔接**：推演前确保 [pre-launch-config-checklist.md](pre-launch-config-checklist.md) 已打勾（环境变量、迁移、Cron 鉴权、健康检查）。

### 9.3 建议执行顺序

1. 完成配置检查表与 Runbook（本次已具备）。
2. 先跑 P0：账号 1.1/1.3/1.6 → 订单 6.1/6.2/6.3/6.10 → 聊天 4.1/4.2/4.5/4.11。
3. 再跑 P1：资料与社交、帖子、商品、订阅全表。
4. 最后补 P2 与系统级；必要时做一次端到端「注册 → 发帖 → 下单 → 支付 → 订单完成」串联。

---

## 十、项目特有补充（可选）

根据实际功能可增删，例如：

- **举报与审核**：用户举报帖子/评论 → 管理员处理 → 举报人/被举报人通知（若有）。
- **带货/佣金**：带货者推广商品、下单后佣金计算与结算（若有）。
- **保证金/卖家存款**：卖家存款不足时下单拦截、存款扣减与退款（若有）。
- **客服工单**：创建工单、回复、关闭（若有）。

以上条目可并入对应类别并赋予编号（如 3.9、6.11），保持总量约 60、推演对象为意图即可。

---

---

## 十一、系统性实施计划表（执行节奏）

| 阶段 | 内容 | 负责人（示例） | 产出 | 完成标准 |
|------|------|----------------|------|----------|
| **阶段 0** | 配置与安全 | 运维/开发 | [pre-launch-config-checklist.md](pre-launch-config-checklist.md) 全部打勾 | 生产无 503、Cron 可执行、健康检查 200 |
| **阶段 1** | P0 推演（账号 + 订单 + 聊天） | QA/开发 | 推演结果表：1.1/1.3/1.6、4.1/4.2/4.5/4.11、6.1～6.10 通过 | 所有 P0 用例「通过」或「已知问题+缓解」 |
| **阶段 2** | P1 推演（资料 + 帖子 + 商品 + 订阅） | QA/开发 | 推演结果表：二/三/五/七全部通过 | 所有 P1 用例「通过」或「已知问题+缓解」 |
| **阶段 3** | P2 推演（系统级 + 剩余一） | QA/开发 | 推演结果表：八 + 一剩余 | 所有 P2 用例「通过」或「已知问题+缓解」 |
| **阶段 4** | 端到端串联 | QA | 1 条完整链路：注册 → 发帖 → 下单 → 支付 → 订单完成 | 链路无阻塞、无错误态 |
| **阶段 5** | 上线决策 | 负责人 | 推演结果表 + Runbook 就绪 + 配置检查表打勾 | 签字/记录日期后发布 |

**说明**：推演对象 = 意图（Intent）；每条用例执行时记录「通过 / 失败 / 阻塞」及备注；失败/阻塞项需对应到缺陷或 Runbook 条目，修复或缓解后再复测。

---

**文档版本**：与上线前「能扛」推演及 [production-runbook.md](production-runbook.md)、[pre-launch-config-checklist.md](pre-launch-config-checklist.md) 配套使用。

**推演结果表**：执行时请在同一目录下维护 [pre-launch-runthrough-results.md](pre-launch-runthrough-results.md)，记录每条用例的代码验证与手工结果。
