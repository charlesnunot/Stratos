# 商品销售国家 - 03 创建页与编辑页

## 一、创建页

**文件**：`src/app/[locale]/(main)/seller/products/create/page.tsx`

### 1.1 FormData

- 增加 `sales_countries: string[]`
- 初始值：从 localStorage 读取上次选择（key 如 `seller_create_sales_countries`），若无则为 `[]`

### 1.2 UI

- 在「可见性」或「运费」区块附近增加「销售国家/地区」区块
- 使用 `SalesCountriesSelector` 组件
- 绑定 `formData.sales_countries` 与 `setFormData`

### 1.3 提交

- `productData` 增加：`sales_countries: formData.sales_countries || []`
- 提交成功后，将 `formData.sales_countries` 写入 localStorage（记住选择）

### 1.4 记住选择逻辑

```ts
// 初始值：localStorage
const [formData, setFormData] = useState<FormData>({
  // ...
  sales_countries: (() => {
    if (typeof window === 'undefined') return []
    try {
      const saved = localStorage.getItem('seller_create_sales_countries')
      if (saved) {
        const parsed = JSON.parse(saved)
        return Array.isArray(parsed) ? parsed : []
      }
    } catch {}
    return []
  })(),
})

// 提交成功后
localStorage.setItem('seller_create_sales_countries', JSON.stringify(formData.sales_countries))
```

---

## 二、编辑页

**文件**：`src/app/[locale]/(main)/seller/products/[id]/edit/page.tsx`

### 2.1 FormData

- 已有 `sales_countries: []`，保持不变

### 2.2 加载商品

- 已有 `sales_countries: product.sales_countries || []`，保持不变

### 2.3 UI

- 在「可见性」区块附近增加「销售国家/地区」区块
- 使用 `SalesCountriesSelector` 组件
- 绑定 `formData.sales_countries` 与 `setFormData`

### 2.4 提交（重要：当前缺失）

- 在 `productData` 中增加：`sales_countries: formData.sales_countries || []`
- 当前编辑页的 `productData` 未包含 `sales_countries`，必须补上

### 2.5 记住选择（可选）

- 编辑页保存成功后，也可将选择写入 localStorage，作为下次创建新商品时的默认值

---

## 三、商品详情页展示（可选）

**文件**：`src/app/[locale]/(main)/product/[id]/ProductPageClient.tsx`

- 在价格、库存、运费附近增加展示：
  - 若 `sales_countries` 为空或未设置：显示「全球可售」
  - 若非空：显示「销售至：中国、美国、日本...」（按 locale 显示国家名称）

---

## 四、DTO / Mapper / Hooks（可选）

若商品列表、搜索等需要展示或筛选销售国家：

- `src/lib/product-card/types.ts`：`ListProductContentDTO` 增加 `salesCountries?: string[]`
- `src/lib/product-card/mappers.ts`：`salesCountries: raw.sales_countries ?? []`
- `src/lib/hooks/useProducts.ts`：Product 接口增加 `sales_countries?: string[]`

---

## 五、结账/订单校验（可选，后续扩展）

- 在结账页或订单创建 API 中，可根据买家收货地址的 `country` 与商品的 `sales_countries` 做校验
- 若商品 `sales_countries` 非空且买家国家不在其中，可提示「该商品暂不配送至您的国家」
- 本期可只实现数据存储与展示，校验留作后续迭代

---

## 六、实施步骤汇总

| 步骤 | 文件 | 操作 |
|------|------|------|
| 1 | migrations/244_add_product_sales_countries.sql | 新增迁移 |
| 2 | src/types/database.ts | products 增加 sales_countries |
| 3 | src/lib/constants/sales-countries.ts | 新建国家常量 |
| 4 | src/components/ecommerce/SalesCountriesSelector.tsx | 新建选择器组件 |
| 5 | zh.json / en.json | 补充 seller、products 翻译 |
| 6 | create/page.tsx | FormData、UI、productData、localStorage |
| 7 | edit/page.tsx | UI、productData 补全 sales_countries |
| 8 | ProductPageClient.tsx（可选） | 详情页展示 |
| 9 | mappers/types/useProducts（可选） | DTO 传递 |

---

## 七、验证步骤

1. 创建商品：选择若干国家，提交后检查 DB `products.sales_countries`
2. 再次进入创建页：默认应显示上次选择（localStorage）
3. 编辑商品：修改销售国家，保存后检查 DB
4. 商品详情页：正确显示「全球可售」或「销售至：...」
5. 多语言：中英文国家名称、文案正确
