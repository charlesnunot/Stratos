# 商品删除功能修复实施计划

**问题**：在 `/zh/seller/products` 页面点击删除图标没有任何反应。

**根因**：`products` 表缺少 DELETE 的 RLS 策略，导致卖家发出的删除请求被数据库拒绝。

---

## 一、根因分析

### 1.1 代码流程

1. 用户点击删除按钮 → 触发 `handleDelete(product.id)`
2. `confirm(tCommon('confirm') + '?')` 弹出确认框
3. 用户确认后 → `supabase.from('products').delete().eq('id', productId).eq('seller_id', user.id)`
4. Supabase 将 DELETE 请求发送至 Postgres
5. **Postgres RLS**：`products` 表未配置 DELETE 策略 → 操作被拒绝
6. 返回 `{ error: { message: "..." } }`
7. 前端显示错误 toast（若 toast 展示不明显，用户易误认为「没反应」）

### 1.2 现有 products 表 RLS 策略

| 操作 | 策略 | 状态 |
|------|------|------|
| SELECT | Users can view visible products | ✅ |
| INSERT | Only active users can create products | ✅ |
| UPDATE | Sellers can update own products | ✅ |
| **DELETE** | **无** | ❌ 缺失 |

### 1.3 结论

- **主因**：缺少 `products` 表的 DELETE RLS 策略，删除请求被 RLS 拒绝。
- **次要**：删除失败时虽有 toast，但若不够醒目，用户可能感觉「没有任何反应」。

---

## 二、解决方案

### 2.1 新增 products 表 DELETE 策略

- 允许：卖家删除自己的商品；admin/support 删除任意商品。
- 与 UPDATE 策略逻辑保持一致。

### 2.2 前端增强（可选）

- 为删除按钮添加 `type="button"`，避免意外触发表单提交。
- 删除成功后增加 success toast。
- 使用更明确的删除确认文案（如 `confirmDeleteProduct`）。

---

## 三、实施步骤

### 步骤 1：新增 DELETE RLS 策略

**新建迁移文件**：`supabase/migrations/245_add_products_delete_policy.sql`

```sql
-- 允许卖家删除自己的商品，admin/support 可删除任意商品
CREATE POLICY "Sellers can delete own products" ON products
  FOR DELETE
  USING (
    auth.uid() = seller_id
    OR EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role IN ('admin', 'support')
    )
  );

COMMENT ON POLICY "Sellers can delete own products" ON products IS '卖家可删除自己的商品，管理员可删除任意商品';
```

### 步骤 2：应用迁移

```bash
supabase db push
# 或
supabase migration up
```

### 步骤 3：前端调整（建议）

**文件**：`src/app/[locale]/(main)/seller/products/page.tsx`

**修改 1**：删除按钮添加 `type="button"`

```tsx
<Button
  type="button"
  variant="outline"
  size="sm"
  onClick={() => handleDelete(product.id)}
  className="text-red-600 hover:text-red-700"
>
  <Trash2 className="h-4 w-4" />
</Button>
```

**修改 2**：删除成功后增加 success toast

```tsx
} else {
  logAudit({ ... })
  toast({
    variant: 'success',
    title: t('deleteSuccess') || '已删除',
    description: t('productDeleted') || '商品已删除',
  })
  refetch()
}
```

**修改 3**：使用更明确的确认文案（可选）

- 在 seller 或 common 中新增 `confirmDeleteProduct`（如「确定要删除该商品吗？此操作不可撤销。」）
- 将 `confirm(tCommon('confirm') + '?')` 改为 `confirm(t('confirmDeleteProduct'))`

---

## 四、翻译键补充（可选）

**seller 命名空间**（zh.json / en.json）：

```json
"confirmDeleteProduct": "确定要删除该商品吗？此操作不可撤销。",
"deleteSuccess": "已删除",
"productDeleted": "商品已删除"
```

```json
"confirmDeleteProduct": "Are you sure you want to delete this product? This cannot be undone.",
"deleteSuccess": "Deleted",
"productDeleted": "Product deleted"
```

---

## 五、实施顺序

| 顺序 | 操作 | 必须 |
|------|------|------|
| 1 | 创建并应用 migration 245（ADD DELETE POLICY） | ✅ |
| 2 | 删除按钮添加 type="button" | 建议 |
| 3 | 删除成功增加 success toast | 建议 |
| 4 | 确认文案与翻译 | 可选 |

---

## 六、验证步骤

1. 应用迁移后，在 `/zh/seller/products` 点击删除图标。
2. 确认出现「确定要删除该商品吗？」（或等价）弹窗。
3. 点击确认后，商品应从列表移除。
4. 检查数据库中对应 `products` 行已删除。
5. 验证 admin/support 账号可删除任意商品（若需要）。

---

## 七、注意事项

- 商品删除会受 FK 约束影响（如 `order_items.product_id` 使用 `ON DELETE CASCADE`），子表记录会自动删除。
- 迁移执行后需重新连接数据库或刷新应用，确保新策略生效。
