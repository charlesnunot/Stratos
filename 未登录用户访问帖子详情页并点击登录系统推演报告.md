# 未登录用户访问帖子详情页并点击登录系统推演报告

**生成日期**: 2026-01-25  
**推演场景**: 未登录用户访问 `/en/post/[id]`，页面渲染完成后看到登录提示/操作按钮，点击「登录」→ 进入登录流程（表单或跳转）

---

## 📋 推演目标

- 页面访问链路（Server / Client、权限）
- 未登录用户可见的登录入口与操作按钮状态
- 点击登录后的行为（弹窗 vs 跳转、登录 API）
- 登录成功/失败反馈与 UI 更新
- 边界情况与潜在问题

---

## 🔍 Step 1：访问帖子详情页

### 1.1 当前实现

**页面**: `src/app/[locale]/(main)/post/[id]/page.tsx`  
**类型**: ⚠️ **纯 Client Component**（`'use client'`）

- 使用 `usePost(postId)` 在客户端拉取帖子
- RLS：仅返回 `status = 'approved'` 且作者 `active` 的公开帖
- 未登录可访问，无重定向

### 1.2 布局与登录入口

帖子详情页位于 `(main)` 布局下，包含 **Sidebar**、**TopBar**、**main**。

**未登录用户可见的登录入口**：

| 位置 | 内容 | 类型 |
|------|------|------|
| **Sidebar** | 更多菜单 →「登录/注册」 | `Link` → `/login` |
| **CommentSection** | 「请登录后发表评论」中的「登录」 | `Link` → `/login` |

帖子内容区 **没有** 单独的「登录」按钮；登录依赖侧边栏与评论区的链接。

### 1.3 操作按钮状态（未登录）

| 按钮 | 可见 | 可点 | 未登录行为 |
|------|------|------|------------|
| 点赞 | ✅ | ❌ 禁用 | `disabled={!user}`，点击无效 |
| 评论 | ✅ 数量 | - | 无输入框；显示「请**登录**后发表评论」 |
| 收藏 | ✅ | ❌ 禁用 | `disabled={!user}`，点击无效 |
| 打赏 | ❌ | - | `if (!user) return null`，不渲染 |
| 转发 | ❌ | - | `{user && (...)}`，不渲染 |
| 分享 | ✅ | ✅ | 可点，打开分享弹窗 |

**结论**：点赞、评论、收藏对未登录用户有「登录」相关提示或入口；打赏、转发不展示。

---

## 🎯 Step 2：点击登录按钮

### 2.1 登录入口与跳转

**无登录弹窗**：当前无 Modal 内嵌登录表单，点击「登录」一律 **跳转** 到登录页。

**入口 1 - Sidebar**

```tsx
<Link href="/login" ...>
  <span>{tMenu('loginOrRegister')}</span>
</Link>
```

- 使用 `Link`，即 **导航到 `/login`**（或 `/[locale]/login`）
- 原实现 **未带 `?redirect=`**，登录成功后默认回首页 `/`，**不会回到帖子详情页** ⚠️

**入口 2 - CommentSection**

```tsx
请<Link href="/login" className="...">登录</Link>后发表评论
```

- 同样 **未带 `?redirect=`**，登录后也回首页，**不会回到当前帖子** ⚠️

### 2.2 登录页与表单

**路由**: `src/app/[locale]/(auth)/login/page.tsx`  
**形式**: 独立登录页（Card + 表单），非弹窗。

**表单内容**：

- 邮箱、密码
- 「忘记密码」链接 → `/forgot-password`
- 提交按钮：「登录」
- 文案「没有账号？」+ 链接 → `/register`

**无第三方登录**：仅有邮箱密码 + 注册入口。

### 2.3 登录 API

**未使用** `POST /api/auth/login`。  
登录通过 **Supabase Client** 完成：

```ts
await supabase.auth.signInWithPassword({ email, password })
```

- 成功：取 `session`，读 `searchParams.redirect`，校验后 `router.push(redirect)`，再 `router.refresh()`
- 失败：`setError(getErrorMessage(error))`，页面展示错误文案

**重定向**：支持 `?redirect=...`；若未传或校验不通过，则回 `/`。

---

## 📝 Step 3：登录表单行为

### 3.1 提交流程

1. 用户输入邮箱、密码 → 点击「登录」
2. `handleLogin` 调用 `signInWithPassword`
3. 成功 → `validateRedirectUrl(redirectParam, '/')` → `router.push(redirect)` + `router.refresh()`
4. 失败 → `setError(...)`，页上显示错误信息

### 3.2 登录成功后的 UI

- **服务端**：`router.refresh()` 触发服务端重取数据
- **客户端**：`useAuth` 等基于 Supabase session，session 更新后 `user` 有值
- **帖子详情页**：
  - 若 **带 `?redirect=/post/[id]`**：会回到帖子详情，点赞/评论/收藏可用，打赏/转发出现
  - 若 **未带 redirect**：跳到首页，**不会回到帖子详情** ⚠️

### 3.3 登录失败

- 错误信息映射（如 invalid_credentials、email_not_confirmed、too_many_requests 等）
- 在表单上方 `div` 中展示，**有明确提示** ✅

---

## ⚠️ Step 4：边界情况

| 情况 | 当前处理 |
|------|----------|
| 登录失败 | 页面展示错误文案 ✅ |
| 帖子不存在 | `usePost` 失败 → `EmptyState`「帖子不存在或加载失败」 ✅ |
| 未公开帖子 | RLS 过滤，同上 ✅ |
| 从帖子页点登录但未带 redirect | 登录成功后回首页，**不回到帖子** ⚠️ |
| 登录表单打不开 | 使用 `Link` 跳转，无弹窗，**不存在打不开** ✅ |

---

## ✅ Step 5：推演结论与修正

### 5.1 页面与登录流程概览

- **访问**: 未登录可访问帖子详情页，RLS 限制仅公开帖
- **登录入口**: Sidebar「登录/注册」、CommentSection「登录」
- **登录形式**: 跳转登录页，**无登录弹窗**
- **认证**: Supabase `signInWithPassword`，**非** `POST /api/auth/login`
- **登录成功**: 支持 `?redirect=`；若未传则回首页

### 5.2 与目标场景的符合度

| 项目 | 状态 |
|------|------|
| 未登录可访问帖子详情页 | ✅ |
| 未登录看到登录提示/操作按钮 | ✅（评论、Sidebar） |
| 点赞/评论/收藏有登录引导 | ✅（评论区链接；点赞/收藏禁用） |
| 打赏/转发未登录不展示 | ✅ |
| 点击登录打开登录表单 | ✅（跳转登录页，非弹窗） |
| 邮箱+密码登录 | ✅ |
| 登录失败有提示 | ✅ |
| 登录成功回到帖子详情页 | ⚠️ **依赖 redirect**（见下） |

### 5.3 已修复项（见代码改动）

1. **CommentSection 登录链接**  
   - 增加 `?redirect=` 为当前帖子详情页路径（如 `/post/[id]`）  
   - 登录成功后回到该帖子 ✅  

2. **Sidebar 登录链接**  
   - 未登录时，若当前 path 非 `/login`、`/register`，则 `href="/login?redirect={pathname}"`  
   - 在帖子详情页点「登录/注册」→ 登录后回到帖子 ✅  

### 5.4 潜在问题与说明

| 问题 | 说明 |
|------|------|
| 无登录弹窗 | 设计为跳转登录页；若需弹窗，需新增 Modal + 登录表单组件 |
| 点赞/收藏仅禁用无文案 | 未登录点击无效（disabled），无 Toast；登录入口在评论区与 Sidebar |
| 登录 API | 使用 Supabase，无自定义 `POST /api/auth/login` |

---

## 📝 总结

1. **访问与权限**：未登录可访问帖子详情，仅见公开帖；登录入口在 Sidebar 与 CommentSection。  
2. **操作按钮**：点赞、收藏禁用；评论区有「登录」链接；打赏、转发不展示；分享可用。  
3. **登录流程**：点击「登录」→ 跳转登录页 → 邮箱密码登录 → 支持 `?redirect=` 回源页。  
4. **已修复**：CommentSection、Sidebar 的登录链接增加 `redirect`，从帖子详情页点击登录后可回到该帖。

**已落地改动**：  
- `CommentSection`：登录链接改为 `/login?redirect=/post/[postId]`（或当前 path）。  
- `Sidebar`：登录链接在合适条件下增加 `?redirect={pathname}`，避免回退到登录/注册页本身。
