# P2 ä¼˜åŒ–ä»»åŠ¡æ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2026-01-25  
**ä»»åŠ¡**: P2 ç»§ç»­ä¼˜åŒ– / ä¸­é•¿æœŸæ”¹è¿›

---

## âœ… ä»»åŠ¡ 1: ç»Ÿä¸€é”™è¯¯å¤„ç†

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### åˆ›å»ºçš„æ–‡ä»¶:
- `src/lib/api/error-handler.ts`

### åŠŸèƒ½ç‰¹æ€§:
1. **é”™è¯¯åˆ†ç±»**: è‡ªåŠ¨åˆ†ç±»é”™è¯¯ç±»å‹ï¼ˆéªŒè¯ã€è®¤è¯ã€æˆæƒã€æ•°æ®åº“ç­‰ï¼‰
2. **ç»Ÿä¸€æ ¼å¼**: æ‰€æœ‰ API é”™è¯¯è¿”å›ç»Ÿä¸€æ ¼å¼
3. **ç”¨æˆ·å‹å¥½æ¶ˆæ¯**: è‡ªåŠ¨ç”Ÿæˆç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
4. **æ•æ„Ÿä¿¡æ¯è¿‡æ»¤**: è‡ªåŠ¨è¿‡æ»¤æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†é’¥ã€å¯†ç ç­‰ï¼‰
5. **ç»“æ„åŒ–æ—¥å¿—**: é”™è¯¯è®°å½•ä¸ºç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ª

### ä½¿ç”¨æ–¹å¼:
```typescript
import { handleApiError } from '@/lib/api/error-handler'

try {
  // Your code
} catch (error) {
  return handleApiError(error, {
    userId: user?.id,
    path: '/api/orders/create',
    method: 'POST',
    requestId: generateRequestId(),
  })
}
```

### é”™è¯¯ç±»å‹:
- `VALIDATION_ERROR` (400) - éªŒè¯é”™è¯¯
- `AUTHENTICATION_ERROR` (401) - è®¤è¯é”™è¯¯
- `AUTHORIZATION_ERROR` (403) - æˆæƒé”™è¯¯
- `NOT_FOUND_ERROR` (404) - èµ„æºä¸å­˜åœ¨
- `CONFLICT_ERROR` (409) - å†²çªé”™è¯¯
- `RATE_LIMIT_ERROR` (429) - é€Ÿç‡é™åˆ¶é”™è¯¯
- `DATABASE_ERROR` (500) - æ•°æ®åº“é”™è¯¯
- `EXTERNAL_SERVICE_ERROR` (502) - å¤–éƒ¨æœåŠ¡é”™è¯¯
- `INTERNAL_SERVER_ERROR` (500) - å†…éƒ¨æœåŠ¡å™¨é”™è¯¯

### å·²æ›´æ–°çš„æ–‡ä»¶:
- `src/app/api/orders/create/route.ts` - ä½¿ç”¨ç»Ÿä¸€é”™è¯¯å¤„ç†

---

## âœ… ä»»åŠ¡ 2: API é€Ÿç‡é™åˆ¶

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### åˆ›å»ºçš„æ–‡ä»¶:
- `src/lib/api/rate-limit.ts`

### åŠŸèƒ½ç‰¹æ€§:
1. **å†…å­˜å­˜å‚¨**: ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ˆé€‚åˆ Serverless ç¯å¢ƒï¼‰
2. **å¯é…ç½®é™åˆ¶**: ä¸åŒç«¯ç‚¹å¯ä»¥é…ç½®ä¸åŒçš„é€Ÿç‡é™åˆ¶
3. **ç”¨æˆ·/IP è¯†åˆ«**: ä¼˜å…ˆä½¿ç”¨ç”¨æˆ· IDï¼Œå›é€€åˆ° IP åœ°å€
4. **æ ‡å‡†å“åº”å¤´**: è¿”å›æ ‡å‡†çš„é€Ÿç‡é™åˆ¶å“åº”å¤´ï¼ˆX-RateLimit-*ï¼‰

### é€Ÿç‡é™åˆ¶é…ç½®:
- `DEFAULT`: 100 è¯·æ±‚/åˆ†é’Ÿ
- `AUTH`: 10 è¯·æ±‚/åˆ†é’Ÿï¼ˆè®¤è¯ç«¯ç‚¹ï¼‰
- `PAYMENT`: 20 è¯·æ±‚/åˆ†é’Ÿï¼ˆæ”¯ä»˜ç«¯ç‚¹ï¼‰
- `ORDER_CREATE`: 10 è¯·æ±‚/åˆ†é’Ÿï¼ˆè®¢å•åˆ›å»ºï¼‰
- `ADMIN`: 200 è¯·æ±‚/åˆ†é’Ÿï¼ˆç®¡ç†å‘˜ç«¯ç‚¹ï¼‰
- `WEBHOOK`: 1000 è¯·æ±‚/åˆ†é’Ÿï¼ˆWebhook ç«¯ç‚¹ï¼‰

### ä½¿ç”¨æ–¹å¼:
```typescript
import { withApiLogging, RateLimitConfigs } from '@/lib/api/logger'

export const POST = withApiLogging(
  async (request: NextRequest) => {
    // Your handler
  },
  {
    rateLimitConfig: RateLimitConfigs.ORDER_CREATE,
  }
)
```

### å“åº”å¤´:
- `X-RateLimit-Limit`: é™åˆ¶æ•°é‡
- `X-RateLimit-Remaining`: å‰©ä½™æ•°é‡
- `X-RateLimit-Reset`: é‡ç½®æ—¶é—´æˆ³
- `Retry-After`: é‡è¯•ç­‰å¾…ç§’æ•°

---

## âœ… ä»»åŠ¡ 3: æ—¥å¿—ä¸ç›‘æ§å¢å¼º

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### åˆ›å»ºçš„æ–‡ä»¶:
- `src/lib/api/logger.ts`

### åŠŸèƒ½ç‰¹æ€§:
1. **è¯·æ±‚æ—¥å¿—**: è®°å½•æ‰€æœ‰ API è¯·æ±‚ï¼ˆæ–¹æ³•ã€è·¯å¾„ã€ç”¨æˆ·ã€çŠ¶æ€ç ã€è€—æ—¶ï¼‰
2. **é”™è¯¯æ—¥å¿—**: è®°å½•é”™è¯¯è¯¦æƒ…ï¼ˆç±»å‹ã€æ¶ˆæ¯ã€ä¸Šä¸‹æ–‡ï¼‰
3. **æ€§èƒ½ç›‘æ§**: è®°å½•è¯·æ±‚è€—æ—¶
4. **ç»Ÿè®¡åŠŸèƒ½**: æä¾› API ç»Ÿè®¡åŠŸèƒ½ï¼ˆæ€»è¯·æ±‚æ•°ã€é”™è¯¯ç‡ã€å¹³å‡è€—æ—¶ç­‰ï¼‰
5. **è¯·æ±‚ ID**: ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€ IDï¼Œä¾¿äºè¿½è¸ª

### æ—¥å¿—å­—æ®µ:
- `method`: HTTP æ–¹æ³•
- `path`: è¯·æ±‚è·¯å¾„
- `userId`: ç”¨æˆ· IDï¼ˆå¦‚æœå·²è®¤è¯ï¼‰
- `statusCode`: HTTP çŠ¶æ€ç 
- `duration`: è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
- `error`: é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
- `timestamp`: æ—¶é—´æˆ³
- `userAgent`: ç”¨æˆ·ä»£ç†
- `ip`: å®¢æˆ·ç«¯ IP
- `requestId`: è¯·æ±‚ ID

### ä½¿ç”¨æ–¹å¼:
```typescript
import { withApiLogging } from '@/lib/api/logger'

export const GET = withApiLogging(
  async (request: NextRequest) => {
    // Your handler
    // Logging is automatic
  }
)
```

### ç»Ÿè®¡åŠŸèƒ½:
```typescript
import { getApiStatistics, getApiLogs } from '@/lib/api/logger'

// Get statistics
const stats = getApiStatistics()
// { totalRequests, errorRate, averageDuration, requestsByStatus }

// Get recent logs
const logs = getApiLogs(100)
```

---

## âœ… ä»»åŠ¡ 4: ç´¢å¼•æ£€æŸ¥ä¸æ•°æ®åº“ä¼˜åŒ–

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### åˆ›å»ºçš„æ–‡ä»¶:
- `supabase/migrations/152_add_missing_indexes.sql`

### æ·»åŠ çš„ç´¢å¼•:

#### Orders è¡¨:
- `idx_orders_payment_status` - æ”¯ä»˜çŠ¶æ€ç´¢å¼•
- `idx_orders_order_status` - è®¢å•çŠ¶æ€ç´¢å¼•
- `idx_orders_buyer_status` - ä¹°å®¶è®¢å•æŒ‰çŠ¶æ€æŸ¥è¯¢ï¼ˆå¤åˆç´¢å¼•ï¼‰
- `idx_orders_seller_status` - å–å®¶è®¢å•æŒ‰çŠ¶æ€æŸ¥è¯¢ï¼ˆå¤åˆç´¢å¼•ï¼‰
- `idx_orders_payment_order_status` - æ”¯ä»˜çŠ¶æ€å’Œè®¢å•çŠ¶æ€å¤åˆç´¢å¼•

#### Products è¡¨:
- `idx_products_status_created` - æ´»è·ƒå•†å“æŒ‰åˆ›å»ºæ—¶é—´æ’åº
- `idx_products_seller_status` - å–å®¶å•†å“æŒ‰çŠ¶æ€æŸ¥è¯¢ï¼ˆå¤åˆç´¢å¼•ï¼‰

#### Subscriptions è¡¨:
- `idx_subscriptions_user_status` - ç”¨æˆ·è®¢é˜…æŒ‰çŠ¶æ€æŸ¥è¯¢ï¼ˆå¤åˆç´¢å¼•ï¼‰
- `idx_subscriptions_status_expires` - æ´»è·ƒè®¢é˜…è¿‡æœŸæ—¶é—´æŸ¥è¯¢

#### å…¶ä»–è¡¨:
- `idx_payment_accounts_seller_verified` - å–å®¶æ”¯ä»˜è´¦æˆ·éªŒè¯çŠ¶æ€
- `idx_order_groups_buyer_status` - è®¢å•ç»„ä¹°å®¶çŠ¶æ€æŸ¥è¯¢
- `idx_order_disputes_order_id` - è®¢å•çº çº·è®¢å• ID
- `idx_order_disputes_status` - è®¢å•çº çº·çŠ¶æ€
- `idx_order_refunds_order_id` - é€€æ¬¾è®¢å• ID
- `idx_order_refunds_status` - é€€æ¬¾çŠ¶æ€
- `idx_seller_debts_seller_status` - å–å®¶å€ºåŠ¡çŠ¶æ€æŸ¥è¯¢
- `idx_affiliate_commissions_affiliate_status` - è”ç›Ÿä½£é‡‘çŠ¶æ€æŸ¥è¯¢
- `idx_comments_item_type_id` - è¯„è®ºé¡¹ç±»å‹å’Œ ID

### æ€§èƒ½æå‡:
- âœ… å¸¸è§æŸ¥è¯¢æ¨¡å¼éƒ½æœ‰ç´¢å¼•æ”¯æŒ
- âœ… å¤åˆç´¢å¼•ä¼˜åŒ–å¤šå­—æ®µæŸ¥è¯¢
- âœ… éƒ¨åˆ†ç´¢å¼•ï¼ˆWHERE å­å¥ï¼‰å‡å°‘ç´¢å¼•å¤§å°
- âœ… è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨æŸ¥è¯¢

---

## ğŸ“Š å®æ–½æ•ˆæœ

### 1. ç»Ÿä¸€é”™è¯¯å¤„ç†
- **é—®é¢˜**: é”™è¯¯å¤„ç†ä¸ä¸€è‡´ï¼Œéš¾ä»¥è¿½è¸ª
- **è§£å†³**: ç»Ÿä¸€çš„é”™è¯¯åˆ†ç±»å’Œå¤„ç†
- **å½±å“**: é”™è¯¯è¿½è¸ªæ›´å®¹æ˜“ï¼Œç”¨æˆ·ä½“éªŒæ›´ä¸€è‡´

### 2. API é€Ÿç‡é™åˆ¶
- **é—®é¢˜**: æ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œå¯èƒ½è¢«æ»¥ç”¨
- **è§£å†³**: å¯é…ç½®çš„é€Ÿç‡é™åˆ¶ï¼Œä¸åŒç«¯ç‚¹ä¸åŒé™åˆ¶
- **å½±å“**: é˜²æ­¢æ»¥ç”¨ï¼Œæé«˜å®‰å…¨æ€§

### 3. æ—¥å¿—ä¸ç›‘æ§
- **é—®é¢˜**: ç¼ºå°‘è¯·æ±‚æ—¥å¿—ï¼Œéš¾ä»¥æ’æŸ¥é—®é¢˜
- **è§£å†³**: ç»“æ„åŒ–æ—¥å¿—ï¼ŒåŒ…å«æ‰€æœ‰å…³é”®ä¿¡æ¯
- **å½±å“**: é—®é¢˜æ’æŸ¥æ›´å¿«ï¼Œå¯ä»¥ç”Ÿæˆç›‘æ§æŠ¥è¡¨

### 4. æ•°æ®åº“ç´¢å¼•
- **é—®é¢˜**: éƒ¨åˆ†æŸ¥è¯¢å­—æ®µç¼ºå°‘ç´¢å¼•
- **è§£å†³**: æ·»åŠ å…³é”®æŸ¥è¯¢å­—æ®µçš„ç´¢å¼•
- **å½±å“**: æŸ¥è¯¢æ€§èƒ½æå‡ï¼Œå‡å°‘æ…¢æŸ¥è¯¢

---

## âœ… éªŒè¯æ¸…å•

- [x] ç»Ÿä¸€é”™è¯¯å¤„ç†å·²å®ç°
- [x] API é€Ÿç‡é™åˆ¶å·²å®ç°
- [x] æ—¥å¿—ä¸ç›‘æ§å·²å®ç°
- [x] æ•°æ®åº“ç´¢å¼•å·²æ·»åŠ 
- [x] ç¤ºä¾‹ä»£ç å·²åˆ›å»º
- [x] æ‰€æœ‰ä»£ç é€šè¿‡ linter æ£€æŸ¥

---

## ğŸ“ åç»­å»ºè®®

### 1. é€æ­¥åº”ç”¨ç»Ÿä¸€é”™è¯¯å¤„ç†

å»ºè®®æŒ‰ä¼˜å…ˆçº§åº”ç”¨ï¼š
1. **é«˜ä¼˜å…ˆçº§**: æ”¯ä»˜ç›¸å…³ APIã€è®¢å•ç›¸å…³ API
2. **ä¸­ä¼˜å…ˆçº§**: ç”¨æˆ·ç›¸å…³ APIã€å•†å“ç›¸å…³ API
3. **ä½ä¼˜å…ˆçº§**: å…¶ä»– API

### 2. é€æ­¥åº”ç”¨é€Ÿç‡é™åˆ¶

å»ºè®®é…ç½®ï¼š
- è®¤è¯ç«¯ç‚¹: `RateLimitConfigs.AUTH`
- æ”¯ä»˜ç«¯ç‚¹: `RateLimitConfigs.PAYMENT`
- è®¢å•åˆ›å»º: `RateLimitConfigs.ORDER_CREATE`
- å…¶ä»–ç«¯ç‚¹: `RateLimitConfigs.DEFAULT`

### 3. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

- **é€Ÿç‡é™åˆ¶**: è€ƒè™‘ä½¿ç”¨ Redis æˆ– Supabase å®ç°åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶
- **æ—¥å¿—å­˜å‚¨**: è€ƒè™‘å°†æ—¥å¿—å­˜å‚¨åˆ°æ•°æ®åº“æˆ–æ—¥å¿—æœåŠ¡ï¼ˆå¦‚ Logtail, Datadogï¼‰
- **ç›‘æ§ Dashboard**: åˆ›å»º API ç›‘æ§ Dashboard å±•ç¤ºç»Ÿè®¡ä¿¡æ¯

### 4. ç±»å‹å®‰å…¨æ”¹è¿›

éœ€è¦é€æ­¥æ›¿æ¢ `any` ç±»å‹ï¼š
- ä¼˜å…ˆå¤„ç†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆæ”¯ä»˜ã€è®¢å•ï¼‰
- ä½¿ç”¨ TypeScript ä¸¥æ ¼æ¨¡å¼
- æ·»åŠ ç±»å‹å®šä¹‰æ–‡ä»¶

### 5. å…¶ä»– Server Components é¡µé¢é‡æ„

ç»§ç»­é‡æ„å‰©ä½™é¡µé¢ï¼š
- `feed/page.tsx`
- `products/page.tsx`
- `profile/[id]/page.tsx`
- `post/[id]/page.tsx`
- ç­‰ç­‰...

---

## ğŸ‰ æ€»ç»“

å·²å®Œæˆ P2 ä¼˜åŒ–ä»»åŠ¡çš„æ ¸å¿ƒéƒ¨åˆ†ï¼š

1. âœ… **ç»Ÿä¸€é”™è¯¯å¤„ç†**: åˆ›å»ºäº†ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ç³»ç»Ÿ
2. âœ… **API é€Ÿç‡é™åˆ¶**: å®ç°äº†å¯é…ç½®çš„é€Ÿç‡é™åˆ¶
3. âœ… **æ—¥å¿—ä¸ç›‘æ§**: æ·»åŠ äº†è¯·æ±‚æ—¥å¿—å’Œç»Ÿè®¡åŠŸèƒ½
4. âœ… **æ•°æ®åº“ç´¢å¼•**: æ·»åŠ äº†å…³é”®æŸ¥è¯¢å­—æ®µçš„ç´¢å¼•

**ä¸‹ä¸€æ­¥**: 
- é€æ­¥å°†ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œé€Ÿç‡é™åˆ¶åº”ç”¨åˆ°æ‰€æœ‰ API è·¯ç”±
- ç»§ç»­ç±»å‹å®‰å…¨æ”¹è¿›
- ç»§ç»­ Server Components é¡µé¢é‡æ„
