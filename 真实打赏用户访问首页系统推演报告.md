# 真实打赏用户访问首页系统推演报告

## 用户身份设定

```
- 已注册、已登录
- profiles.role = 'user' 或 'subscriber'
- subscription.status = 'active' (subscription_type = 'tip')
- profiles.tip_enabled = true
- 已绑定支付方式（Stripe/PayPal）
- 非 admin、非 support
```

## 访问行为

```
URL: /en
真实系统上下文：Supabase session、profile、订阅状态、打赏功能状态均有效
```

---

## Step 1: middleware.ts 分析

### 1.1 代码路径
`middleware.ts` → `src/lib/supabase/middleware.ts`

### 1.2 执行流程

```typescript
// middleware.ts
export async function middleware(request: NextRequest) {
  // 1. 环境变量验证（通过）
  // 2. 更新 Supabase 会话
  const response = await updateSession(request)
  // 3. 应用国际化中间件
  return intlMiddleware(request)
}
```

```typescript
// src/lib/supabase/middleware.ts
export async function updateSession(request: NextRequest) {
  // 1. 创建 Supabase 客户端
  const supabase = createServerClient(...)
  
  // 2. 获取用户
  const { data: { user } } = await supabase.auth.getUser()
  
  // 3. 检查用户状态
  if (user) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('status, subscription_type, role')
      .eq('id', user.id)
      .single()
    
    // 4. 检查 banned/suspended
    if (profile?.status === 'banned' || profile?.status === 'suspended') {
      return NextResponse.redirect('/en/banned')
    }
  }
  
  return response
}
```

### 1.3 推演结果

✅ **正常流程**：
- Session 正确识别：`supabase.auth.getUser()` 返回有效用户
- Profile 查询成功：获取 `status`, `subscription_type`, `role`
- 状态检查通过：`status` 不是 'banned' 或 'suspended'
- 继续路由到 `/en`

⚠️ **发现的问题**：

1. **P2 - 未检查订阅状态**
   - middleware 只检查 `status`，**不检查订阅是否过期**
   - 如果 `subscription.status = 'expired'` 但 `tip_enabled = true`（数据不一致），用户仍可访问首页
   - **影响**：可能导致过期订阅用户仍看到打赏功能

2. **P2 - 未检查打赏功能状态**
   - middleware 不检查 `tip_enabled`
   - 如果 `tip_enabled = false` 但 `subscription.status = 'active'`，用户仍可访问
   - **影响**：功能状态不一致时，用户可能看到错误提示

3. **P1 - 未验证订阅类型**
   - middleware 查询了 `subscription_type` 但未使用
   - 如果用户有 `subscription_type = 'seller'` 但没有 `tip` 订阅，理论上不应有打赏功能
   - **影响**：权限验证不完整

### 1.4 修复建议

```typescript
// src/lib/supabase/middleware.ts
if (user) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('status, subscription_type, role, tip_enabled')
    .eq('id', user.id)
    .single()

  if (profile?.status === 'banned' || profile?.status === 'suspended') {
    return NextResponse.redirect(bannedUrl)
  }
  
  // 新增：检查 tip 订阅状态（如果用户有 tip 订阅）
  if (profile?.subscription_type === 'tip') {
    const { data: tipSubscription } = await supabase
      .from('subscriptions')
      .select('status, expires_at')
      .eq('user_id', user.id)
      .eq('subscription_type', 'tip')
      .eq('status', 'active')
      .gt('expires_at', new Date().toISOString())
      .single()
    
    // 如果订阅过期，清除 tip_enabled（可选，或由 cron job 处理）
    if (!tipSubscription && profile.tip_enabled) {
      // 可选：异步更新 tip_enabled = false
      // 但不应阻塞请求
    }
  }
}
```

---

## Step 2: 路由解析

### 2.1 路由路径
`/en` → `src/app/[locale]/(main)/page.tsx`

### 2.2 路由结构

```
src/app/
  ├── page.tsx (根路由，重定向到 /en)
  ├── [locale]/
  │   ├── layout.tsx (国际化布局)
  │   └── (main)/
  │       └── page.tsx (首页 Server Component)
```

### 2.3 推演结果

✅ **正常流程**：
- 路由正确解析到 `[locale]/(main)/page.tsx`
- 国际化中间件已处理 locale = 'en'
- 无额外路由守卫

⚠️ **发现的问题**：

1. **P2 - 首页无订阅状态检查**
   - 首页 Server Component 不检查订阅状态
   - 不验证 `tip_enabled` 是否与订阅状态一致
   - **影响**：可能显示不一致的功能状态

---

## Step 3: 首页 Server Component

### 3.1 代码路径
`src/app/[locale]/(main)/page.tsx`

### 3.2 执行流程

```typescript
export default async function HomePage() {
  const supabase = await createClient()
  
  // 1. 获取用户
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  const validUser = authError ? null : user
  
  // 2. 检查用户状态
  if (validUser) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('status, subscription_type, role')
      .eq('id', validUser.id)
      .single()
    
    // 3. 检查 deleted/banned/suspended
    if (profile?.status === 'deleted') { return <HomePageClient ... /> }
    if (profile?.status === 'banned' || profile?.status === 'suspended') { return <HomePageClient ... /> }
    
    // 4. 存储 subscription_type
    subscriptionType = profile?.subscription_type || null
  }
  
  // 5. 查询帖子
  let postsQuery = supabase.from('posts').select(...).eq('status', 'approved')
  
  // 6. 个性化：如果用户有关注，优先显示关注用户的帖子
  if (validUser) {
    const { data: following } = await supabase
      .from('follows')
      .select('following_id')
      .eq('follower_id', validUser.id)
    // ... 个性化逻辑
  }
  
  // 7. 返回 Client Component
  return <HomePageClient
    initialPosts={posts}
    user={validUser}
    subscriptionType={subscriptionType}
    ...
  />
}
```

### 3.3 推演结果

✅ **正常流程**：
- Session 正确识别：`supabase.auth.getUser()` 返回有效用户
- Profile 查询成功：获取 `status`, `subscription_type`, `role`
- 状态检查通过：非 deleted/banned/suspended
- 帖子查询成功：获取已审核的帖子列表
- 个性化逻辑：如果有关注，优先显示关注用户的帖子
- 传递数据到 Client Component：`user`, `subscriptionType`, `initialPosts`

❌ **发现的问题**：

1. **P1 - 未查询打赏功能状态**
   - Server Component **不查询 `tip_enabled`**
   - 不查询 `subscription.status` 验证订阅是否有效
   - **影响**：Client Component 需要额外查询，可能导致 hydration mismatch

2. **P2 - 未传递打赏功能标记**
   - 只传递了 `subscriptionType`，未传递 `tipEnabled` 或 `canTip`
   - Client Component 需要自己查询 `tip_enabled`
   - **影响**：增加客户端查询，可能导致闪烁

3. **P2 - 未根据打赏功能过滤内容**
   - 不根据 `tip_enabled` 返回额外数据（如可打赏的帖子、打赏排行榜）
   - 所有帖子都返回，由 Client Component 决定是否显示打赏按钮
   - **影响**：功能上可接受，但可能影响性能

4. **P0 - 未误用 admin client**
   - ✅ 正确使用 `createClient()`（用户级客户端）
   - ✅ 未使用 admin client

### 3.4 修复建议

```typescript
// src/app/[locale]/(main)/page.tsx
export default async function HomePage() {
  const supabase = await createClient()
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  const validUser = authError ? null : user
  
  let subscriptionType: string | null = null
  let tipEnabled = false // 新增
  
  if (validUser) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('status, subscription_type, role, tip_enabled') // 新增 tip_enabled
      .eq('id', validUser.id)
      .single()
    
    // ... 状态检查 ...
    
    subscriptionType = profile?.subscription_type || null
    tipEnabled = profile?.tip_enabled || false // 新增
    
    // 可选：验证订阅状态
    if (tipEnabled) {
      const { data: tipSubscription } = await supabase
        .from('subscriptions')
        .select('status, expires_at')
        .eq('user_id', validUser.id)
        .eq('subscription_type', 'tip')
        .eq('status', 'active')
        .gt('expires_at', new Date().toISOString())
        .single()
      
      // 如果订阅过期，tipEnabled 应为 false
      if (!tipSubscription) {
        tipEnabled = false
      }
    }
  }
  
  // ... 查询帖子 ...
  
  return (
    <HomePageClient
      initialPosts={posts}
      user={validUser}
      subscriptionType={subscriptionType}
      tipEnabled={tipEnabled} // 新增
      ...
    />
  )
}
```

---

## Step 4: 首页数据查询

### 4.1 查询内容

```typescript
// 帖子查询
postsQuery = supabase
  .from('posts')
  .select(`
    *,
    user:profiles!posts_user_id_fkey (
      username,
      display_name,
      avatar_url
    ),
    topics:post_topics (
      topic:topics (
        id,
        name,
        slug
      )
    )
  `)
  .eq('status', 'approved')
```

### 4.2 推演结果

✅ **正常流程**：
- 帖子查询成功：获取已审核的帖子
- 关联查询成功：获取用户信息、话题信息
- 个性化逻辑：如果有关注，优先显示关注用户的帖子
- 数据转换正确：转换为 Post 接口格式

⚠️ **发现的问题**：

1. **P2 - 未查询打赏相关数据**
   - 查询了 `tip_amount`（帖子总打赏金额），但未查询：
     - 用户今日已打赏次数
     - 用户今日已打赏金额
     - 可打赏的帖子列表（如果有特殊逻辑）
   - **影响**：Client Component 需要额外查询，可能导致延迟显示

2. **P2 - 未优化打赏相关查询**
   - 如果用户有打赏功能，可以预加载打赏限制信息
   - **影响**：性能优化机会

3. **P1 - RLS 策略验证**
   - 查询使用用户级客户端，受 RLS 限制
   - 帖子查询策略：`status = 'approved' OR user_id = auth.uid() OR admin/support`
   - ✅ 打赏用户只能看到已审核的帖子（符合预期）

### 4.3 修复建议

```typescript
// 可选：预加载打赏限制信息
if (validUser && tipEnabled) {
  // 查询用户今日打赏统计（可选，用于显示剩余次数）
  const { data: todayTips } = await supabase
    .from('tip_transactions')
    .select('recipient_id, amount')
    .eq('tipper_id', validUser.id)
    .gte('created_at', new Date().toISOString().split('T')[0])
  
  // 计算今日已打赏次数和金额（可选）
  const todayTipCount = todayTips?.length || 0
  const todayTipAmount = todayTips?.reduce((sum, tip) => sum + parseFloat(tip.amount), 0) || 0
}
```

---

## Step 5: Client Component

### 5.1 代码路径
`src/app/[locale]/(main)/HomePageClient.tsx`

### 5.2 执行流程

```typescript
export function HomePageClient({ 
  initialPosts, 
  user: initialUser,
  subscriptionType: initialSubscriptionType,
  ...
}: HomePageClientProps) {
  const { user, loading: authLoading } = useAuth()
  const effectiveUser = authLoading ? initialUser : user
  const effectiveSubscriptionType = initialSubscriptionType
  const isSeller = effectiveSubscriptionType === 'seller'
  
  // 使用 React Query 加载更多帖子
  const { data, fetchNextPage, ... } = usePosts('approved', {
    enabled: !authLoading || initialPosts.length > 0,
    initialData: initialPosts.length > 0 ? {
      pages: [initialPosts],
      pageParams: [0],
    } : undefined,
  })
  
  const posts = data?.pages.flatMap((page) => page) || initialPosts
  
  return (
    <div>
      {/* 卖家入口提示 */}
      {isSeller && effectiveUser && (
        <div>卖家中心入口</div>
      )}
      
      <h1>发现</h1>
      {posts.length === 0 ? (
        <div>暂无内容</div>
      ) : (
        <MasonryGrid>
          {posts.map((post) => (
            <PostCard key={post.id} post={post} />
          ))}
        </MasonryGrid>
      )}
    </div>
  )
}
```

### 5.3 PostCard 组件分析

```typescript
// src/components/social/PostCard.tsx
function PostCardComponent({ post }: PostCardProps) {
  const { user } = useAuth()
  
  // 注意：PostCard 不显示打赏按钮
  // 打赏按钮只在详情页显示（/post/[id]/page.tsx）
  
  return (
    <Card>
      {/* 帖子内容 */}
      {/* 操作按钮：点赞、评论、收藏 */}
      {/* 用户信息 */}
    </Card>
  )
}
```

### 5.4 推演结果

✅ **正常流程**：
- Hydration 一致性：使用 `initialUser` 和 `initialSubscriptionType` 避免 hydration mismatch
- 帖子列表正常渲染：显示初始帖子
- 无限滚动正常：使用 React Query 加载更多
- 卖家入口显示：如果 `isSeller = true`，显示卖家中心入口

❌ **发现的问题**：

1. **P1 - 首页不显示打赏按钮**
   - `PostCard` 组件**不包含打赏按钮**
   - 打赏按钮只在详情页（`/post/[id]/page.tsx`）显示
   - **影响**：用户需要在详情页才能打赏，首页无法直接打赏

2. **P2 - 未传递打赏功能标记**
   - `HomePageClient` 不接收 `tipEnabled` prop
   - 无法在首页显示打赏相关提示或入口
   - **影响**：用户体验不完整

3. **P2 - 未显示打赏功能状态**
   - 如果用户有打赏功能，首页没有相关提示或入口
   - **影响**：用户可能不知道可以使用打赏功能

4. **P1 - TipButton 组件需要额外查询**
   - `TipButton` 组件使用 `useProfile` hook 查询 `tip_enabled`
   - 每个帖子详情页都需要查询一次
   - **影响**：增加数据库查询，可能导致延迟

### 5.5 修复建议

```typescript
// 1. 修改 HomePageClient 接收 tipEnabled
interface HomePageClientProps {
  // ... 现有 props
  tipEnabled?: boolean // 新增
}

// 2. 在首页显示打赏功能提示（可选）
{tipEnabled && effectiveUser && (
  <div className="mb-6 rounded-lg border border-green-200 bg-green-50/50 p-4">
    <h3 className="text-base font-semibold">打赏功能已启用</h3>
    <p className="mt-1 text-sm">您可以为喜欢的创作者打赏支持</p>
  </div>
)}

// 3. 可选：在 PostCard 添加打赏按钮（需要设计决策）
// 或者在首页显示打赏金额（已显示 tip_amount）
```

---

## Step 6: API 调用

### 6.1 打赏 API 路径
`POST /api/payments/stripe/create-tip-session`

### 6.2 API 执行流程

```typescript
// src/app/api/payments/stripe/create-tip-session/route.ts
export async function POST(request: NextRequest) {
  // 1. 验证用户
  const supabase = await createClient()
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  // 2. 解析请求参数
  const { amount, postId, postAuthorId, ... } = await request.json()
  
  // 3. 验证参数
  if (!amount || !postId || !postAuthorId || ...) {
    return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })
  }
  
  // 4. 检查打赏功能
  const supabaseAdmin = createAdminClient(...)
  const tipEnabled = await checkTipEnabled(user.id, supabaseAdmin)
  if (!tipEnabled) {
    return NextResponse.json(
      { error: 'Tip feature subscription required' },
      { status: 403 }
    )
  }
  
  // 5. 检查打赏限制
  const limitCheck = await checkTipLimits(
    user.id,
    postAuthorId,
    numericAmount,
    currency,
    supabaseAdmin
  )
  if (!limitCheck.allowed) {
    return NextResponse.json(
      { error: limitCheck.reason || 'Tip limit exceeded' },
      { status: 400 }
    )
  }
  
  // 6. 创建 Stripe Checkout Session
  const session = await createCheckoutSession(...)
  
  return NextResponse.json({ url: session.url })
}
```

### 6.3 推演结果

✅ **正常流程**：
- 用户验证：正确验证用户身份
- 参数验证：验证所有必需参数
- 打赏功能检查：使用 `checkTipEnabled` 验证 `tip_enabled`
- 打赏限制检查：使用 `checkTipLimits` 验证金额和次数限制
- 创建支付会话：成功创建 Stripe Checkout Session

✅ **权限验证**：
- ✅ 使用 admin client 查询 `tip_enabled`（绕过 RLS）
- ✅ 使用 admin client 查询打赏限制（绕过 RLS）
- ✅ 再次验证打赏功能（双重验证）

⚠️ **发现的问题**：

1. **P2 - 未检查订阅状态**
   - API 只检查 `tip_enabled`，不检查订阅是否过期
   - 如果 `tip_enabled = true` 但订阅已过期，仍可创建支付会话
   - **影响**：可能导致过期订阅用户仍能打赏

2. **P1 - 未检查是否打赏自己**
   - API 不检查 `postAuthorId === user.id`
   - 理论上用户可以打赏自己（虽然不合理）
   - **影响**：业务逻辑不完整

3. **P2 - 未验证帖子存在**
   - API 不验证 `postId` 是否存在
   - 不验证 `postAuthorId` 是否与帖子作者一致
   - **影响**：可能导致无效打赏

### 6.4 修复建议

```typescript
// src/app/api/payments/stripe/create-tip-session/route.ts
export async function POST(request: NextRequest) {
  // ... 现有验证 ...
  
  // 新增：检查订阅状态
  const { data: tipSubscription } = await supabaseAdmin
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', user.id)
    .eq('subscription_type', 'tip')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  
  if (!tipSubscription) {
    return NextResponse.json(
      { error: 'Tip subscription expired or not found' },
      { status: 403 }
    )
  }
  
  // 新增：检查是否打赏自己
  if (postAuthorId === user.id) {
    return NextResponse.json(
      { error: 'Cannot tip yourself' },
      { status: 400 }
    )
  }
  
  // 新增：验证帖子存在
  const { data: post } = await supabaseAdmin
    .from('posts')
    .select('id, user_id, status')
    .eq('id', postId)
    .single()
  
  if (!post) {
    return NextResponse.json(
      { error: 'Post not found' },
      { status: 404 }
    )
  }
  
  if (post.user_id !== postAuthorId) {
    return NextResponse.json(
      { error: 'Post author mismatch' },
      { status: 400 }
    )
  }
  
  if (post.status !== 'approved') {
    return NextResponse.json(
      { error: 'Post not approved' },
      { status: 400 }
    )
  }
  
  // ... 继续现有逻辑 ...
}
```

---

## Step 7: 边界情况

### 7.1 打赏功能关闭

**场景**：`tip_enabled = false` 但 `subscription.status = 'active'`

**推演结果**：
- ✅ API 会拒绝：`checkTipEnabled` 返回 `false`
- ⚠️ UI 可能显示错误：`TipButton` 会显示"启用打赏"按钮，但用户可能困惑
- **风险等级**：P2

**修复建议**：
- 确保订阅过期时自动清除 `tip_enabled`
- 在 UI 显示更清晰的错误提示

### 7.2 未绑定支付方式

**场景**：`tip_enabled = true` 但未绑定 Stripe/PayPal

**推演结果**：
- ✅ API 不检查支付方式（由 Stripe Checkout 处理）
- ⚠️ 用户可能进入支付流程但无法完成支付
- **风险等级**：P2

**修复建议**：
- 可选：在创建支付会话前检查用户是否有支付方式
- 或在支付失败时显示更清晰的错误提示

### 7.3 订阅过期

**场景**：`subscription.status = 'expired'` 但 `tip_enabled = true`

**推演结果**：
- ❌ API 可能通过：如果只检查 `tip_enabled`，不检查订阅状态
- ⚠️ 用户可能仍能打赏
- **风险等级**：P1

**修复建议**：
- API 必须检查订阅状态（见 Step 6.4）

### 7.4 Session 过期

**场景**：用户 session 过期

**推演结果**：
- ✅ middleware 会处理：`updateSession` 会刷新 session
- ✅ API 会拒绝：`getUser()` 返回错误，返回 401
- **风险等级**：P0（已正确处理）

### 7.5 尝试打赏自己

**场景**：`postAuthorId === user.id`

**推演结果**：
- ❌ API 不检查：用户可以打赏自己
- ⚠️ 业务逻辑不合理
- **风险等级**：P1

**修复建议**：
- API 必须检查（见 Step 6.4）

---

## Step 8: 结论

### 8.1 首页行为总结

✅ **正常行为**：
1. 用户成功访问首页
2. 帖子列表正常显示
3. 打赏功能在详情页可用
4. API 权限验证基本正确

❌ **问题总结**：

| 问题 | 风险等级 | 位置 | 影响 |
|------|---------|------|------|
| middleware 未检查订阅状态 | P2 | `middleware.ts` | 过期订阅用户仍可访问 |
| Server Component 未查询 tip_enabled | P1 | `page.tsx` | 增加客户端查询，可能导致闪烁 |
| Server Component 未传递 tipEnabled | P2 | `page.tsx` | 无法在首页显示打赏状态 |
| 首页不显示打赏按钮 | P1 | `PostCard.tsx` | 用户需要在详情页才能打赏 |
| API 未检查订阅状态 | P1 | `create-tip-session/route.ts` | 过期订阅用户仍能打赏 |
| API 未检查是否打赏自己 | P1 | `create-tip-session/route.ts` | 用户可以打赏自己 |
| API 未验证帖子存在 | P2 | `create-tip-session/route.ts` | 可能导致无效打赏 |

### 8.2 风险等级说明

- **P0**：严重安全漏洞，必须立即修复
- **P1**：功能缺陷或安全风险，应尽快修复
- **P2**：体验问题或优化机会，可计划修复

### 8.3 修复优先级

**高优先级（P1）**：
1. API 检查订阅状态（`create-tip-session/route.ts`）
2. API 检查是否打赏自己（`create-tip-session/route.ts`）
3. Server Component 查询并传递 `tipEnabled`（`page.tsx`）

**中优先级（P2）**：
4. middleware 检查订阅状态（`middleware.ts`）
5. API 验证帖子存在（`create-tip-session/route.ts`）
6. 首页显示打赏功能状态（`HomePageClient.tsx`）

**低优先级（体验优化）**：
7. 在首页添加打赏按钮（需要设计决策）
8. 预加载打赏限制信息（性能优化）

### 8.4 安全评估

✅ **权限控制**：
- RLS 策略正确：用户只能看到已审核的帖子
- API 权限验证：正确验证用户身份和打赏功能
- 双重验证：前端和后端都验证打赏功能

⚠️ **潜在风险**：
- 订阅状态不一致：`tip_enabled` 与订阅状态可能不同步
- 缺少业务逻辑验证：未检查打赏自己、帖子存在等

### 8.5 用户体验评估

✅ **正常体验**：
- 首页加载正常
- 帖子列表显示正常
- 打赏功能在详情页可用

⚠️ **体验问题**：
- 首页无法直接打赏（需要进入详情页）
- 打赏功能状态不明确（首页无提示）
- 过期订阅用户可能看到错误提示

---

## 附录：关键代码位置

### 核心文件

1. **middleware.ts**
   - `middleware.ts` - 主中间件
   - `src/lib/supabase/middleware.ts` - Session 更新逻辑

2. **首页 Server Component**
   - `src/app/[locale]/(main)/page.tsx` - 首页 Server Component

3. **首页 Client Component**
   - `src/app/[locale]/(main)/HomePageClient.tsx` - 首页 Client Component

4. **帖子卡片组件**
   - `src/components/social/PostCard.tsx` - 帖子卡片（不包含打赏按钮）

5. **打赏按钮组件**
   - `src/components/social/TipButton.tsx` - 打赏按钮（只在详情页使用）

6. **打赏 API**
   - `src/app/api/payments/stripe/create-tip-session/route.ts` - 创建打赏支付会话

7. **打赏功能检查**
   - `src/lib/payments/check-tip-limits.ts` - 检查打赏限制
   - `src/lib/payments/process-tip-payment.ts` - 处理打赏支付

8. **数据库函数**
   - `supabase/migrations/107_add_subscription_features.sql` - 订阅功能
   - `supabase/migrations/111_add_tip_limits.sql` - 打赏限制
   - `supabase/migrations/120_add_tip_subscription_type.sql` - 打赏订阅类型

---

## 报告生成时间

**生成时间**：2026-01-25
**推演版本**：基于当前代码库状态
**推演用户身份**：已开通打赏功能的普通用户
