# çœŸå®å–å®¶ç”¨æˆ·è®¿é—®é¦–é¡µç³»ç»Ÿçº§æ¨æ¼”æŠ¥å‘Š

## æ¨æ¼”åœºæ™¯

**ç”¨æˆ·çŠ¶æ€**ï¼š
- âœ… å·²æ³¨å†Œç”¨æˆ·
- âœ… å·²ç™»å½•ï¼ˆSupabase session æœ‰æ•ˆï¼‰
- âœ… auth.uid() è¿”å›æœ‰æ•ˆ user_id
- âœ… ç”¨æˆ·èº«ä»½ï¼šå–å®¶ï¼ˆsellerï¼‰
- âœ… é admin / é support

**å–å®¶ä¸šåŠ¡çŠ¶æ€å‡è®¾**ï¼š
- âœ… æ‹¥æœ‰å·²ä¸Šæ¶å•†å“
- âœ… æ‹¥æœ‰è‡³å°‘ 1 ç¬”è®¢å•ï¼ˆä»»æ„çŠ¶æ€ï¼‰
- âœ… æ‹¥æœ‰ seller_profile / shop ä¿¡æ¯
- âœ… å¯èƒ½å­˜åœ¨ä½™é¢ / å†»ç»“èµ„é‡‘

**æ¨¡æ‹Ÿè¡Œä¸º**ï¼šæµè§ˆå™¨ç›´æ¥è®¿é—® URLï¼š`/en`

---

## Step 1: middleware.ts åˆ†æ

### 1.1 ä»£ç æµç¨‹

```typescript
// middleware.ts
export async function middleware(request: NextRequest) {
  // å…ˆæ›´æ–° Supabase ä¼šè¯
  const response = await updateSession(request)
  // ç„¶ååº”ç”¨å›½é™…åŒ–ä¸­é—´ä»¶
  return intlMiddleware(request)
}
```

### 1.2 updateSession å‡½æ•°åˆ†æ

```typescript
// src/lib/supabase/middleware.ts
export async function updateSession(request: NextRequest) {
  // ... åˆ›å»º supabase client ...
  const { data: { user } } = await supabase.auth.getUser()
  
  // åªæ£€æŸ¥ banned/suspended çŠ¶æ€
  if (user) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('status')
      .eq('id', user.id)
      .single()
    
    if (profile?.status === 'banned' || profile?.status === 'suspended') {
      return NextResponse.redirect(bannedUrl)
    }
  }
  
  return response
}
```

### 1.3 é—®é¢˜å‘ç°

**âŒ é—®é¢˜ 1.1ï¼šmiddleware ä¸è¯†åˆ« seller èº«ä»½**
- **ä½ç½®**ï¼š`middleware.ts` / `src/lib/supabase/middleware.ts`
- **é—®é¢˜**ï¼šmiddleware åªæ£€æŸ¥ `status` å­—æ®µï¼Œ**å®Œå…¨ä¸æ£€æŸ¥ `role` æˆ– `subscription_type`**
- **å½±å“**ï¼šæ— æ³•åœ¨ middleware å±‚è¯†åˆ«å–å®¶èº«ä»½ï¼Œæ— æ³•åš seller ç›¸å…³çš„ redirect
- **ä¸¥é‡çº§åˆ«**ï¼šP2ï¼ˆåŠŸèƒ½ç¼ºå¤±ï¼Œä½†ä¸å½±å“å®‰å…¨æ€§ï¼‰

**âŒ é—®é¢˜ 1.2ï¼šmiddleware ä¸å¯¹ seller åšç‰¹æ®Š redirect**
- **ä½ç½®**ï¼š`middleware.ts`
- **é—®é¢˜**ï¼šå³ä½¿è¯†åˆ«äº† sellerï¼Œä¹Ÿæ²¡æœ‰é€»è¾‘å°† seller é‡å®šå‘åˆ° `/seller/dashboard`
- **å½±å“**ï¼šå–å®¶è®¿é—®é¦–é¡µæ—¶ï¼Œä¼šæ­£å¸¸è¿›å…¥é¦–é¡µï¼Œè€Œä¸æ˜¯å–å®¶ä¸­å¿ƒ
- **ä¸¥é‡çº§åˆ«**ï¼šP2ï¼ˆUX é—®é¢˜ï¼Œéå¿…éœ€åŠŸèƒ½ï¼‰

**âœ… æ­£å¸¸ç‚¹ 1.1ï¼šlocale å¤„ç†ä¸ role è§£è€¦**
- **ä½ç½®**ï¼š`middleware.ts`
- **è¯´æ˜**ï¼šå›½é™…åŒ–ä¸­é—´ä»¶åœ¨ session æ›´æ–°åæ‰§è¡Œï¼Œlocale å¤„ç†ä¸ç”¨æˆ·è§’è‰²å®Œå…¨è§£è€¦ï¼Œè¿™æ˜¯æ­£ç¡®çš„è®¾è®¡

---

## Step 2: è·¯ç”±è§£æ

### 2.1 è·¯ç”±åŒ¹é…

- URL: `/en`
- åŒ¹é…è·¯ç”±ï¼š`src/app/[locale]/(main)/page.tsx`
- è·¯ç”±ç»„ï¼š`(main)` - è¡¨ç¤ºè¿™æ˜¯ä¸»åº”ç”¨è·¯ç”±ï¼Œéœ€è¦è®¤è¯ï¼ˆä½†å…è®¸æœªç™»å½•è®¿é—®ï¼‰

### 2.2 é—®é¢˜å‘ç°

**âœ… æ­£å¸¸ç‚¹ 2.1ï¼šè·¯ç”±è§£ææ­£ç¡®**
- è·¯ç”±æ­£ç¡®åŒ¹é…åˆ°é¦–é¡µç»„ä»¶
- æ²¡æœ‰å› ä¸º seller èº«ä»½è€Œå½±å“è·¯ç”±è§£æ

---

## Step 3: é¦–é¡µ Server Componentï¼ˆpage.tsxï¼‰åˆ†æ

### 3.1 ä»£ç æµç¨‹

```typescript
// src/app/[locale]/(main)/page.tsx
export default async function HomePage() {
  const supabase = await createClient()
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  const validUser = authError ? null : user
  
  // æ£€æŸ¥ banned çŠ¶æ€
  if (validUser) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('status')  // âš ï¸ åªæŸ¥è¯¢ statusï¼Œä¸æŸ¥è¯¢ role/subscription_type
      .eq('id', validUser.id)
      .single()
    
    if (profile?.status === 'banned' || profile?.status === 'suspended') {
      return <HomePageClient ... />
    }
  }
  
  // è·å– postsï¼ˆä¸ªæ€§åŒ–é€»è¾‘ï¼‰
  // ... æŸ¥è¯¢ posts ...
  
  return <HomePageClient initialPosts={posts} user={validUser} ... />
}
```

### 3.2 é—®é¢˜å‘ç°

**âŒ é—®é¢˜ 3.1ï¼šé¦–é¡µä¸åŒºåˆ† seller / buyer**
- **ä½ç½®**ï¼š`src/app/[locale]/(main)/page.tsx`
- **é—®é¢˜**ï¼š
  1. åªæŸ¥è¯¢ `profiles.status`ï¼Œ**å®Œå…¨ä¸æŸ¥è¯¢ `role` æˆ– `subscription_type`**
  2. æ²¡æœ‰ seller ç›¸å…³çš„é€»è¾‘åˆ†æ”¯
  3. å–å®¶è®¿é—®é¦–é¡µæ—¶ï¼Œçœ‹åˆ°çš„å†…å®¹ä¸æ™®é€šä¹°å®¶å®Œå…¨ç›¸åŒ
- **å½±å“**ï¼š
  - å–å®¶æ— æ³•åœ¨é¦–é¡µçœ‹åˆ°å–å®¶ç›¸å…³çš„æç¤ºæˆ–å…¥å£
  - å–å®¶éœ€è¦æ‰‹åŠ¨å¯¼èˆªåˆ° `/seller/dashboard`
- **ä¸¥é‡çº§åˆ«**ï¼šP2ï¼ˆUX é—®é¢˜ï¼‰

**âŒ é—®é¢˜ 3.2ï¼šé¦–é¡µä¸æŸ¥è¯¢ seller ç§æœ‰æ•°æ®ï¼ˆä½†è¿™æ˜¯æ­£ç¡®çš„ï¼‰**
- **ä½ç½®**ï¼š`src/app/[locale]/(main)/page.tsx`
- **è¯´æ˜**ï¼šé¦–é¡µåªæŸ¥è¯¢ `posts` è¡¨ï¼Œä¸æŸ¥è¯¢ `products`ã€`orders` ç­‰ seller ç§æœ‰æ•°æ®
- **è¯„ä¼°**ï¼šâœ… **è¿™æ˜¯æ­£ç¡®çš„è®¾è®¡**ï¼Œé¦–é¡µä¸åº”è¯¥æŸ¥è¯¢ seller ç§æœ‰æ•°æ®ï¼Œé¿å…æ€§èƒ½é—®é¢˜å’Œæ•°æ®æ³„éœ²é£é™©

**âœ… æ­£å¸¸ç‚¹ 3.1ï¼šæ•°æ®æŸ¥è¯¢èŒƒå›´æ­£ç¡®**
- åªæŸ¥è¯¢å…¬å¼€çš„ `posts` è¡¨ï¼ˆstatus = 'approved'ï¼‰
- ä¸æŸ¥è¯¢ seller ç§æœ‰æ•°æ®ï¼ˆordersã€products ç­‰ï¼‰
- æŸ¥è¯¢é€»è¾‘ä¸ç”¨æˆ·è§’è‰²æ— å…³

---

## Step 4: æ•°æ®æŸ¥è¯¢ & RLS åˆ†æ

### 4.1 é¦–é¡µæŸ¥è¯¢çš„è¡¨

1. **posts è¡¨**ï¼ˆä¸»è¦æŸ¥è¯¢ï¼‰
   - æ¡ä»¶ï¼š`status = 'approved'`
   - ä¸ªæ€§åŒ–ï¼šå¦‚æœç”¨æˆ·å·²ç™»å½•ä¸”æœ‰ followï¼Œä¼˜å…ˆæ˜¾ç¤ºå…³æ³¨ç”¨æˆ·çš„ posts

2. **profiles è¡¨**ï¼ˆä»…æŸ¥è¯¢ statusï¼‰
   - æ¡ä»¶ï¼š`id = auth.uid()`
   - å­—æ®µï¼šåªæŸ¥è¯¢ `status`ï¼Œä¸æŸ¥è¯¢ `role` æˆ– `subscription_type`

3. **follows è¡¨**ï¼ˆå¦‚æœç”¨æˆ·å·²ç™»å½•ï¼‰
   - æ¡ä»¶ï¼š`follower_id = auth.uid()`
   - ç”¨é€”ï¼šä¸ªæ€§åŒ–æ¨è

### 4.2 RLS ç­–ç•¥æ£€æŸ¥

#### 4.2.1 posts è¡¨ RLS

```sql
-- æ¥è‡ª supabase/migrations/001_initial_schema.sql
CREATE POLICY "Users can view approved posts" ON posts
  FOR SELECT USING (
    status = 'approved' OR 
    user_id = auth.uid() OR 
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND role IN ('admin', 'support')
    )
  );
```

**âœ… æ­£å¸¸ç‚¹ 4.1ï¼šposts RLS ç­–ç•¥æ­£ç¡®**
- å–å®¶åªèƒ½çœ‹åˆ° `status = 'approved'` çš„ posts
- å–å®¶å¯ä»¥çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„ postsï¼ˆå³ä½¿æœªå®¡æ ¸ï¼‰
- å–å®¶**ä¸èƒ½**çœ‹åˆ°å…¶ä»–å–å®¶çš„ç§æœ‰ posts
- **ç»“è®º**ï¼šRLS ç­–ç•¥æ­£ç¡®ï¼Œå–å®¶åœ¨é¦–é¡µä¸ä¼šçœ‹åˆ°ä¸åº”çœ‹åˆ°çš„æ•°æ®

#### 4.2.2 products è¡¨ RLSï¼ˆé¦–é¡µä¸æŸ¥è¯¢ï¼Œä½†éœ€è¦æ£€æŸ¥ï¼‰

```sql
CREATE POLICY "Users can view active products" ON products
  FOR SELECT USING (
    status = 'active' OR 
    seller_id = auth.uid() OR 
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND role IN ('admin', 'support')
    )
  );
```

**âœ… æ­£å¸¸ç‚¹ 4.2ï¼šproducts RLS ç­–ç•¥æ­£ç¡®**
- å–å®¶åªèƒ½çœ‹åˆ° `status = 'active'` çš„ productsï¼ˆå…¬å¼€å•†å“ï¼‰
- å–å®¶å¯ä»¥çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„æ‰€æœ‰ productsï¼ˆåŒ…æ‹¬æœªä¸Šæ¶çš„ï¼‰
- **ç»“è®º**ï¼šå³ä½¿é¦–é¡µæŸ¥è¯¢ productsï¼ŒRLS ä¹Ÿä¼šæ­£ç¡®é™åˆ¶

#### 4.2.3 orders è¡¨ RLSï¼ˆé¦–é¡µä¸æŸ¥è¯¢ï¼Œä½†éœ€è¦æ£€æŸ¥ï¼‰

```sql
CREATE POLICY "Users can view own orders" ON orders
  FOR SELECT USING (
    buyer_id = auth.uid() OR 
    seller_id = auth.uid() OR 
    affiliate_id = auth.uid() OR
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() AND role IN ('admin', 'support')
    )
  );
```

**âœ… æ­£å¸¸ç‚¹ 4.3ï¼šorders RLS ç­–ç•¥æ­£ç¡®**
- å–å®¶åªèƒ½çœ‹åˆ° `seller_id = auth.uid()` çš„ ordersï¼ˆè‡ªå·±çš„è®¢å•ï¼‰
- å–å®¶**ä¸èƒ½**çœ‹åˆ°å…¶ä»–å–å®¶çš„è®¢å•
- **ç»“è®º**ï¼šå³ä½¿é¦–é¡µæŸ¥è¯¢ ordersï¼ŒRLS ä¹Ÿä¼šæ­£ç¡®é™åˆ¶

### 4.3 é—®é¢˜å‘ç°

**âœ… æ­£å¸¸ç‚¹ 4.4ï¼šRLS ç­–ç•¥å®Œå–„ï¼Œæ— æ•°æ®æ³„éœ²é£é™©**
- æ‰€æœ‰è¡¨çš„ RLS ç­–ç•¥éƒ½æ­£ç¡®é…ç½®
- å–å®¶åœ¨é¦–é¡µåªèƒ½çœ‹åˆ°åº”çœ‹åˆ°çš„æ•°æ®
- ä¸å­˜åœ¨æƒé™æˆ–æ•°æ®æ³„éœ²é—®é¢˜

**âš ï¸ æ³¨æ„ç‚¹ 4.1ï¼šé¦–é¡µä¸æŸ¥è¯¢ seller ç§æœ‰æ•°æ®**
- **è¯´æ˜**ï¼šé¦–é¡µä¸æŸ¥è¯¢ `orders`ã€`products`ï¼ˆseller è§†è§’ï¼‰ç­‰ç§æœ‰æ•°æ®
- **è¯„ä¼°**ï¼šâœ… **è¿™æ˜¯æ­£ç¡®çš„è®¾è®¡**ï¼Œé¿å…æ€§èƒ½é—®é¢˜å’Œæ•°æ®æ³„éœ²

---

## Step 5: é¦–é¡µå†…å®¹å·®å¼‚åˆ†æ

### 5.1 å½“å‰é¦–é¡µå†…å®¹

é¦–é¡µï¼ˆ`HomePageClient`ï¼‰æ˜¾ç¤ºï¼š
1. æ ‡é¢˜ï¼š"å‘ç°"ï¼ˆDiscoverï¼‰
2. Posts åˆ—è¡¨ï¼ˆç€‘å¸ƒæµå¸ƒå±€ï¼‰
3. åŠ è½½æ›´å¤šæŒ‰é’®
4. ç©ºçŠ¶æ€æç¤ºï¼ˆå¦‚æœæ— å†…å®¹ï¼‰

### 5.2 å–å®¶ vs æ™®é€šç”¨æˆ·å¯¹æ¯”

| å†…å®¹é¡¹ | æ™®é€šç”¨æˆ· | å–å®¶ç”¨æˆ· | å·®å¼‚ |
|--------|---------|---------|------|
| Posts åˆ—è¡¨ | âœ… æ˜¾ç¤º | âœ… æ˜¾ç¤º | âŒ **æ— å·®å¼‚** |
| å–å®¶å…¥å£æç¤º | âŒ æ—  | âŒ æ—  | âŒ **ç¼ºå¤±** |
| "ç®¡ç†å•†å“" CTA | âŒ æ—  | âŒ æ—  | âŒ **ç¼ºå¤±** |
| "æŸ¥çœ‹è®¢å•" CTA | âŒ æ—  | âŒ æ—  | âŒ **ç¼ºå¤±** |
| "å–å®¶ä¸­å¿ƒ" é“¾æ¥ | âŒ æ—  | âŒ æ—  | âŒ **ç¼ºå¤±** |

### 5.3 é—®é¢˜å‘ç°

**âŒ é—®é¢˜ 5.1ï¼šé¦–é¡µä¸æ˜¾ç¤ºå–å®¶ç›¸å…³å…¥å£**
- **ä½ç½®**ï¼š`src/app/[locale]/(main)/HomePageClient.tsx`
- **é—®é¢˜**ï¼š
  1. é¦–é¡µå®Œå…¨ä¸åŒºåˆ† seller / buyer
  2. å–å®¶è®¿é—®é¦–é¡µæ—¶ï¼Œçœ‹ä¸åˆ°ä»»ä½•å–å®¶ç›¸å…³çš„æç¤ºæˆ–å…¥å£
  3. å–å®¶éœ€è¦æ‰‹åŠ¨è¾“å…¥ URL æˆ–é€šè¿‡å…¶ä»–é¡µé¢å¯¼èˆªåˆ° `/seller/dashboard`
- **å½±å“**ï¼šUX é—®é¢˜ï¼Œå–å®¶å¯èƒ½ä¸çŸ¥é“å¦‚ä½•è¿›å…¥å–å®¶ä¸­å¿ƒ
- **ä¸¥é‡çº§åˆ«**ï¼šP2ï¼ˆUX é—®é¢˜ï¼‰

**âŒ é—®é¢˜ 5.2ï¼šSidebar ä¸æ˜¾ç¤ºå–å®¶å¯¼èˆª**
- **ä½ç½®**ï¼š`src/components/layout/Sidebar.tsx`
- **é—®é¢˜**ï¼š
  1. Sidebar çš„ `navItems` æ•°ç»„ä¸­æ²¡æœ‰ seller ç›¸å…³çš„å¯¼èˆªé¡¹
  2. å–å®¶åœ¨ä¾§è¾¹æ çœ‹ä¸åˆ°"å–å®¶ä¸­å¿ƒ"ã€"å•†å“ç®¡ç†"ç­‰å…¥å£
  3. åªæœ‰åœ¨ä¸ªäººèµ„æ–™é¡µé¢ï¼ˆ`/profile/[id]`ï¼‰æ‰èƒ½çœ‹åˆ°"å–å®¶ä¸­å¿ƒ"é“¾æ¥
- **å½±å“**ï¼šUX é—®é¢˜ï¼Œå–å®¶å¯¼èˆªä¸ä¾¿
- **ä¸¥é‡çº§åˆ«**ï¼šP2ï¼ˆUX é—®é¢˜ï¼‰

**âœ… æ­£å¸¸ç‚¹ 5.1ï¼šé¦–é¡µä¸æ˜¾ç¤ºå–å®¶ç§æœ‰æ•°æ®**
- **è¯´æ˜**ï¼šé¦–é¡µä¸æ˜¾ç¤ºå–å®¶çš„è®¢å•ã€å•†å“ç»Ÿè®¡ç­‰ç§æœ‰æ•°æ®
- **è¯„ä¼°**ï¼šâœ… **è¿™æ˜¯æ­£ç¡®çš„è®¾è®¡**ï¼Œé¦–é¡µåº”è¯¥ä¿æŒç®€æ´ï¼Œç§æœ‰æ•°æ®åº”åœ¨å–å®¶ä¸­å¿ƒæ˜¾ç¤º

---

## Step 6: Client Component Hydration åˆ†æ

### 6.1 HomePageClient Props

```typescript
interface HomePageClientProps {
  initialPosts: Post[]
  initialError: any
  user: { id: string } | null  // âš ï¸ åªä¼ é€’ user.idï¼Œä¸ä¼ é€’ role/subscription_type
  translations: { ... }
}
```

### 6.2 useAuth Hook

```typescript
// src/lib/hooks/useAuth.ts
export function useAuth() {
  const [user, setUser] = useState<User | null>(null)
  // ...
  return { user, loading }
}
```

**é—®é¢˜**ï¼š`useAuth` åªè¿”å› `user` å¯¹è±¡ï¼ˆæ¥è‡ª Supabase Authï¼‰ï¼Œ**ä¸åŒ…å« `role` æˆ– `subscription_type`**

### 6.3 é—®é¢˜å‘ç°

**âŒ é—®é¢˜ 6.1ï¼šClient Component æ— æ³•è·å– seller èº«ä»½**
- **ä½ç½®**ï¼š`src/app/[locale]/(main)/HomePageClient.tsx`
- **é—®é¢˜**ï¼š
  1. Server Component ä¸ä¼ é€’ `role` æˆ– `subscription_type` ç»™ Client Component
  2. Client Component æ— æ³•é€šè¿‡ `useAuth` è·å– seller èº«ä»½
  3. å³ä½¿æƒ³æ˜¾ç¤º seller ç›¸å…³ UIï¼Œä¹Ÿæ— æ³•åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸º seller
- **å½±å“**ï¼šClient Component æ— æ³•æ ¹æ® seller èº«ä»½æ˜¾ç¤ºä¸åŒçš„ UI
- **ä¸¥é‡çº§åˆ«**ï¼šP2ï¼ˆåŠŸèƒ½ç¼ºå¤±ï¼‰

**âŒ é—®é¢˜ 6.2ï¼šHydration ä¸€è‡´æ€§é£é™©**
- **ä½ç½®**ï¼š`src/app/[locale]/(main)/HomePageClient.tsx`
- **é—®é¢˜**ï¼š
  1. Server æ¸²æŸ“æ—¶ï¼Œ`user` æ¥è‡ª `supabase.auth.getUser()`
  2. Client hydration æ—¶ï¼Œ`user` æ¥è‡ª `useAuth()` hook
  3. å¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´ hydration mismatch
- **å½±å“**ï¼šå¯èƒ½å¯¼è‡´ React hydration è­¦å‘Š
- **ä¸¥é‡çº§åˆ«**ï¼šP1ï¼ˆæ½œåœ¨ bugï¼‰

**âœ… æ­£å¸¸ç‚¹ 6.1ï¼šå½“å‰ hydration é€»è¾‘åŸºæœ¬æ­£ç¡®**
- **è¯´æ˜**ï¼šä»£ç ä¸­ä½¿ç”¨äº† `effectiveUser = authLoading ? initialUser : user` æ¥ç¡®ä¿ä¸€è‡´æ€§
- **è¯„ä¼°**ï¼šâœ… **åŸºæœ¬æ­£ç¡®**ï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´

---

## Step 7: äº¤äº’èƒ½åŠ›æ ¡éªŒ

### 7.1 å–å®¶åœ¨é¦–é¡µçš„äº¤äº’èƒ½åŠ›

| æ“ä½œ | æ˜¯å¦å¯ç”¨ | è¯´æ˜ |
|------|---------|------|
| æµè§ˆ Posts | âœ… å¯ç”¨ | ä¸æ™®é€šç”¨æˆ·ç›¸åŒ |
| ç‚¹èµ/è¯„è®º | âœ… å¯ç”¨ | ä¸æ™®é€šç”¨æˆ·ç›¸åŒ |
| è¿›å…¥å•†å“ç®¡ç† | âŒ **ä¸å¯ç”¨** | é¦–é¡µæ— å…¥å£ï¼Œéœ€æ‰‹åŠ¨è¾“å…¥ URL |
| ä¿®æ”¹å•†å“ | âŒ **ä¸å¯ç”¨** | éœ€å…ˆè¿›å…¥å•†å“ç®¡ç†é¡µé¢ |
| æŸ¥çœ‹è®¢å• | âŒ **ä¸å¯ç”¨** | é¦–é¡µæ— å…¥å£ï¼Œéœ€æ‰‹åŠ¨è¾“å…¥ URL |

### 7.2 æƒé™æ§åˆ¶æ£€æŸ¥

#### 7.2.1 å‰ç«¯æ§åˆ¶

**âŒ é—®é¢˜ 7.1ï¼šé¦–é¡µæ—  seller æƒé™æ£€æŸ¥**
- **ä½ç½®**ï¼š`src/app/[locale]/(main)/page.tsx` / `HomePageClient.tsx`
- **é—®é¢˜**ï¼šé¦–é¡µå®Œå…¨ä¸æ£€æŸ¥ seller èº«ä»½ï¼Œæ— æ³•åœ¨å‰ç«¯æ§åˆ¶ seller ç›¸å…³åŠŸèƒ½
- **å½±å“**ï¼šæ— æ³•åœ¨é¦–é¡µæ˜¾ç¤º seller ç›¸å…³ UI

#### 7.2.2 API å†æ ¡éªŒ

**âœ… æ­£å¸¸ç‚¹ 7.1ï¼šAPI è·¯ç”±æœ‰ seller æƒé™æ£€æŸ¥**
- **ä½ç½®**ï¼š`src/app/api/*` è·¯ç”±
- **è¯´æ˜**ï¼šAPI è·¯ç”±ä½¿ç”¨ `useSellerGuard` æˆ–æ‰‹åŠ¨æ£€æŸ¥ `subscription_type`
- **è¯„ä¼°**ï¼šâœ… **æ­£ç¡®**ï¼ŒAPI å±‚æœ‰æƒé™æ ¡éªŒ

#### 7.2.3 RLS æœ€ç»ˆå…œåº•

**âœ… æ­£å¸¸ç‚¹ 7.2ï¼šRLS ç­–ç•¥æ­£ç¡®**
- **è¯´æ˜**ï¼šæ‰€æœ‰è¡¨çš„ RLS ç­–ç•¥éƒ½æ­£ç¡®é…ç½®ï¼Œå³ä½¿å‰ç«¯ç»•è¿‡ï¼Œæ•°æ®åº“å±‚ä¹Ÿä¼šé˜»æ­¢
- **è¯„ä¼°**ï¼šâœ… **æ­£ç¡®**ï¼Œæ•°æ®åº“å±‚æœ‰æœ€ç»ˆå…œåº•

### 7.3 é—®é¢˜å‘ç°

**âŒ é—®é¢˜ 7.2ï¼šå–å®¶æ— æ³•ä»é¦–é¡µè¿›å…¥å–å®¶åŠŸèƒ½**
- **ä½ç½®**ï¼šæ•´ä¸ªé¦–é¡µç»„ä»¶
- **é—®é¢˜**ï¼š
  1. é¦–é¡µæ—  seller ç›¸å…³å…¥å£
  2. å–å®¶éœ€è¦æ‰‹åŠ¨è¾“å…¥ URL æˆ–é€šè¿‡å…¶ä»–é¡µé¢å¯¼èˆª
  3. ç”¨æˆ·ä½“éªŒä¸ä½³
- **å½±å“**ï¼šUX é—®é¢˜
- **ä¸¥é‡çº§åˆ«**ï¼šP2ï¼ˆUX é—®é¢˜ï¼‰

---

## Step 8: è¾¹ç•Œä¸å¼‚å¸¸æƒ…å†µ

### 8.1 å–å®¶èº«ä»½è¢«å–æ¶ˆ

**åœºæ™¯**ï¼šå–å®¶è®¢é˜…è¿‡æœŸï¼Œ`subscription_type` ä» `'seller'` å˜ä¸º `null`

**å½“å‰è¡Œä¸º**ï¼š
1. middleware ä¸æ£€æŸ¥ `subscription_type`ï¼Œä¸ä¼šé˜»æ­¢è®¿é—®
2. é¦–é¡µä¸æ£€æŸ¥ `subscription_type`ï¼Œæ­£å¸¸æ˜¾ç¤º
3. å¦‚æœè®¿é—® `/seller/dashboard`ï¼Œ`useSellerGuard` ä¼šæ£€æŸ¥å¹¶é‡å®šå‘

**è¯„ä¼°**ï¼šâœ… **åŸºæœ¬æ­£ç¡®**ï¼Œä½†é¦–é¡µåº”è¯¥æç¤ºå–å®¶è®¢é˜…å·²è¿‡æœŸ

### 8.2 seller_profile ä¸å­˜åœ¨æˆ–æœªå®Œæˆ

**åœºæ™¯**ï¼šç”¨æˆ·æœ‰ `subscription_type = 'seller'`ï¼Œä½† `seller_profile` ä¸å­˜åœ¨æˆ–æœªå®Œæˆ

**å½“å‰è¡Œä¸º**ï¼š
1. é¦–é¡µä¸æ£€æŸ¥ `seller_profile`ï¼Œæ­£å¸¸æ˜¾ç¤º
2. å¦‚æœè®¿é—® `/seller/dashboard`ï¼Œå¯èƒ½ä¼šæŠ¥é”™æˆ–æ˜¾ç¤ºä¸å®Œæ•´æ•°æ®

**è¯„ä¼°**ï¼šâš ï¸ **éœ€è¦æ”¹è¿›**ï¼Œåº”è¯¥åœ¨é¦–é¡µæˆ–å–å®¶ä¸­å¿ƒæ£€æŸ¥ `seller_profile` å®Œæ•´æ€§

### 8.3 å–å®¶è¢«å°ç¦

**åœºæ™¯**ï¼šå–å®¶ `status = 'banned'` æˆ– `'suspended'`

**å½“å‰è¡Œä¸º**ï¼š
1. middleware ä¼šæ£€æŸ¥ `status`ï¼Œå¦‚æœ banned/suspendedï¼Œä¼šé‡å®šå‘åˆ° `/banned`
2. é¦–é¡µä¹Ÿä¼šæ£€æŸ¥ `status`ï¼Œå¦‚æœ banned/suspendedï¼Œä¼šæ˜¾ç¤ºé”™è¯¯çŠ¶æ€

**è¯„ä¼°**ï¼šâœ… **æ­£ç¡®**ï¼Œå°ç¦é€»è¾‘æ­£å¸¸

### 8.4 å•†å“ä¸ºç©ºçš„æ–°å–å®¶

**åœºæ™¯**ï¼šæ–°å–å®¶ï¼Œ`subscription_type = 'seller'`ï¼Œä½†è¿˜æ²¡æœ‰å•†å“

**å½“å‰è¡Œä¸º**ï¼š
1. é¦–é¡µæ­£å¸¸æ˜¾ç¤ºï¼Œä¸æ˜¾ç¤º seller ç›¸å…³æç¤º
2. å–å®¶éœ€è¦æ‰‹åŠ¨è¿›å…¥ `/seller/products/create` åˆ›å»ºå•†å“

**è¯„ä¼°**ï¼šâš ï¸ **éœ€è¦æ”¹è¿›**ï¼Œåº”è¯¥åœ¨æ–°å–å®¶é¦–æ¬¡è®¿é—®æ—¶æç¤ºåˆ›å»ºå•†å“

---

## Step 9: ç»“è®ºä¸ä¿®å¤å»ºè®®

### 9.1 é—®é¢˜æ€»ç»“

| é—®é¢˜ç¼–å· | é—®é¢˜æè¿° | ä¸¥é‡çº§åˆ« | ä½ç½® |
|---------|---------|---------|------|
| 1.1 | middleware ä¸è¯†åˆ« seller èº«ä»½ | P2 | `middleware.ts` |
| 1.2 | middleware ä¸å¯¹ seller åšç‰¹æ®Š redirect | P2 | `middleware.ts` |
| 3.1 | é¦–é¡µä¸åŒºåˆ† seller / buyer | P2 | `src/app/[locale]/(main)/page.tsx` |
| 5.1 | é¦–é¡µä¸æ˜¾ç¤ºå–å®¶ç›¸å…³å…¥å£ | P2 | `src/app/[locale]/(main)/HomePageClient.tsx` |
| 5.2 | Sidebar ä¸æ˜¾ç¤ºå–å®¶å¯¼èˆª | P2 | `src/components/layout/Sidebar.tsx` |
| 6.1 | Client Component æ— æ³•è·å– seller èº«ä»½ | P2 | `HomePageClient.tsx` / `useAuth.ts` |
| 6.2 | Hydration ä¸€è‡´æ€§é£é™© | P1 | `HomePageClient.tsx` |
| 7.2 | å–å®¶æ— æ³•ä»é¦–é¡µè¿›å…¥å–å®¶åŠŸèƒ½ | P2 | æ•´ä¸ªé¦–é¡µç»„ä»¶ |

### 9.2 ä¿®å¤å»ºè®®

#### ğŸ”´ P1 é—®é¢˜ä¿®å¤

**é—®é¢˜ 6.2ï¼šHydration ä¸€è‡´æ€§é£é™©**

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. åœ¨ Server Component ä¸­æŸ¥è¯¢å®Œæ•´çš„ profileï¼ˆåŒ…æ‹¬ `subscription_type`ï¼‰
2. å°† `subscription_type` ä½œä¸º prop ä¼ é€’ç»™ Client Component
3. åœ¨ Client Component ä¸­ä½¿ç”¨ server ä¼ é€’çš„ `subscription_type`ï¼Œè€Œä¸æ˜¯ä» client æŸ¥è¯¢

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/app/[locale]/(main)/page.tsx`
- `src/app/[locale]/(main)/HomePageClient.tsx`

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// page.tsx
const { data: profile } = await supabase
  .from('profiles')
  .select('status, subscription_type, role')
  .eq('id', validUser.id)
  .single()

return (
  <HomePageClient
    initialPosts={posts}
    user={validUser}
    subscriptionType={profile?.subscription_type}
    // ...
  />
)
```

#### ğŸŸ¡ P2 é—®é¢˜ä¿®å¤

**é—®é¢˜ 3.1 & 5.1ï¼šé¦–é¡µä¸åŒºåˆ† seller / buyer**

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. åœ¨ Server Component ä¸­æŸ¥è¯¢ `subscription_type`
2. æ ¹æ® `subscription_type === 'seller'` æ˜¾ç¤º seller ç›¸å…³ UI
3. åœ¨é¦–é¡µé¡¶éƒ¨æˆ–ä¾§è¾¹æ˜¾ç¤º"å–å®¶ä¸­å¿ƒ"å…¥å£

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/app/[locale]/(main)/page.tsx`
- `src/app/[locale]/(main)/HomePageClient.tsx`

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// HomePageClient.tsx
{subscriptionType === 'seller' && (
  <div className="mb-4 rounded-lg border bg-blue-50 p-4">
    <div className="flex items-center justify-between">
      <div>
        <h3 className="font-semibold">å–å®¶ä¸­å¿ƒ</h3>
        <p className="text-sm text-muted-foreground">ç®¡ç†æ‚¨çš„å•†å“å’Œè®¢å•</p>
      </div>
      <Link href="/seller/dashboard">
        <Button>è¿›å…¥å–å®¶ä¸­å¿ƒ</Button>
      </Link>
    </div>
  </div>
)}
```

**é—®é¢˜ 5.2ï¼šSidebar ä¸æ˜¾ç¤ºå–å®¶å¯¼èˆª**

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. åœ¨ Sidebar ä¸­æŸ¥è¯¢ç”¨æˆ·çš„ `subscription_type`
2. å¦‚æœ `subscription_type === 'seller'`ï¼Œåœ¨å¯¼èˆªä¸­æ·»åŠ "å–å®¶ä¸­å¿ƒ"ç­‰é“¾æ¥

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/components/layout/Sidebar.tsx`

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// Sidebar.tsx
const { data: profile } = useProfile(user?.id || '')
const isSeller = profile?.subscription_type === 'seller'

const navItems = [
  { href: '/', icon: Home, label: t('home') },
  // ...
]

// å¦‚æœæ˜¯å–å®¶ï¼Œæ·»åŠ å–å®¶ç›¸å…³å¯¼èˆª
if (isSeller) {
  navItems.push(
    { href: '/seller/dashboard', icon: Store, label: t('sellerCenter') },
    { href: '/seller/products', icon: Package, label: t('myProducts') },
    { href: '/seller/orders', icon: ShoppingCart, label: t('myOrders') }
  )
}
```

**é—®é¢˜ 6.1ï¼šClient Component æ— æ³•è·å– seller èº«ä»½**

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
1. æ‰©å±• `useAuth` hookï¼Œæ·»åŠ  `subscriptionType` å’Œ `role` å­—æ®µ
2. æˆ–è€…åˆ›å»ºæ–°çš„ `useProfile` hookï¼Œåœ¨ client ç«¯æŸ¥è¯¢ profile

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/lib/hooks/useAuth.ts` æˆ–åˆ›å»º `src/lib/hooks/useUserProfile.ts`

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// useUserProfile.ts
export function useUserProfile() {
  const { user } = useAuth()
  const { data: profile } = useProfile(user?.id || '')
  
  return {
    user,
    profile,
    isSeller: profile?.subscription_type === 'seller',
    isAdmin: profile?.role === 'admin',
  }
}
```

**é—®é¢˜ 1.1 & 1.2ï¼šmiddleware ä¸è¯†åˆ« seller èº«ä»½**

**ä¿®å¤æ–¹æ¡ˆ**ï¼ˆå¯é€‰ï¼‰ï¼š
1. åœ¨ middleware ä¸­æŸ¥è¯¢ `subscription_type`
2. å¦‚æœ `subscription_type === 'seller'` ä¸”è®¿é—®é¦–é¡µï¼Œå¯ä»¥é‡å®šå‘åˆ° `/seller/dashboard`ï¼ˆå¯é€‰ï¼Œæ ¹æ®äº§å“éœ€æ±‚ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/lib/supabase/middleware.ts`

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
// middleware.ts
if (user) {
  const { data: profile } = await supabase
    .from('profiles')
    .select('status, subscription_type')
    .eq('id', user.id)
    .single()
  
  // æ£€æŸ¥å°ç¦çŠ¶æ€
  if (profile?.status === 'banned' || profile?.status === 'suspended') {
    return NextResponse.redirect(bannedUrl)
  }
  
  // å¯é€‰ï¼šå–å®¶è®¿é—®é¦–é¡µæ—¶é‡å®šå‘åˆ°å–å®¶ä¸­å¿ƒ
  // if (profile?.subscription_type === 'seller' && url.pathname === '/') {
  //   return NextResponse.redirect(new URL('/seller/dashboard', url.origin))
  // }
}
```

### 9.3 ä¿®å¤ä¼˜å…ˆçº§

1. **P1 é—®é¢˜**ï¼ˆå¿…é¡»ä¿®å¤ï¼‰ï¼š
   - é—®é¢˜ 6.2ï¼šHydration ä¸€è‡´æ€§é£é™©

2. **P2 é—®é¢˜**ï¼ˆå»ºè®®ä¿®å¤ï¼‰ï¼š
   - é—®é¢˜ 3.1 & 5.1ï¼šé¦–é¡µä¸åŒºåˆ† seller / buyer
   - é—®é¢˜ 5.2ï¼šSidebar ä¸æ˜¾ç¤ºå–å®¶å¯¼èˆª
   - é—®é¢˜ 6.1ï¼šClient Component æ— æ³•è·å– seller èº«ä»½
   - é—®é¢˜ 1.1 & 1.2ï¼šmiddleware ä¸è¯†åˆ« seller èº«ä»½ï¼ˆå¯é€‰ï¼‰

### 9.4 å®‰å…¨æ€§è¯„ä¼°

**âœ… å®‰å…¨æ€§ï¼šæ— ä¸¥é‡å®‰å…¨é—®é¢˜**
- RLS ç­–ç•¥æ­£ç¡®ï¼Œå–å®¶æ— æ³•è®¿é—®å…¶ä»–å–å®¶çš„ç§æœ‰æ•°æ®
- API å±‚æœ‰æƒé™æ ¡éªŒ
- æ•°æ®åº“å±‚æœ‰æœ€ç»ˆå…œåº•

**âš ï¸ UX é—®é¢˜ï¼šéœ€è¦æ”¹è¿›**
- å–å®¶åœ¨é¦–é¡µçœ‹ä¸åˆ°å–å®¶ç›¸å…³å…¥å£
- å–å®¶éœ€è¦æ‰‹åŠ¨å¯¼èˆªåˆ°å–å®¶ä¸­å¿ƒ
- ç”¨æˆ·ä½“éªŒä¸ä½³

---

## é™„å½•ï¼šç›¸å…³æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- `middleware.ts` - ä¸­é—´ä»¶
- `src/lib/supabase/middleware.ts` - Supabase ä¼šè¯æ›´æ–°
- `src/app/[locale]/(main)/page.tsx` - é¦–é¡µ Server Component
- `src/app/[locale]/(main)/HomePageClient.tsx` - é¦–é¡µ Client Component
- `src/components/layout/Sidebar.tsx` - ä¾§è¾¹æ å¯¼èˆª
- `src/lib/hooks/useAuth.ts` - è®¤è¯ Hook
- `src/lib/hooks/useProfile.ts` - ç”¨æˆ·èµ„æ–™ Hook
- `src/lib/hooks/useSellerGuard.tsx` - å–å®¶æƒé™å®ˆå«

### RLS ç­–ç•¥æ–‡ä»¶
- `supabase/migrations/001_initial_schema.sql` - åˆå§‹ RLS ç­–ç•¥
- `supabase/migrations/006_fix_rls_permissions.sql` - RLS æƒé™ä¿®å¤

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2026-01-25
**æ¨æ¼”å®Œæˆåº¦**ï¼š100%
