# çœŸå®ç”¨æˆ·è®¿é—®ä»–äººä¸»é¡µç³»ç»Ÿæ¨æ¼”æŠ¥å‘Š

## ã€æ¨æ¼”åœºæ™¯ã€‘

**è®¿é—®è€…èº«ä»½ï¼š**
- âœ… å·²æ³¨å†Œ
- âœ… å·²ç™»å½•ï¼ˆSupabase session æœ‰æ•ˆï¼‰
- `profiles.id` â‰  `60bc38f2-da86-4fa3-b9b1-16c77066f790`
- `profiles.role` = `'user'`
- subscription çŠ¶æ€ä¸é™
- é admin
- é seller

**è¢«è®¿é—®ç”¨æˆ·ï¼ˆé¡µé¢ä¸»äººï¼‰ï¼š**
- ç”¨æˆ· ID: `60bc38f2-da86-4fa3-b9b1-16c77066f790`
- å·²æ³¨å†Œ
- å¯èƒ½æ˜¯ï¼šæ™®é€šç”¨æˆ· / å–å®¶ / å¸¦è´§ç”¨æˆ· / å¼€å¯æ‰“èµ
- æ‹¥æœ‰å¸–å­ã€å…³æ³¨å…³ç³»ã€å¯èƒ½æœ‰å•†å“

**è®¿é—® URLï¼š**
```
http://localhost:3000/zh/profile/60bc38f2-da86-4fa3-b9b1-16c77066f790
```

---

## Step 1ï¸âƒ£ middleware.ts æ¨æ¼”

### ä»£ç è·¯å¾„
`middleware.ts` â†’ `src/lib/supabase/middleware.ts`

### æ¨æ¼”æµç¨‹

1. **è¯·æ±‚è¿›å…¥ middleware**
   ```
   URL: /zh/profile/60bc38f2-da86-4fa3-b9b1-16c77066f790
   ```

2. **ç¯å¢ƒå˜é‡éªŒè¯**
   - âœ… æ£€æŸ¥é€šè¿‡ï¼ˆå‡è®¾ç¯å¢ƒå˜é‡å·²é…ç½®ï¼‰

3. **Supabase Session æ›´æ–°**
   ```typescript
   // src/lib/supabase/middleware.ts:57
   const { data: { user } } = await supabase.auth.getUser()
   ```
   - âœ… æ­£ç¡®è¯†åˆ«è®¿é—®è€…çš„ session
   - âœ… `user.id` = è®¿é—®è€… IDï¼ˆä¸æ˜¯é¡µé¢ä¸»äººçš„ IDï¼‰
   - âœ… locale `/zh` ä¸å½±å“ session è¯†åˆ«

4. **ç”¨æˆ·çŠ¶æ€æ£€æŸ¥**
   ```typescript
   // src/lib/supabase/middleware.ts:60-77
   if (user) {
     const { data: profile } = await supabase
       .from('profiles')
       .select('status')
       .eq('id', user.id)  // âœ… æ­£ç¡®ï¼šæŸ¥è¯¢çš„æ˜¯è®¿é—®è€…çš„ profile
       .single()
     
     if (profile?.status === 'banned' || profile?.status === 'suspended') {
       // é‡å®šå‘åˆ° /banned
     }
   }
   ```
   - âœ… **æ­£ç¡®**ï¼šæŸ¥è¯¢çš„æ˜¯è®¿é—®è€…çš„ profileï¼Œä¸æ˜¯é¡µé¢ä¸»äººçš„
   - âœ… å¦‚æœè®¿é—®è€…è¢« banï¼Œä¼šé‡å®šå‘
   - âœ… ä¸ä¼šé”™è¯¯åœ°æŠŠè®¿é—®è€…å½“æˆé¡µé¢ä¸»äºº

5. **å›½é™…åŒ–ä¸­é—´ä»¶**
   ```typescript
   // middleware.ts:53
   return intlMiddleware(request)
   ```
   - âœ… locale å¤„ç†æ­£å¸¸

### âœ… ç»“è®º

**middleware è¡Œä¸ºæ­£å¸¸ï¼š**
- âœ… session æ­£ç¡®è¯†åˆ«ä¸ºã€Œå·²ç™»å½•ç”¨æˆ·ã€
- âœ… locale `/zh` ä¸å½±å“ session / auth
- âœ… æ²¡æœ‰é”™è¯¯åœ°æŠŠè®¿é—®è€…å½“æˆé¡µé¢ä¸»äºº
- âœ… æ²¡æœ‰ä½¿ç”¨ route param `userId` è¦†ç›– `session.user.id`

---

## Step 2ï¸âƒ£ è·¯ç”± & é¡µé¢çº§æƒé™åˆ¤æ–­

### ä»£ç è·¯å¾„
`src/app/[locale]/(main)/profile/[id]/page.tsx`

### æ¨æ¼”æµç¨‹

1. **é¡µé¢ç»„ä»¶åˆå§‹åŒ–**
   ```typescript
   // page.tsx:25-29
   const params = useParams()
   const userId = params.id as string  // '60bc38f2-da86-4fa3-b9b1-16c77066f790'
   const { user } = useAuth()  // è®¿é—®è€…çš„ user å¯¹è±¡
   ```

2. **Owner / Viewer åŒºåˆ†**
   ```typescript
   // page.tsx:75
   const isOwnProfile = user?.id === userId
   ```
   - âœ… **æ­£ç¡®**ï¼šæ˜ç¡®åŒºåˆ†äº† `viewer`ï¼ˆå½“å‰ç™»å½•ç”¨æˆ·ï¼‰å’Œ `owner`ï¼ˆprofile é¡µé¢ä¸»äººï¼‰
   - âœ… `isOwnProfile` = `false`ï¼ˆè®¿é—®è€… â‰  é¡µé¢ä¸»äººï¼‰

3. **Admin åˆ¤æ–­**
   ```typescript
   // page.tsx:76
   const isAdmin = isOwnProfile && (profile?.role === 'admin' || profile?.role === 'support')
   ```
   - âœ… **æ­£ç¡®**ï¼šåªæœ‰åœ¨ `isOwnProfile` ä¸º true æ—¶æ‰åˆ¤æ–­ admin
   - âœ… è®¿é—®ä»–äººä¸»é¡µæ—¶ï¼Œ`isAdmin` = `false`

### âœ… ç»“è®º

**é¡µé¢çº§æƒé™åˆ¤æ–­æ­£å¸¸ï¼š**
- âœ… æ˜ç¡®åŒºåˆ† `viewer` å’Œ `owner`
- âœ… `isOwnProfile` é€»è¾‘æ­£ç¡®
- âœ… æ²¡æœ‰æœªåŒºåˆ† viewer / owner çš„é«˜é£é™©é€»è¾‘

---

## Step 3ï¸âƒ£ Server Component æ•°æ®æ¨æ¼”

### âš ï¸ é‡è¦å‘ç°ï¼šè¿™æ˜¯ Client Component

**ä»£ç æ£€æŸ¥ï¼š**
```typescript
// page.tsx:1
'use client'
```

**é—®é¢˜ï¼š**
- âŒ **è¿™ä¸æ˜¯ Server Componentï¼Œè€Œæ˜¯ Client Component**
- âŒ æ‰€æœ‰æ•°æ®è·å–éƒ½åœ¨å®¢æˆ·ç«¯è¿›è¡Œ
- âŒ æ²¡æœ‰ Server ç«¯çš„æ•°æ®æ‹¦æˆª

### æ•°æ®è·å–é“¾è·¯

1. **Profile æ•°æ®è·å–**
   ```typescript
   // page.tsx:30
   const { data: profile, isLoading: profileLoading, error: profileError } = useProfile(userId)
   ```
   
   **useProfile Hook å®ç°ï¼š**
   ```typescript
   // src/lib/hooks/useProfile.ts:21-46
   export function useProfile(userId: string) {
     return useQuery({
       queryKey: ['profile', userId],
       queryFn: async () => {
         const supabase = createClient()  // Client-side Supabase
         const { data, error } = await supabase
           .from('profiles')
           .select('*')  // âš ï¸ æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
           .eq('id', userId)
           .single()
         return data as Profile
       }
     })
   }
   ```

   **RLS Policy æ£€æŸ¥ï¼š**
   ```sql
   -- supabase/migrations/001_initial_schema.sql:318-319
   CREATE POLICY "Users can view all profiles" ON profiles
     FOR SELECT USING (true);
   ```
   - âš ï¸ **é—®é¢˜**ï¼šRLS å…è®¸æ‰€æœ‰äººæŸ¥çœ‹æ‰€æœ‰å­—æ®µ
   - âš ï¸ **é£é™©**ï¼šå¯èƒ½è¿”å›æ•æ„Ÿå­—æ®µï¼ˆemail, payment_account_id, ç­‰ï¼‰

2. **Posts æ•°æ®è·å–**
   ```typescript
   // page.tsx:31
   const { data: postsData, isLoading: postsLoading } = usePosts('approved')
   ```
   
   **usePosts Hook å®ç°ï¼š**
   ```typescript
   // src/lib/hooks/usePosts.ts:38-97
   async function fetchPosts(page: number = 0, status: string = 'approved') {
     const supabase = createClient()
     const { data, error } = await supabase
       .from('posts')
       .select(`
         *,
         user:profiles!posts_user_id_fkey (
           username,
           display_name,
           avatar_url
         ),
         ...
       `)
       .eq('status', status)  // âœ… åªæŸ¥è¯¢ approved å¸–å­
       .order('created_at', { ascending: false })
   }
   ```
   - âœ… **æ­£ç¡®**ï¼šåªæŸ¥è¯¢ `status = 'approved'` çš„å¸–å­
   - âœ… ç„¶åé€šè¿‡ Client ç«¯è¿‡æ»¤ï¼š`userPosts = postsData.filter(post => post.user_id === userId)`

3. **Favorites æ•°æ®è·å–**
   ```typescript
   // page.tsx:63
   const { data: favorites, isLoading: favoritesLoading } = useFavorites(undefined)
   ```
   
   **useFavorites Hook å®ç°ï¼š**
   ```typescript
   // src/lib/hooks/useFavorites.ts
   // æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ”¶è—ï¼Œä¸æ˜¯é¡µé¢ä¸»äººçš„æ”¶è—
   ```
   - âœ… **æ­£ç¡®**ï¼šæŸ¥è¯¢çš„æ˜¯è®¿é—®è€…çš„æ”¶è—ï¼Œä¸æ˜¯é¡µé¢ä¸»äººçš„
   - âœ… é¡µé¢ä¸­é€šè¿‡ `isOwnProfile` æ§åˆ¶æ˜¾ç¤ºï¼š
     ```typescript
     // page.tsx:283
     {isOwnProfile && (
       <button onClick={() => setActiveTab('favorites')}>...</button>
     )}
     ```

### âŒ é—®é¢˜æ¸…å•

| é—®é¢˜ | é£é™© | æ–‡ä»¶ | åŸå›  | ä¿®å¤å»ºè®® |
|------|------|------|------|----------|
| **Client Component æ— æ³•åœ¨ Server ç«¯æ‹¦æˆªæ•æ„Ÿæ•°æ®** | **P0** | `profile/[id]/page.tsx` | ä½¿ç”¨ `'use client'`ï¼Œæ‰€æœ‰æ•°æ®åœ¨å®¢æˆ·ç«¯è·å– | æ”¹ä¸º Server Componentï¼Œæˆ–ä½¿ç”¨ Server Actions è·å–æ•°æ® |
| **useProfile æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯** | **P0** | `useProfile.ts:28` | `select('*')` æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼ŒRLS å…è®¸æ‰€æœ‰äººæŸ¥çœ‹ | åœ¨ RLS Policy ä¸­é™åˆ¶å­—æ®µï¼Œæˆ–ä½¿ç”¨ `select()` æ˜ç¡®æŒ‡å®šå…¬å¼€å­—æ®µ |
| **æ²¡æœ‰æ£€æŸ¥è¿”å›çš„ profile æ˜¯å¦åŒ…å«æ•æ„Ÿå­—æ®µ** | **P1** | `useProfile.ts` | ç›´æ¥è¿”å›æ‰€æœ‰å­—æ®µï¼Œæ²¡æœ‰è¿‡æ»¤ | åœ¨è¿”å›å‰è¿‡æ»¤æ•æ„Ÿå­—æ®µï¼ˆemail, payment_account_id, ç­‰ï¼‰ |

---

## Step 4ï¸âƒ£ é¡µé¢æ•°æ®æŸ¥è¯¢é“¾è·¯å®¡è®¡

### 1. ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢

**æŸ¥è¯¢è·¯å¾„ï¼š**
```
useProfile(userId) â†’ supabase.from('profiles').select('*').eq('id', userId)
```

**RLS Policyï¼š**
```sql
CREATE POLICY "Users can view all profiles" ON profiles
  FOR SELECT USING (true);
```

**è¿”å›å­—æ®µæ£€æŸ¥ï¼š**
- âœ… `id`, `username`, `display_name`, `avatar_url`, `bio`, `location` - å…¬å¼€å­—æ®µ
- âš ï¸ `email` - **å¯èƒ½æ³„éœ²**ï¼ˆå¦‚æœ profiles è¡¨æœ‰ email å­—æ®µï¼‰
- âš ï¸ `payment_provider`, `payment_account_id` - **å¯èƒ½æ³„éœ²**ï¼ˆå–å®¶æ”¯ä»˜è´¦æˆ·ä¿¡æ¯ï¼‰
- âš ï¸ `provider_charges_enabled`, `provider_payouts_enabled` - **å¯èƒ½æ³„éœ²**ï¼ˆå–å®¶çŠ¶æ€ï¼‰
- âš ï¸ `seller_payout_eligibility` - **å¯èƒ½æ³„éœ²**ï¼ˆå–å®¶èµ„æ ¼ï¼‰
- âš ï¸ `subscription_type`, `subscription_expires_at` - **å¯èƒ½æ³„éœ²**ï¼ˆè®¢é˜…ä¿¡æ¯ï¼‰
- âš ï¸ `role` - **å¯èƒ½æ³„éœ²**ï¼ˆadmin/support è§’è‰²ä¿¡æ¯ï¼‰
- âš ï¸ `status` - **å¯èƒ½æ³„éœ²**ï¼ˆbanned/suspended çŠ¶æ€ï¼‰

**é—®é¢˜ï¼š**
- âŒ RLS Policy å…è®¸æ‰€æœ‰äººæŸ¥çœ‹æ‰€æœ‰å­—æ®µ
- âŒ æ²¡æœ‰å­—æ®µçº§åˆ«çš„æƒé™æ§åˆ¶

### 2. å¸–å­åˆ—è¡¨æŸ¥è¯¢

**æŸ¥è¯¢è·¯å¾„ï¼š**
```
usePosts('approved') â†’ å®¢æˆ·ç«¯è¿‡æ»¤ â†’ userPosts.filter(post => post.user_id === userId)
```

**RLS Policyï¼š**
```sql
CREATE POLICY "Users can view approved posts" ON posts
  FOR SELECT USING (
    status = 'approved' 
    OR user_id = auth.uid() 
    OR EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('admin', 'support'))
  );
```

**è¿”å›æ•°æ®æ£€æŸ¥ï¼š**
- âœ… åªè¿”å› `status = 'approved'` çš„å¸–å­
- âœ… ä¸ä¼šè¿”å›è‰ç¨¿ã€å¾…å®¡æ ¸ã€å·²æ‹’ç»çš„å¸–å­
- âœ… è®¿é—®è€…æ— æ³•çœ‹åˆ°é¡µé¢ä¸»äººçš„ç§æœ‰å¸–å­

**é—®é¢˜ï¼š**
- âš ï¸ **æ€§èƒ½é—®é¢˜**ï¼šå…ˆè·å–æ‰€æœ‰ approved å¸–å­ï¼Œå†åœ¨å®¢æˆ·ç«¯è¿‡æ»¤
- âš ï¸ å¦‚æœé¡µé¢ä¸»äººæœ‰å¤§é‡å¸–å­ï¼Œä¼šåŠ è½½æ‰€æœ‰å¸–å­åˆ°å®¢æˆ·ç«¯

### 3. å…³æ³¨å…³ç³»æŸ¥è¯¢

**æŸ¥è¯¢è·¯å¾„ï¼š**
```
useIsFollowing(userId) â†’ supabase.from('follows').select('*')
  .eq('follower_id', user.id)
  .eq('followee_id', userId)
```

**RLS Policyï¼š**
```sql
-- supabase/migrations/049_add_follows_rls_policies.sql
CREATE POLICY "Anyone can view follows" ON public.follows
  FOR SELECT USING (true);
```

**è¿”å›æ•°æ®æ£€æŸ¥ï¼š**
- âœ… åªæŸ¥è¯¢è®¿é—®è€…æ˜¯å¦å…³æ³¨é¡µé¢ä¸»äºº
- âœ… ä¸ä¼šæ³„éœ²é¡µé¢ä¸»äººçš„å…¶ä»–å…³æ³¨å…³ç³»

### 4. æ”¶è—æ•°æ®æŸ¥è¯¢

**æŸ¥è¯¢è·¯å¾„ï¼š**
```
useFavorites(undefined) â†’ æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ”¶è—
```

**è¿”å›æ•°æ®æ£€æŸ¥ï¼š**
- âœ… æŸ¥è¯¢çš„æ˜¯è®¿é—®è€…çš„æ”¶è—ï¼Œä¸æ˜¯é¡µé¢ä¸»äººçš„
- âœ… é¡µé¢ä¸­é€šè¿‡ `isOwnProfile` æ§åˆ¶æ˜¾ç¤ºï¼Œè®¿é—®ä»–äººä¸»é¡µæ—¶ä¸æ˜¾ç¤º

### âŒ é—®é¢˜æ¸…å•

| é—®é¢˜ | é£é™© | æ–‡ä»¶ | åŸå›  | ä¿®å¤å»ºè®® |
|------|------|------|------|----------|
| **profiles è¡¨ RLS å…è®¸æŸ¥çœ‹æ‰€æœ‰å­—æ®µï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯** | **P0** | `migrations/001_initial_schema.sql:318` | `USING (true)` å…è®¸æ‰€æœ‰äººæŸ¥çœ‹æ‰€æœ‰å­—æ®µ | åˆ›å»ºè§†å›¾æˆ–ä½¿ç”¨åˆ—çº§æƒé™ï¼Œé™åˆ¶æ•æ„Ÿå­—æ®µ |
| **useProfile è¿”å›æ‰€æœ‰å­—æ®µï¼Œæ²¡æœ‰è¿‡æ»¤æ•æ„Ÿä¿¡æ¯** | **P0** | `useProfile.ts:28` | `select('*')` æŸ¥è¯¢æ‰€æœ‰å­—æ®µ | æ˜ç¡®æŒ‡å®šå…¬å¼€å­—æ®µï¼š`select('id, username, display_name, avatar_url, bio, location, follower_count, following_count, created_at')` |
| **å¸–å­æŸ¥è¯¢æ€§èƒ½é—®é¢˜ï¼šå…ˆè·å–æ‰€æœ‰å¸–å­å†è¿‡æ»¤** | **P2** | `page.tsx:31, 44-46` | ä½¿ç”¨ `usePosts('approved')` è·å–æ‰€æœ‰å¸–å­ï¼Œå†å®¢æˆ·ç«¯è¿‡æ»¤ | åˆ›å»ºä¸“é—¨çš„ API æˆ– Server Actionï¼Œç›´æ¥æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„å¸–å­ |

---

## Step 5ï¸âƒ£ Client Component è¡Œä¸ºæ¨æ¼”

### 1. æµè§ˆç”¨æˆ·ä¿¡æ¯

**UI æ¸²æŸ“ï¼š**
```typescript
// page.tsx:115-119
<h1>{profile.display_name || t('unnamedUser')}</h1>
<p>@{profile.username}</p>
```

**æ£€æŸ¥ï¼š**
- âœ… æ˜¾ç¤ºå…¬å¼€ä¿¡æ¯ï¼ˆdisplay_name, usernameï¼‰
- âš ï¸ å¦‚æœ profile åŒ…å«æ•æ„Ÿå­—æ®µï¼Œè™½ç„¶ä¸æ˜¾ç¤ºï¼Œä½†å·²åŠ è½½åˆ°å®¢æˆ·ç«¯

### 2. æŸ¥çœ‹å¸–å­åˆ—è¡¨

**UI æ¸²æŸ“ï¼š**
```typescript
// page.tsx:301-336
{activeTab === 'posts' && (
  <>
    {isOwnProfile && (
      <Card onClick={() => router.push('/post/create')}>
        {/* åˆ›å»ºå¸–å­å¡ç‰‡ */}
      </Card>
    )}
    {userPosts.map((post) => (
      <PostCard key={post.id} post={post} />
    ))}
  </>
)}
```

**æ£€æŸ¥ï¼š**
- âœ… è®¿é—®ä»–äººä¸»é¡µæ—¶ï¼Œä¸æ˜¾ç¤ºã€Œåˆ›å»ºå¸–å­ã€å¡ç‰‡
- âœ… åªæ˜¾ç¤ºé¡µé¢ä¸»äººçš„ approved å¸–å­

### 3. ç‚¹å‡»ã€Œå…³æ³¨ / å–æ¶ˆå…³æ³¨ã€

**ç»„ä»¶ï¼š**
```typescript
// page.tsx:240
<FollowButton userId={userId} />
```

**FollowButton å®ç°ï¼š**
```typescript
// src/components/social/FollowButton.tsx:16-96
export function FollowButton({ userId }: FollowButtonProps) {
  const { user } = useAuth()
  const { data: isFollowing } = useIsFollowing(userId)
  const followMutation = useFollow()
  
  // âœ… æ£€æŸ¥ï¼šä¸èƒ½å…³æ³¨è‡ªå·±
  if (!user || user.id === userId) {
    return null
  }
  
  const handleFollow = async () => {
    if (!user || user.id === userId) return
    await followMutation.mutateAsync({
      followingId: userId,
      shouldFollow: !isFollowing,
    })
  }
  
  return (
    <Button onClick={handleFollow}>
      {isFollowing ? 'å–æ¶ˆå…³æ³¨' : 'å…³æ³¨'}
    </Button>
  )
}
```

**æ£€æŸ¥ï¼š**
- âœ… æŒ‰é’®æ­£ç¡®æ˜¾ç¤ºï¼ˆè®¿é—®ä»–äººä¸»é¡µæ—¶æ˜¾ç¤ºï¼‰
- âœ… ä¸èƒ½å…³æ³¨è‡ªå·±ï¼ˆ`user.id === userId` æ—¶è¿”å› nullï¼‰
- âœ… çŠ¶æ€å˜åŒ–ä¼šå³æ—¶åŒæ­¥ï¼ˆé€šè¿‡ React Query ç¼“å­˜å¤±æ•ˆï¼‰

### 4. ç‚¹å‡»ã€Œç§ä¿¡ã€

**ç»„ä»¶ï¼š**
```typescript
// page.tsx:241-249
<ChatButton
  targetUserId={userId}
  targetUserName={profile.display_name ?? profile.username ?? undefined}
  variant="outline"
  size="sm"
>
  {tMessages('chatWithAuthor')}
</ChatButton>
```

**ChatButton å®ç°ï¼š**
```typescript
// src/components/social/ChatButton.tsx:63-109
const handleClick = async () => {
  if (!user) {
    toast({ description: 'è¯·å…ˆç™»å½•åå†ç§èŠ' })
    return
  }
  
  if (!targetUserId || targetUserId === user.id) return
  
  const conversationId = await getOrCreateConversation(targetUserId)
  router.push(`/messages/${conversationId}`)
}
```

**æ£€æŸ¥ï¼š**
- âœ… æœªç™»å½•æ—¶æç¤ºç™»å½•
- âœ… ä¸èƒ½ç»™è‡ªå·±å‘ç§ä¿¡ï¼ˆ`targetUserId === user.id` æ—¶ returnï¼‰
- âœ… æ­£ç¡®åˆ›å»ºæˆ–è·å–ä¼šè¯

### 5. ç‚¹å‡»ã€Œä¸¾æŠ¥ã€

**ç»„ä»¶ï¼š**
```typescript
// page.tsx:250-263
<Button
  onClick={() => {
    if (!user) {
      showInfo('è¯·å…ˆç™»å½•åå†ä¸¾æŠ¥')
      return
    }
    setShowReportDialog(true)
  }}
>
  <Flag className="mr-2 h-4 w-4" />
  {tCommon('report') || 'ä¸¾æŠ¥'}
</Button>
```

**æ£€æŸ¥ï¼š**
- âœ… æœªç™»å½•æ—¶æç¤ºç™»å½•
- âœ… æ­£ç¡®æ‰“å¼€ä¸¾æŠ¥å¯¹è¯æ¡†

### 6. ç‚¹å‡»å¸–å­å¡ç‰‡

**ç»„ä»¶ï¼š**
```typescript
// page.tsx:332
{userPosts.map((post) => (
  <PostCard key={post.id} post={post} />
))}
```

**æ£€æŸ¥ï¼š**
- âœ… PostCard ç»„ä»¶ä¼šå¤„ç†å¸–å­ç‚¹å‡»ï¼Œè·³è½¬åˆ°å¸–å­è¯¦æƒ…é¡µ
- âœ… å¸–å­è¯¦æƒ…é¡µä¼šæ˜¾ç¤ºæ‰“èµæŒ‰é’®ï¼ˆå¦‚æœå¸–å­ä¸»äººå¼€å¯æ‰“èµï¼‰

### 7. ç¼–è¾‘æŒ‰é’®æ˜¾ç¤º

**UI æ¸²æŸ“ï¼š**
```typescript
// page.tsx:227-237
{isOwnProfile ? (
  <Button onClick={() => router.push(`/profile/${userId}/edit`)}>
    <Pencil className="mr-2 h-4 w-4" />
    {t('editProfile')}
  </Button>
) : (
  // æ˜¾ç¤ºå…³æ³¨ã€ç§ä¿¡ã€ä¸¾æŠ¥æŒ‰é’®
)}
```

**æ£€æŸ¥ï¼š**
- âœ… **æ­£ç¡®**ï¼šè®¿é—®ä»–äººä¸»é¡µæ—¶ï¼Œä¸æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
- âœ… åªæœ‰ `isOwnProfile === true` æ—¶æ‰æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®

### 8. åŠŸèƒ½å…¥å£æ˜¾ç¤ºï¼ˆå–å®¶ä¸­å¿ƒã€å¸¦è´§ä¸­å¿ƒç­‰ï¼‰

**UI æ¸²æŸ“ï¼š**
```typescript
// page.tsx:140-191
{isOwnProfile && (
  <div className="flex flex-wrap gap-2 sm:gap-3 pt-2">
    {isAdmin && (
      <Link href="/admin/dashboard">ç®¡ç†é¢æ¿</Link>
    )}
    <Link href="/seller/dashboard">å–å®¶ä¸­å¿ƒ</Link>
    <Link href="/affiliate/products">å¸¦è´§ä¸­å¿ƒ</Link>
    <Link href="/">æ‰“èµ</Link>
    <Link href="/cart">è´­ç‰©è½¦</Link>
    <Link href="/orders">æˆ‘çš„è®¢å•</Link>
  </div>
)}
```

**æ£€æŸ¥ï¼š**
- âœ… **æ­£ç¡®**ï¼šè®¿é—®ä»–äººä¸»é¡µæ—¶ï¼Œä¸æ˜¾ç¤ºè¿™äº›åŠŸèƒ½å…¥å£
- âœ… åªæœ‰ `isOwnProfile === true` æ—¶æ‰æ˜¾ç¤º

### 9. Favorites Tab æ˜¾ç¤º

**UI æ¸²æŸ“ï¼š**
```typescript
// page.tsx:283-295
{isOwnProfile && (
  <button onClick={() => setActiveTab('favorites')}>
    <Star className="inline-block h-4 w-4 mr-1" />
    {tFavorites('pageTitle')} ({formatNumber(favoritesCount)})
  </button>
)}
```

**æ£€æŸ¥ï¼š**
- âœ… **æ­£ç¡®**ï¼šè®¿é—®ä»–äººä¸»é¡µæ—¶ï¼Œä¸æ˜¾ç¤º Favorites Tab
- âœ… åªæœ‰ `isOwnProfile === true` æ—¶æ‰æ˜¾ç¤º

### âœ… ç»“è®º

**Client Component è¡Œä¸ºæ­£å¸¸ï¼š**
- âœ… æŒ‰é’®æ­£ç¡®æ˜¾ç¤º / éšè—
- âœ… çŠ¶æ€å˜åŒ–å³æ—¶åŒæ­¥
- âœ… æœªæˆæƒæ“ä½œè¢«æ­£ç¡®æ‹¦æˆªï¼ˆå…³æ³¨è‡ªå·±ã€ç»™è‡ªå·±å‘ç§ä¿¡ç­‰ï¼‰
- âœ… æ²¡æœ‰"èƒ½ç‚¹ä½†å¿…å¤±è´¥"çš„å‡æŒ‰é’®

---

## Step 6ï¸âƒ£ API è°ƒç”¨æƒé™å®¡è®¡ï¼ˆé‡ç‚¹ï¼‰

### 1. Follow / Unfollow API

**è°ƒç”¨è·¯å¾„ï¼š**
```
FollowButton â†’ useFollow() â†’ supabase.from('follows').insert/delete()
```

**æƒé™æ£€æŸ¥ï¼š**
```typescript
// src/lib/hooks/useProfile.ts:71-113
export function useFollow() {
  return useMutation({
    mutationFn: async ({ followingId, shouldFollow }) => {
      if (!user) throw new Error('Not authenticated')  // âœ… æ£€æŸ¥ç™»å½•
      if (user.id === followingId) throw new Error('Cannot follow yourself')  // âœ… ä¸èƒ½å…³æ³¨è‡ªå·±
      
      if (shouldFollow) {
        await supabase.from('follows').insert({
          follower_id: user.id,  // âœ… ä½¿ç”¨ session user.id
          followee_id: followingId,
        })
      } else {
        await supabase.from('follows').delete()
          .eq('follower_id', user.id)  // âœ… åªèƒ½åˆ é™¤è‡ªå·±çš„å…³æ³¨
          .eq('followee_id', followingId)
      }
    }
  })
}
```

**RLS Policyï¼š**
```sql
-- supabase/migrations/049_add_follows_rls_policies.sql
CREATE POLICY "Users can insert their own follows" ON public.follows
  FOR INSERT WITH CHECK (auth.uid() = follower_id);  -- âœ… åªèƒ½æ’å…¥è‡ªå·±çš„å…³æ³¨

CREATE POLICY "Users can delete their own follows" ON public.follows
  FOR DELETE USING (auth.uid() = follower_id);  -- âœ… åªèƒ½åˆ é™¤è‡ªå·±çš„å…³æ³¨
```

**æ£€æŸ¥ï¼š**
- âœ… æ ¡éªŒ session å­˜åœ¨
- âœ… æ ¡éªŒ `viewer â‰  owner`ï¼ˆä¸èƒ½å…³æ³¨è‡ªå·±ï¼‰
- âœ… RLS Policy ç¡®ä¿åªèƒ½æ“ä½œè‡ªå·±çš„å…³æ³¨å…³ç³»

### 2. Message / Conversation Create API

**è°ƒç”¨è·¯å¾„ï¼š**
```
ChatButton â†’ useConversation().getOrCreateConversation() â†’ supabase.from('conversations').insert/select()
```

**æƒé™æ£€æŸ¥ï¼š**
```typescript
// src/lib/hooks/useConversation.ts:14-56
const getOrCreateConversation = async (otherUserId: string) => {
  if (!user) throw new Error('User not authenticated')  // âœ… æ£€æŸ¥ç™»å½•
  if (!otherUserId) throw new Error('otherUserId is required')
  if (otherUserId === user.id) throw new Error('Cannot create conversation with self')  // âœ… ä¸èƒ½ç»™è‡ªå·±å‘ç§ä¿¡
  
  // æŸ¥æ‰¾å·²å­˜åœ¨çš„ä¼šè¯
  const { data: existing } = await supabase
    .from('conversations')
    .select('id')
    .eq('conversation_type', 'private')
    .or(`and(participant1_id.eq.${user.id},participant2_id.eq.${otherUserId}),and(participant1_id.eq.${otherUserId},participant2_id.eq.${user.id})`)
    .limit(1)
    .maybeSingle()
  
  if (existing?.id) return existing.id
  
  // åˆ›å»ºæ–°ä¼šè¯
  const { data: conversation } = await supabase
    .from('conversations')
    .insert({
      participant1_id: user.id,  // âœ… ä½¿ç”¨ session user.id
      participant2_id: otherUserId,
      conversation_type: 'private',
    })
    .select('id')
    .single()
  
  return conversation.id
}
```

**RLS Policyï¼š**
```sql
-- supabase/migrations/040_add_conversations_messages_rls_policies.sql
CREATE POLICY "Users can create private conversations" ON conversations
  FOR INSERT
  WITH CHECK (
    conversation_type = 'private'
    AND (participant1_id = auth.uid() OR participant2_id = auth.uid())  -- âœ… å¿…é¡»æ˜¯å‚ä¸è€…
  );
```

**æ£€æŸ¥ï¼š**
- âœ… æ ¡éªŒ session å­˜åœ¨
- âœ… æ ¡éªŒ `viewer â‰  owner`ï¼ˆä¸èƒ½ç»™è‡ªå·±å‘ç§ä¿¡ï¼‰
- âœ… RLS Policy ç¡®ä¿åªèƒ½åˆ›å»ºè‡ªå·±å‚ä¸çš„ä¼šè¯

### 3. Tip / Donate API

**è°ƒç”¨è·¯å¾„ï¼š**
```
TipButtonï¼ˆåœ¨å¸–å­è¯¦æƒ…é¡µï¼‰ â†’ /api/payments/stripe/create-tip-session
```

**æƒé™æ£€æŸ¥ï¼š**
```typescript
// src/app/api/payments/stripe/create-tip-session/route.ts:7-82
export async function POST(request: NextRequest) {
  const supabase = await createClient()
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  
  if (authError || !user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })  // âœ… æ£€æŸ¥ç™»å½•
  }
  
  const { amount, postId, postAuthorId, ... } = await request.json()
  
  // âœ… æ£€æŸ¥æ‰“èµè®¢é˜…
  const tipEnabled = await checkTipEnabled(user.id, supabaseAdmin)
  if (!tipEnabled) {
    return NextResponse.json({ error: 'Tip feature subscription required' }, { status: 403 })
  }
  
  // âœ… æ£€æŸ¥è®¢é˜…çŠ¶æ€
  const { data: tipSubscription } = await supabaseAdmin
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', user.id)  // âœ… æ£€æŸ¥è®¿é—®è€…çš„è®¢é˜…
    .eq('subscription_type', 'tip')
    .eq('status', 'active')
    .gt('expires_at', new Date().toISOString())
    .single()
  
  if (!tipSubscription) {
    return NextResponse.json({ error: 'Tip subscription expired' }, { status: 403 })
  }
  
  // âœ… ä¸èƒ½ç»™è‡ªå·±æ‰“èµ
  if (postAuthorId === user.id) {
    return NextResponse.json({ error: 'Cannot tip yourself' }, { status: 400 })
  }
  
  // âœ… éªŒè¯å¸–å­å­˜åœ¨ä¸”ä½œè€…åŒ¹é…
  const { data: post } = await supabaseAdmin
    .from('posts')
    .select('id, user_id, status')
    .eq('id', postId)
    .single()
  
  if (!post) {
    return NextResponse.json({ error: 'Post not found' }, { status: 404 })
  }
  
  if (post.user_id !== postAuthorId) {
    return NextResponse.json({ error: 'Post author mismatch' }, { status: 400 })
  }
  
  if (post.status !== 'approved') {
    return NextResponse.json({ error: 'Post not approved' }, { status: 400 })
  }
}
```

**æ£€æŸ¥ï¼š**
- âœ… æ ¡éªŒ session å­˜åœ¨
- âœ… æ ¡éªŒ `viewer â‰  owner`ï¼ˆä¸èƒ½ç»™è‡ªå·±æ‰“èµï¼‰
- âœ… æ ¡éªŒ feature flagï¼ˆæ‰“èµè®¢é˜…ï¼‰
- âœ… æ ¡éªŒå¸–å­å­˜åœ¨ä¸”ä½œè€…åŒ¹é…
- âœ… æ ¡éªŒå¸–å­çŠ¶æ€ä¸º approved

### 4. Product View API

**è°ƒç”¨è·¯å¾„ï¼š**
```
PostCardï¼ˆå¦‚æœæœ‰å¸¦è´§å•†å“ï¼‰ â†’ ç‚¹å‡»å•†å“ â†’ /product/[id]
```

**æ£€æŸ¥ï¼š**
- âœ… å•†å“è¯¦æƒ…é¡µåº”è¯¥åªæ˜¾ç¤ºå…¬å¼€å•†å“
- âœ… RLS Policy åº”è¯¥é™åˆ¶åªèƒ½æŸ¥çœ‹ `status = 'active'` çš„å•†å“

### 5. User Stats API

**è°ƒç”¨è·¯å¾„ï¼š**
```
Profile Page â†’ æ˜¾ç¤º follower_count, following_count
```

**æ•°æ®æ¥æºï¼š**
```typescript
// page.tsx:122-136
<Link href={`/profile/${userId}/followers`}>
  <span>{formatNumber(profile.follower_count)}</span>
  <span> {t('followers')}</span>
</Link>
```

**æ£€æŸ¥ï¼š**
- âœ… ç»Ÿè®¡æ•°æ®æ¥è‡ª profile è¡¨ï¼Œæ˜¯å…¬å¼€å­—æ®µ
- âœ… ç‚¹å‡»é“¾æ¥ä¼šè·³è½¬åˆ°å…³æ³¨è€…åˆ—è¡¨é¡µï¼ˆéœ€è¦æ£€æŸ¥è¯¥é¡µé¢çš„æƒé™ï¼‰

### âŒ é—®é¢˜æ¸…å•

| é—®é¢˜ | é£é™© | æ–‡ä»¶ | åŸå›  | ä¿®å¤å»ºè®® |
|------|------|------|------|----------|
| **æ—  Server-side API è°ƒç”¨** | **P1** | - | æ‰€æœ‰æ“ä½œéƒ½é€šè¿‡ Client-side Supabaseï¼Œä¾èµ– RLS | å…³é”®æ“ä½œï¼ˆå¦‚æ‰“èµï¼‰å·²æœ‰ Server APIï¼Œä½†å…³æ³¨ã€ç§ä¿¡ç­‰åªæœ‰ Client API |
| **å…³æ³¨/ç§ä¿¡æ“ä½œåªæœ‰ Client-side æ ¡éªŒ** | **P1** | `useFollow.ts`, `useConversation.ts` | è™½ç„¶ RLS æœ‰ä¿æŠ¤ï¼Œä½†ç¼ºå°‘ Server-side åŒé‡æ ¡éªŒ | å¯¹äºæ•æ„Ÿæ“ä½œï¼Œå»ºè®®æ·»åŠ  Server API è¿›è¡ŒäºŒæ¬¡æ ¡éªŒ |

---

## Step 7ï¸âƒ£ è¾¹ç•Œ & å¼‚å¸¸æ¨æ¼”

### 1. é¡µé¢ä¸»äººç¦ç”¨äº†æ‰“èµ

**åœºæ™¯ï¼š**
- é¡µé¢ä¸»äºº `tip_enabled = false` æˆ–æ²¡æœ‰æ‰“èµè®¢é˜…

**æ¨æ¼”ï¼š**
- âœ… TipButton åœ¨å¸–å­è¯¦æƒ…é¡µæ˜¾ç¤ºï¼Œä½†ç‚¹å‡»æ—¶ä¼šæ£€æŸ¥è®¿é—®è€…çš„æ‰“èµè®¢é˜…
- âš ï¸ **é—®é¢˜**ï¼šTipButton ä¸ä¼šæ£€æŸ¥é¡µé¢ä¸»äººæ˜¯å¦å¼€å¯æ‰“èµ
- âš ï¸ å¦‚æœé¡µé¢ä¸»äººæ²¡æœ‰å¼€å¯æ‰“èµï¼Œè®¿é—®è€…ä»ç„¶å¯ä»¥å°è¯•æ‰“èµï¼ˆä¼šåœ¨æ”¯ä»˜æµç¨‹ä¸­å¤±è´¥ï¼‰

### 2. é¡µé¢ä¸»äººä¸æ˜¯ seller

**åœºæ™¯ï¼š**
- é¡µé¢ä¸»äºº `role != 'seller'` æˆ–æ²¡æœ‰ seller è®¢é˜…

**æ¨æ¼”ï¼š**
- âœ… é¡µé¢ä¸ä¼šæ˜¾ç¤ºã€Œå–å®¶ä¸­å¿ƒã€å…¥å£ï¼ˆå› ä¸º `isOwnProfile === false`ï¼‰
- âœ… å¦‚æœé¡µé¢ä¸»äººæœ‰å•†å“ï¼Œä¼šæ­£å¸¸æ˜¾ç¤ºï¼ˆå•†å“è¯¦æƒ…é¡µä¼šæ£€æŸ¥å•†å“çŠ¶æ€ï¼‰

### 3. Viewer è¢«é¡µé¢ä¸»äººæ‹‰é»‘

**åœºæ™¯ï¼š**
- é¡µé¢ä¸»äººå°†è®¿é—®è€…åŠ å…¥é»‘åå•

**æ¨æ¼”ï¼š**
- âš ï¸ **é—®é¢˜**ï¼šæ²¡æœ‰æ£€æŸ¥é»‘åå•
- âš ï¸ è®¿é—®è€…ä»ç„¶å¯ä»¥ï¼š
  - æŸ¥çœ‹é¡µé¢ä¸»äººçš„ profile
  - æŸ¥çœ‹é¡µé¢ä¸»äººçš„å¸–å­
  - å…³æ³¨é¡µé¢ä¸»äºº
  - ç»™é¡µé¢ä¸»äººå‘ç§ä¿¡
  - ç»™é¡µé¢ä¸»äººçš„å¸–å­æ‰“èµ

**å»ºè®®ï¼š**
- éœ€è¦æ·»åŠ é»‘åå•æ£€æŸ¥é€»è¾‘

### 4. Session è¿‡æœŸ

**åœºæ™¯ï¼š**
- è®¿é—®è€…åœ¨æµè§ˆè¿‡ç¨‹ä¸­ session è¿‡æœŸ

**æ¨æ¼”ï¼š**
- âœ… `useAuth()` ä¼šæ£€æµ‹åˆ° `user === null`
- âœ… éœ€è¦ç™»å½•çš„æ“ä½œä¼šæç¤ºç™»å½•ï¼ˆå¦‚å…³æ³¨ã€ç§ä¿¡ã€ä¸¾æŠ¥ï¼‰
- âœ… å·²åŠ è½½çš„æ•°æ®ä»ç„¶æ˜¾ç¤ºï¼ˆä¸ä¼šè‡ªåŠ¨åˆ·æ–°ï¼‰

### 5. API è¿”å› 401 / 403 / 404

**åœºæ™¯ï¼š**
- å…³æ³¨æ“ä½œè¿”å› 401ï¼ˆæœªç™»å½•ï¼‰
- æ‰“èµæ“ä½œè¿”å› 403ï¼ˆè®¢é˜…è¿‡æœŸï¼‰
- Profile æŸ¥è¯¢è¿”å› 404ï¼ˆç”¨æˆ·ä¸å­˜åœ¨ï¼‰

**æ¨æ¼”ï¼š**

**401 Unauthorizedï¼š**
```typescript
// useFollow.ts:84
if (!user) throw new Error('Not authenticated')
```
- âœ… ä¼šæŠ›å‡ºé”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º

**403 Forbiddenï¼š**
```typescript
// create-tip-session/route.ts:52-56
if (!tipEnabled) {
  return NextResponse.json({ error: 'Tip feature subscription required' }, { status: 403 })
}
```
- âœ… è¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
- âœ… TipButton ä¼šæ˜¾ç¤ºé”™è¯¯æç¤º

**404 Not Foundï¼š**
```typescript
// page.tsx:98-104
if (!profile) {
  return (
    <div className="py-12 text-center">
      <p className="text-destructive">{t('userNotFound')}</p>
      <p className="mt-2 text-sm text-muted-foreground">{t('userId')}: {userId}</p>
    </div>
  )
}
```
- âœ… æ˜¾ç¤ºç”¨æˆ·ä¸å­˜åœ¨æç¤º
- âš ï¸ **é—®é¢˜**ï¼šæ˜¾ç¤ºäº† userIdï¼Œå¯èƒ½æ³„éœ²ä¿¡æ¯

### âŒ é—®é¢˜æ¸…å•

| é—®é¢˜ | é£é™© | æ–‡ä»¶ | åŸå›  | ä¿®å¤å»ºè®® |
|------|------|------|------|----------|
| **æ²¡æœ‰æ£€æŸ¥é»‘åå•** | **P1** | `page.tsx`, `useFollow.ts`, `useConversation.ts` | ç¼ºå°‘é»‘åå•æ£€æŸ¥é€»è¾‘ | åœ¨å…³æ³¨ã€ç§ä¿¡ã€æ‰“èµç­‰æ“ä½œå‰æ£€æŸ¥é»‘åå• |
| **TipButton ä¸æ£€æŸ¥é¡µé¢ä¸»äººæ˜¯å¦å¼€å¯æ‰“èµ** | **P2** | `TipButton.tsx` | åªæ£€æŸ¥è®¿é—®è€…çš„æ‰“èµè®¢é˜…ï¼Œä¸æ£€æŸ¥æ¥æ”¶è€… | åœ¨æ‰“èµ API ä¸­æ£€æŸ¥æ¥æ”¶è€…æ˜¯å¦å¼€å¯æ‰“èµ |
| **404 é”™è¯¯æ˜¾ç¤º userId** | **P2** | `page.tsx:102` | åœ¨é”™è¯¯ä¿¡æ¯ä¸­æ˜¾ç¤º userId | ç§»é™¤ userId æ˜¾ç¤ºï¼Œåªæ˜¾ç¤º"ç”¨æˆ·ä¸å­˜åœ¨" |

---

## Step 8ï¸âƒ£ è¾“å‡ºç»“æœ

### âœ… æ­£å¸¸è¡Œä¸ºæ€»ç»“

1. **è®¤è¯ä¸è·¯ç”±**
   - âœ… middleware æ­£ç¡®è¯†åˆ«è®¿é—®è€… session
   - âœ… locale ä¸å½±å“è®¤è¯
   - âœ… é¡µé¢æ­£ç¡®åŒºåˆ† viewer å’Œ owner

2. **æƒé™éš”ç¦»**
   - âœ… ç¼–è¾‘æŒ‰é’®åªåœ¨ own profile æ—¶æ˜¾ç¤º
   - âœ… åŠŸèƒ½å…¥å£ï¼ˆå–å®¶ä¸­å¿ƒã€å¸¦è´§ä¸­å¿ƒç­‰ï¼‰åªåœ¨ own profile æ—¶æ˜¾ç¤º
   - âœ… Favorites Tab åªåœ¨ own profile æ—¶æ˜¾ç¤º
   - âœ… åˆ›å»ºå¸–å­å¡ç‰‡åªåœ¨ own profile æ—¶æ˜¾ç¤º

3. **åŠŸèƒ½è”åŠ¨**
   - âœ… å…³æ³¨/å–æ¶ˆå…³æ³¨åŠŸèƒ½æ­£å¸¸
   - âœ… ç§ä¿¡åŠŸèƒ½æ­£å¸¸
   - âœ… ä¸¾æŠ¥åŠŸèƒ½æ­£å¸¸
   - âœ… å¸–å­åˆ—è¡¨æ­£ç¡®è¿‡æ»¤

4. **API æƒé™**
   - âœ… å…³æ³¨ API æ ¡éªŒç™»å½•å’Œä¸èƒ½å…³æ³¨è‡ªå·±
   - âœ… ç§ä¿¡ API æ ¡éªŒç™»å½•å’Œä¸èƒ½ç»™è‡ªå·±å‘ç§ä¿¡
   - âœ… æ‰“èµ API æ ¡éªŒç™»å½•ã€è®¢é˜…ã€ä¸èƒ½ç»™è‡ªå·±æ‰“èµ

### âŒ é—®é¢˜æ¸…å•ï¼ˆåˆ†çº§ï¼‰

| é—®é¢˜ | é£é™© | æ–‡ä»¶ | åŸå›  | ä¿®å¤å»ºè®® |
|------|------|------|------|----------|
| **profiles è¡¨ RLS å…è®¸æŸ¥çœ‹æ‰€æœ‰å­—æ®µï¼Œå¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼ˆemail, payment_account_id ç­‰ï¼‰** | **P0** | `migrations/001_initial_schema.sql:318` | `USING (true)` å…è®¸æ‰€æœ‰äººæŸ¥çœ‹æ‰€æœ‰å­—æ®µ | åˆ›å»ºè§†å›¾æˆ–ä½¿ç”¨åˆ—çº§æƒé™ï¼Œé™åˆ¶æ•æ„Ÿå­—æ®µï¼š`select('id, username, display_name, avatar_url, bio, location, follower_count, following_count, created_at')` |
| **useProfile æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œæ²¡æœ‰è¿‡æ»¤æ•æ„Ÿä¿¡æ¯** | **P0** | `useProfile.ts:28` | `select('*')` æŸ¥è¯¢æ‰€æœ‰å­—æ®µ | æ˜ç¡®æŒ‡å®šå…¬å¼€å­—æ®µï¼Œä¸æŸ¥è¯¢ email, payment_account_id, subscription_type ç­‰ |
| **Client Component æ— æ³•åœ¨ Server ç«¯æ‹¦æˆªæ•æ„Ÿæ•°æ®** | **P0** | `profile/[id]/page.tsx:1` | ä½¿ç”¨ `'use client'`ï¼Œæ‰€æœ‰æ•°æ®åœ¨å®¢æˆ·ç«¯è·å– | æ”¹ä¸º Server Componentï¼Œæˆ–ä½¿ç”¨ Server Actions è·å–æ•°æ®ï¼Œåœ¨ Server ç«¯è¿‡æ»¤æ•æ„Ÿå­—æ®µ |
| **æ²¡æœ‰æ£€æŸ¥é»‘åå•** | **P1** | `page.tsx`, `useFollow.ts`, `useConversation.ts` | ç¼ºå°‘é»‘åå•æ£€æŸ¥é€»è¾‘ | åœ¨å…³æ³¨ã€ç§ä¿¡ã€æ‰“èµç­‰æ“ä½œå‰æ£€æŸ¥é»‘åå•ï¼Œå¦‚æœè¢«æ‹‰é»‘åˆ™æ‹’ç»æ“ä½œå¹¶æç¤º |
| **TipButton ä¸æ£€æŸ¥é¡µé¢ä¸»äººæ˜¯å¦å¼€å¯æ‰“èµ** | **P2** | `TipButton.tsx` | åªæ£€æŸ¥è®¿é—®è€…çš„æ‰“èµè®¢é˜…ï¼Œä¸æ£€æŸ¥æ¥æ”¶è€… | åœ¨æ‰“èµ API ä¸­æ£€æŸ¥æ¥æ”¶è€…æ˜¯å¦å¼€å¯æ‰“èµï¼ˆ`tip_enabled = true` ä¸”æœ‰æœ‰æ•ˆè®¢é˜…ï¼‰ |
| **å¸–å­æŸ¥è¯¢æ€§èƒ½é—®é¢˜ï¼šå…ˆè·å–æ‰€æœ‰å¸–å­å†è¿‡æ»¤** | **P2** | `page.tsx:31, 44-46` | ä½¿ç”¨ `usePosts('approved')` è·å–æ‰€æœ‰å¸–å­ï¼Œå†å®¢æˆ·ç«¯è¿‡æ»¤ | åˆ›å»ºä¸“é—¨çš„ API æˆ– Server Actionï¼Œç›´æ¥æŸ¥è¯¢æŒ‡å®šç”¨æˆ·çš„å¸–å­ï¼š`supabase.from('posts').select('*').eq('user_id', userId).eq('status', 'approved')` |
| **404 é”™è¯¯æ˜¾ç¤º userId** | **P2** | `page.tsx:102` | åœ¨é”™è¯¯ä¿¡æ¯ä¸­æ˜¾ç¤º userId | ç§»é™¤ userId æ˜¾ç¤ºï¼Œåªæ˜¾ç¤º"ç”¨æˆ·ä¸å­˜åœ¨" |

### ğŸ¯ æœ€ç»ˆç»“è®º

**å›ç­”æ ¸å¿ƒé—®é¢˜ï¼š**

> ä¸€ä¸ªçœŸå®ç”¨æˆ·è®¿é—®"åˆ«äººçš„ä¸»é¡µ"ï¼Œæ˜¯å¦èƒ½çœ‹åˆ°ä¸è¯¥çœ‹åˆ°çš„å†…å®¹ï¼Œç‚¹åˆ°ä¸è¯¥ç‚¹çš„åŠŸèƒ½ï¼Œç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹æ˜¯å¦å¯ä¿¡ï¼Ÿ

**ç­”æ¡ˆï¼š**

1. **èƒ½çœ‹åˆ°ä¸è¯¥çœ‹åˆ°çš„å†…å®¹ï¼š** âš ï¸ **éƒ¨åˆ†èƒ½**
   - âŒ **P0 é£é™©**ï¼šå¯èƒ½é€šè¿‡ `useProfile` è·å–åˆ°æ•æ„Ÿå­—æ®µï¼ˆemail, payment_account_id, subscription_type ç­‰ï¼‰
   - âŒ è™½ç„¶è¿™äº›å­—æ®µä¸åœ¨ UI ä¸­æ˜¾ç¤ºï¼Œä½†å·²åŠ è½½åˆ°å®¢æˆ·ç«¯ï¼Œå¯ä»¥é€šè¿‡æµè§ˆå™¨ DevTools æŸ¥çœ‹

2. **èƒ½ç‚¹åˆ°ä¸è¯¥ç‚¹çš„åŠŸèƒ½ï¼š** âœ… **ä¸èƒ½**
   - âœ… ç¼–è¾‘æŒ‰é’®ã€åŠŸèƒ½å…¥å£ã€Favorites Tab ç­‰éƒ½æ­£ç¡®éšè—
   - âœ… å…³æ³¨ã€ç§ä¿¡ã€æ‰“èµç­‰åŠŸèƒ½éƒ½æœ‰æ­£ç¡®çš„æƒé™æ ¡éªŒ
   - âš ï¸ **P1 é£é™©**ï¼šç¼ºå°‘é»‘åå•æ£€æŸ¥ï¼Œè¢«æ‹‰é»‘çš„ç”¨æˆ·ä»ç„¶å¯ä»¥å…³æ³¨ã€ç§ä¿¡ã€æ‰“èµ

3. **ç³»ç»Ÿåœ¨å¼‚å¸¸æƒ…å†µä¸‹æ˜¯å¦å¯ä¿¡ï¼š** âš ï¸ **éƒ¨åˆ†å¯ä¿¡**
   - âœ… API è¿”å› 401/403/404 æ—¶æœ‰æ˜ç¡®çš„é”™è¯¯å¤„ç†
   - âš ï¸ **P2 é£é™©**ï¼š404 é”™è¯¯æ˜¾ç¤º userIdï¼Œå¯èƒ½æ³„éœ²ä¿¡æ¯
   - âš ï¸ **P2 é£é™©**ï¼šTipButton ä¸æ£€æŸ¥æ¥æ”¶è€…æ˜¯å¦å¼€å¯æ‰“èµï¼Œå¯èƒ½å¯¼è‡´æ— æ•ˆæ“ä½œ

**æ€»ä½“è¯„ä¼°ï¼š**
- âœ… **UI å±‚é¢æƒé™éš”ç¦»æ­£å¸¸**
- âŒ **æ•°æ®å±‚é¢å­˜åœ¨ P0 é£é™©**ï¼šå¯èƒ½æ³„éœ²æ•æ„Ÿå­—æ®µ
- âš ï¸ **åŠŸèƒ½å±‚é¢å­˜åœ¨ P1 é£é™©**ï¼šç¼ºå°‘é»‘åå•æ£€æŸ¥

**å»ºè®®ä¼˜å…ˆçº§ï¼š**
1. **P0ï¼ˆç«‹å³ä¿®å¤ï¼‰**ï¼šé™åˆ¶ profiles è¡¨å­—æ®µè®¿é—®ï¼Œè¿‡æ»¤æ•æ„Ÿä¿¡æ¯
2. **P1ï¼ˆå°½å¿«ä¿®å¤ï¼‰**ï¼šæ·»åŠ é»‘åå•æ£€æŸ¥
3. **P2ï¼ˆä¼˜åŒ–ï¼‰**ï¼šä¼˜åŒ–å¸–å­æŸ¥è¯¢æ€§èƒ½ï¼Œä¿®å¤ TipButton é€»è¾‘ï¼Œç§»é™¤ 404 é”™è¯¯ä¸­çš„ userId
