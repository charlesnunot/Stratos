# 未登录用户访问帖子详情页并点击分享系统推演报告

**生成日期**: 2026-01-25  
**推演场景**: 未登录用户访问 `/en/post/[id]`，页面加载完成后点击「分享」图标，触发分享（Web Share API / 复制链接）并得到反馈

---

## 📋 推演目标

- 页面渲染链路（Server / Client、权限）
- 分享按钮可见性与点击逻辑
- Web Share API 与复制链接 fallback
- 分享统计 API 与未登录用户
- 边界情况与潜在问题

---

## 🔍 Step 1：访问帖子详情页

### 1.1 当前实现

**页面组件**: `src/app/[locale]/(main)/post/[id]/page.tsx`  
**类型**: ⚠️ **纯 Client Component**（`'use client'`）

- 无 Server Component 预取帖子数据
- 使用 `usePost(postId)` 在客户端拉取
- RLS 限制：仅能查到 `status = 'approved'` 且作者 `active` 的帖子

### 1.2 Middleware 与权限

- **Middleware**: 更新 Supabase session、国际化；未登录不重定向
- **帖子详情页**: 无登录门槛，未登录可访问
- **私密/非公开**: 由 RLS 过滤，`usePost` 拿不到则显示「帖子不存在或加载失败」

### 1.3 数据与 UI

- **帖子内容**: 通过 `usePost` → Supabase，仅公开可见数据
- **功能按钮**: 点赞、评论、收藏、转发、**分享**
- **未登录**:
  - 点赞 / 评论 / 收藏：可点，操作时提示登录
  - 转发：`{user && (...)}` 不渲染，看不到
  - **分享：不包在 `user` 判断内，始终展示、可点** ✅

---

## 🎴 Step 2：渲染分享按钮

### 2.1 按钮位置与绑定

```tsx
// 帖子详情页 - 操作区
<Button variant="ghost" size="sm" className="gap-2" onClick={handleShare}>
  <Share2 className="h-4 w-4" />
  <span className="text-sm">{post.share_count || 0}</span>
</Button>
```

- 与点赞、评论、收藏、转发同排
- **无 `user` 判断**，未登录用户可见、可点

### 2.2 点击逻辑

```tsx
const handleShare = () => {
  setShowShareDialog(true)
}
```

- 仅打开 `ShareDialog`
- **不校验登录**，未登录直接进分享弹窗 ✅

### 2.3 功能可见性小结

| 功能     | 未登录可见 | 未登录可点 | 说明                     |
|----------|------------|------------|--------------------------|
| 点赞     | ✅         | ✅         | 点后提示登录             |
| 评论     | ✅         | ✅         | 点后提示登录             |
| 收藏     | ✅         | ✅         | 点后提示登录             |
| 转发     | ❌         | -          | 仅登录显示               |
| **分享** | **✅**     | **✅**     | **无需登录，直接可用**   |

---

## 📤 Step 3：点击分享图标

### 3.1 流程概览

1. 用户点击分享 → `handleShare` → `ShareDialog` 打开  
2. 用户在弹窗内选平台（复制链接 / 更多 / 微信 / 微博等）  
3. 执行对应分享（复制 / Web Share / 外链等）  
4. 成功则可选记录分享统计；未登录则不记

### 3.2 ShareDialog 实现（`src/components/social/ShareDialog.tsx`）

**分享方式**:

| 平台     | 实现                     | 未登录可用 |
|----------|--------------------------|------------|
| 复制链接 | `copyToClipboard(url)`   | ✅         |
| 更多     | `shareViaNative`（Web Share API） | ✅（支持时展示） |
| 微信     | 二维码                   | ✅         |
| 微博/QQ/Twitter/Facebook | `window.open` 外链 | ✅         |

- 复制链接、原生分享、第三方外链 **均不依赖登录**
- 「更多」仅当 `supportsNativeShare()` 为 true 时展示，否则靠复制链接等 fallback

### 3.3 Web Share API 与 fallback

**`src/lib/utils/share.ts`**:

```ts
// 是否支持原生分享
export function supportsNativeShare(): boolean {
  return typeof navigator !== 'undefined' && 'share' in navigator
}

// 原生分享
export async function shareViaNative(data) {
  if (!navigator.share) return false
  try {
    await navigator.share(data)
    return true
  } catch (e) {
    if (e.name === 'AbortError') return false  // 用户取消
    return false
  }
}

// 复制
export async function copyToClipboard(text: string): Promise<boolean> {
  // 优先 navigator.clipboard.writeText
  // 不支持则 textarea + document.execCommand('copy')
  // 失败 return false
}
```

- **支持 Web Share** → 显示「更多」，可调系统分享  
- **不支持** → 不显示「更多」，仍有「复制链接」等  
- 复制有 `clipboard` + `execCommand` 双重 fallback

### 3.4 分享统计与未登录用户

```ts
const recordShare = async () => {
  if (!user || !supabase) return
  // ...
  await supabase.from('shares').insert({ user_id: user.id, item_type, item_id })
}
```

- **未登录**：`recordShare` 直接 return，**不调用后端、不写 shares 表**
- **已登录**：分享成功后插入 `shares`，用于统计  
- RLS：`INSERT` 要求 `auth.uid() = user_id`，未登录本就不可插入

**结论**：未登录用户只做前端分享，不涉及分享统计 API，无 401/403 问题。

### 3.5 用户反馈

- **复制成功**: `showSuccess('链接已复制到剪贴板')`，然后关闭弹窗（非微信时）  
- **复制失败**: 当前无提示 ⚠️（已在下文修复建议中说明）  
- **原生分享**：成功即 `shared = true`，同上；取消则静默，不报错

---

## ⚠️ Step 4：边界情况

### 4.1 Web Share 不支持

- 「更多」不展示，仅显示复制链接、微博、QQ 等  
- **Fallback**: 依赖「复制链接」，逻辑正确 ✅

### 4.2 复制失败

- `copyToClipboard` 返回 `false`，`shared` 保持 `false`
- 不 `recordShare`，不关弹窗  
- **已修复**: 复制失败时调用 `showError('复制失败，请稍后重试')`，用户可知失败并重试 ✅

### 4.3 帖子不存在或非公开

- 详情页在 `error || !post` 时渲染「帖子不存在或加载失败」  
- 分享按钮在帖子存在且渲染成功后才有，故不会在无效帖上点分享  
- 若用户篡改地址等导致 404/错误页，也不存在分享入口

### 4.4 分享统计 API

- 未登录不调用 `recordShare`，故 **不会** 请求 `/api/...` 或写 `shares`  
- 无匿名分享统计、无频率限制等逻辑，因此不存在「未登录调用分享 API 报错」的问题

---

## ✅ Step 5：推演结论与修正

### 5.1 页面与分享流程

- **渲染**: Client Component（`page`）→ `usePost` → 帖子内容与按钮 → 点击分享 → `ShareDialog`  
- **权限**: 未登录可访问帖子、看到分享按钮、打开分享弹窗、使用复制/原生/外链分享  
- **统计**: 仅登录用户写入 `shares`，未登录完全不涉及

### 5.2 与目标场景的符合度

| 项目                 | 状态 |
|----------------------|------|
| 未登录可访问详情页   | ✅   |
| 未登录可见分享按钮   | ✅   |
| 未登录可点击分享     | ✅   |
| 不依赖登录即可分享   | ✅   |
| Web Share / 复制 fallback | ✅   |
| 分享统计不要求未登录 | ✅   |
| 复制失败有明确提示   | ✅ 已修复 |

### 5.3 已修复项

- **复制失败提示**: 在 `ShareDialog` 的 `copy` 分支中，若 `!copied`，调用 `showError('复制失败，请稍后重试')`，避免静默失败。✅ 已实现

### 5.4 安全与权限

- 分享仅暴露当前帖子的公开链接，无敏感数据  
- 未登录无法执行需登录的操作（转发、写 shares 等）  
- 分享动作本身不做权限校验，符合「分享无需登录」的结论 ✅

---

## 📝 总结

未登录用户访问帖子详情页并点击分享的流程 **符合预期**：

1. 可访问详情页、看到并点击分享按钮  
2. 分享不依赖登录，使用 Web Share 或复制链接  
3. 分享统计仅登录用户写入，未登录不调 API、不报错  
4. 复制失败时补充错误提示后，反馈更完整

**已落地改动**：在 `ShareDialog` 中为复制失败增加了 `showError('复制失败，请稍后重试')` 提示。
