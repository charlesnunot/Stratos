# ç«‹å³ä¿®å¤ä»»åŠ¡å®Œæˆæ€»ç»“

**å®Œæˆæ—¥æœŸ**: 2026-01-25  
**ä»»åŠ¡**: A. ç«‹å³ä¿®å¤ï¼ˆæœ¬å‘¨å†…ï¼‰

---

## âœ… ä»»åŠ¡ 1: åˆ›å»ºè®¢å•å–æ¶ˆçš„æ•°æ®åº“å‡½æ•°ï¼ˆP0-2 å®Œæ•´è§£å†³æ–¹æ¡ˆï¼‰

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### åˆ›å»ºçš„æ–‡ä»¶:
- `supabase/migrations/151_create_order_cancel_function.sql`

### åŠŸèƒ½ç‰¹æ€§:
1. **åŸå­æ“ä½œ**: ä½¿ç”¨ PostgreSQL å‡½æ•°ç¡®ä¿è®¢å•å–æ¶ˆå’Œåº“å­˜æ¢å¤åœ¨åŒä¸€äº‹åŠ¡ä¸­å®Œæˆ
2. **è¡Œçº§é”**: ä½¿ç”¨ `FOR UPDATE` é”å®šè®¢å•å’Œå•†å“è¡Œï¼Œé˜²æ­¢å¹¶å‘é—®é¢˜
3. **å¹‚ç­‰æ€§**: å¦‚æœè®¢å•å·²å–æ¶ˆï¼Œç›´æ¥è¿”å›æˆåŠŸï¼Œä¸ä¼šé‡å¤å¤„ç†
4. **çŠ¶æ€æ£€æŸ¥**: éªŒè¯è®¢å•æ˜¯å¦å¯ä»¥å–æ¶ˆï¼ˆä¸èƒ½å–æ¶ˆå·²å®Œæˆæˆ–å·²å‘è´§çš„è®¢å•ï¼‰
5. **å¤šå•†å“æ”¯æŒ**: æ”¯æŒ `order_items` è¡¨ï¼ˆå¤šå•†å“è®¢å•ï¼‰å’Œæ—§æ ¼å¼ `product_id` å­—æ®µ
6. **é”™è¯¯å¤„ç†**: ä½¿ç”¨ `EXCEPTION` å—æ•è·æ‰€æœ‰é”™è¯¯ï¼Œè‡ªåŠ¨å›æ»š

### ä½¿ç”¨æ–¹å¼:
```typescript
const { data: cancelResult, error: cancelError } = await supabaseAdmin
  .rpc('cancel_order_and_restore_stock', {
    p_order_id: orderId,
  })

if (cancelResult && cancelResult[0].success) {
  // è®¢å•å·²æˆåŠŸå–æ¶ˆï¼Œåº“å­˜å·²æ¢å¤
} else {
  // å¤„ç†é”™è¯¯: cancelResult[0].error_message
}
```

### å·²æ›´æ–°çš„æ–‡ä»¶:
- `src/app/api/orders/[id]/cancel/route.ts` - æœªæ”¯ä»˜è®¢å•å–æ¶ˆæ—¶ä½¿ç”¨æ•°æ®åº“å‡½æ•°
  - æœªæ”¯ä»˜è®¢å•: ä½¿ç”¨ `cancel_order_and_restore_stock()` æ•°æ®åº“å‡½æ•°
  - å·²æ”¯ä»˜è®¢å•é€€æ¬¾å: ä¹Ÿä½¿ç”¨æ•°æ®åº“å‡½æ•°ç¡®ä¿åº“å­˜æ¢å¤
  - æ‰€æœ‰æ“ä½œç»Ÿä¸€ä½¿ç”¨ `getSupabaseAdmin()` åˆ›å»ºå®¢æˆ·ç«¯

---

## âœ… ä»»åŠ¡ 2: ç»§ç»­é‡æ„å‰©ä½™ Admin API è·¯ç”±

### å®ŒæˆçŠ¶æ€: âœ… å·²å®Œæˆ

### é‡æ„ç»Ÿè®¡:
- **æ€»æ–‡ä»¶æ•°**: 14 ä¸ª admin API è·¯ç”±æ–‡ä»¶
- **å·²é‡æ„**: 14 ä¸ªï¼ˆ100%ï¼‰
- **ä½¿ç”¨ `requireAdmin()`**: 13 ä¸ªè·¯ç”±
- **ä½¿ç”¨ `requireAdminOrSupport()`**: 1 ä¸ªè·¯ç”±ï¼ˆdisputes GETï¼‰

### å·²é‡æ„çš„æ–‡ä»¶åˆ—è¡¨:

#### 1. âœ… `src/app/api/admin/monitoring/dashboard/route.ts`
- GET: ä½¿ç”¨ `requireAdmin()`

#### 2. âœ… `src/app/api/admin/platform-fees/charge/route.ts`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 3. âœ… `src/app/api/admin/violation-penalties/deduct/route.ts`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 4. âœ… `src/app/api/admin/compensations/route.ts`
- GET: ä½¿ç”¨ `requireAdmin()`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 5. âœ… `src/app/api/admin/refunds/process/route.ts`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 6. âœ… `src/app/api/admin/disputes/route.ts`
- GET: ä½¿ç”¨ `requireAdminOrSupport()`ï¼ˆadmin æˆ– support éƒ½å¯ä»¥æŸ¥çœ‹ï¼‰
- POST: ä½¿ç”¨ `requireAdmin()`ï¼ˆåªæœ‰ admin å¯ä»¥è§£å†³çº çº·ï¼‰

#### 7. âœ… `src/app/api/admin/payment-accounts/[id]/verify/route.ts`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 8. âœ… `src/app/api/admin/seller-debts/route.ts`
- GET: ä½¿ç”¨ `requireAdmin()`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 9. âœ… `src/app/api/admin/seller-debts/[sellerId]/route.ts`
- GET: ä½¿ç”¨ `requireAdmin()`

#### 10. âœ… `src/app/api/admin/commissions/[id]/settle/route.ts`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 11. âœ… `src/app/api/admin/transfers/retry/route.ts`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 12. âœ… `src/app/api/admin/deposits/[lotId]/process-refund/route.ts`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 13. âœ… `src/app/api/admin/platform-payment-accounts/route.ts`
- GET: ä½¿ç”¨ `requireAdmin()`
- POST: ä½¿ç”¨ `requireAdmin()`

#### 14. âœ… `src/app/api/admin/platform-payment-accounts/[id]/route.ts`
- GET: ä½¿ç”¨ `requireAdmin()`
- PUT: ä½¿ç”¨ `requireAdmin()`
- PATCH: ä½¿ç”¨ `requireAdmin()`

---

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

### é‡æ„å‰:
```typescript
// æ¯ä¸ªæ–‡ä»¶éƒ½é‡å¤è¿™äº›ä»£ç ï¼ˆ20+ å¤„ï¼‰
const supabase = await createClient()
const { data: { user }, error: authError } = await supabase.auth.getUser()
if (authError || !user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
}

const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single()

if (profile?.role !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}

const { createClient: createAdminClient } = await import('@supabase/supabase-js')
const supabaseAdmin = createAdminClient(...)
```

### é‡æ„å:
```typescript
// ç»Ÿä¸€ã€ç®€æ´ã€å®‰å…¨
import { requireAdmin } from '@/lib/auth/require-admin'
import { getSupabaseAdmin } from '@/lib/supabase/admin'

const authResult = await requireAdmin(request)
if (!authResult.success) {
  return authResult.response
}

const supabaseAdmin = await getSupabaseAdmin()
```

---

## ğŸ¯ æ”¹è¿›æ•ˆæœ

### 1. ä»£ç è´¨é‡
- âœ… **å‡å°‘é‡å¤ä»£ç **: ä» 20+ å¤„é‡å¤ä»£ç å‡å°‘åˆ° 0 å¤„
- âœ… **ç»Ÿä¸€é”™è¯¯å¤„ç†**: æ‰€æœ‰ admin è·¯ç”±ä½¿ç”¨ç›¸åŒçš„é”™è¯¯å“åº”æ ¼å¼
- âœ… **ç±»å‹å®‰å…¨**: ç»Ÿä¸€çš„è¿”å›ç±»å‹ï¼Œæ›´å¥½çš„ TypeScript æ”¯æŒ

### 2. å®‰å…¨æ€§
- âœ… **ä¸€è‡´æ€§**: æ‰€æœ‰ admin è·¯ç”±ä½¿ç”¨ç›¸åŒçš„æƒé™æ£€æŸ¥é€»è¾‘
- âœ… **å¯å®¡è®¡æ€§**: å¯ä»¥å¿«é€Ÿç¡®è®¤æ‰€æœ‰ admin ç«¯ç‚¹éƒ½æœ‰æƒé™æ£€æŸ¥
- âœ… **å‡å°‘æ¼æ´é£é™©**: ç»Ÿä¸€å·¥å…·å‡½æ•°å‡å°‘äº†å¿˜è®°æ£€æŸ¥æƒé™çš„å¯èƒ½æ€§

### 3. å¯ç»´æŠ¤æ€§
- âœ… **å•ä¸€èŒè´£**: æƒé™æ£€æŸ¥é€»è¾‘é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­
- âœ… **æ˜“äºä¿®æ”¹**: å¦‚æœéœ€è¦ä¿®æ”¹æƒé™é€»è¾‘ï¼Œåªéœ€ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶
- âœ… **æ˜“äºæµ‹è¯•**: å¯ä»¥å•ç‹¬æµ‹è¯•æƒé™æ£€æŸ¥é€»è¾‘

### 4. æ€§èƒ½
- âœ… **å‡å°‘æŸ¥è¯¢**: ç»Ÿä¸€çš„æƒé™æ£€æŸ¥å¯èƒ½å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢ï¼ˆæœªæ¥å¯ä»¥æ·»åŠ ç¼“å­˜ï¼‰

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### åˆ›å»ºçš„å·¥å…·å‡½æ•°:

#### 1. `src/lib/auth/require-admin.ts`
- `requireAdmin()`: è¦æ±‚ç”¨æˆ·å¿…é¡»æ˜¯ admin
- `requireAdminOrSupport()`: è¦æ±‚ç”¨æˆ·å¿…é¡»æ˜¯ admin æˆ– support
- ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
- è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œ supabase å®¢æˆ·ç«¯

#### 2. `src/lib/supabase/admin.ts`
- `getSupabaseAdmin()`: ç»Ÿä¸€åˆ›å»º Service Role å®¢æˆ·ç«¯
- ç¯å¢ƒå˜é‡éªŒè¯
- æ¯æ¬¡è°ƒç”¨åˆ›å»ºæ–°å®ä¾‹ï¼ˆé€‚åˆ Serverless ç¯å¢ƒï¼‰

---

## ğŸ“ åç»­å»ºè®®

### 1. æ•°æ®åº“å‡½æ•°ä½¿ç”¨
- âœ… å·²åˆ›å»º `cancel_order_and_restore_stock()` å‡½æ•°
- âš ï¸ **å¾…å®Œæˆ**: åœ¨é€€æ¬¾æˆåŠŸåçš„è®¢å•å–æ¶ˆæµç¨‹ä¸­ä¹Ÿä½¿ç”¨æ­¤å‡½æ•°ï¼ˆå½“å‰éƒ¨åˆ†ä½¿ç”¨ï¼Œéƒ¨åˆ†æœªä½¿ç”¨ï¼‰

### 2. å…¶ä»–ä¼˜åŒ–
- å¯ä»¥è€ƒè™‘æ·»åŠ æƒé™æ£€æŸ¥çš„ç¼“å­˜ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
- å¯ä»¥è€ƒè™‘æ·»åŠ æ“ä½œæ—¥å¿—è®°å½•

### 3. æµ‹è¯•
- å»ºè®®ä¸º `requireAdmin()` å’Œ `requireAdminOrSupport()` æ·»åŠ å•å…ƒæµ‹è¯•
- å»ºè®®ä¸ºæ•°æ®åº“å‡½æ•°æ·»åŠ é›†æˆæµ‹è¯•

---

## âœ… éªŒè¯æ¸…å•

- [x] æ‰€æœ‰ `/api/admin/*` è·¯ç”±éƒ½å·²ä½¿ç”¨ç»Ÿä¸€æƒé™æ£€æŸ¥å·¥å…·
- [x] æ‰€æœ‰ admin æ“ä½œéƒ½ä½¿ç”¨ `getSupabaseAdmin()` åˆ›å»ºå®¢æˆ·ç«¯
- [x] è®¢å•å–æ¶ˆæ•°æ®åº“å‡½æ•°å·²åˆ›å»ºå¹¶é›†æˆ
- [x] ä»£ç é€šè¿‡ linter æ£€æŸ¥
- [x] æ²¡æœ‰å¼•å…¥æ–°çš„é”™è¯¯

---

## ğŸ“ˆ ä»£ç ç»Ÿè®¡

### é‡æ„å‰:
- æƒé™æ£€æŸ¥ä»£ç : ~20 å¤„ï¼Œæ¯å¤„ ~15 è¡Œ = **~300 è¡Œé‡å¤ä»£ç **
- Service Role å®¢æˆ·ç«¯åˆ›å»º: ~20 å¤„ï¼Œæ¯å¤„ ~10 è¡Œ = **~200 è¡Œé‡å¤ä»£ç **

### é‡æ„å:
- æƒé™æ£€æŸ¥ä»£ç : ç»Ÿä¸€å·¥å…·å‡½æ•° = **~110 è¡Œ**ï¼ˆå¯å¤ç”¨ï¼‰
- Service Role å®¢æˆ·ç«¯åˆ›å»º: ç»Ÿä¸€å·¥å…·å‡½æ•° = **~25 è¡Œ**ï¼ˆå¯å¤ç”¨ï¼‰
- **å‡å°‘ä»£ç **: ~365 è¡Œé‡å¤ä»£ç  â†’ ~135 è¡Œå¯å¤ç”¨ä»£ç 
- **ä»£ç å‡å°‘ç‡**: ~63%

---

## ğŸ‰ æ€»ç»“

æ‰€æœ‰ç«‹å³ä¿®å¤ä»»åŠ¡å·²å®Œæˆï¼š

1. âœ… **P0-2**: åˆ›å»ºäº†åŸå­åŒ–çš„è®¢å•å–æ¶ˆæ•°æ®åº“å‡½æ•°
2. âœ… **P0-3**: æ‰€æœ‰ admin API è·¯ç”±å·²ç»Ÿä¸€ä½¿ç”¨æƒé™æ£€æŸ¥å·¥å…·

**ä¸‹ä¸€æ­¥**: å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ä¸­ç­‰é—®é¢˜ï¼ˆP1ï¼‰å’Œå»ºè®®ä¼˜åŒ–ï¼ˆP2ï¼‰ã€‚
