# ä»£ç å®¡è®¡ä¸æ¶æ„è¯„å®¡æŠ¥å‘Š

**å®¡è®¡æ—¥æœŸ**: 2026-01-25  
**å®¡è®¡èŒƒå›´**: å…¨æ ˆä»£ç åº“ï¼ˆNext.js 14 + Supabase + TypeScriptï¼‰  
**å®¡è®¡æ ‡å‡†**: ç”Ÿäº§ç¯å¢ƒå®‰å…¨ã€æ€§èƒ½ã€å¯ç»´æŠ¤æ€§ã€Next.js 14 æœ€ä½³å®è·µ

---

## æ‰§è¡Œæ‘˜è¦

### æ€»ä½“è¯„ä¼°
- **æ¶æ„è®¾è®¡**: âš ï¸ è‰¯å¥½ï¼Œä½†æœ‰æ”¹è¿›ç©ºé—´
- **æ•°æ®å®‰å…¨**: âš ï¸ åŸºæœ¬å®‰å…¨ï¼Œå­˜åœ¨å…³é”®æ¼æ´
- **ä¸šåŠ¡é€»è¾‘**: âš ï¸ åŸºæœ¬æ­£ç¡®ï¼Œå­˜åœ¨ç«æ€æ¡ä»¶é£é™©
- **æ€§èƒ½ä¼˜åŒ–**: âš ï¸ éœ€è¦ä¼˜åŒ–
- **ä»£ç è´¨é‡**: âœ… è‰¯å¥½
- **Next.js 14 å®è·µ**: âš ï¸ éƒ¨åˆ†ç¬¦åˆï¼Œéœ€è¦æ”¹è¿›

### å…³é”®å‘ç°
- **ä¸¥é‡é—®é¢˜**: 3 ä¸ª
- **ä¸­ç­‰é—®é¢˜**: 8 ä¸ª
- **å»ºè®®ä¼˜åŒ–**: 12 ä¸ª

---

## ä¸€ã€ä¸¥é‡é—®é¢˜ï¼ˆP0 - å¿…é¡»ç«‹å³ä¿®å¤ï¼‰

### ğŸ”´ P0-1: Service Role å®¢æˆ·ç«¯åœ¨æ¨¡å—çº§åˆ«åˆ›å»ºï¼ˆå®‰å…¨é£é™©ï¼‰

**ä½ç½®**: `src/app/api/payments/stripe/webhook/route.ts:6-15`

**é—®é¢˜æè¿°**:
```typescript
const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  { ... }
)
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
1. **æ¨¡å—çº§å•ä¾‹**: Service Role å®¢æˆ·ç«¯åœ¨æ¨¡å—åŠ è½½æ—¶åˆ›å»ºï¼Œæ‰€æœ‰è¯·æ±‚å…±äº«åŒä¸€ä¸ªå®ä¾‹
2. **æ— è¯·æ±‚éš”ç¦»**: ä¸åŒ webhook è¯·æ±‚å¯èƒ½å…±äº«çŠ¶æ€ï¼Œå¯¼è‡´æ•°æ®æ±¡æŸ“
3. **ç¯å¢ƒå˜é‡æ£€æŸ¥ç¼ºå¤±**: å¦‚æœ `SUPABASE_SERVICE_ROLE_KEY` æœªè®¾ç½®ï¼Œåº”ç”¨å¯åŠ¨æ—¶ä¸ä¼šæŠ¥é”™ï¼Œåªåœ¨è¿è¡Œæ—¶å¤±è´¥
4. **è¿å Serverless æœ€ä½³å®è·µ**: åœ¨ Serverless ç¯å¢ƒä¸­ï¼Œæ¨¡å—çº§å˜é‡å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼

**ç”Ÿäº§ç¯å¢ƒåæœ**:
- é«˜å¹¶å‘æ—¶å¯èƒ½å‡ºç°æ•°æ®æ··ä¹±
- å¦‚æœç¯å¢ƒå˜é‡ç¼ºå¤±ï¼Œæ‰€æœ‰ webhook éƒ½ä¼šå¤±è´¥ï¼Œä½†é”™è¯¯éš¾ä»¥è¿½è¸ª
- å†…å­˜æ³„æ¼é£é™©ï¼ˆè™½ç„¶ Supabase å®¢æˆ·ç«¯é€šå¸¸æ˜¯æ— çŠ¶æ€çš„ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// âŒ é”™è¯¯åšæ³•ï¼ˆå½“å‰ï¼‰
const supabaseAdmin = createClient(...)

// âœ… æ­£ç¡®åšæ³•
async function getSupabaseAdmin() {
  if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
    throw new Error('SUPABASE_SERVICE_ROLE_KEY is not configured')
  }
  
  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    }
  )
}

export async function POST(request: NextRequest) {
  const supabaseAdmin = await getSupabaseAdmin()
  // ... ä½¿ç”¨ supabaseAdmin
}
```

**å½±å“èŒƒå›´**: 
- `src/app/api/payments/stripe/webhook/route.ts`
- æ£€æŸ¥å…¶ä»–æ–‡ä»¶æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜

---

### ğŸ”´ P0-2: è®¢å•å–æ¶ˆæ—¶åº“å­˜æ¢å¤éåŸå­æ“ä½œï¼ˆæ•°æ®ä¸€è‡´æ€§é£é™©ï¼‰

**ä½ç½®**: `src/app/api/orders/[id]/cancel/route.ts:125-165`

**é—®é¢˜æè¿°**:
```typescript
// è®¢å•å–æ¶ˆæ—¶çš„åº“å­˜æ¢å¤
const { data: orderItems } = await supabase
  .from('order_items')
  .select('product_id, quantity')
  .eq('order_id', orderId)

if (orderItems && orderItems.length > 0) {
  for (const item of orderItems) {
    const { data: product } = await supabase
      .from('products')
      .select('stock')
      .eq('id', item.product_id)
      .single()

    if (product && product.stock !== null) {
      await supabase
        .from('products')
        .update({
          stock: (product.stock || 0) + item.quantity,
        })
        .eq('id', item.product_id)
    }
  }
}
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
1. **éåŸå­æ“ä½œ**: è®¢å•çŠ¶æ€æ›´æ–°å’Œåº“å­˜æ¢å¤æ˜¯åˆ†ç¦»çš„ï¼Œå¦‚æœä¸­é—´å¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´
2. **ç«æ€æ¡ä»¶**: å¤šä¸ªå–æ¶ˆè¯·æ±‚åŒæ—¶å¤„ç†åŒä¸€è®¢å•æ—¶ï¼Œå¯èƒ½é‡å¤æ¢å¤åº“å­˜
3. **N+1 æŸ¥è¯¢**: å¾ªç¯ä¸­æ¯ä¸ªå•†å“éƒ½æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œæ€§èƒ½å·®
4. **æ²¡æœ‰è¡Œé”**: è¯»å–åº“å­˜å’Œæ›´æ–°åº“å­˜ä¹‹é—´æ²¡æœ‰é”ï¼Œå¯èƒ½ä¸¢å¤±æ›´æ–°
5. **ä½¿ç”¨æ™®é€šå®¢æˆ·ç«¯**: ä½¿ç”¨ `supabase`ï¼ˆç”¨æˆ·å®¢æˆ·ç«¯ï¼‰è€Œä¸æ˜¯ `supabaseAdmin`ï¼Œå¯èƒ½å— RLS é™åˆ¶

**ç”Ÿäº§ç¯å¢ƒåæœ**:
- **åº“å­˜é”™è¯¯**: è®¢å•å–æ¶ˆä½†åº“å­˜æœªæ¢å¤ï¼Œæˆ–é‡å¤æ¢å¤å¯¼è‡´åº“å­˜è™šé«˜
- **æ•°æ®ä¸ä¸€è‡´**: è®¢å•çŠ¶æ€ä¸º `cancelled` ä½†åº“å­˜æœªæ¢å¤
- **æ€§èƒ½é—®é¢˜**: å¤§é‡è®¢å•å–æ¶ˆæ—¶ï¼ŒN+1 æŸ¥è¯¢å¯¼è‡´æ•°æ®åº“å‹åŠ›
- **å¹¶å‘é—®é¢˜**: é«˜å¹¶å‘æ—¶å¯èƒ½å‡ºç°åº“å­˜è¶…å–æˆ–è´Ÿæ•°

**ä¿®å¤æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ1: åˆ›å»ºæ•°æ®åº“å‡½æ•°ï¼ˆæ¨èï¼‰**
```sql
-- supabase/migrations/151_create_order_cancel_function.sql
CREATE OR REPLACE FUNCTION cancel_order_and_restore_stock(
  p_order_id UUID
)
RETURNS TABLE (
  success BOOLEAN,
  error_message TEXT
) AS $$
DECLARE
  v_order RECORD;
  v_order_item RECORD;
  v_current_stock INT;
  v_new_stock INT;
BEGIN
  -- é”å®šè®¢å•è¡Œ
  SELECT * INTO v_order
  FROM orders
  WHERE id = p_order_id
  FOR UPDATE;
  
  IF NOT FOUND THEN
    RETURN QUERY SELECT false, 'Order not found'::TEXT;
    RETURN;
  END IF;
  
  -- æ£€æŸ¥è®¢å•çŠ¶æ€
  IF v_order.order_status = 'cancelled' THEN
    RETURN QUERY SELECT true, NULL::TEXT; -- å·²å–æ¶ˆï¼Œå¹‚ç­‰è¿”å›æˆåŠŸ
    RETURN;
  END IF;
  
  IF v_order.order_status IN ('completed', 'shipped') THEN
    RETURN QUERY SELECT false, 'Cannot cancel completed or shipped order'::TEXT;
    RETURN;
  END IF;
  
  -- æ›´æ–°è®¢å•çŠ¶æ€
  UPDATE orders
  SET 
    order_status = 'cancelled',
    updated_at = NOW()
  WHERE id = p_order_id;
  
  -- æ¢å¤åº“å­˜ï¼ˆå¤šå•†å“è®¢å•ï¼‰
  FOR v_order_item IN 
    SELECT product_id, quantity
    FROM order_items
    WHERE order_id = p_order_id
  LOOP
    -- é”å®šå•†å“è¡Œ
    SELECT stock INTO v_current_stock
    FROM products
    WHERE id = v_order_item.product_id
    FOR UPDATE;
    
    IF FOUND AND v_current_stock IS NOT NULL THEN
      v_new_stock := v_current_stock + v_order_item.quantity;
      UPDATE products
      SET 
        stock = v_new_stock,
        updated_at = NOW()
      WHERE id = v_order_item.product_id;
    END IF;
  END LOOP;
  
  -- å¤„ç†æ—§æ ¼å¼å•å•†å“è®¢å•
  IF v_order.product_id IS NOT NULL THEN
    SELECT stock INTO v_current_stock
    FROM products
    WHERE id = v_order.product_id
    FOR UPDATE;
    
    IF FOUND AND v_current_stock IS NOT NULL THEN
      v_new_stock := v_current_stock + COALESCE(v_order.quantity, 1);
      UPDATE products
      SET 
        stock = v_new_stock,
        updated_at = NOW()
      WHERE id = v_order.product_id;
    END IF;
  END IF;
  
  RETURN QUERY SELECT true, NULL::TEXT;
  
EXCEPTION
  WHEN OTHERS THEN
    RETURN QUERY SELECT false, SQLERRM::TEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**æ–¹æ¡ˆ2: åœ¨ API ä¸­ä½¿ç”¨æ‰¹é‡æ›´æ–°ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰**
```typescript
// ä½¿ç”¨ supabaseAdmin å¹¶æ‰¹é‡æ›´æ–°
const { createClient: createAdminClient } = await import('@supabase/supabase-js')
const supabaseAdmin = createAdminClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  { auth: { autoRefreshToken: false, persistSession: false } }
)

// æ‰¹é‡è·å–æ‰€æœ‰å•†å“åº“å­˜
const productIds = orderItems.map(item => item.product_id)
const { data: products } = await supabaseAdmin
  .from('products')
  .select('id, stock')
  .in('id', productIds)

// æ‰¹é‡æ›´æ–°ï¼ˆä½¿ç”¨æ•°æ®åº“å‡½æ•°æ›´å®‰å…¨ï¼‰
for (const item of orderItems) {
  const product = products?.find(p => p.id === item.product_id)
  if (product && product.stock !== null) {
    await supabaseAdmin.rpc('increment_product_stock', {
      p_product_id: item.product_id,
      p_quantity: item.quantity
    })
  }
}
```

**å½±å“èŒƒå›´**:
- `src/app/api/orders/[id]/cancel/route.ts` (3 å¤„ç±»ä¼¼ä»£ç )
- éœ€è¦åˆ›å»ºæ•°æ®åº“å‡½æ•°

---

### ğŸ”´ P0-3: ç¼ºå°‘ç»Ÿä¸€çš„ Admin æƒé™æ£€æŸ¥å·¥å…·ï¼ˆå®‰å…¨é£é™©ï¼‰

**ä½ç½®**: æ‰€æœ‰ `/api/admin/*` è·¯ç”±

**é—®é¢˜æè¿°**:
æ¯ä¸ª admin API éƒ½é‡å¤å®ç°æƒé™æ£€æŸ¥ï¼š
```typescript
// é‡å¤å‡ºç°åœ¨ 20+ ä¸ªæ–‡ä»¶ä¸­
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single()

if (profile?.role !== 'admin') {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 403 })
}
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
1. **ä»£ç é‡å¤**: 20+ å¤„é‡å¤ä»£ç ï¼Œç»´æŠ¤å›°éš¾
2. **ä¸ä¸€è‡´æ€§**: æœ‰äº›æ£€æŸ¥ `role !== 'admin'`ï¼Œæœ‰äº›æ£€æŸ¥ `role !== 'admin' && role !== 'support'`
3. **å®‰å…¨é£é™©**: å¦‚æœæŸå¤„å¿˜è®°æ£€æŸ¥ï¼Œå°±æ˜¯ä¸¥é‡çš„å®‰å…¨æ¼æ´
4. **éš¾ä»¥å®¡è®¡**: æ— æ³•å¿«é€Ÿç¡®è®¤æ‰€æœ‰ admin ç«¯ç‚¹éƒ½æœ‰æƒé™æ£€æŸ¥
5. **æ€§èƒ½æµªè´¹**: æ¯ä¸ªè¯·æ±‚éƒ½æŸ¥è¯¢ profiles è¡¨

**ç”Ÿäº§ç¯å¢ƒåæœ**:
- **æƒé™ç»•è¿‡**: å¦‚æœæŸå¤„å¿˜è®°æ£€æŸ¥ï¼Œæ™®é€šç”¨æˆ·å¯èƒ½è®¿é—® admin åŠŸèƒ½
- **ç»´æŠ¤å›°éš¾**: ä¿®æ”¹æƒé™é€»è¾‘éœ€è¦åœ¨ 20+ å¤„ä¿®æ”¹
- **æ€§èƒ½é—®é¢˜**: é‡å¤æŸ¥è¯¢ profiles è¡¨

**ä¿®å¤æ–¹æ¡ˆ**:

**åˆ›å»ºç»Ÿä¸€çš„æƒé™æ£€æŸ¥å·¥å…·**:
```typescript
// src/lib/auth/require-admin.ts
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export interface AdminCheckResult {
  user: { id: string }
  profile: { role: string }
  supabase: Awaited<ReturnType<typeof createClient>>
}

/**
 * è¦æ±‚ç”¨æˆ·å¿…é¡»æ˜¯ admin
 * å¦‚æœä¸æ˜¯ï¼Œè¿”å› 403 é”™è¯¯
 */
export async function requireAdmin(
  request: NextRequest
): Promise<{ success: true; data: AdminCheckResult } | { success: false; response: NextResponse }> {
  const supabase = await createClient()
  const {
    data: { user },
    error: authError,
  } = await supabase.auth.getUser()

  if (authError || !user) {
    return {
      success: false,
      response: NextResponse.json({ error: 'Unauthorized' }, { status: 401 }),
    }
  }

  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single()

  if (profileError || !profile) {
    return {
      success: false,
      response: NextResponse.json({ error: 'Profile not found' }, { status: 404 }),
    }
  }

  if (profile.role !== 'admin') {
    return {
      success: false,
      response: NextResponse.json(
        { error: 'Unauthorized: Admin access required' },
        { status: 403 }
      ),
    }
  }

  return {
    success: true,
    data: { user, profile, supabase },
  }
}

/**
 * è¦æ±‚ç”¨æˆ·å¿…é¡»æ˜¯ admin æˆ– support
 */
export async function requireAdminOrSupport(
  request: NextRequest
): Promise<{ success: true; data: AdminCheckResult } | { success: false; response: NextResponse }> {
  const supabase = await createClient()
  const {
    data: { user },
    error: authError,
  } = await supabase.auth.getUser()

  if (authError || !user) {
    return {
      success: false,
      response: NextResponse.json({ error: 'Unauthorized' }, { status: 401 }),
    }
  }

  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single()

  if (profileError || !profile) {
    return {
      success: false,
      response: NextResponse.json({ error: 'Profile not found' }, { status: 404 }),
    }
  }

  if (profile.role !== 'admin' && profile.role !== 'support') {
    return {
      success: false,
      response: NextResponse.json(
        { error: 'Unauthorized: Admin or support access required' },
        { status: 403 }
      ),
    }
  }

  return {
    success: true,
    data: { user, profile, supabase },
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
// src/app/api/admin/monitoring/dashboard/route.ts
import { requireAdmin } from '@/lib/auth/require-admin'

export async function GET(request: NextRequest) {
  const authResult = await requireAdmin(request)
  if (!authResult.success) {
    return authResult.response
  }

  const { user, supabase } = authResult.data
  
  // ç»§ç»­å¤„ç†ä¸šåŠ¡é€»è¾‘...
  const supabaseAdmin = createAdminClient(...)
}
```

**å½±å“èŒƒå›´**: 
- æ‰€æœ‰ `/api/admin/*` è·¯ç”±ï¼ˆçº¦ 20+ ä¸ªæ–‡ä»¶ï¼‰
- éœ€è¦ç»Ÿä¸€é‡æ„

---

## äºŒã€ä¸­ç­‰é—®é¢˜ï¼ˆP1 - é‡è¦ï¼Œåº”å°½å¿«ä¿®å¤ï¼‰

### ğŸŸ¡ P1-1: è®¢å•å–æ¶ˆæ—¶ä½¿ç”¨æ™®é€šå®¢æˆ·ç«¯è€Œé Admin å®¢æˆ·ç«¯

**ä½ç½®**: `src/app/api/orders/[id]/cancel/route.ts:116-165`

**é—®é¢˜æè¿°**:
```typescript
// ä½¿ç”¨æ™®é€š supabase å®¢æˆ·ç«¯ï¼ˆå— RLS é™åˆ¶ï¼‰
await supabase.from('orders').update({ ... })
await supabase.from('products').update({ ... })
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
1. **RLS é™åˆ¶**: æ™®é€šå®¢æˆ·ç«¯å— RLS ç­–ç•¥é™åˆ¶ï¼Œå¯èƒ½æ— æ³•æ›´æ–°æŸäº›æ•°æ®
2. **æƒé™ä¸è¶³**: å¦‚æœ RLS ç­–ç•¥ä¸å…è®¸ç”¨æˆ·æ›´æ–°è®¢å•/å•†å“ï¼Œæ“ä½œä¼šå¤±è´¥
3. **ä¸ä¸€è‡´**: åŒä¸€æ–‡ä»¶ä¸­ï¼Œéƒ¨åˆ†æ“ä½œä½¿ç”¨ `supabaseAdmin`ï¼Œéƒ¨åˆ†ä½¿ç”¨ `supabase`

**ç”Ÿäº§ç¯å¢ƒåæœ**:
- è®¢å•å–æ¶ˆå¯èƒ½å¤±è´¥ï¼ˆå¦‚æœ RLS ä¸å…è®¸ï¼‰
- åº“å­˜æ¢å¤å¯èƒ½å¤±è´¥
- é”™è¯¯éš¾ä»¥æ’æŸ¥ï¼ˆRLS é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ç»Ÿä¸€ä½¿ç”¨ supabaseAdmin
const { createClient: createAdminClient } = await import('@supabase/supabase-js')
const supabaseAdmin = createAdminClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  { auth: { autoRefreshToken: false, persistSession: false } }
)

// æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½ä½¿ç”¨ supabaseAdmin
await supabaseAdmin.from('orders').update({ ... })
await supabaseAdmin.from('products').update({ ... })
```

---

### ğŸŸ¡ P1-2: N+1 æŸ¥è¯¢é—®é¢˜ï¼ˆè®¢å•å–æ¶ˆæ—¶çš„åº“å­˜æ¢å¤ï¼‰

**ä½ç½®**: `src/app/api/orders/[id]/cancel/route.ts:132-148`

**é—®é¢˜æè¿°**:
```typescript
for (const item of orderItems) {
  const { data: product } = await supabase  // N+1 æŸ¥è¯¢
    .from('products')
    .select('stock')
    .eq('id', item.product_id)
    .single()
  
  await supabase.from('products').update({ ... })  // N+1 æ›´æ–°
}
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
- å¦‚æœæœ‰ 10 ä¸ªå•†å“ï¼Œéœ€è¦æ‰§è¡Œ 20 æ¬¡æ•°æ®åº“æŸ¥è¯¢
- é«˜å¹¶å‘æ—¶æ•°æ®åº“å‹åŠ›å¤§
- å“åº”æ—¶é—´éšå•†å“æ•°é‡çº¿æ€§å¢é•¿

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰å•†å“
const productIds = orderItems.map(item => item.product_id)
const { data: products } = await supabaseAdmin
  .from('products')
  .select('id, stock')
  .in('id', productIds)

// åˆ›å»ºå•†å“æ˜ å°„
const productMap = new Map(products?.map(p => [p.id, p]) || [])

// æ‰¹é‡æ›´æ–°ï¼ˆä½¿ç”¨æ•°æ®åº“å‡½æ•°æ›´å®‰å…¨ï¼‰
const updates = orderItems.map(item => {
  const product = productMap.get(item.product_id)
  if (product && product.stock !== null) {
    return supabaseAdmin.rpc('increment_product_stock', {
      p_product_id: item.product_id,
      p_quantity: item.quantity
    })
  }
  return Promise.resolve()
})

await Promise.all(updates)
```

---

### ğŸŸ¡ P1-3: ç¯å¢ƒå˜é‡éªŒè¯æœªåœ¨å¯åŠ¨æ—¶è°ƒç”¨

**ä½ç½®**: åº”ç”¨å¯åŠ¨å…¥å£

**é—®é¢˜æè¿°**:
è™½ç„¶åˆ›å»ºäº† `src/lib/env/validate.ts`ï¼Œä½†æ²¡æœ‰åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ `validateEnvOrThrow()`

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
- å¦‚æœå…³é”®ç¯å¢ƒå˜é‡ç¼ºå¤±ï¼Œåº”ç”¨ä¼šåœ¨è¿è¡Œæ—¶å¤±è´¥ï¼Œè€Œä¸æ˜¯å¯åŠ¨æ—¶
- éš¾ä»¥å¿«é€Ÿå®šä½é…ç½®é—®é¢˜
- ä¸ç¬¦åˆ Fail Fast åŸåˆ™

**ä¿®å¤æ–¹æ¡ˆ**:

**æ–¹æ¡ˆ1: åœ¨ middleware ä¸­éªŒè¯ï¼ˆæ¨èï¼‰**
```typescript
// middleware.ts
import { validateEnvOrThrow } from '@/lib/env/validate'

// åœ¨åº”ç”¨å¯åŠ¨æ—¶éªŒè¯ï¼ˆåªéªŒè¯ä¸€æ¬¡ï¼‰
let envValidated = false
if (!envValidated) {
  try {
    validateEnvOrThrow()
    envValidated = true
  } catch (error) {
    console.error('Environment validation failed:', error)
    // åœ¨å¼€å‘ç¯å¢ƒç»§ç»­è¿è¡Œï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥å¤±è´¥
    if (process.env.NODE_ENV === 'production') {
      throw error
    }
  }
}

export async function middleware(request: NextRequest) {
  // ... ç°æœ‰é€»è¾‘
}
```

**æ–¹æ¡ˆ2: åœ¨ API è·¯ç”±ä¸­éªŒè¯ï¼ˆå¤‡é€‰ï¼‰**
```typescript
// src/lib/env/validate-startup.ts
let validated = false

export function validateOnFirstCall() {
  if (!validated) {
    validateEnvOrThrow()
    validated = true
  }
}

// åœ¨æ¯ä¸ªå…³é”® API è·¯ç”±å¼€å¤´è°ƒç”¨
import { validateOnFirstCall } from '@/lib/env/validate-startup'

export async function POST(request: NextRequest) {
  validateOnFirstCall() // ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶éªŒè¯
  // ... ä¸šåŠ¡é€»è¾‘
}
```

---

### ğŸŸ¡ P1-4: è®¢å•å–æ¶ˆæƒé™æ£€æŸ¥ä¸å®Œæ•´

**ä½ç½®**: `src/app/api/orders/[id]/cancel/route.ts:40-43`

**é—®é¢˜æè¿°**:
```typescript
// åªæ£€æŸ¥ buyer_id å’Œ seller_id
if (order.buyer_id !== user.id && order.seller_id !== user.id) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
- æ²¡æœ‰æ£€æŸ¥ admin æƒé™
- å¦‚æœè®¢å•å±äºå…¶ä»–ç”¨æˆ·ï¼Œadmin æ— æ³•å–æ¶ˆï¼ˆè™½ç„¶å¯èƒ½ä¸éœ€è¦ï¼Œä½†åº”è¯¥æ˜ç¡®ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// æ£€æŸ¥æƒé™ï¼šä¹°å®¶ã€å–å®¶æˆ– admin
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single()

const isAdmin = profile?.role === 'admin'
const isBuyer = order.buyer_id === user.id
const isSeller = order.seller_id === user.id

if (!isBuyer && !isSeller && !isAdmin) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

---

### ğŸŸ¡ P1-5: å¤§é‡é¡µé¢ä½¿ç”¨ Client Componentï¼Œæœªå……åˆ†åˆ©ç”¨ Server Components

**ä½ç½®**: `src/app/[locale]/(main)/**/*.tsx`

**é—®é¢˜æè¿°**:
- çº¦ 30+ ä¸ªé¡µé¢éƒ½æ˜¯ `'use client'`
- å¾ˆå¤šé¡µé¢åªæ˜¯è·å–æ•°æ®ï¼Œä¸éœ€è¦å®¢æˆ·ç«¯äº¤äº’

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
1. **æ€§èƒ½**: Client Component éœ€è¦å‘é€æ›´å¤š JavaScript åˆ°å®¢æˆ·ç«¯
2. **SEO**: Client Component å†…å®¹å¯èƒ½ä¸åˆ©äº SEO
3. **é¦–å±åŠ è½½**: Server Component å¯ä»¥æ›´å¿«æ¸²æŸ“
4. **ä¸ç¬¦åˆ Next.js 14 æœ€ä½³å®è·µ**: åº”è¯¥é»˜è®¤ä½¿ç”¨ Server Component

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// âŒ å½“å‰åšæ³•
'use client'
export default function ProductPage() {
  const { data: product } = useQuery({ ... })
  // ...
}

// âœ… æ¨èåšæ³•
// page.tsx (Server Component)
import { createClient } from '@/lib/supabase/server'

export default async function ProductPage({ params }: { params: { id: string } }) {
  const supabase = await createClient()
  const { data: product } = await supabase
    .from('products')
    .select('*')
    .eq('id', params.id)
    .single()
  
  return <ProductClient product={product} />
}

// ProductClient.tsx (Client Componentï¼Œä»…ç”¨äºäº¤äº’)
'use client'
export function ProductClient({ product }: { product: Product }) {
  const [quantity, setQuantity] = useState(1)
  // ä»…åŒ…å«éœ€è¦äº¤äº’çš„é€»è¾‘
}
```

**å½±å“èŒƒå›´**: 
- çº¦ 30+ ä¸ªé¡µé¢éœ€è¦é‡æ„
- å¯ä»¥é€æ­¥è¿ç§»ï¼Œä¼˜å…ˆå¤„ç†é«˜æµé‡é¡µé¢

---

### ğŸŸ¡ P1-6: è®¢å•åˆ›å»ºæ—¶çš„å¾ªç¯æŸ¥è¯¢

**ä½ç½®**: `src/app/api/orders/create/route.ts:366-467`

**é—®é¢˜æè¿°**:
```typescript
for (const [sellerId, sellerItems] of Array.from(itemsBySeller.entries())) {
  // æ¯ä¸ªå–å®¶éƒ½æ‰§è¡Œå¤šæ¬¡æŸ¥è¯¢
  const validationResult = await validateSellerPaymentReady({ ... })
  const { data: sellerProfile } = await supabaseAdmin.from('profiles').select(...)
  const { data: defaultAccount } = await supabaseAdmin.from('payment_accounts').select(...)
  // ...
}
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
- å¦‚æœæœ‰ 5 ä¸ªå–å®¶ï¼Œéœ€è¦æ‰§è¡Œ 15+ æ¬¡æŸ¥è¯¢
- å¯ä»¥æ‰¹é‡æŸ¥è¯¢åå¤„ç†

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰å–å®¶ä¿¡æ¯
const sellerIds = Array.from(itemsBySeller.keys())
const { data: sellerProfiles } = await supabaseAdmin
  .from('profiles')
  .select('id, payment_provider, payment_account_id, seller_payout_eligibility')
  .in('id', sellerIds)

const { data: paymentAccounts } = await supabaseAdmin
  .from('payment_accounts')
  .select('seller_id, account_type, is_default, is_verified, currency')
  .in('seller_id', sellerIds)

// åˆ›å»ºæ˜ å°„
const profileMap = new Map(sellerProfiles?.map(p => [p.id, p]) || [])
const accountMap = new Map(
  paymentAccounts?.map(a => [`${a.seller_id}-${a.currency}`, a]) || []
)

// åœ¨å¾ªç¯ä¸­ä½¿ç”¨æ˜ å°„
for (const [sellerId, sellerItems] of itemsBySeller.entries()) {
  const profile = profileMap.get(sellerId)
  // ä½¿ç”¨ profile è€Œä¸æ˜¯æŸ¥è¯¢
}
```

---

### ğŸŸ¡ P1-7: Webhook ç­¾åéªŒè¯å¯èƒ½è¢«ç»•è¿‡

**ä½ç½®**: `src/app/api/payments/stripe/webhook/route.ts:83-100`

**é—®é¢˜æè¿°**:
```typescript
// å°è¯•å¤šä¸ª webhook secretï¼Œå¦‚æœéƒ½å¤±è´¥æ‰è¿”å›é”™è¯¯
// ä½†é€»è¾‘å¯èƒ½ä¸å¤Ÿä¸¥æ ¼
```

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
- å¦‚æœ webhook secret é…ç½®é”™è¯¯ï¼Œå¯èƒ½æ¥å—æ— æ•ˆè¯·æ±‚
- éœ€è¦ç¡®ä¿æ‰€æœ‰ webhook éƒ½æœ‰ä¸¥æ ¼çš„ç­¾åéªŒè¯

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ç¡®ä¿ webhook secret éªŒè¯ä¸¥æ ¼
if (!signature) {
  return NextResponse.json({ error: 'No signature' }, { status: 400 })
}

// éªŒè¯ç­¾åï¼Œå¦‚æœå¤±è´¥ç«‹å³è¿”å›
try {
  event = stripe.webhooks.constructEvent(body, signature, webhookSecret)
} catch (err) {
  console.error('Webhook signature verification failed:', err)
  return NextResponse.json(
    { error: 'Invalid signature' },
    { status: 400 }
  )
}
```

---

### ğŸŸ¡ P1-8: è®¢å•åˆ›å»ºæ—¶ç¼ºå°‘äº‹åŠ¡ä¿æŠ¤

**ä½ç½®**: `src/app/api/orders/create/route.ts:275-580`

**é—®é¢˜æè¿°**:
è®¢å•åˆ›å»ºæ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼š
1. åˆ›å»º order_group
2. ä¸ºæ¯ä¸ªå–å®¶åˆ›å»ºè®¢å•
3. åˆ›å»º order_items
4. å¦‚æœä¸­é—´å¤±è´¥ï¼Œå¯èƒ½ç•™ä¸‹éƒ¨åˆ†æ•°æ®

**ä¸ºä»€ä¹ˆæ˜¯é—®é¢˜**:
- å¦‚æœåˆ›å»ºäº† order_group ä½†è®¢å•åˆ›å»ºå¤±è´¥ï¼Œorder_group æˆä¸ºå­¤ç«‹æ•°æ®
- å¤šå–å®¶è®¢å•æ—¶ï¼Œå¦‚æœéƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥ï¼Œæ•°æ®ä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å‡½æ•°
CREATE OR REPLACE FUNCTION create_order_group_with_orders(
  p_order_group_data JSONB,
  p_orders_data JSONB[]
)
RETURNS TABLE (
  order_group_id UUID,
  order_ids UUID[]
) AS $$
DECLARE
  v_order_group_id UUID;
  v_order_ids UUID[] := ARRAY[]::UUID[];
BEGIN
  -- åœ¨äº‹åŠ¡ä¸­åˆ›å»ºæ‰€æœ‰æ•°æ®
  -- å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œå…¨éƒ¨å›æ»š
  -- ...
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## ä¸‰ã€å»ºè®®ä¼˜åŒ–ï¼ˆP2 - å¯ä»¥é€æ­¥æ”¹è¿›ï¼‰

### ğŸŸ¢ P2-1: åˆ›å»ºç»Ÿä¸€çš„ Admin Client å·¥å…·å‡½æ•°

**ä½ç½®**: æ‰€æœ‰ä½¿ç”¨ `createAdminClient` çš„åœ°æ–¹

**é—®é¢˜**: é‡å¤åˆ›å»º admin å®¢æˆ·ç«¯çš„ä»£ç 

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// src/lib/supabase/admin.ts
import { createClient } from '@supabase/supabase-js'

let adminClient: ReturnType<typeof createClient> | null = null

export async function getSupabaseAdmin() {
  if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
    throw new Error('SUPABASE_SERVICE_ROLE_KEY is not configured')
  }
  
  if (!adminClient) {
    adminClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!,
      {
        auth: {
          autoRefreshToken: false,
          persistSession: false,
        },
      }
    )
  }
  
  return adminClient
}
```

---

### ğŸŸ¢ P2-2: ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰

**ä½ç½®**: å¤šä¸ª API è·¯ç”±

**é—®é¢˜**: å¾ªç¯ä¸­æ‰§è¡ŒæŸ¥è¯¢

**ä¿®å¤æ–¹æ¡ˆ**: å‚è€ƒ P1-6 çš„æ‰¹é‡æŸ¥è¯¢æ–¹æ¡ˆ

---

### ğŸŸ¢ P2-3: æ·»åŠ è¯·æ±‚æ—¥å¿—å’Œç›‘æ§

**ä½ç½®**: æ‰€æœ‰ API è·¯ç”±

**é—®é¢˜**: ç¼ºå°‘ç»Ÿä¸€çš„è¯·æ±‚æ—¥å¿—

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// src/lib/middleware/api-logger.ts
export function logApiRequest(
  method: string,
  path: string,
  userId?: string,
  duration?: number
) {
  // è®°å½•åˆ° cron_logs æˆ–ä¸“é—¨çš„ api_logs è¡¨
}
```

---

### ğŸŸ¢ P2-4: ç»Ÿä¸€é”™è¯¯å¤„ç†

**ä½ç½®**: æ‰€æœ‰ API è·¯ç”±

**é—®é¢˜**: é”™è¯¯å¤„ç†ä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// src/lib/errors/api-error-handler.ts
export function handleApiError(error: unknown) {
  // ç»Ÿä¸€é”™è¯¯æ ¼å¼
  // è®°å½•é”™è¯¯æ—¥å¿—
  // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
}
```

---

### ğŸŸ¢ P2-5: æ·»åŠ  API é€Ÿç‡é™åˆ¶

**ä½ç½®**: æ‰€æœ‰ API è·¯ç”±

**é—®é¢˜**: æ²¡æœ‰é€Ÿç‡é™åˆ¶ï¼Œå¯èƒ½è¢«æ»¥ç”¨

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
// src/lib/middleware/rate-limit.ts
import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '10 s'),
})

export async function checkRateLimit(userId: string) {
  const { success } = await ratelimit.limit(userId)
  return success
}
```

---

### ğŸŸ¢ P2-6: ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼ˆæ·»åŠ ç´¢å¼•æ£€æŸ¥ï¼‰

**ä½ç½®**: æ•°æ®åº“è¿ç§»æ–‡ä»¶

**é—®é¢˜**: éœ€è¦ç¡®è®¤å…³é”®æŸ¥è¯¢å­—æ®µéƒ½æœ‰ç´¢å¼•

**å»ºè®®**: æ£€æŸ¥ä»¥ä¸‹æŸ¥è¯¢æ¨¡å¼æ˜¯å¦æœ‰ç´¢å¼•ï¼š
- `orders.buyer_id`, `orders.seller_id`
- `orders.payment_status`, `orders.order_status`
- `products.seller_id`, `products.status`
- `subscriptions.user_id`, `subscriptions.status`

---

### ğŸŸ¢ P2-7: æ·»åŠ ç±»å‹å®‰å…¨æ”¹è¿›

**ä½ç½®**: ä½¿ç”¨ `any` ç±»å‹çš„åœ°æ–¹

**é—®é¢˜**: çº¦ 25 å¤„ä½¿ç”¨ `any` ç±»å‹

**ä¿®å¤æ–¹æ¡ˆ**: é€æ­¥æ›¿æ¢ä¸ºå…·ä½“ç±»å‹

---

### ğŸŸ¢ P2-8: æ·»åŠ å•å…ƒæµ‹è¯•

**ä½ç½®**: å…³é”®ä¸šåŠ¡é€»è¾‘

**é—®é¢˜**: ç¼ºå°‘æµ‹è¯•è¦†ç›–

**å»ºè®®**: ä¼˜å…ˆæµ‹è¯•ï¼š
- æ”¯ä»˜å¤„ç†é€»è¾‘
- è®¢å•åˆ›å»ºé€»è¾‘
- é€€æ¬¾å¤„ç†é€»è¾‘
- æƒé™æ£€æŸ¥é€»è¾‘

---

## å››ã€æ¶æ„å±‚é¢é—®é¢˜

### 4.1 èŒè´£è¾¹ç•Œ

**âœ… åšå¾—å¥½çš„åœ°æ–¹**:
- æ”¯ä»˜å¤„ç†æœ‰ç»Ÿä¸€çš„æœåŠ¡å±‚ï¼ˆ`process-order-payment.ts`ï¼‰
- ä½£é‡‘è®¡ç®—æœ‰ç‹¬ç«‹çš„æ¨¡å—
- è®¢é˜…ç®¡ç†æœ‰ç‹¬ç«‹çš„æœåŠ¡

**âš ï¸ éœ€è¦æ”¹è¿›**:
- Admin æƒé™æ£€æŸ¥åˆ†æ•£åœ¨å„å¤„ï¼Œåº”è¯¥ç»Ÿä¸€
- Service Role å®¢æˆ·ç«¯åˆ›å»ºåˆ†æ•£ï¼Œåº”è¯¥ç»Ÿä¸€

---

### 4.2 æ¨¡å—æ‹†åˆ†

**âœ… åšå¾—å¥½çš„åœ°æ–¹**:
- `lib/payments/` ç›®å½•ç»“æ„æ¸…æ™°
- `lib/deposits/` ç‹¬ç«‹æ¨¡å—
- `lib/commissions/` ç‹¬ç«‹æ¨¡å—

**âš ï¸ éœ€è¦æ”¹è¿›**:
- ç¼ºå°‘ç»Ÿä¸€çš„ `lib/auth/` æ¨¡å—
- ç¼ºå°‘ç»Ÿä¸€çš„ `lib/admin/` æ¨¡å—

---

## äº”ã€æ•°æ®å®‰å…¨ä¸æƒé™æ§åˆ¶

### 5.1 RLS ç­–ç•¥è¯„ä¼°

**âœ… åšå¾—å¥½çš„åœ°æ–¹**:
- æ‰€æœ‰è¡¨éƒ½å¯ç”¨äº† RLS
- ç­–ç•¥åŸºæœ¬å®Œæ•´

**âš ï¸ æ½œåœ¨é—®é¢˜**:
- éœ€è¦ç¡®è®¤æ‰€æœ‰ Service Role æ“ä½œéƒ½æ˜¯å¿…è¦çš„
- éœ€è¦ç¡®è®¤æ²¡æœ‰ç»•è¿‡ RLS çš„æƒ…å†µ

---

### 5.2 Service Role ä½¿ç”¨

**âš ï¸ é—®é¢˜**:
- ä½¿ç”¨èŒƒå›´å¹¿æ³›ï¼Œéœ€è¦ç¡®ä¿éƒ½æ˜¯å¿…è¦çš„
- æ¨¡å—çº§åˆ›å»ºï¼ˆwebhookï¼‰éœ€è¦ä¿®å¤

---

## å…­ã€æ€§èƒ½ä¸å¯æ‰©å±•æ€§

### 6.1 N+1 æŸ¥è¯¢

**å‘ç°çš„é—®é¢˜**:
- è®¢å•å–æ¶ˆæ—¶çš„åº“å­˜æ¢å¤ï¼ˆP1-2ï¼‰
- è®¢å•åˆ›å»ºæ—¶çš„å–å®¶éªŒè¯ï¼ˆP1-6ï¼‰

**å½±å“**: ä¸­ç­‰ï¼Œé«˜å¹¶å‘æ—¶å¯èƒ½æˆä¸ºç“¶é¢ˆ

---

### 6.2 æ•°æ®åº“è¿æ¥

**âœ… åšå¾—å¥½çš„åœ°æ–¹**:
- Supabase å®¢æˆ·ç«¯ç®¡ç†åŸºæœ¬æ­£ç¡®
- ä½¿ç”¨è¿æ¥æ± ï¼ˆSupabase è‡ªåŠ¨å¤„ç†ï¼‰

**âš ï¸ éœ€è¦æ”¹è¿›**:
- Service Role å®¢æˆ·ç«¯åˆ›å»ºæ–¹å¼éœ€è¦ç»Ÿä¸€

---

## ä¸ƒã€å¯ç»´æŠ¤æ€§ä¸å¯è¯»æ€§

### 7.1 ä»£ç é‡å¤

**ä¸»è¦é—®é¢˜**:
- Admin æƒé™æ£€æŸ¥é‡å¤ï¼ˆP0-3ï¼‰
- Service Role å®¢æˆ·ç«¯åˆ›å»ºé‡å¤

---

### 7.2 å‘½åè§„èŒƒ

**âœ… åšå¾—å¥½çš„åœ°æ–¹**:
- å‡½æ•°å‘½åæ¸…æ™°
- æ–‡ä»¶ç»“æ„åˆç†

---

## å…«ã€Next.js 14 æœ€ä½³å®è·µ

### 8.1 Server Components vs Client Components

**âš ï¸ é—®é¢˜**:
- å¤§é‡é¡µé¢ä½¿ç”¨ Client Componentï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨ Server Component

**å»ºè®®**: é€æ­¥é‡æ„ï¼Œä¼˜å…ˆå¤„ç†ï¼š
- é¦–é¡µ (`page.tsx`)
- å•†å“è¯¦æƒ…é¡µ
- è®¢å•åˆ—è¡¨é¡µ

---

### 8.2 Server Actions

**é—®é¢˜**: æ²¡æœ‰ä½¿ç”¨ Server Actions

**å»ºè®®**: å¯¹äºè¡¨å•æäº¤ç­‰æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ Server Actions æ›¿ä»£ API è·¯ç”±

---

## ä¹ã€ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆæœ¬å‘¨å†…ï¼‰
1. P0-1: Service Role å®¢æˆ·ç«¯æ¨¡å—çº§åˆ›å»º
2. P0-2: è®¢å•å–æ¶ˆåº“å­˜æ¢å¤éåŸå­æ“ä½œ
3. P0-3: ç»Ÿä¸€ Admin æƒé™æ£€æŸ¥

### å°½å¿«ä¿®å¤ï¼ˆæœ¬æœˆå†…ï¼‰
4. P1-1: è®¢å•å–æ¶ˆä½¿ç”¨ Admin å®¢æˆ·ç«¯
5. P1-2: N+1 æŸ¥è¯¢ä¼˜åŒ–
6. P1-3: ç¯å¢ƒå˜é‡å¯åŠ¨éªŒè¯
7. P1-4: è®¢å•å–æ¶ˆæƒé™æ£€æŸ¥

### é€æ­¥æ”¹è¿›ï¼ˆä¸‹ä¸ªè¿­ä»£ï¼‰
8. P1-5: Server Components é‡æ„
9. P1-6: æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
10. P2-1 åˆ° P2-8: å„ç§ä¼˜åŒ–

---

## åã€æ€»ç»“

### ä¼˜ç‚¹
1. âœ… æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å®Œæ•´
2. âœ… æ•°æ®åº“äº‹åŠ¡å‡½æ•°ä½¿ç”¨å¾—å½“ï¼ˆæ”¯ä»˜å¤„ç†ï¼‰
3. âœ… RLS ç­–ç•¥åŸºæœ¬å®Œå–„
4. âœ… é”™è¯¯å¤„ç†åŸºæœ¬å®Œå–„

### éœ€è¦æ”¹è¿›
1. âš ï¸ å®‰å…¨ï¼šService Role ä½¿ç”¨éœ€è¦è§„èŒƒåŒ–
2. âš ï¸ æ•°æ®ä¸€è‡´æ€§ï¼šè®¢å•å–æ¶ˆéœ€è¦åŸå­æ“ä½œ
3. âš ï¸ ä»£ç è´¨é‡ï¼šå‡å°‘é‡å¤ï¼Œç»Ÿä¸€å·¥å…·å‡½æ•°
4. âš ï¸ æ€§èƒ½ï¼šä¼˜åŒ– N+1 æŸ¥è¯¢
5. âš ï¸ Next.js 14ï¼šæ›´å¤šä½¿ç”¨ Server Components

### æ€»ä½“è¯„åˆ†
- **å®‰å…¨æ€§**: 7/10ï¼ˆæœ‰æ”¹è¿›ç©ºé—´ï¼‰
- **æ€§èƒ½**: 7/10ï¼ˆéœ€è¦ä¼˜åŒ–ï¼‰
- **å¯ç»´æŠ¤æ€§**: 8/10ï¼ˆè‰¯å¥½ï¼‰
- **æ¶æ„è®¾è®¡**: 8/10ï¼ˆè‰¯å¥½ï¼‰

**å»ºè®®**: ä¼˜å…ˆä¿®å¤ 3 ä¸ªä¸¥é‡é—®é¢˜ï¼Œç„¶åé€æ­¥æ”¹è¿›ä¸­ç­‰é—®é¢˜ã€‚
